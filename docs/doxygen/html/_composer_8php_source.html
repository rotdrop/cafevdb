<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<link rel="shortcut icon" type="image/png" href="/nextcloud-git/apps/cafevdb/img/logo-greyf32x32.png" />
<title>CamerataDB: /var/www/dev1/htdocs/nextcloud-git-25/apps/cafevdb/lib/EmailForm/Composer.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="/usr/share/mathjax/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo128x128.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">CamerataDB
   &#160;<span id="projectnumber">3.0</span>
   </div>
   <div id="projectbrief">Database application to ease the management of a project-oriented orchestra.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('_composer_8php_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">Composer.php</div></div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span>&lt;?php</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno"><a class="line" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form.html">   25</a></span><span class="keyword">namespace </span><a class="code hl_namespace" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form.html">OCA\CAFEVDB\EmailForm</a>;</div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span> </div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span>use \DateTimeImmutable;</div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span>use \DateTimeInterface;</div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span>use ZipStream\ZipStream;</div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>use \stdClass;</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>use \Net_IMAP;</div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>use \Mail_RFC822;</div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>use \PHP_IBAN;</div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>use \DOMDocument;</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>use Throwable;</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span> </div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>use OCA\CAFEVDB\Wrapped\Doctrine\Common\Collections\Collection;</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span> </div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>use OCP\IDateTimeFormatter;</div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span> </div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_util.html">OCA\CAFEVDB\Common\Util</a>;</div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_uuid.html">OCA\CAFEVDB\Common\Uuid</a>;</div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html">OCA\CAFEVDB\Common\PHPMailer</a>;</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>use <a class="code hl_namespace" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_entities.html">OCA\CAFEVDB\Database\Doctrine\ORM\Entities</a>;</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_entity_manager.html">OCA\CAFEVDB\Database\EntityManager</a>;</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_util.html">OCA\CAFEVDB\Database\Doctrine\Util</a> as DBUtil;</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_d_b_a_l_1_1_types_1_1_enum_participant_field_data_type.html">OCA\CAFEVDB\Database\Doctrine\DBAL\Types\EnumParticipantFieldDataType</a> as FieldType;</div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_d_b_a_l_1_1_types_1_1_enum_participant_field_multiplicity.html">OCA\CAFEVDB\Database\Doctrine\DBAL\Types\EnumParticipantFieldMultiplicity</a> as FieldMultiplicity;</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_d_b_a_l_1_1_types_1_1_enum_attachment_origin.html">OCA\CAFEVDB\Database\Doctrine\DBAL\Types\EnumAttachmentOrigin</a> as AttachmentOrigin;</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_d_b_a_l_1_1_types_1_1_enum_member_status.html">OCA\CAFEVDB\Database\Doctrine\DBAL\Types\EnumMemberStatus</a> as MemberStatus;</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_documents_1_1_open_document_filler.html">OCA\CAFEVDB\Documents\OpenDocumentFiller</a>;</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>use <a class="code hl_namespace" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_exceptions.html">OCA\CAFEVDB\Exceptions</a>;</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_page_renderer_1_1_util_1_1_navigation.html">OCA\CAFEVDB\PageRenderer\Util\Navigation</a> as PageNavigation;</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_config_service.html">OCA\CAFEVDB\Service\ConfigService</a>;</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_instrumentation_service.html">OCA\CAFEVDB\Service\InstrumentationService</a>;</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_request_parameter_service.html">OCA\CAFEVDB\Service\RequestParameterService</a>;</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_events_service.html">OCA\CAFEVDB\Service\EventsService</a>;</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_progress_status_service.html">OCA\CAFEVDB\Service\ProgressStatusService</a>;</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_config_check_service.html">OCA\CAFEVDB\Service\ConfigCheckService</a>;</div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_simple_sharing_service.html">OCA\CAFEVDB\Service\SimpleSharingService</a>;</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_organizational_roles_service.html">OCA\CAFEVDB\Service\OrganizationalRolesService</a>;</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_project_service.html">OCA\CAFEVDB\Service\ProjectService</a>;</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_project_participant_fields_service.html">OCA\CAFEVDB\Service\ProjectParticipantFieldsService</a>;</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_sepa_bulk_transaction_service.html">OCA\CAFEVDB\Service\Finance\SepaBulkTransactionService</a>;</div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_finance_service.html">OCA\CAFEVDB\Service\Finance\FinanceService</a>;</div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_instrument_insurance_service.html">OCA\CAFEVDB\Service\Finance\InstrumentInsuranceService</a>;</div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_receivables_generator_factory.html">OCA\CAFEVDB\Service\Finance\ReceivablesGeneratorFactory</a>;</div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>use <a class="code hl_interface" href="interface_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_i_recurring_receivables_generator.html">OCA\CAFEVDB\Service\Finance\IRecurringReceivablesGenerator</a>;</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_storage_1_1_app_storage.html">OCA\CAFEVDB\Storage\AppStorage</a>;</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_storage_1_1_user_storage.html">OCA\CAFEVDB\Storage\UserStorage</a>;</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_storage_1_1_database_storage_util.html">OCA\CAFEVDB\Storage\DatabaseStorageUtil</a>;</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span> </div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>use <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_background_job_1_1_cleanup_expired_downloads.html">OCA\CAFEVDB\BackgroundJob\CleanupExpiredDownloads</a>;</div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span> </div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html">   83</a></span><span class="keyword">class </span><a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html">Composer</a></div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>{</div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>  use \OCA\CAFEVDB\Traits\ConfigTrait;</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>  use \OCA\CAFEVDB\Traits\EntityManagerTrait;</div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>  use \OCA\CAFEVDB\Traits\SloppyTrait;</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>  use \OCA\CAFEVDB\Toolkit\Traits\FakeTranslationTrait;</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span> </div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>  <span class="keyword">const</span> MSG_ID_AT = <span class="stringliteral">&#39;_at_&#39;</span>;</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span> </div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>  <span class="keyword">private</span> <span class="keyword">const</span> PROGRESS_CHUNK_SIZE = 4096;</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>  <span class="keyword">private</span> <span class="keyword">const</span> PROGRESS_THROTTLE_SECONDS = 2;</div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span> </div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>  <span class="keyword">const</span> POST_TAG = <span class="stringliteral">&#39;emailComposer&#39;</span>;</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span> </div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>  <span class="keyword">private</span> <span class="keyword">const</span> PERSONAL_ATTACHMENT_PARENTS_STRIP = 5;</div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>  <span class="keyword">private</span> <span class="keyword">const</span> ATTACHMENT_PREVIEW_CACHE_TTL = 4 * 60 * 60;</div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span> </div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>  <span class="keyword">private</span> <span class="keyword">const</span> HEADER_TAG = <span class="stringliteral">&#39;X-CAFEVDB&#39;</span>;</div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>  <span class="keyword">private</span> <span class="keyword">const</span> HEADER_MARKER = [ self::HEADER_TAG =&gt; <span class="stringliteral">&#39;YES&#39;</span>, ];</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>  <span class="keyword">private</span> <span class="keyword">const</span> HEADER_MARKER_RECIPIENT = [ self::HEADER_TAG . <span class="charliteral">&#39;-&#39;</span> . <span class="stringliteral">&#39;DESTINATION&#39;</span> =&gt; <span class="stringliteral">&#39;Recipient&#39;</span>, ];</div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>  <span class="keyword">private</span> <span class="keyword">const</span> HEADER_MARKER_SENT = [ self::HEADER_TAG . <span class="charliteral">&#39;-&#39;</span> . <span class="stringliteral">&#39;DESTINATION&#39;</span> =&gt; <span class="stringliteral">&#39;Self&#39;</span>, ];</div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>  <span class="keyword">private</span> <span class="keyword">const</span> DO_NOT_REPLY_SENDER = <span class="stringliteral">&#39;do-not-reply&#39;</span>;</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span> </div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_STAGE = <span class="stringliteral">&#39;stage&#39;</span>;</div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_CAPTION = <span class="stringliteral">&#39;caption&#39;</span>; <span class="comment">// appears not to be displayed?</span></div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_TOTAL_COUNT = <span class="stringliteral">&#39;TotalCount&#39;</span>;</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_TOTAL_PAYLOAD = <span class="stringliteral">&#39;TotalPayload&#39;</span>;</div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_FAILED_COUNT = <span class="stringliteral">&#39;FailedCount&#39;</span>;</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_FAILED_RECIPIENTS = <span class="stringliteral">&#39;FailedRecipients&#39;</span>;</div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_MAILER_EXCEPTIONS = <span class="stringliteral">&#39;MailerExceptions&#39;</span>;</div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_DUPLICATES = <span class="stringliteral">&#39;Duplicates&#39;</span>;</div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_COPY_TO_SENT = <span class="stringliteral">&#39;CopyToSent&#39;</span>;</div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_TEMPLATE_VALIDATION = <span class="stringliteral">&#39;TemplateValidation&#39;</span>;</div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_ADDRESS_VALIDATION = <span class="stringliteral">&#39;AddressValidation&#39;</span>;</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_SUBJECT_VALIDATION = <span class="stringliteral">&#39;SubjectValidation&#39;</span>;</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_FROM_VALIDATION = <span class="stringliteral">&#39;FromValidation&#39;</span>;</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_ATTACHMENT_VALIDATION = <span class="stringliteral">&#39;AttachmentValidation&#39;</span>;</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_MESSAGE = <span class="stringliteral">&#39;Message&#39;</span>;</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_EXTERNAL_LINK_VALIDATION = <span class="stringliteral">&#39;ExternalLinkValidation&#39;</span>;</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_SHARE_LINK_VALIDATION = <span class="stringliteral">&#39;ShareLinkValidation&#39;</span>;</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_PRIVACY_NOTICE_VALIDATION = <span class="stringliteral">&#39;PrivacyNoticeValidation&#39;</span>;</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span> </div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_STAGE_PREVIEW = <span class="stringliteral">&#39;preview&#39;</span>;</div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>  <span class="keyword">public</span> <span class="keyword">const</span> DIAGNOSTICS_STAGE_SEND = <span class="stringliteral">&#39;send&#39;</span>;</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span> </div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>  <span class="keyword">const</span> DEFAULT_ATTACHMENT_SIZE_LIMIT = (1 &lt;&lt; 20); <span class="comment">// 1 Mib, quite small</span></div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span> </div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>  <span class="keyword">const</span> DEFAULT_ATTACHMENT_LINK_EXPIRATION_LIMIT = 7; <span class="comment">// days</span></div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span> </div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>  <span class="keyword">const</span> DEFAULT_TEMPLATE_NAME = <span class="stringliteral">&#39;Default&#39;</span>;</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span>  <span class="comment">// phpcs:disable Generic.Files.LineLength.TooLong</span></div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>  <span class="keyword">const</span> DEFAULT_TEMPLATE = <span class="stringliteral">&#39;Liebe Musiker,</span></div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span><span class="stringliteral">&lt;p&gt;</span></div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span><span class="stringliteral">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</span></div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span><span class="stringliteral">&lt;p&gt;</span></div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span><span class="stringliteral">Mit den besten Grüßen,</span></div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span><span class="stringliteral">&lt;p&gt;</span></div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span><span class="stringliteral">Euer Camerata Vorstand (${GLOBAL::ORGANIZER})</span></div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span><span class="stringliteral">&lt;p&gt;</span></div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span><span class="stringliteral">P.s.:</span></div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span><span class="stringliteral">Sie erhalten diese Email, weil Sie schon einmal mit dem Orchester</span></div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span><span class="stringliteral">Camerata Academica Freiburg musiziert haben. Wenn wir Sie aus unserer Datenbank</span></div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span><span class="stringliteral">löschen sollen, teilen Sie uns das bitte kurz mit, indem Sie entsprechend</span></div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span><span class="stringliteral">auf diese Email antworten. Wir entschuldigen uns in diesem Fall für die</span></div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span><span class="stringliteral">Störung.&#39;</span>;</div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>  <span class="comment">// phpcs:enable</span></div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>  <span class="keyword">const</span> GLOBAL_NAMESPACE = <span class="stringliteral">&#39;GLOBAL&#39;</span>;</div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>  <span class="keyword">const</span> MEMBER_NAMESPACE = <span class="stringliteral">&#39;MEMBER&#39;</span>;</div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>  <span class="keyword">const</span> MEMBER_VARIABLES = [</div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>    <span class="stringliteral">&#39;FIRST_NAME&#39;</span>,</div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>    <span class="stringliteral">&#39;SUR_NAME&#39;</span>,</div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>    <span class="stringliteral">&#39;NICK_NAME&#39;</span>,</div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>    <span class="stringliteral">&#39;DISPLAY_NAME&#39;</span>,</div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>    <span class="stringliteral">&#39;EMAIL&#39;</span>,</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>    <span class="stringliteral">&#39;MOBILE_PHONE&#39;</span>,</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>    <span class="stringliteral">&#39;FIXED_LINE_PHONE&#39;</span>,</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>    <span class="stringliteral">&#39;STREET&#39;</span>,</div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>    <span class="stringliteral">&#39;STREET_NUMBER&#39;</span>,</div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>    <span class="stringliteral">&#39;STREET_AND_NUMBER&#39;</span>,</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>    <span class="stringliteral">&#39;POSTAL_CODE&#39;</span>,</div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>    <span class="stringliteral">&#39;CITY&#39;</span>,</div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>    <span class="stringliteral">&#39;COUNTRY&#39;</span>,</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>    <span class="stringliteral">&#39;LANGUAGE&#39;</span>,</div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>    <span class="stringliteral">&#39;BIRTHDAY&#39;</span>,</div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>    <span class="stringliteral">&#39;TOTAL_FEES&#39;</span>,</div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>    <span class="stringliteral">&#39;AMOUNT_PAID&#39;</span>,</div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span>    <span class="stringliteral">&#39;MISSING_AMOUNT&#39;</span>,</div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>    <span class="stringliteral">&#39;PROJECT_DATA&#39;</span>,</div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>    <span class="stringliteral">&#39;SEPA_MANDATE_REFERENCE&#39;</span>,</div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span>    <span class="stringliteral">&#39;SEPA_MANDATE_DATE&#39;</span>,</div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>    <span class="stringliteral">&#39;BANK_ACCOUNT_IBAN&#39;</span>,</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span>    <span class="stringliteral">&#39;BANK_ACCOUNT_BIC&#39;</span>,</div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>    <span class="stringliteral">&#39;BANK_ACCOUNT_BANK&#39;</span>,</div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>    <span class="stringliteral">&#39;BANK_ACCOUNT_OWNER&#39;</span>,</div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span>    <span class="stringliteral">&#39;BANK_TRANSACTION_AMOUNT&#39;</span>,</div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>    <span class="stringliteral">&#39;BANK_TRANSACTION_PURPOSE&#39;</span>,</div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>    <span class="stringliteral">&#39;BANK_TRANSACTION_PARTS&#39;</span>,</div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>    <span class="stringliteral">&#39;DATE&#39;</span>,</div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>  ];</div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>  <span class="keyword">const</span> DEFAULT_HTML_TEMPLATES = [</div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>    <span class="stringliteral">&#39;transaction-parts&#39;</span> =&gt; [</div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span>      <span class="stringliteral">&#39;header&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;table class=&quot;transaction-parts[CSSCLASS]&quot;&gt;&lt;thead&gt;&lt;tr&gt;</span></div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span><span class="stringliteral">  &lt;th class=&quot;cell purpose&quot;&gt;[PURPOSE]&lt;/th&gt;</span></div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span><span class="stringliteral">  &lt;th class=&quot;cell invoiced&quot;&gt;[INVOICED]&lt;/th&gt;</span></div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span><span class="stringliteral">  &lt;th class=&quot;cell details totals&quot;&gt;[TOTALS]&lt;/th&gt;</span></div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span><span class="stringliteral">  &lt;th class=&quot;cell details received&quot;&gt;[RECEIVED]&lt;/th&gt;</span></div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span><span class="stringliteral">  &lt;th class=&quot;cell details remaining&quot;&gt;[REMAINING]&lt;/th&gt;</span></div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span><span class="stringliteral">&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&#39;</span>,</div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>      <span class="stringliteral">&#39;row&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;tr&gt;</span></div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span><span class="stringliteral">  &lt;td class=&quot;cell purpose&quot;&gt;[PURPOSE]&lt;/td&gt;</span></div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span><span class="stringliteral">  &lt;td class=&quot;cell invoiced money&quot;&gt;[INVOICED]&lt;/td&gt;</span></div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span><span class="stringliteral">  &lt;td class=&quot;cell details totals money&quot;&gt;[TOTALS]&lt;/td&gt;</span></div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span><span class="stringliteral">  &lt;td class=&quot;cell details received money&quot;&gt;[RECEIVED]&lt;/td&gt;</span></div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span><span class="stringliteral">  &lt;td class=&quot;cell details remaining money&quot;&gt;[REMAINING]&lt;/td&gt;</span></div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span><span class="stringliteral">&lt;/tr&gt;&#39;</span>,</div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>      <span class="stringliteral">&#39;footer&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;/tbody&gt;&lt;tbody class=&quot;footer&quot;&gt;</span></div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span><span class="stringliteral">  &lt;tr class=&quot;totalsum&quot;&gt;</span></div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span><span class="stringliteral">    &lt;td class=&quot;cell purpose&quot;&gt;[PURPOSE]&lt;/td&gt;</span></div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span><span class="stringliteral">    &lt;td class=&quot;cell invoiced money&quot;&gt;[INVOICED]&lt;/td&gt;</span></div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span><span class="stringliteral">    &lt;td class=&quot;cell details totals money&quot;&gt;[TOTALS]&lt;/td&gt;</span></div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span><span class="stringliteral">    &lt;td class=&quot;cell details received money&quot;&gt;[RECEIVED]&lt;/td&gt;</span></div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span><span class="stringliteral">    &lt;td class=&quot;cell details remaining money&quot;&gt;[REMAINING]&lt;/td&gt;</span></div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span><span class="stringliteral">  &lt;/tr&gt;</span></div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span><span class="stringliteral">&lt;/tbody&gt;&lt;/table&gt;&#39;</span></div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span>    ],</div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span>    <span class="stringliteral">&#39;monetary-fields&#39;</span> =&gt; [</div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span>      <span class="stringliteral">&#39;header&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;table class=&quot;[CSSCLASS]&quot;&gt;&lt;thead&gt;&lt;tr&gt;</span></div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span><span class="stringliteral">  &lt;th&gt;[OPTION]&lt;/th&gt;</span></div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span><span class="stringliteral">  &lt;th&gt;[TOTALS]&lt;/th&gt;</span></div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span><span class="stringliteral">  &lt;th&gt;[RECEIVED]&lt;/th&gt;</span></div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span><span class="stringliteral">  &lt;th&gt;[REMAINING]&lt;/th&gt;</span></div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span><span class="stringliteral">  &lt;th&gt;[DUEDATE]&lt;/th&gt;</span></div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span><span class="stringliteral">&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&#39;</span>,</div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span>      <span class="stringliteral">&#39;fieldHeader&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;/tbody&gt;&lt;tbody class=&quot;[CSSCLASS]&quot;&gt;</span></div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span><span class="stringliteral">  &lt;tr class=&quot;[CSSCLASS]&quot;&gt;</span></div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span><span class="stringliteral">    &lt;td colspan=&quot;4&quot;&gt;[FIELDNAME]&lt;/td&gt;</span></div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span><span class="stringliteral">    &lt;td&gt;[DUEDATE]&lt;/td&gt;</span></div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span><span class="stringliteral">  &lt;/tr&gt;</span></div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span><span class="stringliteral">&lt;/tbody&gt;&lt;tbody class=&quot;[CSSROWCLASS]&quot;&gt;&#39;</span>,</div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>      <span class="stringliteral">&#39;row&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;tr class=&quot;[CSSROWCLASS]&quot;&gt;</span></div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span><span class="stringliteral">  &lt;td class=&quot;row-label&quot;&gt;[OPTION]&lt;/td&gt;</span></div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span><span class="stringliteral">  &lt;td class=&quot;money&quot;&gt;[TOTALS]&lt;/td&gt;</span></div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span><span class="stringliteral">  &lt;td class=&quot;money&quot;&gt;[RECEIVED]&lt;/td&gt;</span></div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span><span class="stringliteral">  &lt;td class=&quot;money&quot;&gt;[REMAINING]&lt;/td&gt;</span></div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span><span class="stringliteral">  &lt;td class=&quot;date&quot;&gt;[DUEDATE]&lt;/td&gt;</span></div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span><span class="stringliteral">&lt;/tr&gt;&lt;tr class=&quot;row-data&quot;&gt;</span></div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span><span class="stringliteral">  &lt;td class=&quot;row-data-label&quot;&gt;[ROWDATALABEL]&lt;/td&gt;</span></div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span><span class="stringliteral">  &lt;td class=&quot;row-data-contents&quot; colspan=&quot;4&quot;&gt;[ROWDATACONTENTS]&lt;/td&gt;</span></div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span><span class="stringliteral">&lt;/tr&gt;&#39;</span>,</div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>      <span class="stringliteral">&#39;footer&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;/tbody&gt;&lt;tbody class=&quot;[CSSCLASS]&quot;&gt;</span></div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span><span class="stringliteral">  &lt;tr class=&quot;[CSSCLASS]&quot;&gt;</span></div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span><span class="stringliteral">    &lt;td class=&quot;row-label&quot;&gt;[LABEl]&lt;/td&gt;</span></div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span><span class="stringliteral">    &lt;td class=&quot;money&quot;&gt;[TOTALS]&lt;/td&gt;</span></div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span><span class="stringliteral">    &lt;td class=&quot;money&quot;&gt;[RECEIVED]&lt;/td&gt;</span></div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span><span class="stringliteral">    &lt;td class=&quot;money&quot;&gt;[REMAINING]&lt;/td&gt;</span></div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span><span class="stringliteral">    &lt;td class=&quot;date&quot;&gt;[DUEDATE]&lt;/td&gt;</span></div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span><span class="stringliteral">  &lt;/tr&gt;</span></div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span><span class="stringliteral">&lt;/tbody&gt;&lt;/table&gt;&#39;</span>,</div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span>    ],</div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span>  ];</div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span>  <span class="comment">// @todo Fix the prefix, make it more automatic</span></div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>  <span class="keyword">const</span> EMAIL_PREVIEW_SELECTOR = <span class="stringliteral">&#39;.ui-dialog.emailform #emailformdialog div#emailformwrapper form#cafevdb-email-form div#emailformdebug div#cafevdb-email-preview .email-body.reset-css&#39;</span>;</div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span>  <span class="keyword">const</span> DEFAULT_HTML_STYLES = [</div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span>    <span class="stringliteral">&#39;transaction-parts&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;style&gt;</span></div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span><span class="stringliteral">[CSSPREFIX]table.transaction-parts.nothing-received-yet .cell.details {</span></div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span><span class="stringliteral">  display:none;</span></div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span><span class="stringliteral">[CSSPREFIX]table.transaction-parts,</span></div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span><span class="stringliteral">[CSSPREFIX]table.transaction-parts tr,</span></div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span><span class="stringliteral">[CSSPREFIX]table.transaction-parts th,</span></div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span><span class="stringliteral">[CSSPREFIX]table.transaction-parts td {</span></div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span><span class="stringliteral">  border-collapse:collapse;</span></div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span><span class="stringliteral">[CSSPREFIX]table.transaction-parts th,</span></div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span><span class="stringliteral">[CSSPREFIX]table.transaction-parts td {</span></div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span><span class="stringliteral">  border: 1px solid black;</span></div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span><span class="stringliteral">  padding: 0 2pt;</span></div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span><span class="stringliteral">[CSSPREFIX]table.transaction-parts th {</span></div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span><span class="stringliteral">  text-align:center;</span></div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span><span class="stringliteral">  font-weight:bold;</span></div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span><span class="stringliteral">  border-bottom:2px solid black;</span></div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span><span class="stringliteral">[CSSPREFIX]table.transaction-parts td { text-align:left; }</span></div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span><span class="stringliteral">[CSSPREFIX]table.transaction-parts tr.totalsum {</span></div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span><span class="stringliteral">  border-top:double;</span></div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span><span class="stringliteral">[CSSPREFIX]table.transaction-parts tr.totalsum td {</span></div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span><span class="stringliteral">  text-align:right;</span></div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span><span class="stringliteral">  font-weight:bold;</span></div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span><span class="stringliteral">[CSSPREFIX]table.transaction-parts td.money {</span></div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span><span class="stringliteral">  text-align:right;</span></div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span><span class="stringliteral">  padding-left: 1em;</span></div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span><span class="stringliteral"> }</span></div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span><span class="stringliteral">&lt;/style&gt;&#39;</span>,</div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>    <span class="stringliteral">&#39;monetary-fields&#39;</span> =&gt; <span class="stringliteral">&#39;&lt;style&gt;</span></div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields,</span></div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr,</span></div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields th,</span></div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields td {</span></div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span><span class="stringliteral">  border-collapse:collapse;</span></div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields th,</span></div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields td {</span></div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span><span class="stringliteral">  border: 1px solid black;</span></div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span><span class="stringliteral">  padding: 0 2pt;</span></div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr.field-header {</span></div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span><span class="stringliteral">  border-top:double;</span></div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span><span class="stringliteral">  border-bottom:2px solid black;</span></div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr.field-header td {</span></div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span><span class="stringliteral">  font-style:italic;</span></div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span><span class="stringliteral">  text-align:center;</span></div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields th {</span></div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span><span class="stringliteral">  font-weight:bold;</span></div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span><span class="stringliteral">  text-align:center;</span></div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span><span class="stringliteral">  border-bottom:2px solid black;</span></div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tbody.field-option.number-of-options-1 td.row-label {</span></div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span><span class="stringliteral">  font-style:italic;</span></div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tbody.footer td.date,</span></div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tbody.number-of-options-1 td.date {</span></div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span><span class="stringliteral">  opacity:inherit;</span></div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields td.money {</span></div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span><span class="stringliteral">  text-align:right;</span></div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span><span class="stringliteral">  padding-left: 1em;</span></div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr.totalsum {</span></div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span><span class="stringliteral">  border-top:3px double black;</span></div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span><span class="stringliteral">  border-bottom:3px double black;</span></div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr.totalsum td {</span></div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span><span class="stringliteral">  font-weight:bold;</span></div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr.totalsum td.row-label {</span></div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span><span class="stringliteral">  text-align:right;</span></div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr.totalsum.total-number-of-options-0,</span></div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr.totalsum.total-number-of-options-1,</span></div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tbody.field-header.number-of-options-0,</span></div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tbody.field-header.number-of-options-1,</span></div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr.field-header.number-of-options-0,</span></div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr.field-header.number-of-options-1,</span></div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tbody.field-option tr.row-data,</span></div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tbody:empty {</span></div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span><span class="stringliteral">  display:none;</span></div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tbody.field-option tr.has-data + tr.row-data {</span></div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span><span class="stringliteral">  display:table-row;</span></div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr.row-data td {</span></div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span><span class="stringliteral">  opacity:0.6;</span></div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr.row-data td.row-data-label {</span></div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span><span class="stringliteral">  text-align:right;</span></div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span><span class="stringliteral">[CSSPREFIX]table.monetary-fields tr.row-data td.row-data-contents {</span></div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span><span class="stringliteral">  white-space:nowrap;</span></div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span><span class="stringliteral">  overflow:hidden;</span></div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span><span class="stringliteral">  max-width:80%;</span></div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span><span class="stringliteral">  text-overflow:ellipsis;</span></div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span><span class="stringliteral">  font-style:italic;</span></div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span><span class="stringliteral">}</span></div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span><span class="stringliteral">&lt;/style&gt;&#39;</span>,</div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span>  ];</div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span>  <span class="keyword">const</span> PARTICIPANT_MONETARY_FIELDS_CSS_CLASS = [</div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span>    <span class="stringliteral">&#39;header&#39;</span> =&gt; <span class="stringliteral">&#39;monetary-fields&#39;</span>,</div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span>    <span class="stringliteral">&#39;fieldHeader&#39;</span> =&gt; <span class="stringliteral">&#39;field-header&#39;</span>,</div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span>    <span class="stringliteral">&#39;row&#39;</span> =&gt; <span class="stringliteral">&#39;field-option&#39;</span>,</div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span>    <span class="stringliteral">&#39;footer&#39;</span> =&gt; <span class="stringliteral">&#39;footer totalsum&#39;</span>,</div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span>  ];</div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span> </div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a1e0d5995112f4233f626fbb08fc44753">  376</a></span>  <span class="keyword">private</span> <a class="code hl_variable" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a1e0d5995112f4233f626fbb08fc44753">$recipients</a>; </div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a583519d7e9354b0ee2cd0b656711dd91">  377</a></span>  <span class="keyword">private</span> <a class="code hl_variable" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a583519d7e9354b0ee2cd0b656711dd91">$onLookers</a>;  </div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span> </div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span>  <span class="keyword">private</span> $cgiData;</div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span> </div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span>  <span class="keyword">private</span> $submitted;</div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span> </div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span>  <span class="keyword">private</span> $projectId;</div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span> </div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span>  <span class="keyword">private</span> $projectName;</div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span> </div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span>  <span class="keyword">private</span> $project;</div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span> </div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span>  <span class="keyword">private</span> $bulkTransaction;</div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span> </div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span>  <span class="keyword">private</span> $bulkTransactionId;</div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span> </div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span>  <span class="keyword">private</span> $paymentSign = 1.0;</div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span> </div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span>  <span class="keyword">private</span> $constructionMode;</div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span> </div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac54fcac898abdad38c7a08936d225d0b">  406</a></span>  <span class="keyword">private</span> <a class="code hl_variable" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac54fcac898abdad38c7a08936d225d0b">$catchAllEmail</a>; </div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a93205910f367adeb7052a773907ab2c2">  407</a></span>  <span class="keyword">private</span> <a class="code hl_variable" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a93205910f367adeb7052a773907ab2c2">$catchAllName</a>;  </div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span> </div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span>  <span class="keyword">private</span> $initialTemplate;</div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span>  <span class="keyword">private</span> $templateName;</div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span> </div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aeee4b6b94a0d071a13a6f75057140db5">  412</a></span>  <span class="keyword">private</span> <a class="code hl_variable" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aeee4b6b94a0d071a13a6f75057140db5">$inReplyToId</a>; </div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a71a62ba0936f5853e5c3ac3c0157ff66">  413</a></span>  <span class="keyword">private</span> <a class="code hl_variable" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a71a62ba0936f5853e5c3ac3c0157ff66">$referencing</a>; </div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span> </div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8b343a4564c310b65c59e5a08305dbf0">  415</a></span>  <span class="keyword">private</span> <a class="code hl_variable" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8b343a4564c310b65c59e5a08305dbf0">$draftId</a>; </div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span> </div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span>  <span class="keyword">private</span> $messageTag;</div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span> </div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span>  <span class="keyword">private</span> $messageContents; <span class="comment">// What we finally send out to the world</span></div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span> </div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span>  <span class="keyword">private</span> $executionStatus; <span class="comment">// false on error</span></div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span>  <span class="keyword">private</span> $diagnostics; <span class="comment">// mixed, depends on operation</span></div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span> </div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span>  <span class="keyword">private</span> $parameterService;</div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span> </div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span>  <span class="keyword">private</span> $recipientsFilter;</div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span> </div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span>  <span class="keyword">private</span> $eventsService;</div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span> </div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span>  <span class="keyword">private</span> $participantFieldsService;</div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span> </div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span>  <span class="keyword">private</span> $progressStatusService;</div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span> </div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span>  <span class="keyword">private</span> $simpleSharingService;</div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span> </div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span>  <span class="keyword">private</span> $organizationalRolesService;</div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span> </div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span>  <span class="keyword">private</span> $appStorage;</div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span> </div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span>  <span class="keyword">private</span> $userStorage;</div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span> </div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span>  <span class="keyword">private</span> $progressToken;</div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span> </div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span>  <span class="keyword">private</span> $substitutions;</div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span> </div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a3d0e19c34ee0b39d6539a29a3ff33f43">  462</a></span>  <span class="keyword">private</span> <a class="code hl_variable" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a3d0e19c34ee0b39d6539a29a3ff33f43">$templateFileAttachments</a> = <span class="keyword">null</span>;</div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span> </div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa3c2bbdf1d23258866694670e6549993">  470</a></span>  <span class="keyword">private</span> <a class="code hl_variable" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa3c2bbdf1d23258866694670e6549993">$personalFileAttachments</a> = <span class="keyword">null</span>;</div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span> </div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#af4c5ee02b3adc07ecccf22dfcd9b1108">  477</a></span>  <span class="keyword">private</span> <a class="code hl_variable" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#af4c5ee02b3adc07ecccf22dfcd9b1108">$globalFileAttachments</a> = <span class="keyword">null</span>;</div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span> </div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa250740057568420a6211021cd23db97">  485</a></span>  <span class="keyword">private</span> <a class="code hl_variable" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa250740057568420a6211021cd23db97">$implicitFileAttachments</a> = <span class="keyword">null</span>;</div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span> </div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a093a2dca4bf36d33578bf0ab620eb6fa">  488</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a093a2dca4bf36d33578bf0ab620eb6fa">__construct</a>(</div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_config_service.html">ConfigService</a> $configService,</div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_request_parameter_service.html">RequestParameterService</a> $parameterService,</div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_events_service.html">EventsService</a> $eventsService,</div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_recipients_filter.html">RecipientsFilter</a> $recipientsFilter,</div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_entity_manager.html">EntityManager</a> $entityManager,</div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_project_participant_fields_service.html">ProjectParticipantFieldsService</a> $participantFieldsService,</div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_progress_status_service.html">ProgressStatusService</a> $progressStatusService,</div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_simple_sharing_service.html">SimpleSharingService</a> $simpleSharingService,</div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_organizational_roles_service.html">OrganizationalRolesService</a> $organizationRolesService,</div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_storage_1_1_app_storage.html">AppStorage</a> $appStorage,</div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_storage_1_1_user_storage.html">UserStorage</a> $userStorage,</div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span>  ) {</div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span>    $this-&gt;configService = $configService;</div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>    $this-&gt;eventsService = $eventsService;</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span>    $this-&gt;progressStatusService = $progressStatusService;</div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span>    $this-&gt;simpleSharingService = $simpleSharingService;</div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span>    $this-&gt;organizationalRolesService = $organizationRolesService;</div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span>    $this-&gt;appStorage = $appStorage;</div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span>    $this-&gt;userStorage = $userStorage;</div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span>    $this-&gt;entityManager = $entityManager;</div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span>    $this-&gt;participantFieldsService = $participantFieldsService;</div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span>    $this-&gt;l = $this-&gt;l10N();</div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span> </div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span>    $this-&gt;constructionMode = $this-&gt;getConfigValue(<span class="stringliteral">&#39;emailtestmode&#39;</span>) !== <span class="stringliteral">&#39;off&#39;</span>;</div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span>    $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a24e7fbb14ed9dce86eee44d9f81c2e06">setCatchAll</a>();</div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span> </div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>    $this-&gt;bind($parameterService, $recipientsFilter);</div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span>  }</div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span> </div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span>  <span class="keyword">public</span> <span class="keyword">function</span> bind(</div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_request_parameter_service.html">RequestParameterService</a> $parameterService,</div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_recipients_filter.html">RecipientsFilter</a> $recipientsFilter = <span class="keyword">null</span>,</div>
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno">  531</span>  ):void {</div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span>    $this-&gt;parameterService = $parameterService;</div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span> </div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span>    <span class="keywordflow">if</span> (empty($recipientsFilter)) {</div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span>      $this-&gt;recipientsFilter-&gt;bind($parameterService);</div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span>      $this-&gt;recipientsFilter = $recipientsFilter;</div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span>    }</div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span> </div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span>    $this-&gt;recipients = $this-&gt;recipientsFilter-&gt;selectedRecipients();</div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span> </div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span>    $template = $this-&gt;parameterService[<span class="stringliteral">&#39;emailTemplate&#39;</span>];</div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span> </div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno">  544</span>    $this-&gt;cgiData = $this-&gt;parameterService-&gt;getParam(self::POST_TAG, []);</div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span> </div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span>    $this-&gt;projectId   = $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">cgiValue</a>(</div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span>      <span class="stringliteral">&#39;projectId&#39;</span>, $this-&gt;parameterService-&gt;getParam(<span class="stringliteral">&#39;projectId&#39;</span>, 0));</div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span>    $this-&gt;projectName = $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">cgiValue</a>(</div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span>      <span class="stringliteral">&#39;projectName&#39;</span>, $this-&gt;parameterService-&gt;getParam(<span class="stringliteral">&#39;projectName&#39;</span>, <span class="stringliteral">&#39;&#39;</span>));</div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span>    <span class="keywordflow">if</span> ($this-&gt;projectId &gt; 0) {</div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span>      $this-&gt;project = $this-&gt;getDatabaseRepository(Entities\Project::class)</div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span>                            -&gt;find($this-&gt;projectId);</div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span>      $this-&gt;projectName = $this-&gt;project-&gt;getName();</div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span>    }</div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span> </div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span>    $this-&gt;bulkTransactionId = $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">cgiValue</a>(</div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span>      <span class="stringliteral">&#39;bulkTransactionId&#39;</span>, $this-&gt;parameterService-&gt;getParam(<span class="stringliteral">&#39;bulkTransactionId&#39;</span>, 0));</div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span>    <span class="keywordflow">if</span> ($this-&gt;bulkTransactionId &gt; 0) {</div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span>      $this-&gt;bulkTransaction = $this</div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span>        -&gt;getDatabaseRepository(Entities\SepaBulkTransaction::class)</div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span>        -&gt;find($this-&gt;bulkTransactionId);</div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span>      <span class="keywordflow">if</span> (!empty($this-&gt;bulkTransaction)) {</div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span>        $bulkTransactionService = $this-&gt;di(SepaBulkTransactionService::class);</div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span>        $bulkTransactionService-&gt;updateBulkTransaction($this-&gt;bulkTransaction, flush: <span class="keyword">true</span>);</div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span>        <span class="keywordflow">if</span> (empty($template)) {</div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span>          $template = $bulkTransactionService-&gt;getBulkTransactionSlug($this-&gt;bulkTransaction);</div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span>          $template = $template . <span class="charliteral">&#39;-&#39;</span> . $this-&gt;l-&gt;t(<span class="stringliteral">&#39;announcement&#39;</span>);</div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span>          list($template,) = $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a28c3e766ec95a8d1201a7dc1c857b0b3">normalizeTemplateName</a>($template);</div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span>        }</div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span>        $this-&gt;paymentSign = ($this-&gt;bulkTransaction instanceof Entities\SepaDebitNote)</div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span>          ? 1.0</div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span>          : -1.0;</div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span>      }</div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span>    }</div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span> </div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno">  577</span>    <span class="keywordflow">if</span> (!empty($template)) {</div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span>      $this-&gt;cgiData[<span class="stringliteral">&#39;storedMessagesSelector&#39;</span>] = $template;</div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span>    }</div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span> </div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span>    $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad74240dcb020960b41df6447a5b0e1ff">setSubjectTag</a>();</div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span> </div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span>    <span class="comment">// First initialize defaults, will be overriden based on</span></div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span>    <span class="comment">// form-submit data in $this-&gt;execute()</span></div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span>    $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a346f94effc8c8dfea565e54bc6a27ba7">setDefaultTemplate</a>();</div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span> </div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span>    $this-&gt;draftId = $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">cgiValue</a>(<span class="stringliteral">&#39;messageDraftId&#39;</span>, 0);</div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span> </div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span>    $this-&gt;inReplyToId = $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">cgiValue</a>(<span class="stringliteral">&#39;inReplyTo&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);</div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span>    $this-&gt;referencing = $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">cgiValue</a>(<span class="stringliteral">&#39;referencing&#39;</span>, []);</div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span> </div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span>    $this-&gt;progressToken = $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">cgiValue</a>(<span class="stringliteral">&#39;progressToken&#39;</span>);</div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span> </div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span>    <span class="comment">// Set to false on error</span></div>
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno">  595</span>    $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8d6568d7a87ba2a132aa630bb5fd5f4f">executionStatus</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span> </div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span>    <span class="comment">// Error diagnostics, can be retrieved by</span></div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span>    <span class="comment">// $this-&gt;statusDiagnostics()</span></div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span>    $this-&gt;diagnostics = [</div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span>      self::DIAGNOSTICS_CAPTION =&gt; <span class="stringliteral">&#39;&#39;</span>,</div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span>      self::DIAGNOSTICS_ADDRESS_VALIDATION =&gt; [</div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span>        <span class="stringliteral">&#39;CC&#39;</span> =&gt; [],</div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span>        <span class="stringliteral">&#39;BCC&#39;</span> =&gt; [],</div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span>        <span class="stringliteral">&#39;Empty&#39;</span> =&gt; <span class="keyword">false</span>,</div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span>      ],</div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span>      self::DIAGNOSTICS_TEMPLATE_VALIDATION =&gt; [],</div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span>      <span class="stringliteral">&#39;ExternalLinkValidation&#39;</span> =&gt; [],</div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span>      self::DIAGNOSTICS_SUBJECT_VALIDATION =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span>      self::DIAGNOSTICS_FROM_VALIDATION =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span>      self::DIAGNOSTICS_ATTACHMENT_VALIDATION =&gt; [</div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span>        <span class="stringliteral">&#39;Files&#39;</span> =&gt; [],</div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span>        <span class="stringliteral">&#39;Events&#39;</span> =&gt; [],</div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span>      ],</div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span>      self::DIAGNOSTICS_FAILED_RECIPIENTS =&gt; [],</div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span>      self::DIAGNOSTICS_MAILER_EXCEPTIONS =&gt; [],</div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span>      self::DIAGNOSTICS_DUPLICATES =&gt; [],</div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span>      self::DIAGNOSTICS_COPY_TO_SENT =&gt; [], <span class="comment">// IMAP stuff</span></div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span>      self::DIAGNOSTICS_MESSAGE =&gt; [</div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span>        <span class="stringliteral">&#39;Text&#39;</span> =&gt; <span class="stringliteral">&#39;&#39;</span>,</div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span>        <span class="stringliteral">&#39;Files&#39;</span> =&gt; [],</div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span>        <span class="stringliteral">&#39;Events&#39;</span> =&gt; [],</div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span>      ],</div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span>      self::DIAGNOSTICS_SHARE_LINK_VALIDATION =&gt; [</div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span>        <span class="stringliteral">&#39;status&#39;</span> =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span>      ],</div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span>      <span class="comment">// start of sent-messages for log window</span></div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span>      self::DIAGNOSTICS_TOTAL_PAYLOAD =&gt; 0,</div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span>      self::DIAGNOSTICS_TOTAL_COUNT =&gt; 0,</div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span>      self::DIAGNOSTICS_FAILED_COUNT =&gt; 0</div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span>    ];</div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span> </div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span>    <span class="comment">// Maybe should also check something else. If submitted is true,</span></div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span>    <span class="comment">// then we use the form data, otherwise the defaults.</span></div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span>    $this-&gt;submitted = $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">cgiValue</a>(<span class="stringliteral">&#39;formStatus&#39;</span>, <span class="stringliteral">&#39;&#39;</span>) == <span class="stringliteral">&#39;submitted&#39;</span>;</div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span> </div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span>    <span class="keywordflow">if</span> (!$this-&gt;submitted) {</div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span>      <span class="comment">// Leave everything at default state, except for an optional</span></div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span>      <span class="comment">// initial template and subject</span></div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span>      $initialTemplate = $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">cgiValue</a>(<span class="stringliteral">&#39;storedMessagesSelector&#39;</span>);</div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span>      <span class="keywordflow">if</span> (!empty($initialTemplate)) {</div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span>        $template = $this-&gt;fetchTemplate($initialTemplate, exact: <span class="keyword">false</span>);</div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span>        <span class="keywordflow">if</span> (empty($template)) {</div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span>          $template = $this-&gt;fetchTemplate($this-&gt;l-&gt;t(<span class="stringliteral">&#39;ExampleFormletter&#39;</span>), exact: <span class="keyword">false</span>);</div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span>        }</div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span>        $loadedTag = $template-&gt;getTag();</div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span>        <span class="keywordflow">if</span> (empty($this-&gt;bulkTransaction) || str_ends_with($loadedTag, $initialTemplate)) {</div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span>          $initialTemplate = $template-&gt;getTag();</div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span>          $this-&gt;cgiData[<span class="stringliteral">&#39;storedMessagesSelector&#39;</span>] = $initialTemplate;</div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span>          $this-&gt;templateName = $initialTemplate;</div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span>          $this-&gt;templateName = $initialTemplate;</div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span>        }</div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span>        <span class="keywordflow">if</span> (!empty($template)) {</div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span>          $this-&gt;messageContents = $template-&gt;getContents();</div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span>          $this-&gt;cgiData[<span class="stringliteral">&#39;subject&#39;</span>] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Unknown Template&#39;</span>);</div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span>        }</div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span>      }</div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span>      $this-&gt;messageContents = $this-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">cgiValue</a>(<span class="stringliteral">&#39;messageText&#39;</span>, $this-&gt;initialTemplate);</div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span>    }</div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span> </div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span>    <span class="comment">// sanitze the message contents here</span></div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span>    $this-&gt;messageContents = $this-&gt;sanitizeMessageHtml($this-&gt;messageContents);</div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span>  }</div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span> </div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a64e84fa7a7176cd87fe8fa9818aae4d7">  672</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a64e84fa7a7176cd87fe8fa9818aae4d7">getRecipientsFilter</a>():<a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_recipients_filter.html">RecipientsFilter</a></div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span>  {</div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span>    <span class="keywordflow">return</span> $this-&gt;recipientsFilter;</div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span>  }</div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span> </div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">  686</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">cgiValue</a>(<span class="keywordtype">string</span> $key, $default = <span class="keyword">null</span>)</div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span>  {</div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span>    <span class="keywordflow">if</span> (isset($this-&gt;cgiData[$key])) {</div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span>      $value = $this-&gt;cgiData[$key];</div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span>      <span class="keywordflow">if</span> (is_string($value)) {</div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span>        $value = Util::normalizeSpaces($value);</div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span>      }</div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span>      <span class="keywordflow">return</span> $value;</div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span>      <span class="keywordflow">return</span> $default;</div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span>    }</div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span>  }</div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span> </div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span>  <span class="keyword">private</span> <span class="keyword">function</span> generateSubstitutionHandlers():void</div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span>  {</div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span>    $this-&gt;generateGlobalSubstitutionHandlers();</div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span> </div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span>    <span class="keywordflow">foreach</span> (self::MEMBER_VARIABLES as $key) {</div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][$key] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) use ($key) {</div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span>        $field = Util::dashesToCamelCase(strtolower($key), <span class="keyword">false</span>, <span class="charliteral">&#39;_&#39;</span>);</div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span>        <span class="keywordflow">if</span> (empty($musician) || !isset($musician[$field])) {</div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span>        }</div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno">  716</span>        <span class="keywordflow">return</span> $musician[$field];</div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span>      };</div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span>    }</div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span> </div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span>    $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;STREET_AND_NUMBER&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span>      <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno">  722</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span>      }</div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span>      <span class="comment">// maybe some day formatted according to locale</span></div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span>      <span class="keywordflow">return</span> $musician-&gt;getStreet() . <span class="charliteral">&#39; &#39;</span> . $musician-&gt;getStreetNumber();</div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span>    };</div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span> </div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span>    $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;EMAIL&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span>      <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span>      }</div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>      <span class="keywordflow">return</span> $musician-&gt;getEmail();</div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span>    };</div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span> </div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span>    $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;NICK_NAME&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span>      <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span>      }</div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span>      <span class="keywordflow">return</span> $musician-&gt;getNickName()?:$musician-&gt;getFirstName();</div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span>    };</div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span> </div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span>    $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;DISPLAY_NAME&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span>      <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span>      }</div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span>      <span class="keywordflow">return</span> $musician-&gt;getPublicName(<span class="keyword">true</span>); <span class="comment">// rather firstName lastName than last, first</span></div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span>    };</div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span> </div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span>    $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;COUNTRY&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno">  750</span>      <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span>      }</div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span>      $country = $musician-&gt;getCountry();</div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span>      <span class="keywordflow">if</span> (empty($country)) {</div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span>        <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span>      }</div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span>      $language = substr($this-&gt;l-&gt;getLocaleCode(), 0, 2);</div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span>      $locale = $language.<span class="charliteral">&#39;_&#39;</span>.$country;</div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span>      <span class="keywordflow">return</span> locale_get_display_region($locale, $language);</div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span>    };</div>
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno">  761</span> </div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno">  762</span>    $languageNames = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a4c1dc0e4e1b0686a92c0f6486e91b7c6">localeLanguageNames</a>();</div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span>    $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;LANGUAGE&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) use ($languageNames) {</div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span>      <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span>      }</div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span>      $language = $musician[<span class="stringliteral">&#39;language&#39;</span>];</div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span>      <span class="keywordflow">if</span> (empty($language)) {</div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span>        <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span>      }</div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span>      <span class="keywordflow">return</span> $languageNames[$language] ?? $language;</div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span>    };</div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span> </div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span>    $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;BIRTHDAY&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span>      <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno">  776</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span>      }</div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span>      $date = $musician-&gt;getBirthday();</div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span>      <span class="keywordflow">if</span> (empty($date)) {</div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span>        <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span>      }</div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span>      $result = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a010c9c0626aa3587f7062ffbcc9ff64e">formatDate</a>($date, $keyArg[1]??<span class="stringliteral">&#39;full&#39;</span>);</div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span> </div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span>      <span class="keywordflow">return</span> $result;</div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span>    };</div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span> </div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span>    $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;DATE&#39;</span>] =  <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span>      <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span>      }</div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span>      <span class="keywordflow">return</span> $this-&gt;dateSubstitution($keyArg, self::MEMBER_NAMESPACE, $musician);</div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span>    };</div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno">  793</span> </div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span>    <span class="keywordflow">if</span> (!empty($this-&gt;project)) {</div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span> </div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;TOTAL_FEES&#39;</span>] =  <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span>        <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span>        }</div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span>        $obligations = ProjectParticipantFieldsService::participantMonetaryObligations($musician, $this-&gt;project);</div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aaeb05cf94149de0821a30628a8c7bcef">moneyValue</a>($obligations[<span class="stringliteral">&#39;sum&#39;</span>]);</div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span>      };</div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span> </div>
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno">  804</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;AMOUNT_PAID&#39;</span>] =  <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span>        <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span>        }</div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span>        $obligations = ProjectParticipantFieldsService::participantMonetaryObligations($musician, $this-&gt;project);</div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aaeb05cf94149de0821a30628a8c7bcef">moneyValue</a>($obligations[<span class="stringliteral">&#39;received&#39;</span>]);</div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span>      };</div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span> </div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;MISSING_AMOUNT&#39;</span>] =  <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span>        <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span>        }</div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span>        $obligations = ProjectParticipantFieldsService::participantMonetaryObligations($musician, $this-&gt;project);</div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aaeb05cf94149de0821a30628a8c7bcef">moneyValue</a>($obligations[<span class="stringliteral">&#39;sum&#39;</span>] - $obligations[<span class="stringliteral">&#39;received&#39;</span>]);</div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno">  818</span>      };</div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span> </div>
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno">  820</span>      <span class="comment">// per-participant project-data</span></div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;PROJECT_DATA&#39;</span>] =  <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span> </div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span>        <span class="keywordflow">if</span> (empty($musician) || <a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a8e12ef5cafdab7b950132867526d1113">count</a>($keyArg) &gt; 2) {</div>
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno">  824</span>          <span class="keywordflow">return</span> implode(<span class="charliteral">&#39;:&#39;</span>, $keyArg);</div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span>        }</div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span> </div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span>        $projectParticipant = $musician-&gt;getProjectParticipantOf($this-&gt;project);</div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span> </div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span>        <a class="code hl_variable" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_page_renderer_1_1_field_traits.html#a6f53acf3fbee704d2b47e98751896711">$participantFields</a> = $this-&gt;project-&gt;getParticipantFields();</div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span>        $fieldsByType = [</div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span>          <span class="stringliteral">&#39;monetary&#39;</span> =&gt; <a class="code hl_variable" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_page_renderer_1_1_field_traits.html#a6f53acf3fbee704d2b47e98751896711">$participantFields</a>-&gt;filter(<span class="keyword">function</span>($field) {</div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span>            <span class="keywordflow">switch</span> ($field-&gt;getDataType()) {</div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span>              case FieldType::RECEIVABLES:</div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span>              case FieldType::LIABILITIES:</div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span>                return true;</div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span>              default:</div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span>                return false;</div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span>            }</div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span>          }),</div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span>          <span class="stringliteral">&#39;deposit&#39;</span> =&gt; <a class="code hl_variable" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_page_renderer_1_1_field_traits.html#a6f53acf3fbee704d2b47e98751896711">$participantFields</a>-&gt;filter(<span class="keyword">function</span>($field) {</div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span>            if (empty($field-&gt;getDepositDueDate())) {</div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span>              return false;</div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span>            }</div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span>            switch ($field-&gt;getDataType()) {</div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span>              case FieldType::RECEIVABLES:</div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span>              case FieldType::LIABILITIES:</div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span>                return true;</div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span>              default:</div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span>                return false;</div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span>            }</div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span>          }),</div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno">  855</span>          <span class="stringliteral">&#39;files&#39;</span> =&gt; <a class="code hl_variable" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_page_renderer_1_1_field_traits.html#a6f53acf3fbee704d2b47e98751896711">$participantFields</a>-&gt;filter(<span class="keyword">function</span>($field) {</div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span>            return ($field-&gt;getDataType() == FieldType::CLOUD_FILE</div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span>                    || $field-&gt;getDataType() == FieldType::DB_FILE</div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span>                    || $field-&gt;getDataType() == FieldType::CLOUD_FOLDER);</div>
<div class="line"><a id="l00860" name="l00860"></a><span class="lineno">  860</span>          }),</div>
<div class="line"><a id="l00861" name="l00861"></a><span class="lineno">  861</span>          <span class="stringliteral">&#39;other&#39;</span> =&gt; <a class="code hl_variable" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_page_renderer_1_1_field_traits.html#a6f53acf3fbee704d2b47e98751896711">$participantFields</a>-&gt;filter(<span class="keyword">function</span>($field) {</div>
<div class="line"><a id="l00863" name="l00863"></a><span class="lineno">  863</span>            <span class="keywordflow">return</span> ($field-&gt;getDataType() != FieldType::RECEIVABLES</div>
<div class="line"><a id="l00864" name="l00864"></a><span class="lineno">  864</span>                    &amp;&amp; $field-&gt;getDataType() != FieldType::LIABILITIES</div>
<div class="line"><a id="l00865" name="l00865"></a><span class="lineno">  865</span>                    &amp;&amp; $field-&gt;getDataType() != FieldType::CLOUD_FILE</div>
<div class="line"><a id="l00866" name="l00866"></a><span class="lineno">  866</span>                    &amp;&amp; $field-&gt;getDataType() != FieldType::DB_FILE</div>
<div class="line"><a id="l00867" name="l00867"></a><span class="lineno">  867</span>                    &amp;&amp; $field-&gt;getDataType() != FieldType::CLOUD_FOLDER);</div>
<div class="line"><a id="l00868" name="l00868"></a><span class="lineno">  868</span>          }),</div>
<div class="line"><a id="l00869" name="l00869"></a><span class="lineno">  869</span>        ];</div>
<div class="line"><a id="l00870" name="l00870"></a><span class="lineno">  870</span> </div>
<div class="line"><a id="l00871" name="l00871"></a><span class="lineno">  871</span>        $doSpecificField = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00872" name="l00872"></a><span class="lineno">  872</span>        $doSpecificType = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00873" name="l00873"></a><span class="lineno">  873</span> </div>
<div class="line"><a id="l00874" name="l00874"></a><span class="lineno">  874</span>        <span class="keywordflow">if</span> (<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a8e12ef5cafdab7b950132867526d1113">count</a>($keyArg) == 2) {</div>
<div class="line"><a id="l00875" name="l00875"></a><span class="lineno">  875</span>          $found = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00876" name="l00876"></a><span class="lineno">  876</span>          $selector = strtolower($keyArg[1]);</div>
<div class="line"><a id="l00877" name="l00877"></a><span class="lineno">  877</span> </div>
<div class="line"><a id="l00878" name="l00878"></a><span class="lineno">  878</span>          $specificField = <a class="code hl_variable" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_page_renderer_1_1_field_traits.html#a6f53acf3fbee704d2b47e98751896711">$participantFields</a>-&gt;filter(<span class="keyword">function</span>($field) use ($selector) {</div>
<div class="line"><a id="l00880" name="l00880"></a><span class="lineno">  880</span>            <span class="keywordflow">return</span> strtolower($field-&gt;getName()) == $selector;</div>
<div class="line"><a id="l00881" name="l00881"></a><span class="lineno">  881</span>          });</div>
<div class="line"><a id="l00882" name="l00882"></a><span class="lineno">  882</span>          <span class="keywordflow">if</span> ($specificField-&gt;count() == 1) {</div>
<div class="line"><a id="l00883" name="l00883"></a><span class="lineno">  883</span>            $doSpecificField = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00884" name="l00884"></a><span class="lineno">  884</span>            $found = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00885" name="l00885"></a><span class="lineno">  885</span>            <span class="keywordflow">switch</span> ($specificField-&gt;first()-&gt;getDataType()) {</div>
<div class="line"><a id="l00886" name="l00886"></a><span class="lineno">  886</span>              <span class="keywordflow">case</span> FieldType::RECEIVABLES:</div>
<div class="line"><a id="l00887" name="l00887"></a><span class="lineno">  887</span>              <span class="keywordflow">case</span> FieldType::LIABILITIES:</div>
<div class="line"><a id="l00888" name="l00888"></a><span class="lineno">  888</span>                $fieldsByType = [<span class="stringliteral">&#39;monetary&#39;</span> =&gt; $specificField ];</div>
<div class="line"><a id="l00889" name="l00889"></a><span class="lineno">  889</span>                <span class="keywordflow">if</span> (!empty($specificField-&gt;first()-&gt;getDepositDueDate())) {</div>
<div class="line"><a id="l00890" name="l00890"></a><span class="lineno">  890</span>                  $fieldsByType[<span class="stringliteral">&#39;deposit&#39;</span>] = $specificField;</div>
<div class="line"><a id="l00891" name="l00891"></a><span class="lineno">  891</span>                }</div>
<div class="line"><a id="l00892" name="l00892"></a><span class="lineno">  892</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00893" name="l00893"></a><span class="lineno">  893</span>              <span class="keywordflow">case</span> FieldType::CLOUD_FILE:</div>
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno">  894</span>              <span class="keywordflow">case</span> FieldType::DB_FILE:</div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span>                $fieldsByType = [ <span class="stringliteral">&#39;file&#39;</span> =&gt; $specificField ];</div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span>              <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno">  898</span>                $fieldsByType = [ <span class="stringliteral">&#39;other&#39;</span> =&gt; $specificField ];</div>
<div class="line"><a id="l00899" name="l00899"></a><span class="lineno">  899</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00900" name="l00900"></a><span class="lineno">  900</span>            }</div>
<div class="line"><a id="l00901" name="l00901"></a><span class="lineno">  901</span>          } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00902" name="l00902"></a><span class="lineno">  902</span>            <span class="keywordflow">foreach</span> (array_keys($fieldsByType) as $type) {</div>
<div class="line"><a id="l00903" name="l00903"></a><span class="lineno">  903</span>              $variants = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a38cf04b2bc83979fbc0084250dd7a772">translationVariants</a>($type);</div>
<div class="line"><a id="l00904" name="l00904"></a><span class="lineno">  904</span>              <span class="keywordflow">if</span> (array_search($selector, $variants) !== <span class="keyword">false</span>) {</div>
<div class="line"><a id="l00905" name="l00905"></a><span class="lineno">  905</span>                $fieldsByType = [ $type =&gt; $fieldsByType[$type] ];</div>
<div class="line"><a id="l00906" name="l00906"></a><span class="lineno">  906</span>                $doSpecificType = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00907" name="l00907"></a><span class="lineno">  907</span>                $found = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00908" name="l00908"></a><span class="lineno">  908</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00909" name="l00909"></a><span class="lineno">  909</span>              }</div>
<div class="line"><a id="l00910" name="l00910"></a><span class="lineno">  910</span>            }</div>
<div class="line"><a id="l00911" name="l00911"></a><span class="lineno">  911</span>          }</div>
<div class="line"><a id="l00912" name="l00912"></a><span class="lineno">  912</span>          <span class="keywordflow">if</span> (!$found) {</div>
<div class="line"><a id="l00913" name="l00913"></a><span class="lineno">  913</span>            <span class="keywordflow">return</span> $keyArg[0] . <span class="charliteral">&#39;:&#39;</span> . $keyArg[1];</div>
<div class="line"><a id="l00914" name="l00914"></a><span class="lineno">  914</span>          }</div>
<div class="line"><a id="l00915" name="l00915"></a><span class="lineno">  915</span>        }</div>
<div class="line"><a id="l00916" name="l00916"></a><span class="lineno">  916</span> </div>
<div class="line"><a id="l00917" name="l00917"></a><span class="lineno">  917</span>        $html = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l00918" name="l00918"></a><span class="lineno">  918</span>        <span class="keywordflow">foreach</span> ($fieldsByType as $type =&gt; $fields) {</div>
<div class="line"><a id="l00919" name="l00919"></a><span class="lineno">  919</span> </div>
<div class="line"><a id="l00920" name="l00920"></a><span class="lineno">  920</span>          <span class="comment">// add implicit file attachments</span></div>
<div class="line"><a id="l00921" name="l00921"></a><span class="lineno">  921</span>          <span class="keywordflow">foreach</span> ($fields as $field) {</div>
<div class="line"><a id="l00922" name="l00922"></a><span class="lineno">  922</span>            <span class="keywordflow">switch</span> ($field-&gt;getDataType()) {</div>
<div class="line"><a id="l00923" name="l00923"></a><span class="lineno">  923</span>              <span class="keywordflow">case</span> FieldType::RECEIVABLES:</div>
<div class="line"><a id="l00924" name="l00924"></a><span class="lineno">  924</span>              <span class="keywordflow">case</span> FieldType::LIABILITIES:</div>
<div class="line"><a id="l00925" name="l00925"></a><span class="lineno">  925</span>              <span class="keywordflow">case</span> FieldType::CLOUD_FILE:</div>
<div class="line"><a id="l00926" name="l00926"></a><span class="lineno">  926</span>              <span class="keywordflow">case</span> FieldType::DB_FILE:</div>
<div class="line"><a id="l00927" name="l00927"></a><span class="lineno">  927</span>              <span class="keywordflow">case</span> FieldType::CLOUD_FOLDER:</div>
<div class="line"><a id="l00928" name="l00928"></a><span class="lineno">  928</span>                $this-&gt;implicitFileAttachments[] = <span class="stringliteral">&#39;participant-field&#39;</span> . <span class="charliteral">&#39;:&#39;</span> . $field-&gt;getId();</div>
<div class="line"><a id="l00929" name="l00929"></a><span class="lineno">  929</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00930" name="l00930"></a><span class="lineno">  930</span>            }</div>
<div class="line"><a id="l00931" name="l00931"></a><span class="lineno">  931</span>          }</div>
<div class="line"><a id="l00932" name="l00932"></a><span class="lineno">  932</span> </div>
<div class="line"><a id="l00933" name="l00933"></a><span class="lineno">  933</span>          $numberOfFields = $fields-&gt;count();</div>
<div class="line"><a id="l00934" name="l00934"></a><span class="lineno">  934</span> </div>
<div class="line"><a id="l00935" name="l00935"></a><span class="lineno">  935</span>          <span class="comment">// First output the simple options, then the ones with multiple</span></div>
<div class="line"><a id="l00936" name="l00936"></a><span class="lineno">  936</span>          <span class="comment">// options. Also sort by name.</span></div>
<div class="line"><a id="l00937" name="l00937"></a><span class="lineno">  937</span>          $fieldsByMultiplicity = [</div>
<div class="line"><a id="l00938" name="l00938"></a><span class="lineno">  938</span>            <span class="comment">// only one possible option</span></div>
<div class="line"><a id="l00939" name="l00939"></a><span class="lineno">  939</span>            <span class="stringliteral">&#39;single&#39;</span> =&gt; (<span class="keyword">function</span>($fields) {</div>
<div class="line"><a id="l00940" name="l00940"></a><span class="lineno">  940</span>              $fieldArray = $fields-&gt;filter(<span class="keyword">function</span>($field) {</div>
<div class="line"><a id="l00942" name="l00942"></a><span class="lineno">  942</span>                <span class="keywordflow">return</span> ($field-&gt;getMultiplicity() == FieldMultiplicity::SIMPLE</div>
<div class="line"><a id="l00943" name="l00943"></a><span class="lineno">  943</span>                        || $field-&gt;getMultiplicity() == FieldMultiplicity::SINGLE</div>
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno">  944</span>                        || $field-&gt;getMultiplicity() == FieldMultiplicity::GROUPOFPEOPLE);</div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span>              })-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_traits.html#a658defb34762c8f40085aec87e16ba1a">toArray</a>();</div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span>              usort($fieldArray, <span class="keyword">function</span>($a, $b) {</div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span>                <span class="keywordflow">return</span> strcmp($a-&gt;getName(), $b-&gt;getName());</div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span>              });</div>
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno">  949</span>              <span class="keywordflow">return</span> $fieldArray;</div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span>            })($fields),</div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span>            <span class="comment">// possibly multiple options</span></div>
<div class="line"><a id="l00952" name="l00952"></a><span class="lineno">  952</span>            <span class="stringliteral">&#39;multiple&#39;</span> =&gt; (<span class="keyword">function</span>($fields) {</div>
<div class="line"><a id="l00953" name="l00953"></a><span class="lineno">  953</span>              $fieldArray = $fields-&gt;filter(<span class="keyword">function</span>($field) {</div>
<div class="line"><a id="l00955" name="l00955"></a><span class="lineno">  955</span>                <span class="keywordflow">return</span> ($field-&gt;getMultiplicity() == FieldMultiplicity::MULTIPLE</div>
<div class="line"><a id="l00956" name="l00956"></a><span class="lineno">  956</span>                        || $field-&gt;getMultiplicity() == FieldMultiplicity::PARALLEL</div>
<div class="line"><a id="l00957" name="l00957"></a><span class="lineno">  957</span>                        || $field-&gt;getMultiplicity() == FieldMultiplicity::RECURRING</div>
<div class="line"><a id="l00958" name="l00958"></a><span class="lineno">  958</span>                        || $field-&gt;getMultiplicity() == FieldMultiplicity::GROUPSOFPEOPLE);</div>
<div class="line"><a id="l00959" name="l00959"></a><span class="lineno">  959</span>              })-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_traits.html#a658defb34762c8f40085aec87e16ba1a">toArray</a>();</div>
<div class="line"><a id="l00960" name="l00960"></a><span class="lineno">  960</span>              usort($fieldArray, <span class="keyword">function</span>($a, $b) {</div>
<div class="line"><a id="l00961" name="l00961"></a><span class="lineno">  961</span>                <span class="keywordflow">return</span> strcmp($a-&gt;getName(), $b-&gt;getName());</div>
<div class="line"><a id="l00962" name="l00962"></a><span class="lineno">  962</span>              });</div>
<div class="line"><a id="l00963" name="l00963"></a><span class="lineno">  963</span>              <span class="keywordflow">return</span> $fieldArray;</div>
<div class="line"><a id="l00964" name="l00964"></a><span class="lineno">  964</span>            })($fields),</div>
<div class="line"><a id="l00965" name="l00965"></a><span class="lineno">  965</span>          ];</div>
<div class="line"><a id="l00966" name="l00966"></a><span class="lineno">  966</span> </div>
<div class="line"><a id="l00967" name="l00967"></a><span class="lineno">  967</span>          <span class="comment">// PLAN: table for monetary fields, perhaps file-downloads for file fields.</span></div>
<div class="line"><a id="l00968" name="l00968"></a><span class="lineno">  968</span> </div>
<div class="line"><a id="l00970" name="l00970"></a><span class="lineno">  970</span>          $formatter = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a3a2983317152273aaf635e4bd61f0c7a">appContainer</a>()-&gt;get(IDateTimeFormatter::class);</div>
<div class="line"><a id="l00971" name="l00971"></a><span class="lineno">  971</span> </div>
<div class="line"><a id="l00972" name="l00972"></a><span class="lineno">  972</span>          <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;files&#39;</span> || $type == <span class="stringliteral">&#39;other&#39;</span>) {</div>
<div class="line"><a id="l00973" name="l00973"></a><span class="lineno">  973</span>            $html .= <span class="stringliteral">&#39;&lt;ul class=&quot;participant-fields&quot;&gt;&#39;</span>;</div>
<div class="line"><a id="l00974" name="l00974"></a><span class="lineno">  974</span> </div>
<div class="line"><a id="l00976" name="l00976"></a><span class="lineno">  976</span>            <span class="keywordflow">foreach</span> ($fieldsByMultiplicity as $multiplicity =&gt; $fields) {</div>
<div class="line"><a id="l00977" name="l00977"></a><span class="lineno">  977</span>              <span class="keywordflow">foreach</span> ($fields as $field) {</div>
<div class="line"><a id="l00979" name="l00979"></a><span class="lineno">  979</span>                $fieldOptions = $field-&gt;getSelectableOptions();</div>
<div class="line"><a id="l00980" name="l00980"></a><span class="lineno">  980</span>                <span class="keywordflow">if</span> ($multiplicity == <span class="stringliteral">&#39;single&#39;</span>) {</div>
<div class="line"><a id="l00981" name="l00981"></a><span class="lineno">  981</span>                  $fieldOption = $fieldOptions-&gt;first();</div>
<div class="line"><a id="l00982" name="l00982"></a><span class="lineno">  982</span>                  $fieldValue = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l00983" name="l00983"></a><span class="lineno">  983</span>                  <span class="keywordflow">if</span> (!empty($fieldOption)) {</div>
<div class="line"><a id="l00984" name="l00984"></a><span class="lineno">  984</span>                    $fieldDatum = $projectParticipant-&gt;getParticipantFieldsDatum($fieldOption-&gt;getKey());</div>
<div class="line"><a id="l00985" name="l00985"></a><span class="lineno">  985</span>                    $fieldValue = $this-&gt;participantFieldsService-&gt;printEffectiveFieldDatum($fieldDatum);</div>
<div class="line"><a id="l00986" name="l00986"></a><span class="lineno">  986</span>                  }</div>
<div class="line"><a id="l00987" name="l00987"></a><span class="lineno">  987</span>                  $html .= <span class="stringliteral">&#39;&lt;li&gt;&#39;</span></div>
<div class="line"><a id="l00988" name="l00988"></a><span class="lineno">  988</span>                    . $field-&gt;getName()</div>
<div class="line"><a id="l00989" name="l00989"></a><span class="lineno">  989</span>                    . <span class="stringliteral">&#39;: &#39;</span></div>
<div class="line"><a id="l00990" name="l00990"></a><span class="lineno">  990</span>                    . $fieldValue</div>
<div class="line"><a id="l00991" name="l00991"></a><span class="lineno">  991</span>                    . <span class="stringliteral">&#39;&lt;/li&gt;&#39;</span>;</div>
<div class="line"><a id="l00992" name="l00992"></a><span class="lineno">  992</span>                } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00993" name="l00993"></a><span class="lineno">  993</span>                  $html .= <span class="stringliteral">&#39;&lt;li&gt;&#39;</span> . $field-&gt;getName() . <span class="stringliteral">&#39;&lt;ul&gt;&#39;</span>;</div>
<div class="line"><a id="l00994" name="l00994"></a><span class="lineno">  994</span>                  <span class="keywordflow">foreach</span> ($fieldOptions as $fieldOption) {</div>
<div class="line"><a id="l00995" name="l00995"></a><span class="lineno">  995</span>                    $fieldValue = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l00996" name="l00996"></a><span class="lineno">  996</span>                    <span class="keywordflow">if</span> (!empty($fieldOption)) {</div>
<div class="line"><a id="l00997" name="l00997"></a><span class="lineno">  997</span>                      $fieldDatum = $projectParticipant-&gt;getParticipantFieldsDatum($fieldOption-&gt;getKey());</div>
<div class="line"><a id="l00998" name="l00998"></a><span class="lineno">  998</span>                      $fieldValue = $this-&gt;participantFieldsService-&gt;printEffectiveFieldDatum($fieldDatum);</div>
<div class="line"><a id="l00999" name="l00999"></a><span class="lineno">  999</span>                    }</div>
<div class="line"><a id="l01000" name="l01000"></a><span class="lineno"> 1000</span>                    <span class="keywordflow">if</span> (empty($fieldValue)) {</div>
<div class="line"><a id="l01001" name="l01001"></a><span class="lineno"> 1001</span>                      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"> 1002</span>                    }</div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span>                    $html .= <span class="stringliteral">&#39;&lt;li&gt;&#39;</span></div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span>                      . $fieldValue</div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"> 1005</span>                      . <span class="stringliteral">&#39;&lt;/li&gt;&#39;</span>;</div>
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"> 1006</span>                  }</div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span>                  $html .= <span class="stringliteral">&#39;&lt;/ul&gt;&lt;/li&gt;&#39;</span>;</div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span>                }</div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span>              }</div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span>            }</div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span>            $html .= <span class="stringliteral">&#39;&lt;/ul&gt;&#39;</span>;</div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span>          } elseif ($type == <span class="stringliteral">&#39;monetary&#39;</span> || $type == <span class="stringliteral">&#39;deposit&#39;</span>) {</div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span> </div>
<div class="line"><a id="l01014" name="l01014"></a><span class="lineno"> 1014</span>            $headerReplacements = [</div>
<div class="line"><a id="l01015" name="l01015"></a><span class="lineno"> 1015</span>              <span class="stringliteral">&#39;option&#39;</span> =&gt; $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Option&#39;</span>),</div>
<div class="line"><a id="l01016" name="l01016"></a><span class="lineno"> 1016</span>              <span class="stringliteral">&#39;totals&#39;</span> =&gt; $type == <span class="stringliteral">&#39;monetary&#39;</span> ? $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Total Amount&#39;</span>) : $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Deposit&#39;</span>),</div>
<div class="line"><a id="l01017" name="l01017"></a><span class="lineno"> 1017</span>              <span class="stringliteral">&#39;received&#39;</span> =&gt; $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Received&#39;</span>),</div>
<div class="line"><a id="l01018" name="l01018"></a><span class="lineno"> 1018</span>              <span class="stringliteral">&#39;remaining&#39;</span> =&gt; $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Remaining&#39;</span>),</div>
<div class="line"><a id="l01019" name="l01019"></a><span class="lineno"> 1019</span>              <span class="stringliteral">&#39;dueDate&#39;</span> =&gt; $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Due Date&#39;</span>),</div>
<div class="line"><a id="l01020" name="l01020"></a><span class="lineno"> 1020</span>            ];</div>
<div class="line"><a id="l01021" name="l01021"></a><span class="lineno"> 1021</span>            $replacementKeys = array_keys($headerReplacements);</div>
<div class="line"><a id="l01022" name="l01022"></a><span class="lineno"> 1022</span>            $header = self::DEFAULT_HTML_TEMPLATES[<span class="stringliteral">&#39;monetary-fields&#39;</span>][<span class="stringliteral">&#39;header&#39;</span>];</div>
<div class="line"><a id="l01023" name="l01023"></a><span class="lineno"> 1023</span>            <span class="keywordflow">foreach</span> ($headerReplacements as $key =&gt; $replacement) {</div>
<div class="line"><a id="l01024" name="l01024"></a><span class="lineno"> 1024</span>              $keyVariants = array_map(</div>
<div class="line"><a id="l01025" name="l01025"></a><span class="lineno"> 1025</span>                fn($key) =&gt; <span class="charliteral">&#39;[&#39;</span>.$key.<span class="charliteral">&#39;]&#39;</span>,</div>
<div class="line"><a id="l01026" name="l01026"></a><span class="lineno"> 1026</span>                $this-&gt;translationVariants($key)</div>
<div class="line"><a id="l01027" name="l01027"></a><span class="lineno"> 1027</span>              );</div>
<div class="line"><a id="l01028" name="l01028"></a><span class="lineno"> 1028</span>              $header = str_ireplace($keyVariants, $replacement, $header);</div>
<div class="line"><a id="l01029" name="l01029"></a><span class="lineno"> 1029</span>            }</div>
<div class="line"><a id="l01030" name="l01030"></a><span class="lineno"> 1030</span>            $cssClass = implode(<span class="charliteral">&#39; &#39;</span>, [</div>
<div class="line"><a id="l01031" name="l01031"></a><span class="lineno"> 1031</span>              self::PARTICIPANT_MONETARY_FIELDS_CSS_CLASS[<span class="stringliteral">&#39;header&#39;</span>],</div>
<div class="line"><a id="l01032" name="l01032"></a><span class="lineno"> 1032</span>              <span class="stringliteral">&#39;number-of-fields-&#39;</span>.$numberOfFields,</div>
<div class="line"><a id="l01033" name="l01033"></a><span class="lineno"> 1033</span>            ]);</div>
<div class="line"><a id="l01034" name="l01034"></a><span class="lineno"> 1034</span>            $header = str_replace(<span class="stringliteral">&#39;[CSSCLASS]&#39;</span>, $cssClass, $header);</div>
<div class="line"><a id="l01035" name="l01035"></a><span class="lineno"> 1035</span>            $html .= <span class="comment">/* self::DEFAULT_PARTICIPANT_MONETARY_FIELDS_STYLE . */</span> $header;</div>
<div class="line"><a id="l01036" name="l01036"></a><span class="lineno"> 1036</span> </div>
<div class="line"><a id="l01037" name="l01037"></a><span class="lineno"> 1037</span>            $totalSum = array_fill_keys($replacementKeys, 0.0);</div>
<div class="line"><a id="l01038" name="l01038"></a><span class="lineno"> 1038</span>            $totalSum[<span class="stringliteral">&#39;label&#39;</span>] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Total Amount&#39;</span>);</div>
<div class="line"><a id="l01039" name="l01039"></a><span class="lineno"> 1039</span>            $totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>] = <span class="keyword">null</span>;</div>
<div class="line"><a id="l01040" name="l01040"></a><span class="lineno"> 1040</span> </div>
<div class="line"><a id="l01041" name="l01041"></a><span class="lineno"> 1041</span>            $totalNumberOfOptions = 0;</div>
<div class="line"><a id="l01042" name="l01042"></a><span class="lineno"> 1042</span>            <span class="keywordflow">foreach</span> ($fieldsByMultiplicity as $multiplicity =&gt; $fields) {</div>
<div class="line"><a id="l01043" name="l01043"></a><span class="lineno"> 1043</span> </div>
<div class="line"><a id="l01045" name="l01045"></a><span class="lineno"> 1045</span>              <span class="keywordflow">foreach</span> ($fields as $field) {</div>
<div class="line"><a id="l01046" name="l01046"></a><span class="lineno"> 1046</span> </div>
<div class="line"><a id="l01047" name="l01047"></a><span class="lineno"> 1047</span>                $fieldHasNonZeroData = <span class="keyword">false</span>;</div>
<div class="line"><a id="l01048" name="l01048"></a><span class="lineno"> 1048</span>                $fieldHtml = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l01049" name="l01049"></a><span class="lineno"> 1049</span> </div>
<div class="line"><a id="l01050" name="l01050"></a><span class="lineno"> 1050</span>                <span class="keywordflow">if</span> ($field-&gt;getMultiplicity() == FieldMultiplicity::RECURRING) {</div>
<div class="line"><a id="l01052" name="l01052"></a><span class="lineno"> 1052</span>                  $receivablesGenerator = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(ReceivablesGeneratorFactory::class)-&gt;getGenerator($field);</div>
<div class="line"><a id="l01053" name="l01053"></a><span class="lineno"> 1053</span>                  $dueDate = $receivablesGenerator-&gt;dueDate();</div>
<div class="line"><a id="l01054" name="l01054"></a><span class="lineno"> 1054</span>                } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01055" name="l01055"></a><span class="lineno"> 1055</span>                  $dueDate = $type == <span class="stringliteral">&#39;monetary&#39;</span> ? $field-&gt;getDueDate() : $field-&gt;getDepositDueDate();</div>
<div class="line"><a id="l01056" name="l01056"></a><span class="lineno"> 1056</span>                }</div>
<div class="line"><a id="l01057" name="l01057"></a><span class="lineno"> 1057</span>                <span class="keywordflow">if</span> (!empty($dueDate)) {</div>
<div class="line"><a id="l01058" name="l01058"></a><span class="lineno"> 1058</span>                  $formattedDueDate = $dueDate</div>
<div class="line"><a id="l01059" name="l01059"></a><span class="lineno"> 1059</span>                           ? $formatter-&gt;formatDate($dueDate, <span class="stringliteral">&#39;medium&#39;</span>)</div>
<div class="line"><a id="l01060" name="l01060"></a><span class="lineno"> 1060</span>                           : <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l01061" name="l01061"></a><span class="lineno"> 1061</span>                }</div>
<div class="line"><a id="l01062" name="l01062"></a><span class="lineno"> 1062</span> </div>
<div class="line"><a id="l01063" name="l01063"></a><span class="lineno"> 1063</span>                $numberOfOptions = $field-&gt;getSelectableOptions()-&gt;count();</div>
<div class="line"><a id="l01064" name="l01064"></a><span class="lineno"> 1064</span>                $totalNumberOfOptions += $numberOfOptions;</div>
<div class="line"><a id="l01065" name="l01065"></a><span class="lineno"> 1065</span> </div>
<div class="line"><a id="l01067" name="l01067"></a><span class="lineno"> 1067</span>                <span class="keywordflow">foreach</span> ($field-&gt;getSelectableOptions() as $fieldOption) {</div>
<div class="line"><a id="l01068" name="l01068"></a><span class="lineno"> 1068</span> </div>
<div class="line"><a id="l01069" name="l01069"></a><span class="lineno"> 1069</span>                  <span class="keywordflow">if</span> ($field-&gt;getMultiplicity() == FieldMultiplicity::RECURRING) {</div>
<div class="line"><a id="l01070" name="l01070"></a><span class="lineno"> 1070</span>                    $receivableDueDate = $receivablesGenerator-&gt;dueDate($fieldOption) ?? <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l01071" name="l01071"></a><span class="lineno"> 1071</span>                    <span class="keywordflow">if</span> (!empty($receivableDueDate)) {</div>
<div class="line"><a id="l01072" name="l01072"></a><span class="lineno"> 1072</span>                      $receivableDueDate = $formatter-&gt;formatDate($receivableDueDate, <span class="stringliteral">&#39;medium&#39;</span>);</div>
<div class="line"><a id="l01073" name="l01073"></a><span class="lineno"> 1073</span>                    }</div>
<div class="line"><a id="l01074" name="l01074"></a><span class="lineno"> 1074</span>                  } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01075" name="l01075"></a><span class="lineno"> 1075</span>                    $receivableDueDate = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l01076" name="l01076"></a><span class="lineno"> 1076</span>                  }</div>
<div class="line"><a id="l01077" name="l01077"></a><span class="lineno"> 1077</span> </div>
<div class="line"><a id="l01078" name="l01078"></a><span class="lineno"> 1078</span>                  $option = $fieldOption-&gt;getLabel() ?: $field-&gt;getName(); <span class="comment">// phpmd:ignore</span></div>
<div class="line"><a id="l01079" name="l01079"></a><span class="lineno"> 1079</span> </div>
<div class="line"><a id="l01080" name="l01080"></a><span class="lineno"> 1080</span>                  $fieldData = $projectParticipant-&gt;getParticipantFieldsDatum($fieldOption-&gt;getKey());</div>
<div class="line"><a id="l01081" name="l01081"></a><span class="lineno"> 1081</span> </div>
<div class="line"><a id="l01082" name="l01082"></a><span class="lineno"> 1082</span>                  $totals = <span class="stringliteral">&#39;--&#39;</span>;</div>
<div class="line"><a id="l01083" name="l01083"></a><span class="lineno"> 1083</span>                  $received = <span class="stringliteral">&#39;--&#39;</span>;</div>
<div class="line"><a id="l01084" name="l01084"></a><span class="lineno"> 1084</span>                  $remaining = <span class="stringliteral">&#39;--&#39;</span>; <span class="comment">// phpmd:ignore</span></div>
<div class="line"><a id="l01085" name="l01085"></a><span class="lineno"> 1085</span>                  $memberNames = [];</div>
<div class="line"><a id="l01086" name="l01086"></a><span class="lineno"> 1086</span> </div>
<div class="line"><a id="l01087" name="l01087"></a><span class="lineno"> 1087</span>                  <span class="keywordflow">if</span> (!empty($fieldData)) {</div>
<div class="line"><a id="l01088" name="l01088"></a><span class="lineno"> 1088</span>                    <span class="keywordflow">switch</span> ($type) {</div>
<div class="line"><a id="l01089" name="l01089"></a><span class="lineno"> 1089</span>                      <span class="keywordflow">case</span> <span class="stringliteral">&#39;monetary&#39;</span>:</div>
<div class="line"><a id="l01090" name="l01090"></a><span class="lineno"> 1090</span>                        $totals = $fieldData-&gt;amountPayable();</div>
<div class="line"><a id="l01091" name="l01091"></a><span class="lineno"> 1091</span>                        $received = $fieldData-&gt;amountPaid();</div>
<div class="line"><a id="l01092" name="l01092"></a><span class="lineno"> 1092</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01093" name="l01093"></a><span class="lineno"> 1093</span>                      <span class="keywordflow">case</span> <span class="stringliteral">&#39;deposit&#39;</span>:</div>
<div class="line"><a id="l01094" name="l01094"></a><span class="lineno"> 1094</span>                        $totals = $fieldData-&gt;depositAmount();</div>
<div class="line"><a id="l01095" name="l01095"></a><span class="lineno"> 1095</span>                        $received = min($totals, $fieldData-&gt;amountPaid());</div>
<div class="line"><a id="l01096" name="l01096"></a><span class="lineno"> 1096</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01097" name="l01097"></a><span class="lineno"> 1097</span>                    }</div>
<div class="line"><a id="l01098" name="l01098"></a><span class="lineno"> 1098</span>                    $remaining = $totals - $received;</div>
<div class="line"><a id="l01099" name="l01099"></a><span class="lineno"> 1099</span> </div>
<div class="line"><a id="l01100" name="l01100"></a><span class="lineno"> 1100</span>                    <span class="keywordflow">if</span> ($field-&gt;getMultiplicity() == FieldMultiplicity::GROUPOFPEOPLE</div>
<div class="line"><a id="l01101" name="l01101"></a><span class="lineno"> 1101</span>                        || $field-&gt;getMultiplicity() == FieldMultiplicity::GROUPSOFPEOPLE) {</div>
<div class="line"><a id="l01102" name="l01102"></a><span class="lineno"> 1102</span>                      $groupMembers = $this-&gt;participantFieldsService-&gt;findGroupMembersOf($fieldData);</div>
<div class="line"><a id="l01104" name="l01104"></a><span class="lineno"> 1104</span>                      <span class="keywordflow">foreach</span> ($groupMembers as $groupMember) {</div>
<div class="line"><a id="l01105" name="l01105"></a><span class="lineno"> 1105</span>                        $memberNames[] = $groupMember-&gt;getMusician()-&gt;getPublicName(<span class="keyword">true</span>);</div>
<div class="line"><a id="l01106" name="l01106"></a><span class="lineno"> 1106</span>                      }</div>
<div class="line"><a id="l01107" name="l01107"></a><span class="lineno"> 1107</span>                    }</div>
<div class="line"><a id="l01108" name="l01108"></a><span class="lineno"> 1108</span>                  } elseif ($field-&gt;getMultiplicity() == FieldMultiplicity::GROUPOFPEOPLE) {</div>
<div class="line"><a id="l01109" name="l01109"></a><span class="lineno"> 1109</span>                    <span class="keywordflow">if</span> ($fieldOption != $field-&gt;getSelectableOptions()-&gt;last()) {</div>
<div class="line"><a id="l01110" name="l01110"></a><span class="lineno"> 1110</span>                      <span class="comment">// make sure we only include the option the participant has booked.</span></div>
<div class="line"><a id="l01111" name="l01111"></a><span class="lineno"> 1111</span>                      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01112" name="l01112"></a><span class="lineno"> 1112</span>                    }</div>
<div class="line"><a id="l01113" name="l01113"></a><span class="lineno"> 1113</span>                  }</div>
<div class="line"><a id="l01114" name="l01114"></a><span class="lineno"> 1114</span> </div>
<div class="line"><a id="l01115" name="l01115"></a><span class="lineno"> 1115</span>                  <span class="comment">// compute substitution values</span></div>
<div class="line"><a id="l01116" name="l01116"></a><span class="lineno"> 1116</span>                  $replacements = [];</div>
<div class="line"><a id="l01117" name="l01117"></a><span class="lineno"> 1117</span>                  $nonZeroData = <span class="keyword">false</span>;</div>
<div class="line"><a id="l01118" name="l01118"></a><span class="lineno"> 1118</span>                  <span class="keywordflow">foreach</span> ($replacementKeys as $key) {</div>
<div class="line"><a id="l01119" name="l01119"></a><span class="lineno"> 1119</span>                    <span class="keywordflow">if</span> ($key == <span class="stringliteral">&#39;option&#39;</span>) {</div>
<div class="line"><a id="l01120" name="l01120"></a><span class="lineno"> 1120</span>                      $replacements[$key] = ${$key};</div>
<div class="line"><a id="l01121" name="l01121"></a><span class="lineno"> 1121</span>                      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01122" name="l01122"></a><span class="lineno"> 1122</span>                    }</div>
<div class="line"><a id="l01123" name="l01123"></a><span class="lineno"> 1123</span>                    <span class="keywordflow">if</span> ($key == <span class="stringliteral">&#39;dueDate&#39;</span>) {</div>
<div class="line"><a id="l01124" name="l01124"></a><span class="lineno"> 1124</span>                      $replacements[$key] = $receivableDueDate</div>
<div class="line"><a id="l01125" name="l01125"></a><span class="lineno"> 1125</span>                        ? $receivableDueDate</div>
<div class="line"><a id="l01126" name="l01126"></a><span class="lineno"> 1126</span>                        : ($numberOfOptions === 1</div>
<div class="line"><a id="l01127" name="l01127"></a><span class="lineno"> 1127</span>                           ? $formattedDueDate</div>
<div class="line"><a id="l01128" name="l01128"></a><span class="lineno"> 1128</span>                           : <span class="stringliteral">&#39;&#39;</span>);</div>
<div class="line"><a id="l01129" name="l01129"></a><span class="lineno"> 1129</span>                      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01130" name="l01130"></a><span class="lineno"> 1130</span>                    }</div>
<div class="line"><a id="l01131" name="l01131"></a><span class="lineno"> 1131</span>                    <span class="keywordflow">if</span> (${$key} != <span class="stringliteral">&#39;--&#39;</span>) {</div>
<div class="line"><a id="l01132" name="l01132"></a><span class="lineno"> 1132</span>                      $nonZeroData = $nonZeroData || !empty(${$key});</div>
<div class="line"><a id="l01133" name="l01133"></a><span class="lineno"> 1133</span>                      $totalSum[$key] += ${$key};</div>
<div class="line"><a id="l01134" name="l01134"></a><span class="lineno"> 1134</span>                      $replacements[$key] = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aaeb05cf94149de0821a30628a8c7bcef">moneyValue</a>(${$key});</div>
<div class="line"><a id="l01135" name="l01135"></a><span class="lineno"> 1135</span>                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01136" name="l01136"></a><span class="lineno"> 1136</span>                      $replacements[$key] = ${$key};</div>
<div class="line"><a id="l01137" name="l01137"></a><span class="lineno"> 1137</span>                    }</div>
<div class="line"><a id="l01138" name="l01138"></a><span class="lineno"> 1138</span>                  }</div>
<div class="line"><a id="l01139" name="l01139"></a><span class="lineno"> 1139</span> </div>
<div class="line"><a id="l01140" name="l01140"></a><span class="lineno"> 1140</span>                  <span class="keywordflow">if</span> (!$nonZeroData) {</div>
<div class="line"><a id="l01141" name="l01141"></a><span class="lineno"> 1141</span>                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01142" name="l01142"></a><span class="lineno"> 1142</span>                  }</div>
<div class="line"><a id="l01143" name="l01143"></a><span class="lineno"> 1143</span> </div>
<div class="line"><a id="l01144" name="l01144"></a><span class="lineno"> 1144</span>                  $fieldHasNonZeroData = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01145" name="l01145"></a><span class="lineno"> 1145</span> </div>
<div class="line"><a id="l01146" name="l01146"></a><span class="lineno"> 1146</span>                  <span class="comment">// inject into template</span></div>
<div class="line"><a id="l01147" name="l01147"></a><span class="lineno"> 1147</span>                  $row = self::DEFAULT_HTML_TEMPLATES[<span class="stringliteral">&#39;monetary-fields&#39;</span>][<span class="stringliteral">&#39;row&#39;</span>];</div>
<div class="line"><a id="l01148" name="l01148"></a><span class="lineno"> 1148</span>                  <span class="keywordflow">foreach</span> ($replacementKeys as $key) {</div>
<div class="line"><a id="l01149" name="l01149"></a><span class="lineno"> 1149</span>                    $keyVariants = array_map(</div>
<div class="line"><a id="l01150" name="l01150"></a><span class="lineno"> 1150</span>                      fn($key) =&gt; <span class="charliteral">&#39;[&#39;</span>.$key.<span class="charliteral">&#39;]&#39;</span>,</div>
<div class="line"><a id="l01151" name="l01151"></a><span class="lineno"> 1151</span>                      $this-&gt;translationVariants($key)</div>
<div class="line"><a id="l01152" name="l01152"></a><span class="lineno"> 1152</span>                    );</div>
<div class="line"><a id="l01153" name="l01153"></a><span class="lineno"> 1153</span>                    $row = str_ireplace($keyVariants, $replacements[$key], $row);</div>
<div class="line"><a id="l01154" name="l01154"></a><span class="lineno"> 1154</span>                  }</div>
<div class="line"><a id="l01155" name="l01155"></a><span class="lineno"> 1155</span>                  $cssClass = <span class="stringliteral">&#39;@cssRowClass@&#39;</span>;</div>
<div class="line"><a id="l01156" name="l01156"></a><span class="lineno"> 1156</span>                  <span class="keywordflow">if</span> (!empty($memberNames)) {</div>
<div class="line"><a id="l01157" name="l01157"></a><span class="lineno"> 1157</span>                    $cssClass .= <span class="stringliteral">&#39; has-data&#39;</span>;</div>
<div class="line"><a id="l01158" name="l01158"></a><span class="lineno"> 1158</span>                    $rowData = [ $cssClass, $this-&gt;l-&gt;t(<span class="stringliteral">&#39;members&#39;</span>), implode(<span class="stringliteral">&#39;, &#39;</span>, $memberNames), ];</div>
<div class="line"><a id="l01159" name="l01159"></a><span class="lineno"> 1159</span>                  } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01160" name="l01160"></a><span class="lineno"> 1160</span>                    $rowData = [ $cssClass, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, ];</div>
<div class="line"><a id="l01161" name="l01161"></a><span class="lineno"> 1161</span>                  }</div>
<div class="line"><a id="l01162" name="l01162"></a><span class="lineno"> 1162</span>                  $rowKeys = [ <span class="stringliteral">&#39;[CSSROWCLASS]&#39;</span>, <span class="stringliteral">&#39;[ROWDATALABEL]&#39;</span>, <span class="stringliteral">&#39;[ROWDATACONTENTS]&#39;</span>,  ];</div>
<div class="line"><a id="l01163" name="l01163"></a><span class="lineno"> 1163</span>                  $row = str_replace($rowKeys, $rowData, $row);</div>
<div class="line"><a id="l01164" name="l01164"></a><span class="lineno"> 1164</span>                  $fieldHtml .= $row;</div>
<div class="line"><a id="l01165" name="l01165"></a><span class="lineno"> 1165</span>                }</div>
<div class="line"><a id="l01166" name="l01166"></a><span class="lineno"> 1166</span> </div>
<div class="line"><a id="l01167" name="l01167"></a><span class="lineno"> 1167</span>                <span class="keywordflow">if</span> ($fieldHasNonZeroData) {</div>
<div class="line"><a id="l01168" name="l01168"></a><span class="lineno"> 1168</span>                  <span class="keywordflow">if</span> (!empty($dueDate)) {</div>
<div class="line"><a id="l01169" name="l01169"></a><span class="lineno"> 1169</span>                    <span class="keywordflow">if</span> (empty($totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>])) {</div>
<div class="line"><a id="l01170" name="l01170"></a><span class="lineno"> 1170</span>                      $totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>][<span class="stringliteral">&#39;min&#39;</span>] = $totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>][<span class="stringliteral">&#39;max&#39;</span>] = $dueDate;</div>
<div class="line"><a id="l01171" name="l01171"></a><span class="lineno"> 1171</span>                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01172" name="l01172"></a><span class="lineno"> 1172</span>                      $totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>][<span class="stringliteral">&#39;min&#39;</span>] = min($totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>][<span class="stringliteral">&#39;min&#39;</span>], $dueDate);</div>
<div class="line"><a id="l01173" name="l01173"></a><span class="lineno"> 1173</span>                      $totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>][<span class="stringliteral">&#39;max&#39;</span>] = max($totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>][<span class="stringliteral">&#39;max&#39;</span>], $dueDate);</div>
<div class="line"><a id="l01174" name="l01174"></a><span class="lineno"> 1174</span>                    }</div>
<div class="line"><a id="l01175" name="l01175"></a><span class="lineno"> 1175</span>                  }</div>
<div class="line"><a id="l01176" name="l01176"></a><span class="lineno"> 1176</span> </div>
<div class="line"><a id="l01177" name="l01177"></a><span class="lineno"> 1177</span>                  <span class="comment">// @todo: make this rather dependent on the multiplicity.</span></div>
<div class="line"><a id="l01178" name="l01178"></a><span class="lineno"> 1178</span>                  <span class="keywordflow">if</span> ($numberOfOptions &gt; 1) {</div>
<div class="line"><a id="l01179" name="l01179"></a><span class="lineno"> 1179</span> </div>
<div class="line"><a id="l01180" name="l01180"></a><span class="lineno"> 1180</span>                    <span class="comment">// generate a field-header for multiple options</span></div>
<div class="line"><a id="l01181" name="l01181"></a><span class="lineno"> 1181</span>                    $replacements = [</div>
<div class="line"><a id="l01182" name="l01182"></a><span class="lineno"> 1182</span>                      <span class="stringliteral">&#39;field-name&#39;</span> =&gt; $field-&gt;getName(),</div>
<div class="line"><a id="l01183" name="l01183"></a><span class="lineno"> 1183</span>                      <span class="stringliteral">&#39;dueDate&#39;</span> =&gt; $formattedDueDate,</div>
<div class="line"><a id="l01184" name="l01184"></a><span class="lineno"> 1184</span>                    ];</div>
<div class="line"><a id="l01185" name="l01185"></a><span class="lineno"> 1185</span> </div>
<div class="line"><a id="l01186" name="l01186"></a><span class="lineno"> 1186</span>                    $fieldHeader = self::DEFAULT_HTML_TEMPLATES[<span class="stringliteral">&#39;monetary-fields&#39;</span>][<span class="stringliteral">&#39;fieldHeader&#39;</span>];</div>
<div class="line"><a id="l01187" name="l01187"></a><span class="lineno"> 1187</span>                    <span class="keywordflow">foreach</span> ($replacements as $key =&gt; $replacement) {</div>
<div class="line"><a id="l01188" name="l01188"></a><span class="lineno"> 1188</span>                      $keyVariants = array_map(</div>
<div class="line"><a id="l01189" name="l01189"></a><span class="lineno"> 1189</span>                        fn($key) =&gt; <span class="charliteral">&#39;[&#39;</span>.$key.<span class="charliteral">&#39;]&#39;</span>,</div>
<div class="line"><a id="l01190" name="l01190"></a><span class="lineno"> 1190</span>                        $this-&gt;translationVariants($key)</div>
<div class="line"><a id="l01191" name="l01191"></a><span class="lineno"> 1191</span>                      );</div>
<div class="line"><a id="l01192" name="l01192"></a><span class="lineno"> 1192</span>                      $fieldHeader = str_ireplace($keyVariants, $replacement, $fieldHeader);</div>
<div class="line"><a id="l01193" name="l01193"></a><span class="lineno"> 1193</span>                    }</div>
<div class="line"><a id="l01194" name="l01194"></a><span class="lineno"> 1194</span>                    $cssClass = implode(<span class="charliteral">&#39; &#39;</span>, [</div>
<div class="line"><a id="l01195" name="l01195"></a><span class="lineno"> 1195</span>                      self::PARTICIPANT_MONETARY_FIELDS_CSS_CLASS[<span class="stringliteral">&#39;fieldHeader&#39;</span>],</div>
<div class="line"><a id="l01196" name="l01196"></a><span class="lineno"> 1196</span>                      <span class="stringliteral">&#39;number-of-options-&#39;</span> . $numberOfOptions,</div>
<div class="line"><a id="l01197" name="l01197"></a><span class="lineno"> 1197</span>                    ]);</div>
<div class="line"><a id="l01198" name="l01198"></a><span class="lineno"> 1198</span>                    $cssRowClass = implode(<span class="charliteral">&#39; &#39;</span>, [</div>
<div class="line"><a id="l01199" name="l01199"></a><span class="lineno"> 1199</span>                      self::PARTICIPANT_MONETARY_FIELDS_CSS_CLASS[<span class="stringliteral">&#39;row&#39;</span>],</div>
<div class="line"><a id="l01200" name="l01200"></a><span class="lineno"> 1200</span>                      <span class="stringliteral">&#39;number-of-options-&#39;</span>.$numberOfOptions,</div>
<div class="line"><a id="l01201" name="l01201"></a><span class="lineno"> 1201</span>                    ]);</div>
<div class="line"><a id="l01202" name="l01202"></a><span class="lineno"> 1202</span>                    $fieldHeader = str_replace(</div>
<div class="line"><a id="l01203" name="l01203"></a><span class="lineno"> 1203</span>                      [ <span class="stringliteral">&#39;[CSSCLASS]&#39;</span>, <span class="stringliteral">&#39;[CSSROWCLASS]&#39;</span> ], [ $cssClass, $cssRowClass ], $fieldHeader);</div>
<div class="line"><a id="l01204" name="l01204"></a><span class="lineno"> 1204</span> </div>
<div class="line"><a id="l01205" name="l01205"></a><span class="lineno"> 1205</span>                    $fieldHtml = $fieldHeader  . $fieldHtml;</div>
<div class="line"><a id="l01206" name="l01206"></a><span class="lineno"> 1206</span>                  }</div>
<div class="line"><a id="l01207" name="l01207"></a><span class="lineno"> 1207</span> </div>
<div class="line"><a id="l01208" name="l01208"></a><span class="lineno"> 1208</span>                  $html .= str_replace(<span class="stringliteral">&#39;@cssRowClass@&#39;</span>, $cssRowClass ?? <span class="stringliteral">&#39;&#39;</span>, $fieldHtml);</div>
<div class="line"><a id="l01209" name="l01209"></a><span class="lineno"> 1209</span>                }</div>
<div class="line"><a id="l01210" name="l01210"></a><span class="lineno"> 1210</span>              }</div>
<div class="line"><a id="l01211" name="l01211"></a><span class="lineno"> 1211</span>            }</div>
<div class="line"><a id="l01212" name="l01212"></a><span class="lineno"> 1212</span> </div>
<div class="line"><a id="l01213" name="l01213"></a><span class="lineno"> 1213</span>            $footer = self::DEFAULT_HTML_TEMPLATES[<span class="stringliteral">&#39;monetary-fields&#39;</span>][<span class="stringliteral">&#39;footer&#39;</span>];</div>
<div class="line"><a id="l01214" name="l01214"></a><span class="lineno"> 1214</span>            <span class="keywordflow">foreach</span> ($replacementKeys as $key) {</div>
<div class="line"><a id="l01215" name="l01215"></a><span class="lineno"> 1215</span>              <span class="keywordflow">switch</span> ($key) {</div>
<div class="line"><a id="l01216" name="l01216"></a><span class="lineno"> 1216</span>                <span class="keywordflow">case</span> <span class="stringliteral">&#39;option&#39;</span>:</div>
<div class="line"><a id="l01217" name="l01217"></a><span class="lineno"> 1217</span>                  $key = <span class="stringliteral">&#39;label&#39;</span>;</div>
<div class="line"><a id="l01218" name="l01218"></a><span class="lineno"> 1218</span>                  <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01219" name="l01219"></a><span class="lineno"> 1219</span>                <span class="keywordflow">case</span> <span class="stringliteral">&#39;dueDate&#39;</span>:</div>
<div class="line"><a id="l01220" name="l01220"></a><span class="lineno"> 1220</span>                  <span class="keywordflow">if</span> (!empty($totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>])) {</div>
<div class="line"><a id="l01221" name="l01221"></a><span class="lineno"> 1221</span>                    $minDate = $formatter-&gt;formatDate($totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>][<span class="stringliteral">&#39;min&#39;</span>], <span class="stringliteral">&#39;short&#39;</span>);</div>
<div class="line"><a id="l01222" name="l01222"></a><span class="lineno"> 1222</span>                    $maxDate = $formatter-&gt;formatDate($totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>][<span class="stringliteral">&#39;max&#39;</span>], <span class="stringliteral">&#39;short&#39;</span>);</div>
<div class="line"><a id="l01223" name="l01223"></a><span class="lineno"> 1223</span>                    <span class="keywordflow">if</span> (<span class="keyword">true</span> || $minDate == $maxDate) {</div>
<div class="line"><a id="l01224" name="l01224"></a><span class="lineno"> 1224</span>                      $totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>] = $formatter-&gt;formatDate($totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>][<span class="stringliteral">&#39;max&#39;</span>], <span class="stringliteral">&#39;medium&#39;</span>);</div>
<div class="line"><a id="l01225" name="l01225"></a><span class="lineno"> 1225</span>                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01226" name="l01226"></a><span class="lineno"> 1226</span>                      $totalSum[<span class="stringliteral">&#39;dueDate&#39;</span>] = $minDate . <span class="stringliteral">&#39; - &#39;</span> . $maxDate;</div>
<div class="line"><a id="l01227" name="l01227"></a><span class="lineno"> 1227</span>                    }</div>
<div class="line"><a id="l01228" name="l01228"></a><span class="lineno"> 1228</span>                  }</div>
<div class="line"><a id="l01229" name="l01229"></a><span class="lineno"> 1229</span>                  <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01230" name="l01230"></a><span class="lineno"> 1230</span>                <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l01231" name="l01231"></a><span class="lineno"> 1231</span>                  $totalSum[$key] = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aaeb05cf94149de0821a30628a8c7bcef">moneyValue</a>($totalSum[$key]);</div>
<div class="line"><a id="l01232" name="l01232"></a><span class="lineno"> 1232</span>                  <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01233" name="l01233"></a><span class="lineno"> 1233</span>              }</div>
<div class="line"><a id="l01234" name="l01234"></a><span class="lineno"> 1234</span>              $keyVariants = array_map(</div>
<div class="line"><a id="l01235" name="l01235"></a><span class="lineno"> 1235</span>                fn($key) =&gt; <span class="charliteral">&#39;[&#39;</span>.$key.<span class="charliteral">&#39;]&#39;</span>,</div>
<div class="line"><a id="l01236" name="l01236"></a><span class="lineno"> 1236</span>                $this-&gt;translationVariants($key)</div>
<div class="line"><a id="l01237" name="l01237"></a><span class="lineno"> 1237</span>              );</div>
<div class="line"><a id="l01238" name="l01238"></a><span class="lineno"> 1238</span>              $footer = str_ireplace($keyVariants, $totalSum[$key], $footer);</div>
<div class="line"><a id="l01239" name="l01239"></a><span class="lineno"> 1239</span>            }</div>
<div class="line"><a id="l01240" name="l01240"></a><span class="lineno"> 1240</span>            $cssClass = implode(<span class="charliteral">&#39; &#39;</span>, [</div>
<div class="line"><a id="l01241" name="l01241"></a><span class="lineno"> 1241</span>              self::PARTICIPANT_MONETARY_FIELDS_CSS_CLASS[<span class="stringliteral">&#39;footer&#39;</span>],</div>
<div class="line"><a id="l01242" name="l01242"></a><span class="lineno"> 1242</span>              <span class="stringliteral">&#39;total-number-of-options-&#39;</span> . $totalNumberOfOptions,</div>
<div class="line"><a id="l01243" name="l01243"></a><span class="lineno"> 1243</span>            ]);</div>
<div class="line"><a id="l01244" name="l01244"></a><span class="lineno"> 1244</span>            $footer = str_replace(<span class="stringliteral">&#39;[CSSCLASS]&#39;</span>, $cssClass, $footer);</div>
<div class="line"><a id="l01245" name="l01245"></a><span class="lineno"> 1245</span>            $html .= $footer;</div>
<div class="line"><a id="l01246" name="l01246"></a><span class="lineno"> 1246</span>          }</div>
<div class="line"><a id="l01247" name="l01247"></a><span class="lineno"> 1247</span>          <span class="keywordflow">if</span> ($numberOfFields &gt; 0 &amp;&amp; !$doSpecificType &amp;&amp; !$doSpecificField) {</div>
<div class="line"><a id="l01248" name="l01248"></a><span class="lineno"> 1248</span>            $html .= <span class="stringliteral">&#39;&lt;p&gt;&#39;</span>;</div>
<div class="line"><a id="l01249" name="l01249"></a><span class="lineno"> 1249</span>          }</div>
<div class="line"><a id="l01250" name="l01250"></a><span class="lineno"> 1250</span>        }</div>
<div class="line"><a id="l01251" name="l01251"></a><span class="lineno"> 1251</span> </div>
<div class="line"><a id="l01252" name="l01252"></a><span class="lineno"> 1252</span>        <span class="keywordflow">return</span> $html;</div>
<div class="line"><a id="l01253" name="l01253"></a><span class="lineno"> 1253</span>      };</div>
<div class="line"><a id="l01254" name="l01254"></a><span class="lineno"> 1254</span> </div>
<div class="line"><a id="l01255" name="l01255"></a><span class="lineno"> 1255</span>    }</div>
<div class="line"><a id="l01256" name="l01256"></a><span class="lineno"> 1256</span> </div>
<div class="line"><a id="l01257" name="l01257"></a><span class="lineno"> 1257</span>    <span class="keywordflow">if</span> (!empty($this-&gt;bulkTransaction)) {</div>
<div class="line"><a id="l01258" name="l01258"></a><span class="lineno"> 1258</span> </div>
<div class="line"><a id="l01259" name="l01259"></a><span class="lineno"> 1259</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;BANK_TRANSACTION_AMOUNT&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l01260" name="l01260"></a><span class="lineno"> 1260</span>        <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l01261" name="l01261"></a><span class="lineno"> 1261</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01262" name="l01262"></a><span class="lineno"> 1262</span>        }</div>
<div class="line"><a id="l01263" name="l01263"></a><span class="lineno"> 1263</span>        <span class="keywordflow">if</span> (empty($this-&gt;bulkTransaction)) {</div>
<div class="line"><a id="l01264" name="l01264"></a><span class="lineno"> 1264</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01265" name="l01265"></a><span class="lineno"> 1265</span>        }</div>
<div class="line"><a id="l01266" name="l01266"></a><span class="lineno"> 1266</span> </div>
<div class="line"><a id="l01268" name="l01268"></a><span class="lineno"> 1268</span>        $compositePayment = $this-&gt;bulkTransaction-&gt;getPayments()-&gt;get($musician-&gt;getId());</div>
<div class="line"><a id="l01269" name="l01269"></a><span class="lineno"> 1269</span>        <span class="keywordflow">if</span> (!empty($compositePayment)) {</div>
<div class="line"><a id="l01270" name="l01270"></a><span class="lineno"> 1270</span>          $amount = $this-&gt;paymentSign * $compositePayment-&gt;getAmount();</div>
<div class="line"><a id="l01271" name="l01271"></a><span class="lineno"> 1271</span>          <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aaeb05cf94149de0821a30628a8c7bcef">moneyValue</a>($amount);</div>
<div class="line"><a id="l01272" name="l01272"></a><span class="lineno"> 1272</span>        }</div>
<div class="line"><a id="l01273" name="l01273"></a><span class="lineno"> 1273</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01274" name="l01274"></a><span class="lineno"> 1274</span>      };</div>
<div class="line"><a id="l01275" name="l01275"></a><span class="lineno"> 1275</span> </div>
<div class="line"><a id="l01276" name="l01276"></a><span class="lineno"> 1276</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;BANK_TRANSACTION_PURPOSE&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l01277" name="l01277"></a><span class="lineno"> 1277</span>        <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l01278" name="l01278"></a><span class="lineno"> 1278</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01279" name="l01279"></a><span class="lineno"> 1279</span>        }</div>
<div class="line"><a id="l01280" name="l01280"></a><span class="lineno"> 1280</span> </div>
<div class="line"><a id="l01282" name="l01282"></a><span class="lineno"> 1282</span>        $compositePayment = $this-&gt;bulkTransaction-&gt;getPayments()-&gt;get($musician-&gt;getId());</div>
<div class="line"><a id="l01283" name="l01283"></a><span class="lineno"> 1283</span>        <span class="keywordflow">if</span> (!empty($compositePayment)) {</div>
<div class="line"><a id="l01284" name="l01284"></a><span class="lineno"> 1284</span>          <span class="keywordflow">return</span> $compositePayment-&gt;getSubject();</div>
<div class="line"><a id="l01285" name="l01285"></a><span class="lineno"> 1285</span>        }</div>
<div class="line"><a id="l01286" name="l01286"></a><span class="lineno"> 1286</span> </div>
<div class="line"><a id="l01287" name="l01287"></a><span class="lineno"> 1287</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01288" name="l01288"></a><span class="lineno"> 1288</span>      };</div>
<div class="line"><a id="l01289" name="l01289"></a><span class="lineno"> 1289</span> </div>
<div class="line"><a id="l01290" name="l01290"></a><span class="lineno"> 1290</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;SEPA_MANDATE_REFERENCE&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l01291" name="l01291"></a><span class="lineno"> 1291</span>        <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l01292" name="l01292"></a><span class="lineno"> 1292</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01293" name="l01293"></a><span class="lineno"> 1293</span>        }</div>
<div class="line"><a id="l01294" name="l01294"></a><span class="lineno"> 1294</span> </div>
<div class="line"><a id="l01296" name="l01296"></a><span class="lineno"> 1296</span>        $compositePayment = $this-&gt;bulkTransaction-&gt;getPayments()-&gt;get($musician-&gt;getId());</div>
<div class="line"><a id="l01297" name="l01297"></a><span class="lineno"> 1297</span>        <span class="keywordflow">if</span> (!empty($compositePayment)) {</div>
<div class="line"><a id="l01299" name="l01299"></a><span class="lineno"> 1299</span>          $debitMandate = $compositePayment-&gt;getSepaDebitMandate();</div>
<div class="line"><a id="l01300" name="l01300"></a><span class="lineno"> 1300</span>          <span class="keywordflow">if</span> (!empty($debitMandate)) {</div>
<div class="line"><a id="l01301" name="l01301"></a><span class="lineno"> 1301</span>            <span class="keywordflow">return</span> $debitMandate-&gt;getMandateReference();</div>
<div class="line"><a id="l01302" name="l01302"></a><span class="lineno"> 1302</span>          }</div>
<div class="line"><a id="l01303" name="l01303"></a><span class="lineno"> 1303</span>        }</div>
<div class="line"><a id="l01304" name="l01304"></a><span class="lineno"> 1304</span> </div>
<div class="line"><a id="l01305" name="l01305"></a><span class="lineno"> 1305</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01306" name="l01306"></a><span class="lineno"> 1306</span>      };</div>
<div class="line"><a id="l01307" name="l01307"></a><span class="lineno"> 1307</span> </div>
<div class="line"><a id="l01308" name="l01308"></a><span class="lineno"> 1308</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;SEPA_MANDATE_DATE&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l01309" name="l01309"></a><span class="lineno"> 1309</span>        <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l01310" name="l01310"></a><span class="lineno"> 1310</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01311" name="l01311"></a><span class="lineno"> 1311</span>        }</div>
<div class="line"><a id="l01312" name="l01312"></a><span class="lineno"> 1312</span> </div>
<div class="line"><a id="l01314" name="l01314"></a><span class="lineno"> 1314</span>        $compositePayment = $this-&gt;bulkTransaction-&gt;getPayments()-&gt;get($musician-&gt;getId());</div>
<div class="line"><a id="l01315" name="l01315"></a><span class="lineno"> 1315</span>        <span class="keywordflow">if</span> (!empty($compositePayment)) {</div>
<div class="line"><a id="l01317" name="l01317"></a><span class="lineno"> 1317</span>          $debitMandate = $compositePayment-&gt;getSepaDebitMandate();</div>
<div class="line"><a id="l01318" name="l01318"></a><span class="lineno"> 1318</span>          <span class="keywordflow">if</span> (!empty($debitMandate)) {</div>
<div class="line"><a id="l01319" name="l01319"></a><span class="lineno"> 1319</span>            <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a010c9c0626aa3587f7062ffbcc9ff64e">formatDate</a>($debitMandate-&gt;getMandateDate(), $keyArg[1]??<span class="stringliteral">&#39;medium&#39;</span>);</div>
<div class="line"><a id="l01320" name="l01320"></a><span class="lineno"> 1320</span>          }</div>
<div class="line"><a id="l01321" name="l01321"></a><span class="lineno"> 1321</span>        }</div>
<div class="line"><a id="l01322" name="l01322"></a><span class="lineno"> 1322</span> </div>
<div class="line"><a id="l01323" name="l01323"></a><span class="lineno"> 1323</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01324" name="l01324"></a><span class="lineno"> 1324</span>      };</div>
<div class="line"><a id="l01325" name="l01325"></a><span class="lineno"> 1325</span> </div>
<div class="line"><a id="l01326" name="l01326"></a><span class="lineno"> 1326</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;BANK_ACCOUNT_IBAN&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l01327" name="l01327"></a><span class="lineno"> 1327</span>        <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l01328" name="l01328"></a><span class="lineno"> 1328</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01329" name="l01329"></a><span class="lineno"> 1329</span>        }</div>
<div class="line"><a id="l01330" name="l01330"></a><span class="lineno"> 1330</span> </div>
<div class="line"><a id="l01332" name="l01332"></a><span class="lineno"> 1332</span>        $compositePayment = $this-&gt;bulkTransaction-&gt;getPayments()-&gt;get($musician-&gt;getId());</div>
<div class="line"><a id="l01333" name="l01333"></a><span class="lineno"> 1333</span>        <span class="keywordflow">if</span> (!empty($compositePayment)) {</div>
<div class="line"><a id="l01335" name="l01335"></a><span class="lineno"> 1335</span>          $bankAccount = $compositePayment-&gt;getSepaBankAccount();</div>
<div class="line"><a id="l01336" name="l01336"></a><span class="lineno"> 1336</span>          <span class="keywordflow">if</span> (!empty($bankAccount)) {</div>
<div class="line"><a id="l01337" name="l01337"></a><span class="lineno"> 1337</span>            <span class="keywordflow">return</span> $bankAccount-&gt;getIban();</div>
<div class="line"><a id="l01338" name="l01338"></a><span class="lineno"> 1338</span>          }</div>
<div class="line"><a id="l01339" name="l01339"></a><span class="lineno"> 1339</span>        }</div>
<div class="line"><a id="l01340" name="l01340"></a><span class="lineno"> 1340</span> </div>
<div class="line"><a id="l01341" name="l01341"></a><span class="lineno"> 1341</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01342" name="l01342"></a><span class="lineno"> 1342</span>      };</div>
<div class="line"><a id="l01343" name="l01343"></a><span class="lineno"> 1343</span> </div>
<div class="line"><a id="l01344" name="l01344"></a><span class="lineno"> 1344</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;BANK_ACCOUNT_BIC&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l01345" name="l01345"></a><span class="lineno"> 1345</span>        <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l01346" name="l01346"></a><span class="lineno"> 1346</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01347" name="l01347"></a><span class="lineno"> 1347</span>        }</div>
<div class="line"><a id="l01348" name="l01348"></a><span class="lineno"> 1348</span> </div>
<div class="line"><a id="l01350" name="l01350"></a><span class="lineno"> 1350</span>        $compositePayment = $this-&gt;bulkTransaction-&gt;getPayments()-&gt;get($musician-&gt;getId());</div>
<div class="line"><a id="l01351" name="l01351"></a><span class="lineno"> 1351</span>        <span class="keywordflow">if</span> (!empty($compositePayment)) {</div>
<div class="line"><a id="l01353" name="l01353"></a><span class="lineno"> 1353</span>          $bankAccount = $compositePayment-&gt;getSepaBankAccount();</div>
<div class="line"><a id="l01354" name="l01354"></a><span class="lineno"> 1354</span>          <span class="keywordflow">if</span> (!empty($bankAccount)) {</div>
<div class="line"><a id="l01355" name="l01355"></a><span class="lineno"> 1355</span>            <span class="keywordflow">return</span> $bankAccount-&gt;getBic();</div>
<div class="line"><a id="l01356" name="l01356"></a><span class="lineno"> 1356</span>          }</div>
<div class="line"><a id="l01357" name="l01357"></a><span class="lineno"> 1357</span>        }</div>
<div class="line"><a id="l01358" name="l01358"></a><span class="lineno"> 1358</span> </div>
<div class="line"><a id="l01359" name="l01359"></a><span class="lineno"> 1359</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01360" name="l01360"></a><span class="lineno"> 1360</span>      };</div>
<div class="line"><a id="l01361" name="l01361"></a><span class="lineno"> 1361</span> </div>
<div class="line"><a id="l01362" name="l01362"></a><span class="lineno"> 1362</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;BANK_ACCOUNT_BANK&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l01363" name="l01363"></a><span class="lineno"> 1363</span>        <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l01364" name="l01364"></a><span class="lineno"> 1364</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01365" name="l01365"></a><span class="lineno"> 1365</span>        }</div>
<div class="line"><a id="l01366" name="l01366"></a><span class="lineno"> 1366</span> </div>
<div class="line"><a id="l01368" name="l01368"></a><span class="lineno"> 1368</span>        $compositePayment = $this-&gt;bulkTransaction-&gt;getPayments()-&gt;get($musician-&gt;getId());</div>
<div class="line"><a id="l01369" name="l01369"></a><span class="lineno"> 1369</span>        <span class="keywordflow">if</span> (!empty($compositePayment)) {</div>
<div class="line"><a id="l01371" name="l01371"></a><span class="lineno"> 1371</span>          $bankAccount = $compositePayment-&gt;getSepaBankAccount();</div>
<div class="line"><a id="l01372" name="l01372"></a><span class="lineno"> 1372</span>          <span class="keywordflow">if</span> (!empty($bankAccount)) {</div>
<div class="line"><a id="l01373" name="l01373"></a><span class="lineno"> 1373</span>            $iban = $bankAccount-&gt;getIban();</div>
<div class="line"><a id="l01375" name="l01375"></a><span class="lineno"> 1375</span>            $financeService = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(FinanceService::class);</div>
<div class="line"><a id="l01376" name="l01376"></a><span class="lineno"> 1376</span>            $info = $financeService-&gt;getIbanInfo($iban);</div>
<div class="line"><a id="l01377" name="l01377"></a><span class="lineno"> 1377</span>            $bank = $info[<span class="stringliteral">&#39;bank&#39;</span>];</div>
<div class="line"><a id="l01378" name="l01378"></a><span class="lineno"> 1378</span>            $city = $info[<span class="stringliteral">&#39;city&#39;</span>];</div>
<div class="line"><a id="l01379" name="l01379"></a><span class="lineno"> 1379</span>            <span class="keywordflow">if</span> (!empty($bank)) {</div>
<div class="line"><a id="l01380" name="l01380"></a><span class="lineno"> 1380</span>              <span class="keywordflow">if</span> (!empty($city)) {</div>
<div class="line"><a id="l01381" name="l01381"></a><span class="lineno"> 1381</span>                $bank .= <span class="stringliteral">&#39;, &#39;</span> . $info[<span class="stringliteral">&#39;city&#39;</span>];</div>
<div class="line"><a id="l01382" name="l01382"></a><span class="lineno"> 1382</span>              }</div>
<div class="line"><a id="l01383" name="l01383"></a><span class="lineno"> 1383</span>              <span class="keywordflow">return</span> $bank;</div>
<div class="line"><a id="l01384" name="l01384"></a><span class="lineno"> 1384</span>            }</div>
<div class="line"><a id="l01385" name="l01385"></a><span class="lineno"> 1385</span>          }</div>
<div class="line"><a id="l01386" name="l01386"></a><span class="lineno"> 1386</span>        }</div>
<div class="line"><a id="l01387" name="l01387"></a><span class="lineno"> 1387</span> </div>
<div class="line"><a id="l01388" name="l01388"></a><span class="lineno"> 1388</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01389" name="l01389"></a><span class="lineno"> 1389</span>      };</div>
<div class="line"><a id="l01390" name="l01390"></a><span class="lineno"> 1390</span> </div>
<div class="line"><a id="l01391" name="l01391"></a><span class="lineno"> 1391</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;BANK_ACCOUNT_OWNER&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l01392" name="l01392"></a><span class="lineno"> 1392</span>        <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l01393" name="l01393"></a><span class="lineno"> 1393</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01394" name="l01394"></a><span class="lineno"> 1394</span>        }</div>
<div class="line"><a id="l01395" name="l01395"></a><span class="lineno"> 1395</span> </div>
<div class="line"><a id="l01397" name="l01397"></a><span class="lineno"> 1397</span>        $compositePayment = $this-&gt;bulkTransaction-&gt;getPayments()-&gt;get($musician-&gt;getId());</div>
<div class="line"><a id="l01398" name="l01398"></a><span class="lineno"> 1398</span>        <span class="keywordflow">if</span> (!empty($compositePayment)) {</div>
<div class="line"><a id="l01400" name="l01400"></a><span class="lineno"> 1400</span>          $bankAccount = $compositePayment-&gt;getSepaBankAccount();</div>
<div class="line"><a id="l01401" name="l01401"></a><span class="lineno"> 1401</span>          <span class="keywordflow">if</span> (!empty($bankAccount)) {</div>
<div class="line"><a id="l01402" name="l01402"></a><span class="lineno"> 1402</span>            <span class="keywordflow">return</span> $bankAccount-&gt;getBankAccountOwner();</div>
<div class="line"><a id="l01403" name="l01403"></a><span class="lineno"> 1403</span>          }</div>
<div class="line"><a id="l01404" name="l01404"></a><span class="lineno"> 1404</span>        }</div>
<div class="line"><a id="l01405" name="l01405"></a><span class="lineno"> 1405</span> </div>
<div class="line"><a id="l01406" name="l01406"></a><span class="lineno"> 1406</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01407" name="l01407"></a><span class="lineno"> 1407</span>      };</div>
<div class="line"><a id="l01408" name="l01408"></a><span class="lineno"> 1408</span> </div>
<div class="line"><a id="l01409" name="l01409"></a><span class="lineno"> 1409</span>      $this-&gt;substitutions[self::MEMBER_NAMESPACE][<span class="stringliteral">&#39;BANK_TRANSACTION_PARTS&#39;</span>] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) {</div>
<div class="line"><a id="l01410" name="l01410"></a><span class="lineno"> 1410</span>        <span class="keywordflow">if</span> (empty($musician)) {</div>
<div class="line"><a id="l01411" name="l01411"></a><span class="lineno"> 1411</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01412" name="l01412"></a><span class="lineno"> 1412</span>        }</div>
<div class="line"><a id="l01413" name="l01413"></a><span class="lineno"> 1413</span>        <span class="keywordflow">if</span> (empty($this-&gt;bulkTransaction)) {</div>
<div class="line"><a id="l01414" name="l01414"></a><span class="lineno"> 1414</span>          <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01415" name="l01415"></a><span class="lineno"> 1415</span>        }</div>
<div class="line"><a id="l01416" name="l01416"></a><span class="lineno"> 1416</span> </div>
<div class="line"><a id="l01418" name="l01418"></a><span class="lineno"> 1418</span>        $compositePayment = $this-&gt;bulkTransaction-&gt;getPayments()-&gt;get($musician-&gt;getId());</div>
<div class="line"><a id="l01419" name="l01419"></a><span class="lineno"> 1419</span>        <span class="keywordflow">if</span> (!empty($compositePayment)) {</div>
<div class="line"><a id="l01420" name="l01420"></a><span class="lineno"> 1420</span> </div>
<div class="line"><a id="l01421" name="l01421"></a><span class="lineno"> 1421</span>          $keyArg = array_map(</div>
<div class="line"><a id="l01422" name="l01422"></a><span class="lineno"> 1422</span>            <span class="keyword">function</span>($value) {</div>
<div class="line"><a id="l01423" name="l01423"></a><span class="lineno"> 1423</span>              <span class="keywordflow">return</span> html_entity_decode($value, ENT_HTML5, <span class="stringliteral">&#39;UTF-8&#39;</span>);</div>
<div class="line"><a id="l01424" name="l01424"></a><span class="lineno"> 1424</span>            },</div>
<div class="line"><a id="l01425" name="l01425"></a><span class="lineno"> 1425</span>            $keyArg);</div>
<div class="line"><a id="l01426" name="l01426"></a><span class="lineno"> 1426</span> </div>
<div class="line"><a id="l01427" name="l01427"></a><span class="lineno"> 1427</span>          $tableTemplate = [</div>
<div class="line"><a id="l01428" name="l01428"></a><span class="lineno"> 1428</span>            <span class="stringliteral">&#39;header&#39;</span> =&gt; $keyArg[1] ?? self::DEFAULT_HTML_TEMPLATES[<span class="stringliteral">&#39;transaction-parts&#39;</span>][<span class="stringliteral">&#39;header&#39;</span>],</div>
<div class="line"><a id="l01429" name="l01429"></a><span class="lineno"> 1429</span>            <span class="stringliteral">&#39;row&#39;</span> =&gt; $keyArg[2] ?? self::DEFAULT_HTML_TEMPLATES[<span class="stringliteral">&#39;transaction-parts&#39;</span>][<span class="stringliteral">&#39;row&#39;</span>],</div>
<div class="line"><a id="l01430" name="l01430"></a><span class="lineno"> 1430</span>            <span class="stringliteral">&#39;footer&#39;</span> =&gt; $keyArg[3] ?? self::DEFAULT_HTML_TEMPLATES[<span class="stringliteral">&#39;transaction-parts&#39;</span>][<span class="stringliteral">&#39;footer&#39;</span>],</div>
<div class="line"><a id="l01431" name="l01431"></a><span class="lineno"> 1431</span>          ];</div>
<div class="line"><a id="l01432" name="l01432"></a><span class="lineno"> 1432</span> </div>
<div class="line"><a id="l01433" name="l01433"></a><span class="lineno"> 1433</span>          $replacementKeys = [ <span class="stringliteral">&#39;purpose&#39;</span>, <span class="stringliteral">&#39;invoiced&#39;</span>, <span class="stringliteral">&#39;totals&#39;</span>, <span class="stringliteral">&#39;received&#39;</span>, <span class="stringliteral">&#39;remaining&#39;</span> ];</div>
<div class="line"><a id="l01434" name="l01434"></a><span class="lineno"> 1434</span>          $totalSum = array_fill_keys($replacementKeys, 0.0);</div>
<div class="line"><a id="l01435" name="l01435"></a><span class="lineno"> 1435</span>          $totalSum[<span class="stringliteral">&#39;purpose&#39;</span>] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Total Amount&#39;</span>);</div>
<div class="line"><a id="l01436" name="l01436"></a><span class="lineno"> 1436</span> </div>
<div class="line"><a id="l01437" name="l01437"></a><span class="lineno"> 1437</span>          $rowTemplate = $tableTemplate[<span class="stringliteral">&#39;row&#39;</span>];</div>
<div class="line"><a id="l01438" name="l01438"></a><span class="lineno"> 1438</span> </div>
<div class="line"><a id="l01439" name="l01439"></a><span class="lineno"> 1439</span>          <span class="comment">// in order to have the chance to emit a more simple table</span></div>
<div class="line"><a id="l01440" name="l01440"></a><span class="lineno"> 1440</span>          $receivedIsZero = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01441" name="l01441"></a><span class="lineno"> 1441</span> </div>
<div class="line"><a id="l01442" name="l01442"></a><span class="lineno"> 1442</span>          $rowHtml = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l01443" name="l01443"></a><span class="lineno"> 1443</span>          $payments = $compositePayment-&gt;getProjectPayments();</div>
<div class="line"><a id="l01445" name="l01445"></a><span class="lineno"> 1445</span>          <span class="keywordflow">foreach</span> ($payments as $payment) {</div>
<div class="line"><a id="l01446" name="l01446"></a><span class="lineno"> 1446</span>            $invoiced = $this-&gt;paymentSign * $payment-&gt;getAmount();</div>
<div class="line"><a id="l01447" name="l01447"></a><span class="lineno"> 1447</span> </div>
<div class="line"><a id="l01448" name="l01448"></a><span class="lineno"> 1448</span>            $totals = $this-&gt;paymentSign * $payment-&gt;getReceivable()-&gt;amountPayable();</div>
<div class="line"><a id="l01449" name="l01449"></a><span class="lineno"> 1449</span>            $received = $this-&gt;paymentSign * $payment-&gt;getReceivable()-&gt;amountPaid();</div>
<div class="line"><a id="l01450" name="l01450"></a><span class="lineno"> 1450</span> </div>
<div class="line"><a id="l01451" name="l01451"></a><span class="lineno"> 1451</span>            <span class="comment">// otherwise one would have to account for the dueDate,</span></div>
<div class="line"><a id="l01452" name="l01452"></a><span class="lineno"> 1452</span>            <span class="comment">// so keep it simple and just remove the current payment.</span></div>
<div class="line"><a id="l01453" name="l01453"></a><span class="lineno"> 1453</span>            $received -= $invoiced;</div>
<div class="line"><a id="l01454" name="l01454"></a><span class="lineno"> 1454</span> </div>
<div class="line"><a id="l01455" name="l01455"></a><span class="lineno"> 1455</span>            <span class="keywordflow">if</span> (!empty($received)) {</div>
<div class="line"><a id="l01456" name="l01456"></a><span class="lineno"> 1456</span>              $receivedIsZero = <span class="keyword">false</span>;</div>
<div class="line"><a id="l01457" name="l01457"></a><span class="lineno"> 1457</span>            }</div>
<div class="line"><a id="l01458" name="l01458"></a><span class="lineno"> 1458</span> </div>
<div class="line"><a id="l01459" name="l01459"></a><span class="lineno"> 1459</span>            $remaining = $totals - $received;</div>
<div class="line"><a id="l01460" name="l01460"></a><span class="lineno"> 1460</span> </div>
<div class="line"><a id="l01461" name="l01461"></a><span class="lineno"> 1461</span>            $purpose = $payment-&gt;getSubject();</div>
<div class="line"><a id="l01462" name="l01462"></a><span class="lineno"> 1462</span> </div>
<div class="line"><a id="l01463" name="l01463"></a><span class="lineno"> 1463</span>            $replacements = [];</div>
<div class="line"><a id="l01464" name="l01464"></a><span class="lineno"> 1464</span>            <span class="keywordflow">foreach</span> ($replacementKeys as $key) {</div>
<div class="line"><a id="l01465" name="l01465"></a><span class="lineno"> 1465</span>              <span class="keywordflow">if</span> ($key == <span class="stringliteral">&#39;purpose&#39;</span>) {</div>
<div class="line"><a id="l01466" name="l01466"></a><span class="lineno"> 1466</span>                $replacements[$key] = ${$key};</div>
<div class="line"><a id="l01467" name="l01467"></a><span class="lineno"> 1467</span>                <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01468" name="l01468"></a><span class="lineno"> 1468</span>              }</div>
<div class="line"><a id="l01469" name="l01469"></a><span class="lineno"> 1469</span>              $totalSum[$key] += ${$key};</div>
<div class="line"><a id="l01470" name="l01470"></a><span class="lineno"> 1470</span>              $replacements[$key] = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aaeb05cf94149de0821a30628a8c7bcef">moneyValue</a>(${$key});</div>
<div class="line"><a id="l01471" name="l01471"></a><span class="lineno"> 1471</span>            }</div>
<div class="line"><a id="l01472" name="l01472"></a><span class="lineno"> 1472</span> </div>
<div class="line"><a id="l01473" name="l01473"></a><span class="lineno"> 1473</span>            $row = $rowTemplate;</div>
<div class="line"><a id="l01474" name="l01474"></a><span class="lineno"> 1474</span>            <span class="keywordflow">foreach</span> ($replacementKeys as $key) {</div>
<div class="line"><a id="l01475" name="l01475"></a><span class="lineno"> 1475</span>              $keyVariants = array_map(</div>
<div class="line"><a id="l01476" name="l01476"></a><span class="lineno"> 1476</span>                fn($key) =&gt; <span class="charliteral">&#39;[&#39;</span>.$key.<span class="charliteral">&#39;]&#39;</span>,</div>
<div class="line"><a id="l01477" name="l01477"></a><span class="lineno"> 1477</span>                $this-&gt;translationVariants($key)</div>
<div class="line"><a id="l01478" name="l01478"></a><span class="lineno"> 1478</span>              );</div>
<div class="line"><a id="l01479" name="l01479"></a><span class="lineno"> 1479</span>              $row = str_ireplace($keyVariants, $replacements[$key], $row);</div>
<div class="line"><a id="l01480" name="l01480"></a><span class="lineno"> 1480</span>            }</div>
<div class="line"><a id="l01481" name="l01481"></a><span class="lineno"> 1481</span>            $rowHtml .= $row;</div>
<div class="line"><a id="l01482" name="l01482"></a><span class="lineno"> 1482</span>          }</div>
<div class="line"><a id="l01483" name="l01483"></a><span class="lineno"> 1483</span> </div>
<div class="line"><a id="l01484" name="l01484"></a><span class="lineno"> 1484</span>          $headerReplacements = [</div>
<div class="line"><a id="l01485" name="l01485"></a><span class="lineno"> 1485</span>            <span class="stringliteral">&#39;purpose&#39;</span> =&gt; $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Purpose&#39;</span>),</div>
<div class="line"><a id="l01486" name="l01486"></a><span class="lineno"> 1486</span>            <span class="stringliteral">&#39;invoiced&#39;</span> =&gt; $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Invoice Amount&#39;</span>),</div>
<div class="line"><a id="l01487" name="l01487"></a><span class="lineno"> 1487</span>            <span class="stringliteral">&#39;totals&#39;</span> =&gt; $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Total Amount&#39;</span>),</div>
<div class="line"><a id="l01488" name="l01488"></a><span class="lineno"> 1488</span>            <span class="stringliteral">&#39;received&#39;</span> =&gt; $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Received&#39;</span>),</div>
<div class="line"><a id="l01489" name="l01489"></a><span class="lineno"> 1489</span>            <span class="stringliteral">&#39;remaining&#39;</span> =&gt; $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Remaining&#39;</span>),</div>
<div class="line"><a id="l01490" name="l01490"></a><span class="lineno"> 1490</span>          ];</div>
<div class="line"><a id="l01491" name="l01491"></a><span class="lineno"> 1491</span>          $headerHtml = $tableTemplate[<span class="stringliteral">&#39;header&#39;</span>];</div>
<div class="line"><a id="l01492" name="l01492"></a><span class="lineno"> 1492</span>          <span class="keywordflow">foreach</span> ($replacementKeys as $key) {</div>
<div class="line"><a id="l01493" name="l01493"></a><span class="lineno"> 1493</span>            $keyVariants = array_map(</div>
<div class="line"><a id="l01494" name="l01494"></a><span class="lineno"> 1494</span>              fn($key) =&gt; <span class="charliteral">&#39;[&#39;</span>.$key.<span class="charliteral">&#39;]&#39;</span>,</div>
<div class="line"><a id="l01495" name="l01495"></a><span class="lineno"> 1495</span>              $this-&gt;translationVariants($key)</div>
<div class="line"><a id="l01496" name="l01496"></a><span class="lineno"> 1496</span>            );</div>
<div class="line"><a id="l01497" name="l01497"></a><span class="lineno"> 1497</span>            $headerHtml = str_ireplace($keyVariants, $headerReplacements[$key], $headerHtml);</div>
<div class="line"><a id="l01498" name="l01498"></a><span class="lineno"> 1498</span>          }</div>
<div class="line"><a id="l01499" name="l01499"></a><span class="lineno"> 1499</span>          $cssClass = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l01500" name="l01500"></a><span class="lineno"> 1500</span>          <span class="keywordflow">if</span> ($receivedIsZero) {</div>
<div class="line"><a id="l01501" name="l01501"></a><span class="lineno"> 1501</span>            $cssClass = <span class="stringliteral">&#39; nothing-received-yet&#39;</span>;</div>
<div class="line"><a id="l01502" name="l01502"></a><span class="lineno"> 1502</span>          }</div>
<div class="line"><a id="l01503" name="l01503"></a><span class="lineno"> 1503</span>          $headerHtml = str_replace(<span class="stringliteral">&#39;[CSSCLASS]&#39;</span>, $cssClass, $headerHtml);</div>
<div class="line"><a id="l01504" name="l01504"></a><span class="lineno"> 1504</span> </div>
<div class="line"><a id="l01505" name="l01505"></a><span class="lineno"> 1505</span>          $footerHtml = $tableTemplate[<span class="stringliteral">&#39;footer&#39;</span>];</div>
<div class="line"><a id="l01506" name="l01506"></a><span class="lineno"> 1506</span>          <span class="keywordflow">foreach</span> ($replacementKeys as $key) {</div>
<div class="line"><a id="l01507" name="l01507"></a><span class="lineno"> 1507</span>            <span class="keywordflow">if</span> ($key != <span class="stringliteral">&#39;purpose&#39;</span>) {</div>
<div class="line"><a id="l01508" name="l01508"></a><span class="lineno"> 1508</span>              $totalSum[$key] = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aaeb05cf94149de0821a30628a8c7bcef">moneyValue</a>($totalSum[$key]);</div>
<div class="line"><a id="l01509" name="l01509"></a><span class="lineno"> 1509</span>            }</div>
<div class="line"><a id="l01510" name="l01510"></a><span class="lineno"> 1510</span>            $keyVariants = array_map(</div>
<div class="line"><a id="l01511" name="l01511"></a><span class="lineno"> 1511</span>              fn($key) =&gt; <span class="charliteral">&#39;[&#39;</span>.$key.<span class="charliteral">&#39;]&#39;</span>,</div>
<div class="line"><a id="l01512" name="l01512"></a><span class="lineno"> 1512</span>              $this-&gt;translationVariants($key)</div>
<div class="line"><a id="l01513" name="l01513"></a><span class="lineno"> 1513</span>            );</div>
<div class="line"><a id="l01514" name="l01514"></a><span class="lineno"> 1514</span>            $footerHtml = str_ireplace($keyVariants, $totalSum[$key], $footerHtml);</div>
<div class="line"><a id="l01515" name="l01515"></a><span class="lineno"> 1515</span>          }</div>
<div class="line"><a id="l01516" name="l01516"></a><span class="lineno"> 1516</span> </div>
<div class="line"><a id="l01517" name="l01517"></a><span class="lineno"> 1517</span>          <span class="keywordflow">return</span> $headerHtml . $rowHtml . $footerHtml;</div>
<div class="line"><a id="l01518" name="l01518"></a><span class="lineno"> 1518</span>        }</div>
<div class="line"><a id="l01519" name="l01519"></a><span class="lineno"> 1519</span> </div>
<div class="line"><a id="l01520" name="l01520"></a><span class="lineno"> 1520</span>        <span class="keywordflow">return</span> $keyArg[0];</div>
<div class="line"><a id="l01521" name="l01521"></a><span class="lineno"> 1521</span>      };</div>
<div class="line"><a id="l01522" name="l01522"></a><span class="lineno"> 1522</span> </div>
<div class="line"><a id="l01523" name="l01523"></a><span class="lineno"> 1523</span>    } <span class="comment">// bulk-transaction fields</span></div>
<div class="line"><a id="l01524" name="l01524"></a><span class="lineno"> 1524</span> </div>
<div class="line"><a id="l01525" name="l01525"></a><span class="lineno"> 1525</span>    <span class="comment">// Generate localized variable names</span></div>
<div class="line"><a id="l01526" name="l01526"></a><span class="lineno"> 1526</span>    <span class="keywordflow">foreach</span> ($this-&gt;substitutions as $nameSpace =&gt; $replacements) {</div>
<div class="line"><a id="l01527" name="l01527"></a><span class="lineno"> 1527</span>      <span class="keywordflow">foreach</span> ($replacements as $key =&gt; $handler) {</div>
<div class="line"><a id="l01528" name="l01528"></a><span class="lineno"> 1528</span>        $this-&gt;substitutions[$nameSpace][$this-&gt;l-&gt;t($key)] = <span class="keyword">function</span>(array $keyArg, ?Entities\Musician $musician) use ($handler, $key) {</div>
<div class="line"><a id="l01529" name="l01529"></a><span class="lineno"> 1529</span>          $keyArg[0] = $key;</div>
<div class="line"><a id="l01530" name="l01530"></a><span class="lineno"> 1530</span>          <span class="keywordflow">return</span> $handler($keyArg, $musician);</div>
<div class="line"><a id="l01531" name="l01531"></a><span class="lineno"> 1531</span>        };</div>
<div class="line"><a id="l01532" name="l01532"></a><span class="lineno"> 1532</span>      }</div>
<div class="line"><a id="l01533" name="l01533"></a><span class="lineno"> 1533</span>    }</div>
<div class="line"><a id="l01534" name="l01534"></a><span class="lineno"> 1534</span>  }</div>
<div class="line"><a id="l01535" name="l01535"></a><span class="lineno"> 1535</span> </div>
<div class="line"><a id="l01550" name="l01550"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8e77623277f1542549bfd7ae557512eb"> 1550</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8e77623277f1542549bfd7ae557512eb">hasSubstitutionNamespace</a>(<span class="keywordtype">string</span> $nameSpace, ?<span class="keywordtype">string</span> $message = <span class="keyword">null</span>)</div>
<div class="line"><a id="l01551" name="l01551"></a><span class="lineno"> 1551</span>  {</div>
<div class="line"><a id="l01552" name="l01552"></a><span class="lineno"> 1552</span>    <span class="keywordflow">if</span> (empty($message)) {</div>
<div class="line"><a id="l01553" name="l01553"></a><span class="lineno"> 1553</span>      $message = $this-&gt;messageContents;</div>
<div class="line"><a id="l01554" name="l01554"></a><span class="lineno"> 1554</span>    }</div>
<div class="line"><a id="l01555" name="l01555"></a><span class="lineno"> 1555</span> </div>
<div class="line"><a id="l01556" name="l01556"></a><span class="lineno"> 1556</span>    <span class="keywordflow">return</span> preg_match(<span class="stringliteral">&#39;/([^$]|^)[$]{(&#39;</span>.$nameSpace.<span class="charliteral">&#39;|&#39;</span>.$this-&gt;l-&gt;t($nameSpace).<span class="stringliteral">&#39;)(.)\3(.*?)(?&lt;!\\\&zwj;)}/u&#39;</span>, $message);</div>
<div class="line"><a id="l01557" name="l01557"></a><span class="lineno"> 1557</span>  }</div>
<div class="line"><a id="l01558" name="l01558"></a><span class="lineno"> 1558</span> </div>
<div class="line"><a id="l01576" name="l01576"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a858b467638cc7c967dd04b9fb1272c73"> 1576</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a858b467638cc7c967dd04b9fb1272c73">replaceFormVariables</a>(<span class="keywordtype">string</span> $nameSpace, mixed $data = <span class="keyword">null</span>, ?<span class="keywordtype">string</span> $message = <span class="keyword">null</span>, ?array &amp;$failures = <span class="keyword">null</span>):string</div>
<div class="line"><a id="l01577" name="l01577"></a><span class="lineno"> 1577</span>  {</div>
<div class="line"><a id="l01578" name="l01578"></a><span class="lineno"> 1578</span>    <span class="keywordflow">if</span> (empty($message)) {</div>
<div class="line"><a id="l01579" name="l01579"></a><span class="lineno"> 1579</span>      $message = $this-&gt;messageContents;</div>
<div class="line"><a id="l01580" name="l01580"></a><span class="lineno"> 1580</span>    }</div>
<div class="line"><a id="l01581" name="l01581"></a><span class="lineno"> 1581</span> </div>
<div class="line"><a id="l01582" name="l01582"></a><span class="lineno"> 1582</span>    <span class="keywordflow">if</span> (empty($this-&gt;substitutions)) {</div>
<div class="line"><a id="l01583" name="l01583"></a><span class="lineno"> 1583</span>      $this-&gt;generateSubstitutionHandlers();</div>
<div class="line"><a id="l01584" name="l01584"></a><span class="lineno"> 1584</span>    }</div>
<div class="line"><a id="l01585" name="l01585"></a><span class="lineno"> 1585</span> </div>
<div class="line"><a id="l01586" name="l01586"></a><span class="lineno"> 1586</span>    $regexp = <span class="stringliteral">&#39;/([^$]|^)(?:[$]|%24)(?:{|%7B)(&#39;</span>.$nameSpace.<span class="charliteral">&#39;|&#39;</span>.$this-&gt;l-&gt;t($nameSpace).<span class="stringliteral">&#39;)(.)\3(.*?)(?&lt;!\\\\)(?:}|%7D)/u&#39;</span>;</div>
<div class="line"><a id="l01587" name="l01587"></a><span class="lineno"> 1587</span>    <span class="keywordflow">return</span> preg_replace_callback(</div>
<div class="line"><a id="l01588" name="l01588"></a><span class="lineno"> 1588</span>      $regexp,</div>
<div class="line"><a id="l01589" name="l01589"></a><span class="lineno"> 1589</span>      <span class="keyword">function</span>($matches) use ($data, &amp;$failures) {</div>
<div class="line"><a id="l01590" name="l01590"></a><span class="lineno"> 1590</span>        $prefix = $matches[1]; <span class="comment">// in order not to substitute $$</span></div>
<div class="line"><a id="l01591" name="l01591"></a><span class="lineno"> 1591</span>        $nameSpace = html_entity_decode($matches[2], ENT_HTML5, <span class="stringliteral">&#39;UTF-8&#39;</span>);</div>
<div class="line"><a id="l01592" name="l01592"></a><span class="lineno"> 1592</span>        $separator = $matches[3];</div>
<div class="line"><a id="l01593" name="l01593"></a><span class="lineno"> 1593</span>        $variable  = array_map(<span class="keyword">function</span>($value) {</div>
<div class="line"><a id="l01594" name="l01594"></a><span class="lineno"> 1594</span>          <span class="keywordflow">return</span> preg_replace(<span class="stringliteral">&#39;/\\\\(.)/u&#39;</span>, <span class="stringliteral">&#39;$1&#39;</span>, html_entity_decode($value, ENT_HTML5, <span class="stringliteral">&#39;UTF-8&#39;</span>));</div>
<div class="line"><a id="l01595" name="l01595"></a><span class="lineno"> 1595</span>        }, explode($separator, $matches[4]));</div>
<div class="line"><a id="l01596" name="l01596"></a><span class="lineno"> 1596</span>        $handler = $this-&gt;substitutions[$nameSpace][$variable[0]]??<span class="keyword">null</span>;</div>
<div class="line"><a id="l01597" name="l01597"></a><span class="lineno"> 1597</span>        <span class="keywordflow">if</span> (empty($handler) || !is_callable($handler)) {</div>
<div class="line"><a id="l01598" name="l01598"></a><span class="lineno"> 1598</span>          <span class="keywordflow">if</span> (!is_array($failures)) {</div>
<div class="line"><a id="l01599" name="l01599"></a><span class="lineno"> 1599</span>            <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_exceptions_1_1_substitution_exception.html">Exceptions\SubstitutionException</a>($this-&gt;l-&gt;t(<span class="stringliteral">&#39;No substitution handler found for &quot;%s%s%s&quot;.&#39;</span>, [ $nameSpace, $separator.$separator, $variable[0] ]));</div>
<div class="line"><a id="l01600" name="l01600"></a><span class="lineno"> 1600</span>          } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01601" name="l01601"></a><span class="lineno"> 1601</span>            $failures[] = [</div>
<div class="line"><a id="l01602" name="l01602"></a><span class="lineno"> 1602</span>              <span class="stringliteral">&#39;namespace&#39;</span> =&gt; $nameSpace,</div>
<div class="line"><a id="l01603" name="l01603"></a><span class="lineno"> 1603</span>              <span class="stringliteral">&#39;variable&#39;</span> =&gt; $variable,</div>
<div class="line"><a id="l01604" name="l01604"></a><span class="lineno"> 1604</span>              <span class="stringliteral">&#39;error&#39;</span> =&gt; <span class="stringliteral">&#39;unknown&#39;</span>,</div>
<div class="line"><a id="l01605" name="l01605"></a><span class="lineno"> 1605</span>            ];</div>
<div class="line"><a id="l01606" name="l01606"></a><span class="lineno"> 1606</span>          }</div>
<div class="line"><a id="l01607" name="l01607"></a><span class="lineno"> 1607</span>          <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l01608" name="l01608"></a><span class="lineno"> 1608</span>        }</div>
<div class="line"><a id="l01609" name="l01609"></a><span class="lineno"> 1609</span>        <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l01610" name="l01610"></a><span class="lineno"> 1610</span>          <span class="keywordflow">return</span> $prefix.call_user_func($handler, $variable, $data);</div>
<div class="line"><a id="l01611" name="l01611"></a><span class="lineno"> 1611</span>        } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l01612" name="l01612"></a><span class="lineno"> 1612</span>          <span class="keywordflow">if</span> (!is_array($failures)) {</div>
<div class="line"><a id="l01613" name="l01613"></a><span class="lineno"> 1613</span>            <span class="keywordflow">throw</span> $t;</div>
<div class="line"><a id="l01614" name="l01614"></a><span class="lineno"> 1614</span>          }</div>
<div class="line"><a id="l01615" name="l01615"></a><span class="lineno"> 1615</span>          $this-&gt;logException($t);</div>
<div class="line"><a id="l01616" name="l01616"></a><span class="lineno"> 1616</span>          $failures[] = [</div>
<div class="line"><a id="l01617" name="l01617"></a><span class="lineno"> 1617</span>            <span class="stringliteral">&#39;namespace&#39;</span> =&gt; $nameSpace,</div>
<div class="line"><a id="l01618" name="l01618"></a><span class="lineno"> 1618</span>            <span class="stringliteral">&#39;variable&#39;</span> =&gt; $variable,</div>
<div class="line"><a id="l01619" name="l01619"></a><span class="lineno"> 1619</span>            <span class="stringliteral">&#39;error&#39;</span> =&gt; <span class="stringliteral">&#39;substitution&#39;</span>,</div>
<div class="line"><a id="l01620" name="l01620"></a><span class="lineno"> 1620</span>            <span class="stringliteral">&#39;exception&#39;</span> =&gt; $t-&gt;getMessage(),</div>
<div class="line"><a id="l01621" name="l01621"></a><span class="lineno"> 1621</span>          ];</div>
<div class="line"><a id="l01622" name="l01622"></a><span class="lineno"> 1622</span>        }</div>
<div class="line"><a id="l01623" name="l01623"></a><span class="lineno"> 1623</span>        <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// replace with empty string in case of error</span></div>
<div class="line"><a id="l01624" name="l01624"></a><span class="lineno"> 1624</span>      },</div>
<div class="line"><a id="l01625" name="l01625"></a><span class="lineno"> 1625</span>      $message);</div>
<div class="line"><a id="l01626" name="l01626"></a><span class="lineno"> 1626</span>  }</div>
<div class="line"><a id="l01627" name="l01627"></a><span class="lineno"> 1627</span> </div>
<div class="line"><a id="l01636" name="l01636"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad9a0cdb1a4120677afc94f22b45b6f1f"> 1636</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad9a0cdb1a4120677afc94f22b45b6f1f">finalizeSubstitutions</a>(?<span class="keywordtype">string</span> $message = <span class="keyword">null</span>):string</div>
<div class="line"><a id="l01637" name="l01637"></a><span class="lineno"> 1637</span>  {</div>
<div class="line"><a id="l01638" name="l01638"></a><span class="lineno"> 1638</span>    <span class="keywordflow">if</span> (empty($message)) {</div>
<div class="line"><a id="l01639" name="l01639"></a><span class="lineno"> 1639</span>      $message = $this-&gt;messageContents;</div>
<div class="line"><a id="l01640" name="l01640"></a><span class="lineno"> 1640</span>    }</div>
<div class="line"><a id="l01641" name="l01641"></a><span class="lineno"> 1641</span> </div>
<div class="line"><a id="l01642" name="l01642"></a><span class="lineno"> 1642</span>    <span class="keywordflow">return</span> str_replace(<span class="stringliteral">&#39;$$&#39;</span>, <span class="charliteral">&#39;$&#39;</span>, $message);</div>
<div class="line"><a id="l01643" name="l01643"></a><span class="lineno"> 1643</span>  }</div>
<div class="line"><a id="l01644" name="l01644"></a><span class="lineno"> 1644</span> </div>
<div class="line"><a id="l01652" name="l01652"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac5976a0a50b5addf24a0bd26280f2772"> 1652</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac5976a0a50b5addf24a0bd26280f2772">discloseRecipients</a>():bool</div>
<div class="line"><a id="l01653" name="l01653"></a><span class="lineno"> 1653</span>  {</div>
<div class="line"><a id="l01654" name="l01654"></a><span class="lineno"> 1654</span>    <span class="keywordflow">return</span> $this-&gt;projectId &gt;= 0</div>
<div class="line"><a id="l01655" name="l01655"></a><span class="lineno"> 1655</span>      &amp;&amp; (</div>
<div class="line"><a id="l01656" name="l01656"></a><span class="lineno"> 1656</span>        filter_var(</div>
<div class="line"><a id="l01657" name="l01657"></a><span class="lineno"> 1657</span>          $this-&gt;cgiValue(<span class="stringliteral">&#39;disclosedRecipients&#39;</span>, <span class="stringliteral">&#39;off&#39;</span>),</div>
<div class="line"><a id="l01658" name="l01658"></a><span class="lineno"> 1658</span>          FILTER_VALIDATE_BOOLEAN,</div>
<div class="line"><a id="l01659" name="l01659"></a><span class="lineno"> 1659</span>          FILTER_NULL_ON_FAILURE)</div>
<div class="line"><a id="l01660" name="l01660"></a><span class="lineno"> 1660</span>        ??<span class="keyword">false</span>);</div>
<div class="line"><a id="l01661" name="l01661"></a><span class="lineno"> 1661</span>  }</div>
<div class="line"><a id="l01662" name="l01662"></a><span class="lineno"> 1662</span> </div>
<div class="line"><a id="l01670" name="l01670"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac9b7ecf11f96b66f5b50b296815ace81"> 1670</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac9b7ecf11f96b66f5b50b296815ace81">sendMessages</a>():bool</div>
<div class="line"><a id="l01671" name="l01671"></a><span class="lineno"> 1671</span>  {</div>
<div class="line"><a id="l01672" name="l01672"></a><span class="lineno"> 1672</span>    $this-&gt;diagnostics[self::DIAGNOSTICS_STAGE] = self::DIAGNOSTICS_STAGE_SEND;</div>
<div class="line"><a id="l01673" name="l01673"></a><span class="lineno"> 1673</span> </div>
<div class="line"><a id="l01674" name="l01674"></a><span class="lineno"> 1674</span>    <span class="keywordflow">if</span> (!$this-&gt;preComposeValidation($this-&gt;recipients)) {</div>
<div class="line"><a id="l01675" name="l01675"></a><span class="lineno"> 1675</span>      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l01676" name="l01676"></a><span class="lineno"> 1676</span>    }</div>
<div class="line"><a id="l01677" name="l01677"></a><span class="lineno"> 1677</span> </div>
<div class="line"><a id="l01678" name="l01678"></a><span class="lineno"> 1678</span>    <span class="comment">// Checks passed, let&#39;s see what happens. The mailer may throw</span></div>
<div class="line"><a id="l01679" name="l01679"></a><span class="lineno"> 1679</span>    <span class="comment">// any kind of &quot;nasty&quot; exceptions.</span></div>
<div class="line"><a id="l01680" name="l01680"></a><span class="lineno"> 1680</span>    $this-&gt;doSendMessages();</div>
<div class="line"><a id="l01681" name="l01681"></a><span class="lineno"> 1681</span>    <span class="keywordflow">if</span> (!$this-&gt;errorStatus()) {</div>
<div class="line"><a id="l01682" name="l01682"></a><span class="lineno"> 1682</span>      <span class="comment">// Hurray!!!</span></div>
<div class="line"><a id="l01683" name="l01683"></a><span class="lineno"> 1683</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_CAPTION] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Message(s) sent out successfully!&#39;</span>);</div>
<div class="line"><a id="l01684" name="l01684"></a><span class="lineno"> 1684</span> </div>
<div class="line"><a id="l01685" name="l01685"></a><span class="lineno"> 1685</span>      <span class="comment">// If sending out a draft, remove the draft.</span></div>
<div class="line"><a id="l01686" name="l01686"></a><span class="lineno"> 1686</span>      $this-&gt;deleteDraft();</div>
<div class="line"><a id="l01687" name="l01687"></a><span class="lineno"> 1687</span>    }</div>
<div class="line"><a id="l01688" name="l01688"></a><span class="lineno"> 1688</span>    <span class="keywordflow">return</span> $this-&gt;executionStatus;</div>
<div class="line"><a id="l01689" name="l01689"></a><span class="lineno"> 1689</span>  }</div>
<div class="line"><a id="l01690" name="l01690"></a><span class="lineno"> 1690</span> </div>
<div class="line"><a id="l01698" name="l01698"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a4eba5485d3006dee315412a6e8cce42e"> 1698</a></span>  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a4eba5485d3006dee315412a6e8cce42e">emitHtmlBodyStyle</a>(<span class="keywordtype">string</span> $style, ?<span class="keywordtype">string</span> $cssPrefix = <span class="keyword">null</span>):string</div>
<div class="line"><a id="l01699" name="l01699"></a><span class="lineno"> 1699</span>  {</div>
<div class="line"><a id="l01700" name="l01700"></a><span class="lineno"> 1700</span>    <span class="keywordflow">return</span> str_replace(<span class="stringliteral">&#39;[CSSPREFIX]&#39;</span>, empty($cssPrefix) ? <span class="stringliteral">&#39;&#39;</span> : ($cssPrefix . <span class="charliteral">&#39; &#39;</span>), $style);</div>
<div class="line"><a id="l01701" name="l01701"></a><span class="lineno"> 1701</span>  }</div>
<div class="line"><a id="l01702" name="l01702"></a><span class="lineno"> 1702</span> </div>
<div class="line"><a id="l01727" name="l01727"></a><span class="lineno"> 1727</span>  <span class="keyword">private</span> <span class="keyword">function</span> doSendMessages():bool</div>
<div class="line"><a id="l01728" name="l01728"></a><span class="lineno"> 1728</span>  {</div>
<div class="line"><a id="l01729" name="l01729"></a><span class="lineno"> 1729</span>    $messageTemplate = implode(<span class="stringliteral">&quot;\n&quot;</span>, array_map([ $this, <span class="stringliteral">&#39;emitHtmlBodyStyle&#39;</span> ], self::DEFAULT_HTML_STYLES))</div>
<div class="line"><a id="l01730" name="l01730"></a><span class="lineno"> 1730</span>      . $this-&gt;replaceFormVariables(self::GLOBAL_NAMESPACE);</div>
<div class="line"><a id="l01731" name="l01731"></a><span class="lineno"> 1731</span> </div>
<div class="line"><a id="l01732" name="l01732"></a><span class="lineno"> 1732</span>    <span class="keywordflow">if</span> (!$this-&gt;validateMessageHtml($messageTemplate)) {</div>
<div class="line"><a id="l01733" name="l01733"></a><span class="lineno"> 1733</span>      $this-&gt;logInfo(<span class="stringliteral">&#39;VALIDATION FAILED&#39;</span>);</div>
<div class="line"><a id="l01734" name="l01734"></a><span class="lineno"> 1734</span>    }</div>
<div class="line"><a id="l01735" name="l01735"></a><span class="lineno"> 1735</span> </div>
<div class="line"><a id="l01736" name="l01736"></a><span class="lineno"> 1736</span>    $hasPersonalSubstitutions = $this-&gt;hasSubstitutionNamespace(self::MEMBER_NAMESPACE, $messageTemplate);</div>
<div class="line"><a id="l01737" name="l01737"></a><span class="lineno"> 1737</span>    $hasPersonalAttachments = $this-&gt;activePersonalAttachments() &gt; 0;</div>
<div class="line"><a id="l01738" name="l01738"></a><span class="lineno"> 1738</span> </div>
<div class="line"><a id="l01739" name="l01739"></a><span class="lineno"> 1739</span>    $references = [];</div>
<div class="line"><a id="l01740" name="l01740"></a><span class="lineno"> 1740</span>    $templateMessageId = $this-&gt;getOutboundService()-&gt;generateMessageId();</div>
<div class="line"><a id="l01741" name="l01741"></a><span class="lineno"> 1741</span> </div>
<div class="line"><a id="l01742" name="l01742"></a><span class="lineno"> 1742</span>    <span class="keywordflow">if</span> ($hasPersonalSubstitutions || $hasPersonalAttachments) {</div>
<div class="line"><a id="l01743" name="l01743"></a><span class="lineno"> 1743</span> </div>
<div class="line"><a id="l01744" name="l01744"></a><span class="lineno"> 1744</span>      $this-&gt;logInfo(</div>
<div class="line"><a id="l01745" name="l01745"></a><span class="lineno"> 1745</span>        <span class="stringliteral">&#39;Sending separately because of personal substitutions / attachments &#39;</span></div>
<div class="line"><a id="l01746" name="l01746"></a><span class="lineno"> 1746</span>        . (<span class="keywordtype">int</span>)$hasPersonalSubstitutions</div>
<div class="line"><a id="l01747" name="l01747"></a><span class="lineno"> 1747</span>        . <span class="stringliteral">&#39; / &#39;</span></div>
<div class="line"><a id="l01748" name="l01748"></a><span class="lineno"> 1748</span>        . (<span class="keywordtype">int</span>)$hasPersonalAttachments);</div>
<div class="line"><a id="l01749" name="l01749"></a><span class="lineno"> 1749</span> </div>
<div class="line"><a id="l01750" name="l01750"></a><span class="lineno"> 1750</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_PAYLOAD] = count($this-&gt;recipients)+1;</div>
<div class="line"><a id="l01751" name="l01751"></a><span class="lineno"> 1751</span> </div>
<div class="line"><a id="l01752" name="l01752"></a><span class="lineno"> 1752</span>      <span class="keywordflow">foreach</span> ($this-&gt;recipients as $recipient) {</div>
<div class="line"><a id="l01753" name="l01753"></a><span class="lineno"> 1753</span>        ++$this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_COUNT];</div>
<div class="line"><a id="l01754" name="l01754"></a><span class="lineno"> 1754</span> </div>
<div class="line"><a id="l01756" name="l01756"></a><span class="lineno"> 1756</span>        $musician = $recipient[<span class="stringliteral">&#39;dbdata&#39;</span>];</div>
<div class="line"><a id="l01757" name="l01757"></a><span class="lineno"> 1757</span> </div>
<div class="line"><a id="l01758" name="l01758"></a><span class="lineno"> 1758</span>        $this-&gt;implicitFileAttachments = [];</div>
<div class="line"><a id="l01759" name="l01759"></a><span class="lineno"> 1759</span>        $strMessage = $this-&gt;replaceFormVariables(self::MEMBER_NAMESPACE, $musician, $messageTemplate);</div>
<div class="line"><a id="l01760" name="l01760"></a><span class="lineno"> 1760</span>        $strMessage = $this-&gt;finalizeSubstitutions($strMessage);</div>
<div class="line"><a id="l01761" name="l01761"></a><span class="lineno"> 1761</span> </div>
<div class="line"><a id="l01762" name="l01762"></a><span class="lineno"> 1762</span>        $this-&gt;implicitFileAttachments = array_values(array_unique($this-&gt;implicitFileAttachments));</div>
<div class="line"><a id="l01763" name="l01763"></a><span class="lineno"> 1763</span>        <span class="keywordflow">if</span> (!empty($this-&gt;implicitFileAttachments)) {</div>
<div class="line"><a id="l01764" name="l01764"></a><span class="lineno"> 1764</span>          $this-&gt;personalFileAttachments = <span class="keyword">null</span>; <span class="comment">// have to void it ...</span></div>
<div class="line"><a id="l01765" name="l01765"></a><span class="lineno"> 1765</span>          $this-&gt;cgiData[<span class="stringliteral">&#39;attachedFiles&#39;</span>] = array_values(</div>
<div class="line"><a id="l01766" name="l01766"></a><span class="lineno"> 1766</span>            array_unique(</div>
<div class="line"><a id="l01767" name="l01767"></a><span class="lineno"> 1767</span>              array_merge(</div>
<div class="line"><a id="l01768" name="l01768"></a><span class="lineno"> 1768</span>                $this-&gt;cgiData[<span class="stringliteral">&#39;attachedFiles&#39;</span>]??[],</div>
<div class="line"><a id="l01769" name="l01769"></a><span class="lineno"> 1769</span>                $this-&gt;implicitFileAttachments??[]</div>
<div class="line"><a id="l01770" name="l01770"></a><span class="lineno"> 1770</span>              )));</div>
<div class="line"><a id="l01771" name="l01771"></a><span class="lineno"> 1771</span>        }</div>
<div class="line"><a id="l01772" name="l01772"></a><span class="lineno"> 1772</span>        $personalAttachments = $this-&gt;composePersonalAttachments($musician);</div>
<div class="line"><a id="l01773" name="l01773"></a><span class="lineno"> 1773</span> </div>
<div class="line"><a id="l01774" name="l01774"></a><span class="lineno"> 1774</span>        <span class="comment">// we should not send the message out if the generation of the</span></div>
<div class="line"><a id="l01775" name="l01775"></a><span class="lineno"> 1775</span>        <span class="comment">// personal attachment has failed.</span></div>
<div class="line"><a id="l01776" name="l01776"></a><span class="lineno"> 1776</span>        <span class="keywordflow">if</span> (!empty($this-&gt;diagnostics[self::DIAGNOSTICS_ATTACHMENT_VALIDATION][<span class="stringliteral">&#39;Personal&#39;</span>][$musician-&gt;getId()])) {</div>
<div class="line"><a id="l01777" name="l01777"></a><span class="lineno"> 1777</span>          ++$this-&gt;diagnostics[self::DIAGNOSTICS_FAILED_COUNT];</div>
<div class="line"><a id="l01778" name="l01778"></a><span class="lineno"> 1778</span>          <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01779" name="l01779"></a><span class="lineno"> 1779</span>        }</div>
<div class="line"><a id="l01780" name="l01780"></a><span class="lineno"> 1780</span> </div>
<div class="line"><a id="l01781" name="l01781"></a><span class="lineno"> 1781</span>        $msg = $this-&gt;composeAndSend(</div>
<div class="line"><a id="l01782" name="l01782"></a><span class="lineno"> 1782</span>          $strMessage, [ $recipient ], $personalAttachments,</div>
<div class="line"><a id="l01783" name="l01783"></a><span class="lineno"> 1783</span>          addCC: <span class="keyword">false</span>,</div>
<div class="line"><a id="l01784" name="l01784"></a><span class="lineno"> 1784</span>          references: $templateMessageId,</div>
<div class="line"><a id="l01785" name="l01785"></a><span class="lineno"> 1785</span>          customHeaders: self::HEADER_MARKER_RECIPIENT,</div>
<div class="line"><a id="l01786" name="l01786"></a><span class="lineno"> 1786</span>        );</div>
<div class="line"><a id="l01787" name="l01787"></a><span class="lineno"> 1787</span>        <span class="keywordflow">if</span> (!empty($msg[<span class="stringliteral">&#39;message&#39;</span>])) {</div>
<div class="line"><a id="l01788" name="l01788"></a><span class="lineno"> 1788</span>          $this-&gt;copyToSentFolder($msg[<span class="stringliteral">&#39;message&#39;</span>]);</div>
<div class="line"><a id="l01789" name="l01789"></a><span class="lineno"> 1789</span>          $messageId =  $msg[<span class="stringliteral">&#39;messageId&#39;</span>];</div>
<div class="line"><a id="l01790" name="l01790"></a><span class="lineno"> 1790</span>          $references[] = $messageId;</div>
<div class="line"><a id="l01791" name="l01791"></a><span class="lineno"> 1791</span> </div>
<div class="line"><a id="l01792" name="l01792"></a><span class="lineno"> 1792</span>          <span class="comment">// Don&#39;t remember the individual emails, but for</span></div>
<div class="line"><a id="l01793" name="l01793"></a><span class="lineno"> 1793</span>          <span class="comment">// debit-mandates record the message id, ignore errors.</span></div>
<div class="line"><a id="l01794" name="l01794"></a><span class="lineno"> 1794</span>          <span class="keywordflow">if</span> (!empty($this-&gt;bulkTransaction)) {</div>
<div class="line"><a id="l01795" name="l01795"></a><span class="lineno"> 1795</span>            $payment = $this-&gt;bulkTransaction-&gt;getPayment($musician);</div>
<div class="line"><a id="l01796" name="l01796"></a><span class="lineno"> 1796</span>            <span class="keywordflow">if</span> (empty($payment)) {</div>
<div class="line"><a id="l01797" name="l01797"></a><span class="lineno"> 1797</span>              <span class="comment">// this must not happen</span></div>
<div class="line"><a id="l01798" name="l01798"></a><span class="lineno"> 1798</span>              <span class="keywordflow">throw</span> <span class="keyword">new</span> Exceptions\DatabaseEntityNotFoundException(</div>
<div class="line"><a id="l01799" name="l01799"></a><span class="lineno"> 1799</span>                $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Unable to find a payment for the musician &quot;%s&quot; (transaction %d)&#39;</span>, [</div>
<div class="line"><a id="l01800" name="l01800"></a><span class="lineno"> 1800</span>                  $musician-&gt;getPublicName(), $this-&gt;bulkTransactionId</div>
<div class="line"><a id="l01801" name="l01801"></a><span class="lineno"> 1801</span>                ])</div>
<div class="line"><a id="l01802" name="l01802"></a><span class="lineno"> 1802</span>              );</div>
<div class="line"><a id="l01803" name="l01803"></a><span class="lineno"> 1803</span>            }</div>
<div class="line"><a id="l01804" name="l01804"></a><span class="lineno"> 1804</span>            $payment-&gt;setNotificationMessageId($messageId);</div>
<div class="line"><a id="l01805" name="l01805"></a><span class="lineno"> 1805</span>            <span class="comment">// $this-&gt;flush();</span></div>
<div class="line"><a id="l01806" name="l01806"></a><span class="lineno"> 1806</span>          }</div>
<div class="line"><a id="l01807" name="l01807"></a><span class="lineno"> 1807</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01808" name="l01808"></a><span class="lineno"> 1808</span>          ++$this-&gt;diagnostics[self::DIAGNOSTICS_FAILED_COUNT];</div>
<div class="line"><a id="l01809" name="l01809"></a><span class="lineno"> 1809</span>        }</div>
<div class="line"><a id="l01810" name="l01810"></a><span class="lineno"> 1810</span>      }</div>
<div class="line"><a id="l01811" name="l01811"></a><span class="lineno"> 1811</span> </div>
<div class="line"><a id="l01812" name="l01812"></a><span class="lineno"> 1812</span>      <span class="comment">// Finally send one message without template substitution (as this makes</span></div>
<div class="line"><a id="l01813" name="l01813"></a><span class="lineno"> 1813</span>      <span class="comment">// no sense) to all Cc:, Bcc: recipients and the catch-all. This Message</span></div>
<div class="line"><a id="l01814" name="l01814"></a><span class="lineno"> 1814</span>      <span class="comment">// also gets copied to the Sent-folder on the imap server. This message</span></div>
<div class="line"><a id="l01815" name="l01815"></a><span class="lineno"> 1815</span>      <span class="comment">// is allowed to fail the duplicates check as form-letters for standard</span></div>
<div class="line"><a id="l01816" name="l01816"></a><span class="lineno"> 1816</span>      <span class="comment">// purposes naturally generate duplicates.</span></div>
<div class="line"><a id="l01817" name="l01817"></a><span class="lineno"> 1817</span> </div>
<div class="line"><a id="l01818" name="l01818"></a><span class="lineno"> 1818</span>      ++$this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_COUNT];</div>
<div class="line"><a id="l01819" name="l01819"></a><span class="lineno"> 1819</span>      $mimeMsg = $this-&gt;composeAndSend(</div>
<div class="line"><a id="l01820" name="l01820"></a><span class="lineno"> 1820</span>        $messageTemplate, [],</div>
<div class="line"><a id="l01821" name="l01821"></a><span class="lineno"> 1821</span>        addCC: <span class="keyword">true</span>,</div>
<div class="line"><a id="l01822" name="l01822"></a><span class="lineno"> 1822</span>        messageId: $templateMessageId,</div>
<div class="line"><a id="l01823" name="l01823"></a><span class="lineno"> 1823</span>        references: $references,</div>
<div class="line"><a id="l01824" name="l01824"></a><span class="lineno"> 1824</span>        customHeaders: self::HEADER_MARKER_SENT,</div>
<div class="line"><a id="l01825" name="l01825"></a><span class="lineno"> 1825</span>        doNotReply: <span class="keyword">true</span>,</div>
<div class="line"><a id="l01826" name="l01826"></a><span class="lineno"> 1826</span>        allowDuplicates: <span class="keyword">true</span>,</div>
<div class="line"><a id="l01827" name="l01827"></a><span class="lineno"> 1827</span>      );</div>
<div class="line"><a id="l01828" name="l01828"></a><span class="lineno"> 1828</span>      <span class="keywordflow">if</span> (!empty($mimeMsg[<span class="stringliteral">&#39;message&#39;</span>])) {</div>
<div class="line"><a id="l01829" name="l01829"></a><span class="lineno"> 1829</span>        $this-&gt;copyToSentFolder($mimeMsg[<span class="stringliteral">&#39;message&#39;</span>]);</div>
<div class="line"><a id="l01830" name="l01830"></a><span class="lineno"> 1830</span>        $this-&gt;recordMessageDiagnostics($mimeMsg[<span class="stringliteral">&#39;message&#39;</span>]);</div>
<div class="line"><a id="l01831" name="l01831"></a><span class="lineno"> 1831</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01832" name="l01832"></a><span class="lineno"> 1832</span>        ++$this-&gt;diagnostics[self::DIAGNOSTICS_FAILED_COUNT];</div>
<div class="line"><a id="l01833" name="l01833"></a><span class="lineno"> 1833</span>      }</div>
<div class="line"><a id="l01834" name="l01834"></a><span class="lineno"> 1834</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01835" name="l01835"></a><span class="lineno"> 1835</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_PAYLOAD] = 1;</div>
<div class="line"><a id="l01836" name="l01836"></a><span class="lineno"> 1836</span>      ++$this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_COUNT]; <span class="comment">// this is ONE then ...</span></div>
<div class="line"><a id="l01837" name="l01837"></a><span class="lineno"> 1837</span> </div>
<div class="line"><a id="l01838" name="l01838"></a><span class="lineno"> 1838</span>      $recipients = $this-&gt;recipients;</div>
<div class="line"><a id="l01839" name="l01839"></a><span class="lineno"> 1839</span> </div>
<div class="line"><a id="l01840" name="l01840"></a><span class="lineno"> 1840</span>      $announcementsList = $this-&gt;recipientsFilter-&gt;substituteAnnouncementsMailingList($recipients);</div>
<div class="line"><a id="l01841" name="l01841"></a><span class="lineno"> 1841</span>      <span class="keywordflow">if</span> ($announcementsList) {</div>
<div class="line"><a id="l01842" name="l01842"></a><span class="lineno"> 1842</span>        $this-&gt;setSubjectTag(RecipientsFilter::ANNOUNCEMENTS_MAILING_LIST);</div>
<div class="line"><a id="l01843" name="l01843"></a><span class="lineno"> 1843</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01844" name="l01844"></a><span class="lineno"> 1844</span>        <span class="comment">// if in project mode potentially send to the mailing list instead of the individual recipients ...</span></div>
<div class="line"><a id="l01845" name="l01845"></a><span class="lineno"> 1845</span>        $projectList = $this-&gt;recipientsFilter-&gt;substituteProjectMailingList($recipients);</div>
<div class="line"><a id="l01846" name="l01846"></a><span class="lineno"> 1846</span>        <span class="keywordflow">if</span> ($projectList) {</div>
<div class="line"><a id="l01847" name="l01847"></a><span class="lineno"> 1847</span>          $this-&gt;setSubjectTag(RecipientsFilter::PROJECT_MAILING_LIST);</div>
<div class="line"><a id="l01848" name="l01848"></a><span class="lineno"> 1848</span>        }</div>
<div class="line"><a id="l01849" name="l01849"></a><span class="lineno"> 1849</span>      }</div>
<div class="line"><a id="l01850" name="l01850"></a><span class="lineno"> 1850</span> </div>
<div class="line"><a id="l01851" name="l01851"></a><span class="lineno"> 1851</span>      $mimeMsg = $this-&gt;composeAndSend($messageTemplate, $recipients);</div>
<div class="line"><a id="l01852" name="l01852"></a><span class="lineno"> 1852</span>      <span class="keywordflow">if</span> (!empty($mimeMsg[<span class="stringliteral">&#39;message&#39;</span>])) {</div>
<div class="line"><a id="l01853" name="l01853"></a><span class="lineno"> 1853</span>        $this-&gt;copyToSentFolder($mimeMsg[<span class="stringliteral">&#39;message&#39;</span>]);</div>
<div class="line"><a id="l01854" name="l01854"></a><span class="lineno"> 1854</span>        $this-&gt;recordMessageDiagnostics($mimeMsg[<span class="stringliteral">&#39;message&#39;</span>]);</div>
<div class="line"><a id="l01855" name="l01855"></a><span class="lineno"> 1855</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01856" name="l01856"></a><span class="lineno"> 1856</span>        ++$this-&gt;diagnostics[self::DIAGNOSTICS_FAILED_COUNT];</div>
<div class="line"><a id="l01857" name="l01857"></a><span class="lineno"> 1857</span>      }</div>
<div class="line"><a id="l01858" name="l01858"></a><span class="lineno"> 1858</span>    }</div>
<div class="line"><a id="l01859" name="l01859"></a><span class="lineno"> 1859</span> </div>
<div class="line"><a id="l01860" name="l01860"></a><span class="lineno"> 1860</span>    $this-&gt;entityManager-&gt;beginTransaction();</div>
<div class="line"><a id="l01861" name="l01861"></a><span class="lineno"> 1861</span>    <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l01862" name="l01862"></a><span class="lineno"> 1862</span>      $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#ad9f7964d2ea3ec421dd166a41e4ff17d">flush</a>();</div>
<div class="line"><a id="l01863" name="l01863"></a><span class="lineno"> 1863</span>      $this-&gt;entityManager-&gt;commit();</div>
<div class="line"><a id="l01864" name="l01864"></a><span class="lineno"> 1864</span>    } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l01865" name="l01865"></a><span class="lineno"> 1865</span>      $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a6d05693fe567b9d34daf71eb6c8aecb4">logException</a>($t);</div>
<div class="line"><a id="l01866" name="l01866"></a><span class="lineno"> 1866</span>      <span class="keywordflow">if</span> ($this-&gt;entityManager-&gt;isTransactionActive()) {</div>
<div class="line"><a id="l01867" name="l01867"></a><span class="lineno"> 1867</span>        $this-&gt;entityManager-&gt;rollback();</div>
<div class="line"><a id="l01868" name="l01868"></a><span class="lineno"> 1868</span>      }</div>
<div class="line"><a id="l01869" name="l01869"></a><span class="lineno"> 1869</span>    }</div>
<div class="line"><a id="l01870" name="l01870"></a><span class="lineno"> 1870</span> </div>
<div class="line"><a id="l01871" name="l01871"></a><span class="lineno"> 1871</span>    <span class="keywordflow">return</span> $this-&gt;executionStatus;</div>
<div class="line"><a id="l01872" name="l01872"></a><span class="lineno"> 1872</span>  }</div>
<div class="line"><a id="l01873" name="l01873"></a><span class="lineno"> 1873</span> </div>
<div class="line"><a id="l01887" name="l01887"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#af38d44317b9aa9b9f6a8886ec8b293d1"> 1887</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#af38d44317b9aa9b9f6a8886ec8b293d1">head</a>(<span class="keywordtype">string</span> $text, <span class="keywordtype">int</span> $lines = 64, <span class="keywordtype">string</span> $separators = <span class="stringliteral">&quot;/\n/&quot;</span>):string</div>
<div class="line"><a id="l01888" name="l01888"></a><span class="lineno"> 1888</span>  {</div>
<div class="line"><a id="l01889" name="l01889"></a><span class="lineno"> 1889</span>    $text = preg_split($separators, $text, $lines+1);</div>
<div class="line"><a id="l01890" name="l01890"></a><span class="lineno"> 1890</span>    <span class="keywordflow">if</span> (isset($text[$lines])) {</div>
<div class="line"><a id="l01891" name="l01891"></a><span class="lineno"> 1891</span>      unset($text[$lines]);</div>
<div class="line"><a id="l01892" name="l01892"></a><span class="lineno"> 1892</span>    }</div>
<div class="line"><a id="l01893" name="l01893"></a><span class="lineno"> 1893</span>    <span class="keywordflow">return</span> implode(<span class="stringliteral">&quot;\n&quot;</span>, $text);</div>
<div class="line"><a id="l01894" name="l01894"></a><span class="lineno"> 1894</span>  }</div>
<div class="line"><a id="l01895" name="l01895"></a><span class="lineno"> 1895</span> </div>
<div class="line"><a id="l01903" name="l01903"></a><span class="lineno"> 1903</span>  <span class="keyword">private</span> <span class="keyword">function</span> composePersonalAttachments(Entities\<a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_entities_1_1_musician.html">Musician</a> $musician):array</div>
<div class="line"><a id="l01904" name="l01904"></a><span class="lineno"> 1904</span>  {</div>
<div class="line"><a id="l01905" name="l01905"></a><span class="lineno"> 1905</span>    <span class="comment">// in order to form file-names withtout dots</span></div>
<div class="line"><a id="l01906" name="l01906"></a><span class="lineno"> 1906</span>    $userIdSlug = $musician-&gt;getUserIdSlug();</div>
<div class="line"><a id="l01907" name="l01907"></a><span class="lineno"> 1907</span>    $camelCaseSlug = Util::dashesToCamelCase($userIdSlug, <span class="keyword">true</span>, <span class="stringliteral">&#39;_-.&#39;</span>);</div>
<div class="line"><a id="l01908" name="l01908"></a><span class="lineno"> 1908</span> </div>
<div class="line"><a id="l01909" name="l01909"></a><span class="lineno"> 1909</span>    $personalAttachments = [];</div>
<div class="line"><a id="l01910" name="l01910"></a><span class="lineno"> 1910</span> </div>
<div class="line"><a id="l01911" name="l01911"></a><span class="lineno"> 1911</span>    $this-&gt;diagnostics[self::DIAGNOSTICS_ATTACHMENT_VALIDATION][<span class="stringliteral">&#39;Personal&#39;</span>][$musician-&gt;getId()] = [];</div>
<div class="line"><a id="l01912" name="l01912"></a><span class="lineno"> 1912</span> </div>
<div class="line"><a id="l01913" name="l01913"></a><span class="lineno"> 1913</span>    <span class="comment">// Find payments and potential attachments. Always attached a pre-filled</span></div>
<div class="line"><a id="l01914" name="l01914"></a><span class="lineno"> 1914</span>    <span class="comment">// member-data update-form</span></div>
<div class="line"><a id="l01915" name="l01915"></a><span class="lineno"> 1915</span>    <span class="keywordflow">if</span> (!empty($this-&gt;bulkTransaction)) {</div>
<div class="line"><a id="l01917" name="l01917"></a><span class="lineno"> 1917</span>      $compositePayment = $this-&gt;bulkTransaction-&gt;getPayments()-&gt;get($musician-&gt;getId());</div>
<div class="line"><a id="l01918" name="l01918"></a><span class="lineno"> 1918</span>      <span class="keywordflow">if</span> (!empty($compositePayment)) {</div>
<div class="line"><a id="l01919" name="l01919"></a><span class="lineno"> 1919</span>        $supportingDocument = $compositePayment-&gt;getSupportingDocument();</div>
<div class="line"><a id="l01920" name="l01920"></a><span class="lineno"> 1920</span>        <span class="keywordflow">if</span> (!empty($supportingDocument)) {</div>
<div class="line"><a id="l01921" name="l01921"></a><span class="lineno"> 1921</span>          $personalAttachments[] = <span class="keyword">function</span>() use ($supportingDocument) {</div>
<div class="line"><a id="l01922" name="l01922"></a><span class="lineno"> 1922</span>            <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l01923" name="l01923"></a><span class="lineno"> 1923</span>              <span class="stringliteral">&#39;data&#39;</span> =&gt; $supportingDocument-&gt;getFileData()-&gt;getData(),</div>
<div class="line"><a id="l01924" name="l01924"></a><span class="lineno"> 1924</span>              <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $supportingDocument-&gt;getFileName(),</div>
<div class="line"><a id="l01925" name="l01925"></a><span class="lineno"> 1925</span>              <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l01926" name="l01926"></a><span class="lineno"> 1926</span>              <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; $supportingDocument-&gt;getMimeType(),</div>
<div class="line"><a id="l01927" name="l01927"></a><span class="lineno"> 1927</span>            ];</div>
<div class="line"><a id="l01928" name="l01928"></a><span class="lineno"> 1928</span>          };</div>
<div class="line"><a id="l01929" name="l01929"></a><span class="lineno"> 1929</span>        }</div>
<div class="line"><a id="l01931" name="l01931"></a><span class="lineno"> 1931</span>        <span class="keywordflow">foreach</span> ($compositePayment-&gt;getProjectPayments() as $projectPayment) {</div>
<div class="line"><a id="l01932" name="l01932"></a><span class="lineno"> 1932</span>          $supportingDocument = $projectPayment-&gt;getReceivable()-&gt;getSupportingDocument();</div>
<div class="line"><a id="l01933" name="l01933"></a><span class="lineno"> 1933</span>          <span class="keywordflow">if</span> (!empty($supportingDocument)) {</div>
<div class="line"><a id="l01934" name="l01934"></a><span class="lineno"> 1934</span>            $personalAttachments[] = <span class="keyword">function</span>() use ($supportingDocument) {</div>
<div class="line"><a id="l01935" name="l01935"></a><span class="lineno"> 1935</span>              <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l01936" name="l01936"></a><span class="lineno"> 1936</span>                <span class="stringliteral">&#39;data&#39;</span> =&gt; $supportingDocument-&gt;getFileData()-&gt;getData(),</div>
<div class="line"><a id="l01937" name="l01937"></a><span class="lineno"> 1937</span>                <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $supportingDocument-&gt;getFileName(),</div>
<div class="line"><a id="l01938" name="l01938"></a><span class="lineno"> 1938</span>                <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l01939" name="l01939"></a><span class="lineno"> 1939</span>                <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; $supportingDocument-&gt;getMimeType(),</div>
<div class="line"><a id="l01940" name="l01940"></a><span class="lineno"> 1940</span>              ];</div>
<div class="line"><a id="l01941" name="l01941"></a><span class="lineno"> 1941</span>            };</div>
<div class="line"><a id="l01942" name="l01942"></a><span class="lineno"> 1942</span>          }</div>
<div class="line"><a id="l01943" name="l01943"></a><span class="lineno"> 1943</span>        }</div>
<div class="line"><a id="l01944" name="l01944"></a><span class="lineno"> 1944</span>      }</div>
<div class="line"><a id="l01945" name="l01945"></a><span class="lineno"> 1945</span>    }</div>
<div class="line"><a id="l01946" name="l01946"></a><span class="lineno"> 1946</span> </div>
<div class="line"><a id="l01947" name="l01947"></a><span class="lineno"> 1947</span>    <span class="keywordflow">foreach</span> ($this-&gt;personalAttachments() as $attachment) {</div>
<div class="line"><a id="l01948" name="l01948"></a><span class="lineno"> 1948</span>      <span class="keywordflow">if</span> ($attachment[<span class="stringliteral">&#39;status&#39;</span>] != <span class="stringliteral">&#39;selected&#39;</span> &amp;&amp; !$attachment[<span class="stringliteral">&#39;sub_selection&#39;</span>]) {</div>
<div class="line"><a id="l01949" name="l01949"></a><span class="lineno"> 1949</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01950" name="l01950"></a><span class="lineno"> 1950</span>      }</div>
<div class="line"><a id="l01951" name="l01951"></a><span class="lineno"> 1951</span> </div>
<div class="line"><a id="l01952" name="l01952"></a><span class="lineno"> 1952</span>      <span class="keywordflow">if</span> (isset($attachment[<span class="stringliteral">&#39;template_id&#39;</span>])) {</div>
<div class="line"><a id="l01953" name="l01953"></a><span class="lineno"> 1953</span>        $templateId = $attachment[<span class="stringliteral">&#39;template_id&#39;</span>];</div>
<div class="line"><a id="l01954" name="l01954"></a><span class="lineno"> 1954</span>        <span class="keywordflow">if</span> (!empty($this-&gt;project)</div>
<div class="line"><a id="l01955" name="l01955"></a><span class="lineno"> 1955</span>            &amp;&amp; $this-&gt;project-&gt;getId() == $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#af5292021a7603645a7372870c43e6115">getClubMembersProjectId</a>()</div>
<div class="line"><a id="l01956" name="l01956"></a><span class="lineno"> 1956</span>            &amp;&amp; $templateId == ConfigService::DOCUMENT_TEMPLATE_PROJECT_DEBIT_NOTE_MANDATE) {</div>
<div class="line"><a id="l01957" name="l01957"></a><span class="lineno"> 1957</span>          $templateId = ConfigService::DOCUMENT_TEMPLATE_MEMBER_DATA_UPDATE;</div>
<div class="line"><a id="l01958" name="l01958"></a><span class="lineno"> 1958</span>        }</div>
<div class="line"><a id="l01959" name="l01959"></a><span class="lineno"> 1959</span> </div>
<div class="line"><a id="l01961" name="l01961"></a><span class="lineno"> 1961</span>        $financeService = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(FinanceService::class);</div>
<div class="line"><a id="l01962" name="l01962"></a><span class="lineno"> 1962</span>        <span class="keywordflow">switch</span> ($templateId) {</div>
<div class="line"><a id="l01963" name="l01963"></a><span class="lineno"> 1963</span>          <span class="keywordflow">case</span> ConfigService::DOCUMENT_TEMPLATE_GENERAL_DEBIT_NOTE_MANDATE:</div>
<div class="line"><a id="l01964" name="l01964"></a><span class="lineno"> 1964</span>            $membersProject = $this-&gt;entityManager-&gt;find(</div>
<div class="line"><a id="l01965" name="l01965"></a><span class="lineno"> 1965</span>              Entities\Project::class,</div>
<div class="line"><a id="l01966" name="l01966"></a><span class="lineno"> 1966</span>              $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#af5292021a7603645a7372870c43e6115">getClubMembersProjectId</a>()</div>
<div class="line"><a id="l01967" name="l01967"></a><span class="lineno"> 1967</span>            );</div>
<div class="line"><a id="l01968" name="l01968"></a><span class="lineno"> 1968</span>            <span class="keywordflow">if</span> (empty($membersProject)) {</div>
<div class="line"><a id="l01969" name="l01969"></a><span class="lineno"> 1969</span>              <span class="keywordflow">continue</span> 2;</div>
<div class="line"><a id="l01970" name="l01970"></a><span class="lineno"> 1970</span>            }</div>
<div class="line"><a id="l01972" name="l01972"></a><span class="lineno"> 1972</span>            $financeService = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(FinanceService::class);</div>
<div class="line"><a id="l01973" name="l01973"></a><span class="lineno"> 1973</span>            $bankAccount = $financeService-&gt;getActiveBankAccount($musician, $membersProject);</div>
<div class="line"><a id="l01974" name="l01974"></a><span class="lineno"> 1974</span> </div>
<div class="line"><a id="l01975" name="l01975"></a><span class="lineno"> 1975</span>            $personalAttachments[] = <span class="keyword">function</span>() use ($financeService, $bankAccount, $membersProject, $musician, $templateId) {</div>
<div class="line"><a id="l01976" name="l01976"></a><span class="lineno"> 1976</span>              list($fileData, $mimeType, $fileName) =</div>
<div class="line"><a id="l01977" name="l01977"></a><span class="lineno"> 1977</span>                $financeService-&gt;preFilledDebitMandateForm(</div>
<div class="line"><a id="l01978" name="l01978"></a><span class="lineno"> 1978</span>                  $bankAccount,</div>
<div class="line"><a id="l01979" name="l01979"></a><span class="lineno"> 1979</span>                  $membersProject,</div>
<div class="line"><a id="l01980" name="l01980"></a><span class="lineno"> 1980</span>                  $musician,</div>
<div class="line"><a id="l01981" name="l01981"></a><span class="lineno"> 1981</span>                  formName: $templateId</div>
<div class="line"><a id="l01982" name="l01982"></a><span class="lineno"> 1982</span>                );</div>
<div class="line"><a id="l01983" name="l01983"></a><span class="lineno"> 1983</span>              <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l01984" name="l01984"></a><span class="lineno"> 1984</span>                <span class="stringliteral">&#39;data&#39;</span> =&gt; $fileData,</div>
<div class="line"><a id="l01985" name="l01985"></a><span class="lineno"> 1985</span>                <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $fileName,</div>
<div class="line"><a id="l01986" name="l01986"></a><span class="lineno"> 1986</span>                <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l01987" name="l01987"></a><span class="lineno"> 1987</span>                <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; $mimeType,</div>
<div class="line"><a id="l01988" name="l01988"></a><span class="lineno"> 1988</span>              ];</div>
<div class="line"><a id="l01989" name="l01989"></a><span class="lineno"> 1989</span>            };</div>
<div class="line"><a id="l01990" name="l01990"></a><span class="lineno"> 1990</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01991" name="l01991"></a><span class="lineno"> 1991</span>          <span class="keywordflow">case</span> ConfigService::DOCUMENT_TEMPLATE_MEMBER_DATA_UPDATE:</div>
<div class="line"><a id="l01992" name="l01992"></a><span class="lineno"> 1992</span>            $membersProject = $this-&gt;entityManager-&gt;find(</div>
<div class="line"><a id="l01993" name="l01993"></a><span class="lineno"> 1993</span>              Entities\Project::class,</div>
<div class="line"><a id="l01994" name="l01994"></a><span class="lineno"> 1994</span>              $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#af5292021a7603645a7372870c43e6115">getClubMembersProjectId</a>()</div>
<div class="line"><a id="l01995" name="l01995"></a><span class="lineno"> 1995</span>            );</div>
<div class="line"><a id="l01996" name="l01996"></a><span class="lineno"> 1996</span>            <span class="keywordflow">if</span> (empty($membersProject)) {</div>
<div class="line"><a id="l01997" name="l01997"></a><span class="lineno"> 1997</span>              <span class="keywordflow">continue</span> 2;</div>
<div class="line"><a id="l01998" name="l01998"></a><span class="lineno"> 1998</span>            }</div>
<div class="line"><a id="l02000" name="l02000"></a><span class="lineno"> 2000</span>            $financeService = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(FinanceService::class);</div>
<div class="line"><a id="l02001" name="l02001"></a><span class="lineno"> 2001</span>            $bankAccount = $financeService-&gt;getActiveBankAccount($musician, $membersProject);</div>
<div class="line"><a id="l02002" name="l02002"></a><span class="lineno"> 2002</span> </div>
<div class="line"><a id="l02003" name="l02003"></a><span class="lineno"> 2003</span>            $personalAttachments[] = <span class="keyword">function</span>() use ($financeService, $bankAccount, $membersProject, $musician, $templateId) {</div>
<div class="line"><a id="l02004" name="l02004"></a><span class="lineno"> 2004</span>              list($fileData, $mimeType, $fileName) =</div>
<div class="line"><a id="l02005" name="l02005"></a><span class="lineno"> 2005</span>                $financeService-&gt;preFilledDebitMandateForm(</div>
<div class="line"><a id="l02006" name="l02006"></a><span class="lineno"> 2006</span>                  $bankAccount,</div>
<div class="line"><a id="l02007" name="l02007"></a><span class="lineno"> 2007</span>                  $membersProject,</div>
<div class="line"><a id="l02008" name="l02008"></a><span class="lineno"> 2008</span>                  $musician,</div>
<div class="line"><a id="l02009" name="l02009"></a><span class="lineno"> 2009</span>                  formName: $templateId</div>
<div class="line"><a id="l02010" name="l02010"></a><span class="lineno"> 2010</span>                );</div>
<div class="line"><a id="l02011" name="l02011"></a><span class="lineno"> 2011</span>              <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l02012" name="l02012"></a><span class="lineno"> 2012</span>                <span class="stringliteral">&#39;data&#39;</span> =&gt; $fileData,</div>
<div class="line"><a id="l02013" name="l02013"></a><span class="lineno"> 2013</span>                <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $fileName,</div>
<div class="line"><a id="l02014" name="l02014"></a><span class="lineno"> 2014</span>                <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l02015" name="l02015"></a><span class="lineno"> 2015</span>                <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; $mimeType,</div>
<div class="line"><a id="l02016" name="l02016"></a><span class="lineno"> 2016</span>              ];</div>
<div class="line"><a id="l02017" name="l02017"></a><span class="lineno"> 2017</span>            };</div>
<div class="line"><a id="l02018" name="l02018"></a><span class="lineno"> 2018</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02019" name="l02019"></a><span class="lineno"> 2019</span>          <span class="keywordflow">case</span> ConfigService::DOCUMENT_TEMPLATE_PROJECT_DEBIT_NOTE_MANDATE:</div>
<div class="line"><a id="l02020" name="l02020"></a><span class="lineno"> 2020</span>            <span class="keywordflow">if</span> (empty($this-&gt;project)) {</div>
<div class="line"><a id="l02021" name="l02021"></a><span class="lineno"> 2021</span>              <span class="keywordflow">continue</span> 2;</div>
<div class="line"><a id="l02022" name="l02022"></a><span class="lineno"> 2022</span>            }</div>
<div class="line"><a id="l02023" name="l02023"></a><span class="lineno"> 2023</span>            <span class="keywordflow">if</span> ($musician-&gt;isMemberOf($this-&gt;getClubMembersProjectId())) {</div>
<div class="line"><a id="l02024" name="l02024"></a><span class="lineno"> 2024</span>              <span class="comment">// switch to the member-data update which also inludes a mandate form</span></div>
<div class="line"><a id="l02025" name="l02025"></a><span class="lineno"> 2025</span>              $templateId = ConfigService::DOCUMENT_TEMPLATE_MEMBER_DATA_UPDATE;</div>
<div class="line"><a id="l02026" name="l02026"></a><span class="lineno"> 2026</span>            }</div>
<div class="line"><a id="l02028" name="l02028"></a><span class="lineno"> 2028</span>            $financeService = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(FinanceService::class);</div>
<div class="line"><a id="l02029" name="l02029"></a><span class="lineno"> 2029</span>            $bankAccount = $financeService-&gt;getActiveBankAccount($musician, $this-&gt;project);</div>
<div class="line"><a id="l02030" name="l02030"></a><span class="lineno"> 2030</span> </div>
<div class="line"><a id="l02031" name="l02031"></a><span class="lineno"> 2031</span>            $personalAttachments[] = <span class="keyword">function</span>() use ($financeService, $bankAccount, $musician, $templateId) {</div>
<div class="line"><a id="l02032" name="l02032"></a><span class="lineno"> 2032</span>              list($fileData, $mimeType, $fileName) =</div>
<div class="line"><a id="l02033" name="l02033"></a><span class="lineno"> 2033</span>                $financeService-&gt;preFilledDebitMandateForm(</div>
<div class="line"><a id="l02034" name="l02034"></a><span class="lineno"> 2034</span>                  $bankAccount,</div>
<div class="line"><a id="l02035" name="l02035"></a><span class="lineno"> 2035</span>                  $this-&gt;project,</div>
<div class="line"><a id="l02036" name="l02036"></a><span class="lineno"> 2036</span>                  $musician,</div>
<div class="line"><a id="l02037" name="l02037"></a><span class="lineno"> 2037</span>                  formName: $templateId</div>
<div class="line"><a id="l02038" name="l02038"></a><span class="lineno"> 2038</span>                );</div>
<div class="line"><a id="l02039" name="l02039"></a><span class="lineno"> 2039</span>              <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l02040" name="l02040"></a><span class="lineno"> 2040</span>                <span class="stringliteral">&#39;data&#39;</span> =&gt; $fileData,</div>
<div class="line"><a id="l02041" name="l02041"></a><span class="lineno"> 2041</span>                <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $fileName,</div>
<div class="line"><a id="l02042" name="l02042"></a><span class="lineno"> 2042</span>                <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l02043" name="l02043"></a><span class="lineno"> 2043</span>                <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; $mimeType,</div>
<div class="line"><a id="l02044" name="l02044"></a><span class="lineno"> 2044</span>              ];</div>
<div class="line"><a id="l02045" name="l02045"></a><span class="lineno"> 2045</span>            };</div>
<div class="line"><a id="l02046" name="l02046"></a><span class="lineno"> 2046</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02047" name="l02047"></a><span class="lineno"> 2047</span>          <span class="keywordflow">case</span> ConfigService::DOCUMENT_TEMPLATE_INSTRUMENT_INSURANCE_RECORD:</div>
<div class="line"><a id="l02049" name="l02049"></a><span class="lineno"> 2049</span>            $insuranceService = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(InstrumentInsuranceService::class);</div>
<div class="line"><a id="l02050" name="l02050"></a><span class="lineno"> 2050</span>            $insuranceOverview = $insuranceService-&gt;musicianOverview($musician);</div>
<div class="line"><a id="l02051" name="l02051"></a><span class="lineno"> 2051</span> </div>
<div class="line"><a id="l02052" name="l02052"></a><span class="lineno"> 2052</span>            <span class="keywordflow">if</span> (empty($insuranceOverview[<span class="stringliteral">&#39;musicians&#39;</span>])) {</div>
<div class="line"><a id="l02053" name="l02053"></a><span class="lineno"> 2053</span>              <span class="comment">// just skip</span></div>
<div class="line"><a id="l02054" name="l02054"></a><span class="lineno"> 2054</span>              <span class="keywordflow">continue</span> 2;</div>
<div class="line"><a id="l02055" name="l02055"></a><span class="lineno"> 2055</span>            }</div>
<div class="line"><a id="l02056" name="l02056"></a><span class="lineno"> 2056</span> </div>
<div class="line"><a id="l02057" name="l02057"></a><span class="lineno"> 2057</span>            $personalAttachments[] = <span class="keyword">function</span>() use ($insuranceService, $insuranceOverview) {</div>
<div class="line"><a id="l02058" name="l02058"></a><span class="lineno"> 2058</span>              <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l02059" name="l02059"></a><span class="lineno"> 2059</span>                $fileData = $insuranceService-&gt;musicianOverviewLetter($insuranceOverview);</div>
<div class="line"><a id="l02060" name="l02060"></a><span class="lineno"> 2060</span>                $mimeType = <span class="stringliteral">&#39;application/pdf&#39;</span>;</div>
<div class="line"><a id="l02061" name="l02061"></a><span class="lineno"> 2061</span>              } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l02062" name="l02062"></a><span class="lineno"> 2062</span>                $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a6d05693fe567b9d34daf71eb6c8aecb4">logException</a>($t);</div>
<div class="line"><a id="l02063" name="l02063"></a><span class="lineno"> 2063</span>                $fileData = $t-&gt;getMessage() . <span class="stringliteral">&#39; / &#39;</span> . $t-&gt;getTraceAsString();</div>
<div class="line"><a id="l02064" name="l02064"></a><span class="lineno"> 2064</span>                $mimeType = <span class="stringliteral">&#39;text/plain&#39;</span>;</div>
<div class="line"><a id="l02065" name="l02065"></a><span class="lineno"> 2065</span>              }</div>
<div class="line"><a id="l02066" name="l02066"></a><span class="lineno"> 2066</span>              $fileName = $insuranceService-&gt;musicianOverviewFileName($insuranceOverview);</div>
<div class="line"><a id="l02067" name="l02067"></a><span class="lineno"> 2067</span>              <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l02068" name="l02068"></a><span class="lineno"> 2068</span>                <span class="stringliteral">&#39;data&#39;</span> =&gt; $fileData,</div>
<div class="line"><a id="l02069" name="l02069"></a><span class="lineno"> 2069</span>                <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $fileName,</div>
<div class="line"><a id="l02070" name="l02070"></a><span class="lineno"> 2070</span>                <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l02071" name="l02071"></a><span class="lineno"> 2071</span>                <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; $mimeType,</div>
<div class="line"><a id="l02072" name="l02072"></a><span class="lineno"> 2072</span>              ];</div>
<div class="line"><a id="l02073" name="l02073"></a><span class="lineno"> 2073</span>            };</div>
<div class="line"><a id="l02074" name="l02074"></a><span class="lineno"> 2074</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02075" name="l02075"></a><span class="lineno"> 2075</span>        }</div>
<div class="line"><a id="l02076" name="l02076"></a><span class="lineno"> 2076</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02077" name="l02077"></a><span class="lineno"> 2077</span>      }</div>
<div class="line"><a id="l02078" name="l02078"></a><span class="lineno"> 2078</span> </div>
<div class="line"><a id="l02080" name="l02080"></a><span class="lineno"> 2080</span>      $field = $this-&gt;entityManager-&gt;find(Entities\ProjectParticipantField::class, $attachment[<span class="stringliteral">&#39;field_id&#39;</span>]);</div>
<div class="line"><a id="l02081" name="l02081"></a><span class="lineno"> 2081</span>      <span class="keywordflow">if</span> (empty($field)) {</div>
<div class="line"><a id="l02082" name="l02082"></a><span class="lineno"> 2082</span>        $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a90f07ed512379da471e822b7471b72fc">logError</a>(<span class="stringliteral">&#39;Unable to find attachment field &quot;%s&quot;.&#39;</span>, $field-&gt;getId());</div>
<div class="line"><a id="l02083" name="l02083"></a><span class="lineno"> 2083</span>        $this-&gt;diagnostics[self::DIAGNOSTICS_ATTACHMENT_VALIDATION][<span class="stringliteral">&#39;Personal&#39;</span>][$musician-&gt;getId()][<span class="stringliteral">&#39;Fields&#39;</span>][] = $attachment;</div>
<div class="line"><a id="l02084" name="l02084"></a><span class="lineno"> 2084</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02085" name="l02085"></a><span class="lineno"> 2085</span>      }</div>
<div class="line"><a id="l02086" name="l02086"></a><span class="lineno"> 2086</span> </div>
<div class="line"><a id="l02087" name="l02087"></a><span class="lineno"> 2087</span>      $fieldName = $field-&gt;getName();</div>
<div class="line"><a id="l02088" name="l02088"></a><span class="lineno"> 2088</span>      $fieldType = $field-&gt;getDataType();</div>
<div class="line"><a id="l02089" name="l02089"></a><span class="lineno"> 2089</span>      $fieldMultiplicity = $field-&gt;getMultiplicity();</div>
<div class="line"><a id="l02090" name="l02090"></a><span class="lineno"> 2090</span> </div>
<div class="line"><a id="l02091" name="l02091"></a><span class="lineno"> 2091</span>      <span class="keywordflow">switch</span> ($fieldType) {</div>
<div class="line"><a id="l02092" name="l02092"></a><span class="lineno"> 2092</span>        <span class="keywordflow">case</span> FieldType::CLOUD_FILE:</div>
<div class="line"><a id="l02093" name="l02093"></a><span class="lineno"> 2093</span>        <span class="keywordflow">case</span> FieldType::CLOUD_FOLDER:</div>
<div class="line"><a id="l02094" name="l02094"></a><span class="lineno"> 2094</span>        <span class="keywordflow">case</span> FieldType::DB_FILE:</div>
<div class="line"><a id="l02095" name="l02095"></a><span class="lineno"> 2095</span>        <span class="keywordflow">case</span> FieldType::RECEIVABLES:</div>
<div class="line"><a id="l02096" name="l02096"></a><span class="lineno"> 2096</span>        <span class="keywordflow">case</span> FieldType::LIABILITIES:</div>
<div class="line"><a id="l02097" name="l02097"></a><span class="lineno"> 2097</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02098" name="l02098"></a><span class="lineno"> 2098</span>        <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l02099" name="l02099"></a><span class="lineno"> 2099</span>          $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a90f07ed512379da471e822b7471b72fc">logError</a>(sprintf(<span class="stringliteral">&#39;Cannot attach field &quot;%s&quot; of type &quot;%s&quot;.&#39;</span>, $fieldName, $fieldType));</div>
<div class="line"><a id="l02100" name="l02100"></a><span class="lineno"> 2100</span>          $this-&gt;diagnostics[self::DIAGNOSTICS_ATTACHMENT_VALIDATION][<span class="stringliteral">&#39;Personal&#39;</span>][$musician-&gt;getId()][<span class="stringliteral">&#39;Fields&#39;</span>][] = $attachment;</div>
<div class="line"><a id="l02101" name="l02101"></a><span class="lineno"> 2101</span>          <span class="keywordflow">continue</span> 2;</div>
<div class="line"><a id="l02102" name="l02102"></a><span class="lineno"> 2102</span>      }</div>
<div class="line"><a id="l02103" name="l02103"></a><span class="lineno"> 2103</span> </div>
<div class="line"><a id="l02105" name="l02105"></a><span class="lineno"> 2105</span>      $fieldData = $musician-&gt;getProjectParticipantFieldsData()</div>
<div class="line"><a id="l02106" name="l02106"></a><span class="lineno"> 2106</span>        -&gt;matching(<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_util.html#aafe8e2082bd107d572aa76086a06b24e">DBUtil::criteriaWhere</a>([ <span class="stringliteral">&#39;field&#39;</span> =&gt; $field, <span class="stringliteral">&#39;deleted&#39;</span> =&gt; <span class="keyword">null</span> ]));</div>
<div class="line"><a id="l02107" name="l02107"></a><span class="lineno"> 2107</span> </div>
<div class="line"><a id="l02108" name="l02108"></a><span class="lineno"> 2108</span>      <span class="keywordflow">if</span> ($fieldData-&gt;isEmpty()) {</div>
<div class="line"><a id="l02109" name="l02109"></a><span class="lineno"> 2109</span>        <span class="comment">// Fields are optional, perhaps one could add a &quot;required&quot; field qualifier ...</span></div>
<div class="line"><a id="l02110" name="l02110"></a><span class="lineno"> 2110</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02111" name="l02111"></a><span class="lineno"> 2111</span>      }</div>
<div class="line"><a id="l02112" name="l02112"></a><span class="lineno"> 2112</span> </div>
<div class="line"><a id="l02113" name="l02113"></a><span class="lineno"> 2113</span>      <span class="keywordflow">if</span> ($fieldData-&gt;count() &gt; 1 &amp;&amp; $fieldMultiplicity == FieldMultiplicity::SIMPLE) {</div>
<div class="line"><a id="l02114" name="l02114"></a><span class="lineno"> 2114</span>        $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a90f07ed512379da471e822b7471b72fc">logError</a>(sprintf(<span class="stringliteral">&#39;More than one data-item for field &quot;%s&quot; of type &quot;%s&quot; with multiplicity &quot;%s&quot;.&#39;</span>, $fieldName, $fieldType, $fieldMultiplicity));</div>
<div class="line"><a id="l02115" name="l02115"></a><span class="lineno"> 2115</span>        $this-&gt;diagnostics[self::DIAGNOSTICS_ATTACHMENT_VALIDATION][<span class="stringliteral">&#39;Personal&#39;</span>][$musician-&gt;getId()][<span class="stringliteral">&#39;Fields&#39;</span>][] = $attachment;</div>
<div class="line"><a id="l02116" name="l02116"></a><span class="lineno"> 2116</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02117" name="l02117"></a><span class="lineno"> 2117</span>      }</div>
<div class="line"><a id="l02118" name="l02118"></a><span class="lineno"> 2118</span> </div>
<div class="line"><a id="l02119" name="l02119"></a><span class="lineno"> 2119</span>      <span class="keywordflow">switch</span> ($fieldType) {</div>
<div class="line"><a id="l02120" name="l02120"></a><span class="lineno"> 2120</span>        <span class="keywordflow">case</span> FieldType::RECEIVABLES:</div>
<div class="line"><a id="l02121" name="l02121"></a><span class="lineno"> 2121</span>        <span class="keywordflow">case</span> FieldType::LIABILITIES:</div>
<div class="line"><a id="l02122" name="l02122"></a><span class="lineno"> 2122</span>          <span class="comment">// ATM we support sub-selection item only for FieldMultiplicity::RECURRING</span></div>
<div class="line"><a id="l02123" name="l02123"></a><span class="lineno"> 2123</span>          <span class="keywordflow">if</span> ($attachment[<span class="stringliteral">&#39;status&#39;</span>] != <span class="stringliteral">&#39;selected&#39;</span>) {</div>
<div class="line"><a id="l02124" name="l02124"></a><span class="lineno"> 2124</span>            $selectedKeys = [];</div>
<div class="line"><a id="l02125" name="l02125"></a><span class="lineno"> 2125</span>            <span class="keywordflow">foreach</span> ($attachment[<span class="stringliteral">&#39;sub_options&#39;</span>] as $subOption) {</div>
<div class="line"><a id="l02126" name="l02126"></a><span class="lineno"> 2126</span>              <span class="keywordflow">if</span> ($subOption[<span class="stringliteral">&#39;status&#39;</span>] == <span class="stringliteral">&#39;selected&#39;</span>) {</div>
<div class="line"><a id="l02127" name="l02127"></a><span class="lineno"> 2127</span>                $selectedKeys[] = $subOption[<span class="stringliteral">&#39;option_key&#39;</span>];</div>
<div class="line"><a id="l02128" name="l02128"></a><span class="lineno"> 2128</span>              }</div>
<div class="line"><a id="l02129" name="l02129"></a><span class="lineno"> 2129</span>            }</div>
<div class="line"><a id="l02130" name="l02130"></a><span class="lineno"> 2130</span>            $fieldData = $fieldData-&gt;filter(<span class="keyword">function</span>(Entities\ProjectParticipantFieldDatum $fieldDatum) use ($selectedKeys) {</div>
<div class="line"><a id="l02131" name="l02131"></a><span class="lineno"> 2131</span>              <span class="keywordflow">return</span> in_array((<span class="keywordtype">string</span>)$fieldDatum-&gt;getOptionKey(), $selectedKeys);</div>
<div class="line"><a id="l02132" name="l02132"></a><span class="lineno"> 2132</span>            });</div>
<div class="line"><a id="l02133" name="l02133"></a><span class="lineno"> 2133</span>          }</div>
<div class="line"><a id="l02134" name="l02134"></a><span class="lineno"> 2134</span>          <span class="keywordflow">if</span> ($fieldData-&gt;isEmpty()) {</div>
<div class="line"><a id="l02135" name="l02135"></a><span class="lineno"> 2135</span>            <span class="comment">// ok, field-data is optional</span></div>
<div class="line"><a id="l02136" name="l02136"></a><span class="lineno"> 2136</span>            <span class="keywordflow">continue</span> 2;</div>
<div class="line"><a id="l02137" name="l02137"></a><span class="lineno"> 2137</span>          }</div>
<div class="line"><a id="l02139" name="l02139"></a><span class="lineno"> 2139</span>          <span class="keywordflow">if</span> ($fieldData-&gt;count() == 1) {</div>
<div class="line"><a id="l02140" name="l02140"></a><span class="lineno"> 2140</span>            <span class="comment">// attach file</span></div>
<div class="line"><a id="l02141" name="l02141"></a><span class="lineno"> 2141</span>            $fieldDatum = $fieldData-&gt;first();</div>
<div class="line"><a id="l02142" name="l02142"></a><span class="lineno"> 2142</span>            $supportingDocument = $fieldDatum-&gt;getSupportingDocument();</div>
<div class="line"><a id="l02143" name="l02143"></a><span class="lineno"> 2143</span>            <span class="keywordflow">if</span> (!empty($supportingDocument)) {</div>
<div class="line"><a id="l02144" name="l02144"></a><span class="lineno"> 2144</span>              $personalAttachments[] = <span class="keyword">function</span>() use ($supportingDocument) {</div>
<div class="line"><a id="l02145" name="l02145"></a><span class="lineno"> 2145</span>                <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l02146" name="l02146"></a><span class="lineno"> 2146</span>                  <span class="stringliteral">&#39;data&#39;</span> =&gt; $supportingDocument-&gt;getFileData()-&gt;getData(),</div>
<div class="line"><a id="l02147" name="l02147"></a><span class="lineno"> 2147</span>                  <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $supportingDocument-&gt;getFileName(),</div>
<div class="line"><a id="l02148" name="l02148"></a><span class="lineno"> 2148</span>                  <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l02149" name="l02149"></a><span class="lineno"> 2149</span>                  <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; $supportingDocument-&gt;getMimeType(),</div>
<div class="line"><a id="l02150" name="l02150"></a><span class="lineno"> 2150</span>                ];</div>
<div class="line"><a id="l02151" name="l02151"></a><span class="lineno"> 2151</span>              };</div>
<div class="line"><a id="l02152" name="l02152"></a><span class="lineno"> 2152</span>            }</div>
<div class="line"><a id="l02153" name="l02153"></a><span class="lineno"> 2153</span>          } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02154" name="l02154"></a><span class="lineno"> 2154</span>            <span class="comment">// attach zip-archive</span></div>
<div class="line"><a id="l02155" name="l02155"></a><span class="lineno"> 2155</span>            $items = [];</div>
<div class="line"><a id="l02156" name="l02156"></a><span class="lineno"> 2156</span>            <span class="keywordflow">foreach</span> ($fieldData as $fieldDatum) {</div>
<div class="line"><a id="l02158" name="l02158"></a><span class="lineno"> 2158</span>              $items[] = $fieldDatum-&gt;getSupportingDocument();</div>
<div class="line"><a id="l02159" name="l02159"></a><span class="lineno"> 2159</span>            }</div>
<div class="line"><a id="l02160" name="l02160"></a><span class="lineno"> 2160</span>            $folderName = $fieldName . <span class="charliteral">&#39;-&#39;</span> . $camelCaseSlug;</div>
<div class="line"><a id="l02161" name="l02161"></a><span class="lineno"> 2161</span> </div>
<div class="line"><a id="l02162" name="l02162"></a><span class="lineno"> 2162</span>            $personalAttachments[] = <span class="keyword">function</span>() use ($folderName, $items) {</div>
<div class="line"><a id="l02163" name="l02163"></a><span class="lineno"> 2163</span>              <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l02164" name="l02164"></a><span class="lineno"> 2164</span>                <span class="stringliteral">&#39;data&#39;</span> =&gt; $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(DatabaseStorageUtil::class)-&gt;getCollectionArchive($items, $folderName),</div>
<div class="line"><a id="l02165" name="l02165"></a><span class="lineno"> 2165</span>                <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $folderName . <span class="stringliteral">&#39;.zip&#39;</span>,</div>
<div class="line"><a id="l02166" name="l02166"></a><span class="lineno"> 2166</span>                <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l02167" name="l02167"></a><span class="lineno"> 2167</span>                <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; <span class="stringliteral">&#39;application/zip&#39;</span>,</div>
<div class="line"><a id="l02168" name="l02168"></a><span class="lineno"> 2168</span>              ];</div>
<div class="line"><a id="l02169" name="l02169"></a><span class="lineno"> 2169</span>            };</div>
<div class="line"><a id="l02170" name="l02170"></a><span class="lineno"> 2170</span>          }</div>
<div class="line"><a id="l02171" name="l02171"></a><span class="lineno"> 2171</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02172" name="l02172"></a><span class="lineno"> 2172</span>        <span class="keywordflow">case</span> FieldType::CLOUD_FILE:</div>
<div class="line"><a id="l02173" name="l02173"></a><span class="lineno"> 2173</span>          <span class="comment">// can be a single file or multiple files with FieldMultiplicity::PARALLEL</span></div>
<div class="line"><a id="l02174" name="l02174"></a><span class="lineno"> 2174</span>          <span class="keywordflow">if</span> ($fieldData-&gt;count() == 1) {</div>
<div class="line"><a id="l02175" name="l02175"></a><span class="lineno"> 2175</span>            $fieldDatum = $fieldData-&gt;first();</div>
<div class="line"><a id="l02177" name="l02177"></a><span class="lineno"> 2177</span>            $file = $this-&gt;participantFieldsService-&gt;getEffectiveFieldDatum($fieldDatum);</div>
<div class="line"><a id="l02178" name="l02178"></a><span class="lineno"> 2178</span> </div>
<div class="line"><a id="l02179" name="l02179"></a><span class="lineno"> 2179</span>            $fileName = str_replace(</div>
<div class="line"><a id="l02180" name="l02180"></a><span class="lineno"> 2180</span>              $userIdSlug, $camelCaseSlug,</div>
<div class="line"><a id="l02181" name="l02181"></a><span class="lineno"> 2181</span>              str_replace(</div>
<div class="line"><a id="l02182" name="l02182"></a><span class="lineno"> 2182</span>                UserStorage::PATH_SEP, <span class="charliteral">&#39;_&#39;</span>,</div>
<div class="line"><a id="l02183" name="l02183"></a><span class="lineno"> 2183</span>                  substr(UserStorage::stripParents($file-&gt;getPath(), self::PERSONAL_ATTACHMENT_PARENTS_STRIP), 1)</div>
<div class="line"><a id="l02184" name="l02184"></a><span class="lineno"> 2184</span>              )</div>
<div class="line"><a id="l02185" name="l02185"></a><span class="lineno"> 2185</span>            );</div>
<div class="line"><a id="l02186" name="l02186"></a><span class="lineno"> 2186</span> </div>
<div class="line"><a id="l02187" name="l02187"></a><span class="lineno"> 2187</span>            $personalAttachments[] = <span class="keyword">function</span>() use ($file, $fileName) {</div>
<div class="line"><a id="l02188" name="l02188"></a><span class="lineno"> 2188</span>              <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l02189" name="l02189"></a><span class="lineno"> 2189</span>                <span class="stringliteral">&#39;data&#39;</span> =&gt; $file-&gt;getContent(),</div>
<div class="line"><a id="l02190" name="l02190"></a><span class="lineno"> 2190</span>                <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $fileName,</div>
<div class="line"><a id="l02191" name="l02191"></a><span class="lineno"> 2191</span>                <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l02192" name="l02192"></a><span class="lineno"> 2192</span>                <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; $file-&gt;getMimeType(),</div>
<div class="line"><a id="l02193" name="l02193"></a><span class="lineno"> 2193</span>              ];</div>
<div class="line"><a id="l02194" name="l02194"></a><span class="lineno"> 2194</span>            };</div>
<div class="line"><a id="l02195" name="l02195"></a><span class="lineno"> 2195</span>          } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02196" name="l02196"></a><span class="lineno"> 2196</span>            $folderPath = $this-&gt;participantFieldsService-&gt;getFieldFolderPath($fieldData-&gt;first());</div>
<div class="line"><a id="l02197" name="l02197"></a><span class="lineno"> 2197</span>            $folder = $this-&gt;userStorage-&gt;getFolder($folderPath);</div>
<div class="line"><a id="l02198" name="l02198"></a><span class="lineno"> 2198</span> </div>
<div class="line"><a id="l02199" name="l02199"></a><span class="lineno"> 2199</span>            <span class="comment">// _claus_files_camerata_projects_1997_Vereinsmitglieder_participants_claus-justus.heine_MultiCloudFile.zip</span></div>
<div class="line"><a id="l02200" name="l02200"></a><span class="lineno"> 2200</span>            $fileName = str_replace(</div>
<div class="line"><a id="l02201" name="l02201"></a><span class="lineno"> 2201</span>              $userIdSlug, $camelCaseSlug,</div>
<div class="line"><a id="l02202" name="l02202"></a><span class="lineno"> 2202</span>              str_replace(</div>
<div class="line"><a id="l02203" name="l02203"></a><span class="lineno"> 2203</span>                UserStorage::PATH_SEP, <span class="charliteral">&#39;_&#39;</span>,</div>
<div class="line"><a id="l02204" name="l02204"></a><span class="lineno"> 2204</span>                substr(UserStorage::stripParents($folder-&gt;getPath(), self::PERSONAL_ATTACHMENT_PARENTS_STRIP), 1)</div>
<div class="line"><a id="l02205" name="l02205"></a><span class="lineno"> 2205</span>              )</div>
<div class="line"><a id="l02206" name="l02206"></a><span class="lineno"> 2206</span>            );</div>
<div class="line"><a id="l02207" name="l02207"></a><span class="lineno"> 2207</span>            $fileName .= <span class="stringliteral">&#39;.zip&#39;</span>;</div>
<div class="line"><a id="l02208" name="l02208"></a><span class="lineno"> 2208</span> </div>
<div class="line"><a id="l02209" name="l02209"></a><span class="lineno"> 2209</span>            $personalAttachments[] = <span class="keyword">function</span>() use ($folder, $fileName) {</div>
<div class="line"><a id="l02210" name="l02210"></a><span class="lineno"> 2210</span>              $data = $this-&gt;userStorage-&gt;getFolderArchive($folder, self::PERSONAL_ATTACHMENT_PARENTS_STRIP);</div>
<div class="line"><a id="l02211" name="l02211"></a><span class="lineno"> 2211</span>              <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l02212" name="l02212"></a><span class="lineno"> 2212</span>                <span class="stringliteral">&#39;data&#39;</span> =&gt; $data,</div>
<div class="line"><a id="l02213" name="l02213"></a><span class="lineno"> 2213</span>                <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $fileName,</div>
<div class="line"><a id="l02214" name="l02214"></a><span class="lineno"> 2214</span>                <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l02215" name="l02215"></a><span class="lineno"> 2215</span>                <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; <span class="stringliteral">&#39;application/zip&#39;</span>,</div>
<div class="line"><a id="l02216" name="l02216"></a><span class="lineno"> 2216</span>              ];</div>
<div class="line"><a id="l02217" name="l02217"></a><span class="lineno"> 2217</span>            };</div>
<div class="line"><a id="l02218" name="l02218"></a><span class="lineno"> 2218</span>          }</div>
<div class="line"><a id="l02219" name="l02219"></a><span class="lineno"> 2219</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02220" name="l02220"></a><span class="lineno"> 2220</span>        <span class="keywordflow">case</span> FieldType::CLOUD_FOLDER:</div>
<div class="line"><a id="l02221" name="l02221"></a><span class="lineno"> 2221</span>          <span class="comment">// simply add the folder as a zip-archive</span></div>
<div class="line"><a id="l02222" name="l02222"></a><span class="lineno"> 2222</span>          $fieldDatum = $fieldData-&gt;first();</div>
<div class="line"><a id="l02224" name="l02224"></a><span class="lineno"> 2224</span>          $folder = $this-&gt;participantFieldsService-&gt;getEffectiveFieldDatum($fieldDatum);</div>
<div class="line"><a id="l02225" name="l02225"></a><span class="lineno"> 2225</span>          <span class="keywordflow">if</span> (!empty($folder)) {</div>
<div class="line"><a id="l02226" name="l02226"></a><span class="lineno"> 2226</span>            <span class="comment">// _claus_files_camerata_projects_1997_Vereinsmitglieder_participants_claus-justus.heine_Anlagen Versicherung.zip</span></div>
<div class="line"><a id="l02227" name="l02227"></a><span class="lineno"> 2227</span>            $fileName = str_replace(</div>
<div class="line"><a id="l02228" name="l02228"></a><span class="lineno"> 2228</span>              $userIdSlug, $camelCaseSlug,</div>
<div class="line"><a id="l02229" name="l02229"></a><span class="lineno"> 2229</span>              str_replace(</div>
<div class="line"><a id="l02230" name="l02230"></a><span class="lineno"> 2230</span>                UserStorage::PATH_SEP, <span class="charliteral">&#39;_&#39;</span>,</div>
<div class="line"><a id="l02231" name="l02231"></a><span class="lineno"> 2231</span>                substr(UserStorage::stripParents($folder-&gt;getPath(), self::PERSONAL_ATTACHMENT_PARENTS_STRIP), 1)</div>
<div class="line"><a id="l02232" name="l02232"></a><span class="lineno"> 2232</span>              )</div>
<div class="line"><a id="l02233" name="l02233"></a><span class="lineno"> 2233</span>            );</div>
<div class="line"><a id="l02234" name="l02234"></a><span class="lineno"> 2234</span>            $fileName .= <span class="stringliteral">&#39;.zip&#39;</span>;</div>
<div class="line"><a id="l02235" name="l02235"></a><span class="lineno"> 2235</span>            $personalAttachments[] = <span class="keyword">function</span>() use ($folder, $fileName) {</div>
<div class="line"><a id="l02236" name="l02236"></a><span class="lineno"> 2236</span>              $data = $this-&gt;userStorage-&gt;getFolderArchive($folder, self::PERSONAL_ATTACHMENT_PARENTS_STRIP);</div>
<div class="line"><a id="l02237" name="l02237"></a><span class="lineno"> 2237</span>              <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l02238" name="l02238"></a><span class="lineno"> 2238</span>                <span class="stringliteral">&#39;data&#39;</span> =&gt; $data,</div>
<div class="line"><a id="l02239" name="l02239"></a><span class="lineno"> 2239</span>                <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $fileName,</div>
<div class="line"><a id="l02240" name="l02240"></a><span class="lineno"> 2240</span>                <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l02241" name="l02241"></a><span class="lineno"> 2241</span>                <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; <span class="stringliteral">&#39;application/zip&#39;</span>,</div>
<div class="line"><a id="l02242" name="l02242"></a><span class="lineno"> 2242</span>              ];</div>
<div class="line"><a id="l02243" name="l02243"></a><span class="lineno"> 2243</span>            };</div>
<div class="line"><a id="l02244" name="l02244"></a><span class="lineno"> 2244</span>          }</div>
<div class="line"><a id="l02245" name="l02245"></a><span class="lineno"> 2245</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02246" name="l02246"></a><span class="lineno"> 2246</span>        <span class="keywordflow">case</span> FieldType::DB_FILE:</div>
<div class="line"><a id="l02247" name="l02247"></a><span class="lineno"> 2247</span>          <span class="comment">// can be a single file or multiple files with FieldMultiplicity::PARALLEL or FieldMultiplicity::RECURRING</span></div>
<div class="line"><a id="l02248" name="l02248"></a><span class="lineno"> 2248</span>          $items = [];</div>
<div class="line"><a id="l02249" name="l02249"></a><span class="lineno"> 2249</span>          <span class="keywordflow">foreach</span> ($fieldData as $fieldDatum) {</div>
<div class="line"><a id="l02251" name="l02251"></a><span class="lineno"> 2251</span>            $items[] = $this-&gt;participantFieldsService-&gt;getEffectiveFieldDatum($fieldDatum);</div>
<div class="line"><a id="l02252" name="l02252"></a><span class="lineno"> 2252</span>          }</div>
<div class="line"><a id="l02253" name="l02253"></a><span class="lineno"> 2253</span>          $items = array_values(array_filter($items)); <span class="comment">// fields maybe empty ...</span></div>
<div class="line"><a id="l02254" name="l02254"></a><span class="lineno"> 2254</span>          <span class="keywordflow">if</span> (<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a8e12ef5cafdab7b950132867526d1113">count</a>($items) == 1) {</div>
<div class="line"><a id="l02256" name="l02256"></a><span class="lineno"> 2256</span>            $file = array_shift($items);</div>
<div class="line"><a id="l02257" name="l02257"></a><span class="lineno"> 2257</span>            $personalAttachments[] = <span class="keyword">function</span>() use ($file) {</div>
<div class="line"><a id="l02258" name="l02258"></a><span class="lineno"> 2258</span>              <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l02259" name="l02259"></a><span class="lineno"> 2259</span>                <span class="stringliteral">&#39;data&#39;</span> =&gt; $file-&gt;getFileData()-&gt;getData(),</div>
<div class="line"><a id="l02260" name="l02260"></a><span class="lineno"> 2260</span>                <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $file-&gt;getFileName(),</div>
<div class="line"><a id="l02261" name="l02261"></a><span class="lineno"> 2261</span>                <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l02262" name="l02262"></a><span class="lineno"> 2262</span>                <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; $file-&gt;getMimeType(),</div>
<div class="line"><a id="l02263" name="l02263"></a><span class="lineno"> 2263</span>              ];</div>
<div class="line"><a id="l02264" name="l02264"></a><span class="lineno"> 2264</span>            };</div>
<div class="line"><a id="l02265" name="l02265"></a><span class="lineno"> 2265</span>          } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02266" name="l02266"></a><span class="lineno"> 2266</span>            $folderName = $fieldName . <span class="charliteral">&#39;-&#39;</span> . $camelCaseSlug;</div>
<div class="line"><a id="l02267" name="l02267"></a><span class="lineno"> 2267</span>            $personalAttachments[] = <span class="keyword">function</span>() use ($folderName, $items) {</div>
<div class="line"><a id="l02268" name="l02268"></a><span class="lineno"> 2268</span> </div>
<div class="line"><a id="l02269" name="l02269"></a><span class="lineno"> 2269</span>              <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l02270" name="l02270"></a><span class="lineno"> 2270</span>                <span class="stringliteral">&#39;data&#39;</span> =&gt; $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(DatabaseStorageUtil::class)-&gt;getCollectionArchive($items, $folderName),</div>
<div class="line"><a id="l02271" name="l02271"></a><span class="lineno"> 2271</span>                <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $folderName . <span class="stringliteral">&#39;.zip&#39;</span>,</div>
<div class="line"><a id="l02272" name="l02272"></a><span class="lineno"> 2272</span>                <span class="stringliteral">&#39;encoding&#39;</span> =&gt; <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l02273" name="l02273"></a><span class="lineno"> 2273</span>                <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; <span class="stringliteral">&#39;application/zip&#39;</span>,</div>
<div class="line"><a id="l02274" name="l02274"></a><span class="lineno"> 2274</span>              ];</div>
<div class="line"><a id="l02275" name="l02275"></a><span class="lineno"> 2275</span>            };</div>
<div class="line"><a id="l02276" name="l02276"></a><span class="lineno"> 2276</span>          }</div>
<div class="line"><a id="l02277" name="l02277"></a><span class="lineno"> 2277</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02278" name="l02278"></a><span class="lineno"> 2278</span>      }</div>
<div class="line"><a id="l02279" name="l02279"></a><span class="lineno"> 2279</span>    }</div>
<div class="line"><a id="l02280" name="l02280"></a><span class="lineno"> 2280</span> </div>
<div class="line"><a id="l02281" name="l02281"></a><span class="lineno"> 2281</span>    <span class="keywordflow">return</span> $personalAttachments;</div>
<div class="line"><a id="l02282" name="l02282"></a><span class="lineno"> 2282</span>  }</div>
<div class="line"><a id="l02283" name="l02283"></a><span class="lineno"> 2283</span> </div>
<div class="line"><a id="l02292" name="l02292"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ada8dcf30020d39897d4515e16c4d5ca7"> 2292</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ada8dcf30020d39897d4515e16c4d5ca7">getOutboundService</a>(<span class="keywordtype">bool</span> $authenticate = <span class="keyword">false</span>):<a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html">PHPMailer</a></div>
<div class="line"><a id="l02293" name="l02293"></a><span class="lineno"> 2293</span>  {</div>
<div class="line"><a id="l02294" name="l02294"></a><span class="lineno"> 2294</span>    $phpMailer = <span class="keyword">new</span> <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html">PHPMailer</a>(exceptions: <span class="keyword">true</span>);</div>
<div class="line"><a id="l02295" name="l02295"></a><span class="lineno"> 2295</span>    $phpMailer-&gt;setLanguage($this-&gt;getLanguage());</div>
<div class="line"><a id="l02296" name="l02296"></a><span class="lineno"> 2296</span>    $phpMailer-&gt;CharSet = <span class="stringliteral">&#39;utf-8&#39;</span>;</div>
<div class="line"><a id="l02297" name="l02297"></a><span class="lineno"> 2297</span>    $phpMailer-&gt;SingleTo = <span class="keyword">false</span>;</div>
<div class="line"><a id="l02298" name="l02298"></a><span class="lineno"> 2298</span> </div>
<div class="line"><a id="l02299" name="l02299"></a><span class="lineno"> 2299</span>    $phpMailer-&gt;IsSMTP();</div>
<div class="line"><a id="l02300" name="l02300"></a><span class="lineno"> 2300</span> </div>
<div class="line"><a id="l02301" name="l02301"></a><span class="lineno"> 2301</span>    $phpMailer-&gt;Host = $this-&gt;getConfigValue(<span class="stringliteral">&#39;smtpserver&#39;</span>);</div>
<div class="line"><a id="l02302" name="l02302"></a><span class="lineno"> 2302</span>    $phpMailer-&gt;Port = $this-&gt;getConfigValue(<span class="stringliteral">&#39;smtpport&#39;</span>);</div>
<div class="line"><a id="l02303" name="l02303"></a><span class="lineno"> 2303</span> </div>
<div class="line"><a id="l02304" name="l02304"></a><span class="lineno"> 2304</span>    <span class="keywordflow">if</span> ($authenticate) {</div>
<div class="line"><a id="l02305" name="l02305"></a><span class="lineno"> 2305</span>      <span class="keywordflow">switch</span> ($this-&gt;getConfigValue(<span class="stringliteral">&#39;smtpsecure&#39;</span>)) {</div>
<div class="line"><a id="l02306" name="l02306"></a><span class="lineno"> 2306</span>        <span class="keywordflow">case</span> <span class="stringliteral">&#39;insecure&#39;</span>:</div>
<div class="line"><a id="l02307" name="l02307"></a><span class="lineno"> 2307</span>          $phpMailer-&gt;SMTPSecure = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l02308" name="l02308"></a><span class="lineno"> 2308</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02309" name="l02309"></a><span class="lineno"> 2309</span>        <span class="keywordflow">case</span> <span class="stringliteral">&#39;starttls&#39;</span>:</div>
<div class="line"><a id="l02310" name="l02310"></a><span class="lineno"> 2310</span>          $phpMailer-&gt;SMTPSecure = <span class="stringliteral">&#39;tls&#39;</span>;</div>
<div class="line"><a id="l02311" name="l02311"></a><span class="lineno"> 2311</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02312" name="l02312"></a><span class="lineno"> 2312</span>        <span class="keywordflow">case</span> <span class="stringliteral">&#39;ssl&#39;</span>:</div>
<div class="line"><a id="l02313" name="l02313"></a><span class="lineno"> 2313</span>          $phpMailer-&gt;SMTPSecure = <span class="stringliteral">&#39;ssl&#39;</span>;</div>
<div class="line"><a id="l02314" name="l02314"></a><span class="lineno"> 2314</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02315" name="l02315"></a><span class="lineno"> 2315</span>        <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l02316" name="l02316"></a><span class="lineno"> 2316</span>          $phpMailer-&gt;SMTPSecure = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l02317" name="l02317"></a><span class="lineno"> 2317</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02318" name="l02318"></a><span class="lineno"> 2318</span>      }</div>
<div class="line"><a id="l02319" name="l02319"></a><span class="lineno"> 2319</span>      $phpMailer-&gt;SMTPAuth = <span class="keyword">true</span>;</div>
<div class="line"><a id="l02320" name="l02320"></a><span class="lineno"> 2320</span>      $phpMailer-&gt;Username = $this-&gt;getConfigValue(<span class="stringliteral">&#39;emailuser&#39;</span>);</div>
<div class="line"><a id="l02321" name="l02321"></a><span class="lineno"> 2321</span>      $phpMailer-&gt;Password = $this-&gt;getConfigValue(<span class="stringliteral">&#39;emailpassword&#39;</span>);</div>
<div class="line"><a id="l02322" name="l02322"></a><span class="lineno"> 2322</span>    }</div>
<div class="line"><a id="l02323" name="l02323"></a><span class="lineno"> 2323</span> </div>
<div class="line"><a id="l02324" name="l02324"></a><span class="lineno"> 2324</span>    <span class="keywordflow">return</span> $phpMailer;</div>
<div class="line"><a id="l02325" name="l02325"></a><span class="lineno"> 2325</span>  }</div>
<div class="line"><a id="l02326" name="l02326"></a><span class="lineno"> 2326</span> </div>
<div class="line"><a id="l02334" name="l02334"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a01fa63e084ed727e9a7e0eb0bc2bbba5"> 2334</a></span>  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a01fa63e084ed727e9a7e0eb0bc2bbba5">outBoxSubFolderFromMessageId</a>(<span class="keywordtype">string</span> $messageId):string</div>
<div class="line"><a id="l02335" name="l02335"></a><span class="lineno"> 2335</span>  {</div>
<div class="line"><a id="l02336" name="l02336"></a><span class="lineno"> 2336</span>    <span class="keywordflow">return</span> str_replace([ <span class="charliteral">&#39;@&#39;</span>, <span class="charliteral">&#39;.&#39;</span> ], [ self::MSG_ID_AT, <span class="charliteral">&#39;_&#39;</span> ], substr($messageId, 1, -1));</div>
<div class="line"><a id="l02337" name="l02337"></a><span class="lineno"> 2337</span>  }</div>
<div class="line"><a id="l02338" name="l02338"></a><span class="lineno"> 2338</span> </div>
<div class="line"><a id="l02346" name="l02346"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a4c011d39b66793b8969a1a66e8a74cb6"> 2346</a></span>  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a4c011d39b66793b8969a1a66e8a74cb6">messageIdFromOutBoxSubFolder</a>(<span class="keywordtype">string</span> $outBoxSubFolderPath):string</div>
<div class="line"><a id="l02347" name="l02347"></a><span class="lineno"> 2347</span>  {</div>
<div class="line"><a id="l02348" name="l02348"></a><span class="lineno"> 2348</span>    <span class="keywordflow">return</span> <span class="charliteral">&#39;&lt;&#39;</span> . str_replace([ self::MSG_ID_AT, <span class="charliteral">&#39;_&#39;</span> ], [ <span class="charliteral">&#39;@&#39;</span>, <span class="charliteral">&#39;.&#39;</span> ], $outBoxSubFolderPath) . <span class="charliteral">&#39;&gt;&#39;</span>;</div>
<div class="line"><a id="l02349" name="l02349"></a><span class="lineno"> 2349</span>  }</div>
<div class="line"><a id="l02350" name="l02350"></a><span class="lineno"> 2350</span> </div>
<div class="line"><a id="l02371" name="l02371"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac81b054796aa09191608631425f4b3ee"> 2371</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac81b054796aa09191608631425f4b3ee">addFileAttachment</a>(</div>
<div class="line"><a id="l02372" name="l02372"></a><span class="lineno"> 2372</span>    <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html">PHPMailer</a> $phpMailer,</div>
<div class="line"><a id="l02373" name="l02373"></a><span class="lineno"> 2373</span>    <span class="keywordtype">string</span> $messageId,</div>
<div class="line"><a id="l02374" name="l02374"></a><span class="lineno"> 2374</span>    <span class="keywordtype">string</span> $data,</div>
<div class="line"><a id="l02375" name="l02375"></a><span class="lineno"> 2375</span>    <span class="keywordtype">string</span> $fileName,</div>
<div class="line"><a id="l02376" name="l02376"></a><span class="lineno"> 2376</span>    <span class="keywordtype">string</span> $transferEncoding,</div>
<div class="line"><a id="l02377" name="l02377"></a><span class="lineno"> 2377</span>    <span class="keywordtype">string</span> $mimeType,</div>
<div class="line"><a id="l02378" name="l02378"></a><span class="lineno"> 2378</span>  ) {</div>
<div class="line"><a id="l02379" name="l02379"></a><span class="lineno"> 2379</span>    $linkSizeLimit = $this-&gt;getConfigValue(<span class="stringliteral">&#39;attachmentLinkSizeLimit&#39;</span>, self::DEFAULT_ATTACHMENT_SIZE_LIMIT);</div>
<div class="line"><a id="l02380" name="l02380"></a><span class="lineno"> 2380</span>    $linkExpirationLimit = $this-&gt;getConfigValue(<span class="stringliteral">&#39;attachmentLinkExpirationLimit&#39;</span>, self::DEFAULT_ATTACHMENT_LINK_EXPIRATION_LIMIT);</div>
<div class="line"><a id="l02381" name="l02381"></a><span class="lineno"> 2381</span> </div>
<div class="line"><a id="l02382" name="l02382"></a><span class="lineno"> 2382</span>    $outBoxSubFolderPath = self::outBoxSubFolderFromMessageId($messageId);</div>
<div class="line"><a id="l02383" name="l02383"></a><span class="lineno"> 2383</span>    $outBoxSubFolderPath = UserStorage::pathCat($this-&gt;getOutBoxFolderPath(), $outBoxSubFolderPath);</div>
<div class="line"><a id="l02384" name="l02384"></a><span class="lineno"> 2384</span> </div>
<div class="line"><a id="l02385" name="l02385"></a><span class="lineno"> 2385</span>    $expirationDate = $linkExpirationLimit &lt;= 0</div>
<div class="line"><a id="l02386" name="l02386"></a><span class="lineno"> 2386</span>      ? null</div>
<div class="line"><a id="l02387" name="l02387"></a><span class="lineno"> 2387</span>      : ((<span class="keyword">new</span> DateTimeImmutable(<span class="stringliteral">&#39;UTC midnight&#39;</span>))</div>
<div class="line"><a id="l02388" name="l02388"></a><span class="lineno"> 2388</span>        -&gt;modify(<span class="charliteral">&#39;+&#39;</span> . $linkExpirationLimit . <span class="stringliteral">&#39; days&#39;</span>));</div>
<div class="line"><a id="l02389" name="l02389"></a><span class="lineno"> 2389</span> </div>
<div class="line"><a id="l02390" name="l02390"></a><span class="lineno"> 2390</span>    <span class="keywordflow">if</span> ($linkSizeLimit &gt;= 0 &amp;&amp; strlen($data) &gt; $linkSizeLimit) {</div>
<div class="line"><a id="l02391" name="l02391"></a><span class="lineno"> 2391</span>      $downloadPath = UserStorage::pathCat($outBoxSubFolderPath, $fileName);</div>
<div class="line"><a id="l02392" name="l02392"></a><span class="lineno"> 2392</span>      $downloadFile = $this-&gt;userStorage-&gt;getFile($downloadPath);</div>
<div class="line"><a id="l02393" name="l02393"></a><span class="lineno"> 2393</span>      <span class="keywordflow">if</span> (empty($downloadFile)) {</div>
<div class="line"><a id="l02394" name="l02394"></a><span class="lineno"> 2394</span>        $downloadFile = $this-&gt;userStorage-&gt;putContent($downloadPath, $data);</div>
<div class="line"><a id="l02395" name="l02395"></a><span class="lineno"> 2395</span>      }</div>
<div class="line"><a id="l02396" name="l02396"></a><span class="lineno"> 2396</span>      $shareLink = $this-&gt;simpleSharingService-&gt;linkShare(</div>
<div class="line"><a id="l02397" name="l02397"></a><span class="lineno"> 2397</span>        $downloadFile,</div>
<div class="line"><a id="l02398" name="l02398"></a><span class="lineno"> 2398</span>        $this-&gt;shareOwnerId(),</div>
<div class="line"><a id="l02399" name="l02399"></a><span class="lineno"> 2399</span>        sharePerms: \OCP\Constants::PERMISSION_READ,</div>
<div class="line"><a id="l02400" name="l02400"></a><span class="lineno"> 2400</span>        expirationDate: $expirationDate</div>
<div class="line"><a id="l02401" name="l02401"></a><span class="lineno"> 2401</span>      );</div>
<div class="line"><a id="l02402" name="l02402"></a><span class="lineno"> 2402</span>      $downloadAttachment = $this-&gt;l-&gt;t(</div>
<div class="line"><a id="l02403" name="l02403"></a><span class="lineno"> 2403</span>        <span class="stringliteral">&#39;&lt;!DOCTYPE html&gt;</span></div>
<div class="line"><a id="l02404" name="l02404"></a><span class="lineno"> 2404</span><span class="stringliteral">&lt;html lang=&quot;%1$s&quot;&gt;</span></div>
<div class="line"><a id="l02405" name="l02405"></a><span class="lineno"> 2405</span><span class="stringliteral">  &lt;head&gt;</span></div>
<div class="line"><a id="l02406" name="l02406"></a><span class="lineno"> 2406</span><span class="stringliteral">    &lt;title&gt;%2$s&lt;/title&gt;</span></div>
<div class="line"><a id="l02407" name="l02407"></a><span class="lineno"> 2407</span><span class="stringliteral">    &lt;meta http-equiv=&quot;refresh&quot; content=&quot;%6$d;URL=\&#39;%2$s\&#39;&quot;/&gt;</span></div>
<div class="line"><a id="l02408" name="l02408"></a><span class="lineno"> 2408</span><span class="stringliteral">  &lt;/head&gt;</span></div>
<div class="line"><a id="l02409" name="l02409"></a><span class="lineno"> 2409</span><span class="stringliteral">  &lt;body&gt;</span></div>
<div class="line"><a id="l02410" name="l02410"></a><span class="lineno"> 2410</span><span class="stringliteral">    &lt;div class=&quot;message&quot;&gt;</span></div>
<div class="line"><a id="l02411" name="l02411"></a><span class="lineno"> 2411</span><span class="stringliteral">      You will be redirected to the download location in %6$d seconds. You may as well</span></div>
<div class="line"><a id="l02412" name="l02412"></a><span class="lineno"> 2412</span><span class="stringliteral">      click on the download-link below:</span></div>
<div class="line"><a id="l02413" name="l02413"></a><span class="lineno"> 2413</span><span class="stringliteral">    &lt;/div&gt;</span></div>
<div class="line"><a id="l02414" name="l02414"></a><span class="lineno"> 2414</span><span class="stringliteral">    &lt;blockquote class=&quot;link&quot;&gt;</span></div>
<div class="line"><a id="l02415" name="l02415"></a><span class="lineno"> 2415</span><span class="stringliteral">      &lt;a href=&quot;%2$s&quot;&gt;%2$s&lt;/a&gt;</span></div>
<div class="line"><a id="l02416" name="l02416"></a><span class="lineno"> 2416</span><span class="stringliteral">      &lt;div class=&quot;link-info&quot;&gt;&lt;code&gt;%3$s&lt;/code&gt; -- %4$s, %5$s&lt;/div&gt;</span></div>
<div class="line"><a id="l02417" name="l02417"></a><span class="lineno"> 2417</span><span class="stringliteral">    &lt;/blockquote&gt;</span></div>
<div class="line"><a id="l02418" name="l02418"></a><span class="lineno"> 2418</span><span class="stringliteral">    &lt;div class=&quot;expiration-notice&quot;&gt;</span></div>
<div class="line"><a id="l02419" name="l02419"></a><span class="lineno"> 2419</span><span class="stringliteral">      Please note that the download link will expire on %7$s.</span></div>
<div class="line"><a id="l02420" name="l02420"></a><span class="lineno"> 2420</span><span class="stringliteral">    &lt;/div&gt;</span></div>
<div class="line"><a id="l02421" name="l02421"></a><span class="lineno"> 2421</span><span class="stringliteral">  &lt;/body&gt;</span></div>
<div class="line"><a id="l02422" name="l02422"></a><span class="lineno"> 2422</span><span class="stringliteral">&lt;/html&gt;&#39;</span>, [</div>
<div class="line"><a id="l02423" name="l02423"></a><span class="lineno"> 2423</span>          $this-&gt;getLanguage(),</div>
<div class="line"><a id="l02424" name="l02424"></a><span class="lineno"> 2424</span>          $shareLink,</div>
<div class="line"><a id="l02425" name="l02425"></a><span class="lineno"> 2425</span>          $fileName,</div>
<div class="line"><a id="l02426" name="l02426"></a><span class="lineno"> 2426</span>          Util::humanFileSize($downloadFile-&gt;getSize()),</div>
<div class="line"><a id="l02427" name="l02427"></a><span class="lineno"> 2427</span>          $mimeType,</div>
<div class="line"><a id="l02428" name="l02428"></a><span class="lineno"> 2428</span>          30,</div>
<div class="line"><a id="l02429" name="l02429"></a><span class="lineno"> 2429</span>          $this-&gt;dateTimeFormatter()-&gt;formatDate($expirationDate, <span class="stringliteral">&#39;long&#39;</span>)</div>
<div class="line"><a id="l02430" name="l02430"></a><span class="lineno"> 2430</span>        ]);</div>
<div class="line"><a id="l02431" name="l02431"></a><span class="lineno"> 2431</span>      $data = $downloadAttachment;</div>
<div class="line"><a id="l02432" name="l02432"></a><span class="lineno"> 2432</span>      $fileName = $fileName . <span class="stringliteral">&#39;.html&#39;</span>;</div>
<div class="line"><a id="l02433" name="l02433"></a><span class="lineno"> 2433</span>      $transferEncoding = <span class="stringliteral">&#39;8bit&#39;</span>;</div>
<div class="line"><a id="l02434" name="l02434"></a><span class="lineno"> 2434</span>      $mimeType = <span class="stringliteral">&#39;text/html&#39;</span>;</div>
<div class="line"><a id="l02435" name="l02435"></a><span class="lineno"> 2435</span>      $this-&gt;registerAttachmentDownloadsCleaner();</div>
<div class="line"><a id="l02436" name="l02436"></a><span class="lineno"> 2436</span>    }</div>
<div class="line"><a id="l02437" name="l02437"></a><span class="lineno"> 2437</span>    $phpMailer-&gt;addStringAttachment(</div>
<div class="line"><a id="l02438" name="l02438"></a><span class="lineno"> 2438</span>      $data,</div>
<div class="line"><a id="l02439" name="l02439"></a><span class="lineno"> 2439</span>      $fileName,</div>
<div class="line"><a id="l02440" name="l02440"></a><span class="lineno"> 2440</span>      $transferEncoding,</div>
<div class="line"><a id="l02441" name="l02441"></a><span class="lineno"> 2441</span>      $mimeType,</div>
<div class="line"><a id="l02442" name="l02442"></a><span class="lineno"> 2442</span>    );</div>
<div class="line"><a id="l02443" name="l02443"></a><span class="lineno"> 2443</span>  }</div>
<div class="line"><a id="l02444" name="l02444"></a><span class="lineno"> 2444</span> </div>
<div class="line"><a id="l02460" name="l02460"></a><span class="lineno"> 2460</span>  <span class="keyword">private</span> <span class="keyword">function</span> composeGlobalAttachments(<a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html">PHPMailer</a> $phpMailer, <span class="keywordtype">string</span> $messageId)</div>
<div class="line"><a id="l02461" name="l02461"></a><span class="lineno"> 2461</span>  {</div>
<div class="line"><a id="l02462" name="l02462"></a><span class="lineno"> 2462</span>    <span class="comment">// Add all registered attachments.</span></div>
<div class="line"><a id="l02463" name="l02463"></a><span class="lineno"> 2463</span>    <span class="keywordflow">foreach</span> ($this-&gt;fileAttachments() as $attachment) {</div>
<div class="line"><a id="l02464" name="l02464"></a><span class="lineno"> 2464</span>      <span class="keywordflow">if</span> ($attachment[<span class="stringliteral">&#39;status&#39;</span>] != <span class="stringliteral">&#39;selected&#39;</span>) {</div>
<div class="line"><a id="l02465" name="l02465"></a><span class="lineno"> 2465</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02466" name="l02466"></a><span class="lineno"> 2466</span>      }</div>
<div class="line"><a id="l02467" name="l02467"></a><span class="lineno"> 2467</span>      <span class="keywordflow">if</span> ($attachment[<span class="stringliteral">&#39;type&#39;</span>] == <span class="stringliteral">&#39;message/rfc822&#39;</span>) {</div>
<div class="line"><a id="l02468" name="l02468"></a><span class="lineno"> 2468</span>        $encoding = <span class="stringliteral">&#39;8bit&#39;</span>;</div>
<div class="line"><a id="l02469" name="l02469"></a><span class="lineno"> 2469</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02470" name="l02470"></a><span class="lineno"> 2470</span>        $encoding = <span class="stringliteral">&#39;base64&#39;</span>;</div>
<div class="line"><a id="l02471" name="l02471"></a><span class="lineno"> 2471</span>      }</div>
<div class="line"><a id="l02472" name="l02472"></a><span class="lineno"> 2472</span>      $file = $this-&gt;appStorage-&gt;getFile($attachment[<span class="stringliteral">&#39;tmp_name&#39;</span>]);</div>
<div class="line"><a id="l02473" name="l02473"></a><span class="lineno"> 2473</span> </div>
<div class="line"><a id="l02474" name="l02474"></a><span class="lineno"> 2474</span>      $this-&gt;addFileAttachment(</div>
<div class="line"><a id="l02475" name="l02475"></a><span class="lineno"> 2475</span>        $phpMailer,</div>
<div class="line"><a id="l02476" name="l02476"></a><span class="lineno"> 2476</span>        $messageId,</div>
<div class="line"><a id="l02477" name="l02477"></a><span class="lineno"> 2477</span>        $file-&gt;getContent(),</div>
<div class="line"><a id="l02478" name="l02478"></a><span class="lineno"> 2478</span>        $attachment[<span class="stringliteral">&#39;name&#39;</span>],</div>
<div class="line"><a id="l02479" name="l02479"></a><span class="lineno"> 2479</span>        $encoding,</div>
<div class="line"><a id="l02480" name="l02480"></a><span class="lineno"> 2480</span>        $attachment[<span class="stringliteral">&#39;type&#39;</span>],</div>
<div class="line"><a id="l02481" name="l02481"></a><span class="lineno"> 2481</span>      );</div>
<div class="line"><a id="l02482" name="l02482"></a><span class="lineno"> 2482</span>    }</div>
<div class="line"><a id="l02483" name="l02483"></a><span class="lineno"> 2483</span> </div>
<div class="line"><a id="l02484" name="l02484"></a><span class="lineno"> 2484</span>    <span class="comment">// add &quot;global&quot; blank template attachments with just the orchestra-data</span></div>
<div class="line"><a id="l02485" name="l02485"></a><span class="lineno"> 2485</span>    <span class="comment">// filled. This is needed for bulk-email as personalization just takes too</span></div>
<div class="line"><a id="l02486" name="l02486"></a><span class="lineno"> 2486</span>    <span class="comment">// long.</span></div>
<div class="line"><a id="l02487" name="l02487"></a><span class="lineno"> 2487</span>    <span class="keywordflow">foreach</span> ($this-&gt;blankTemplateAttachments() as $attachment) {</div>
<div class="line"><a id="l02488" name="l02488"></a><span class="lineno"> 2488</span>      <span class="keywordflow">if</span> ($attachment[<span class="stringliteral">&#39;status&#39;</span>] != <span class="stringliteral">&#39;selected&#39;</span>) {</div>
<div class="line"><a id="l02489" name="l02489"></a><span class="lineno"> 2489</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02490" name="l02490"></a><span class="lineno"> 2490</span>      }</div>
<div class="line"><a id="l02491" name="l02491"></a><span class="lineno"> 2491</span> </div>
<div class="line"><a id="l02492" name="l02492"></a><span class="lineno"> 2492</span>      <span class="keywordflow">if</span> (isset($attachment[<span class="stringliteral">&#39;template_id&#39;</span>])) {</div>
<div class="line"><a id="l02493" name="l02493"></a><span class="lineno"> 2493</span>        $templateId = $attachment[<span class="stringliteral">&#39;template_id&#39;</span>];</div>
<div class="line"><a id="l02494" name="l02494"></a><span class="lineno"> 2494</span> </div>
<div class="line"><a id="l02496" name="l02496"></a><span class="lineno"> 2496</span>        $financeService = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(FinanceService::class);</div>
<div class="line"><a id="l02497" name="l02497"></a><span class="lineno"> 2497</span>        <span class="keywordflow">switch</span> ($templateId) {</div>
<div class="line"><a id="l02498" name="l02498"></a><span class="lineno"> 2498</span>          <span class="keywordflow">case</span> ConfigService::DOCUMENT_TEMPLATE_GENERAL_DEBIT_NOTE_MANDATE:</div>
<div class="line"><a id="l02499" name="l02499"></a><span class="lineno"> 2499</span>            $membersProject = $this-&gt;entityManager-&gt;find(</div>
<div class="line"><a id="l02500" name="l02500"></a><span class="lineno"> 2500</span>              Entities\Project::class,</div>
<div class="line"><a id="l02501" name="l02501"></a><span class="lineno"> 2501</span>              $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#af5292021a7603645a7372870c43e6115">getClubMembersProjectId</a>()</div>
<div class="line"><a id="l02502" name="l02502"></a><span class="lineno"> 2502</span>            );</div>
<div class="line"><a id="l02503" name="l02503"></a><span class="lineno"> 2503</span>            <span class="keywordflow">if</span> (empty($membersProject)) {</div>
<div class="line"><a id="l02504" name="l02504"></a><span class="lineno"> 2504</span>              <span class="keywordflow">continue</span> 2;</div>
<div class="line"><a id="l02505" name="l02505"></a><span class="lineno"> 2505</span>            }</div>
<div class="line"><a id="l02506" name="l02506"></a><span class="lineno"> 2506</span>            list($fileData, $mimeType, $fileName) = $financeService-&gt;preFilledDebitMandateForm(</div>
<div class="line"><a id="l02507" name="l02507"></a><span class="lineno"> 2507</span>              <span class="keyword">null</span>, $membersProject, <span class="keyword">null</span>, formName: $templateId);</div>
<div class="line"><a id="l02508" name="l02508"></a><span class="lineno"> 2508</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02509" name="l02509"></a><span class="lineno"> 2509</span>          <span class="keywordflow">case</span> ConfigService::DOCUMENT_TEMPLATE_MEMBER_DATA_UPDATE:</div>
<div class="line"><a id="l02510" name="l02510"></a><span class="lineno"> 2510</span>            $membersProject = $this-&gt;entityManager-&gt;find(</div>
<div class="line"><a id="l02511" name="l02511"></a><span class="lineno"> 2511</span>              Entities\Project::class,</div>
<div class="line"><a id="l02512" name="l02512"></a><span class="lineno"> 2512</span>              $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#af5292021a7603645a7372870c43e6115">getClubMembersProjectId</a>()</div>
<div class="line"><a id="l02513" name="l02513"></a><span class="lineno"> 2513</span>            );</div>
<div class="line"><a id="l02514" name="l02514"></a><span class="lineno"> 2514</span>            <span class="keywordflow">if</span> (empty($membersProject)) {</div>
<div class="line"><a id="l02515" name="l02515"></a><span class="lineno"> 2515</span>              <span class="keywordflow">continue</span> 2;</div>
<div class="line"><a id="l02516" name="l02516"></a><span class="lineno"> 2516</span>            }</div>
<div class="line"><a id="l02517" name="l02517"></a><span class="lineno"> 2517</span>            list($fileData, $mimeType, $fileName) = $financeService-&gt;preFilledDebitMandateForm(</div>
<div class="line"><a id="l02518" name="l02518"></a><span class="lineno"> 2518</span>              <span class="keyword">null</span>, $membersProject, <span class="keyword">null</span>, formName: $templateId);</div>
<div class="line"><a id="l02519" name="l02519"></a><span class="lineno"> 2519</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02520" name="l02520"></a><span class="lineno"> 2520</span>          <span class="keywordflow">case</span> ConfigService::DOCUMENT_TEMPLATE_PROJECT_DEBIT_NOTE_MANDATE:</div>
<div class="line"><a id="l02521" name="l02521"></a><span class="lineno"> 2521</span>            <span class="keywordflow">if</span> (empty($this-&gt;project)) {</div>
<div class="line"><a id="l02522" name="l02522"></a><span class="lineno"> 2522</span>              <span class="keywordflow">continue</span> 2;</div>
<div class="line"><a id="l02523" name="l02523"></a><span class="lineno"> 2523</span>            }</div>
<div class="line"><a id="l02524" name="l02524"></a><span class="lineno"> 2524</span>            list($fileData, $mimeType, $fileName) = $financeService-&gt;preFilledDebitMandateForm(</div>
<div class="line"><a id="l02525" name="l02525"></a><span class="lineno"> 2525</span>              <span class="keyword">null</span>, $this-&gt;project, <span class="keyword">null</span>, formName: $templateId);</div>
<div class="line"><a id="l02526" name="l02526"></a><span class="lineno"> 2526</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02527" name="l02527"></a><span class="lineno"> 2527</span>          <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l02528" name="l02528"></a><span class="lineno"> 2528</span>            <span class="keywordflow">continue</span> 2;</div>
<div class="line"><a id="l02529" name="l02529"></a><span class="lineno"> 2529</span>        }</div>
<div class="line"><a id="l02530" name="l02530"></a><span class="lineno"> 2530</span>        $this-&gt;addFileAttachment(</div>
<div class="line"><a id="l02531" name="l02531"></a><span class="lineno"> 2531</span>          $phpMailer,</div>
<div class="line"><a id="l02532" name="l02532"></a><span class="lineno"> 2532</span>          $messageId,</div>
<div class="line"><a id="l02533" name="l02533"></a><span class="lineno"> 2533</span>          $fileData,</div>
<div class="line"><a id="l02534" name="l02534"></a><span class="lineno"> 2534</span>          $fileName,</div>
<div class="line"><a id="l02535" name="l02535"></a><span class="lineno"> 2535</span>          <span class="stringliteral">&#39;base64&#39;</span>,</div>
<div class="line"><a id="l02536" name="l02536"></a><span class="lineno"> 2536</span>          $mimeType,</div>
<div class="line"><a id="l02537" name="l02537"></a><span class="lineno"> 2537</span>        );</div>
<div class="line"><a id="l02538" name="l02538"></a><span class="lineno"> 2538</span>      }</div>
<div class="line"><a id="l02539" name="l02539"></a><span class="lineno"> 2539</span>    }</div>
<div class="line"><a id="l02540" name="l02540"></a><span class="lineno"> 2540</span>  }</div>
<div class="line"><a id="l02541" name="l02541"></a><span class="lineno"> 2541</span> </div>
<div class="line"><a id="l02584" name="l02584"></a><span class="lineno"> 2584</span>  <span class="keyword">private</span> <span class="keyword">function</span> composeAndSend(</div>
<div class="line"><a id="l02585" name="l02585"></a><span class="lineno"> 2585</span>    <span class="keywordtype">string</span> $strMessage,</div>
<div class="line"><a id="l02586" name="l02586"></a><span class="lineno"> 2586</span>    array $eMails,</div>
<div class="line"><a id="l02587" name="l02587"></a><span class="lineno"> 2587</span>    array $extraAttachments = [],</div>
<div class="line"><a id="l02588" name="l02588"></a><span class="lineno"> 2588</span>    <span class="keywordtype">bool</span> $addCC = <span class="keyword">true</span>,</div>
<div class="line"><a id="l02589" name="l02589"></a><span class="lineno"> 2589</span>    ?<span class="keywordtype">string</span> $messageId = <span class="keyword">null</span>,</div>
<div class="line"><a id="l02590" name="l02590"></a><span class="lineno"> 2590</span>    mixed $references = <span class="keyword">null</span>,</div>
<div class="line"><a id="l02591" name="l02591"></a><span class="lineno"> 2591</span>    array $customHeaders = [],</div>
<div class="line"><a id="l02592" name="l02592"></a><span class="lineno"> 2592</span>    <span class="keywordtype">bool</span> $doNotReply = <span class="keyword">false</span>,</div>
<div class="line"><a id="l02593" name="l02593"></a><span class="lineno"> 2593</span>    <span class="keywordtype">bool</span> $allowDuplicates = <span class="keyword">false</span>,</div>
<div class="line"><a id="l02594" name="l02594"></a><span class="lineno"> 2594</span>  ) {</div>
<div class="line"><a id="l02595" name="l02595"></a><span class="lineno"> 2595</span>    <span class="comment">// Construct an array for the data-base log</span></div>
<div class="line"><a id="l02596" name="l02596"></a><span class="lineno"> 2596</span>    $logMessage = <span class="keyword">new</span> SentEmailDTO;</div>
<div class="line"><a id="l02597" name="l02597"></a><span class="lineno"> 2597</span>    $logMessage-&gt;recipients = $eMails;</div>
<div class="line"><a id="l02598" name="l02598"></a><span class="lineno"> 2598</span> </div>
<div class="line"><a id="l02599" name="l02599"></a><span class="lineno"> 2599</span>    $customHeaders[] = self::HEADER_MARKER;</div>
<div class="line"><a id="l02600" name="l02600"></a><span class="lineno"> 2600</span> </div>
<div class="line"><a id="l02601" name="l02601"></a><span class="lineno"> 2601</span>    <span class="comment">// If we are sending to a single address (i.e. if $strMessage has</span></div>
<div class="line"><a id="l02602" name="l02602"></a><span class="lineno"> 2602</span>    <span class="comment">// been constructed with per-member variable substitution), then</span></div>
<div class="line"><a id="l02603" name="l02603"></a><span class="lineno"> 2603</span>    <span class="comment">// we do not need to send via BCC.</span></div>
<div class="line"><a id="l02604" name="l02604"></a><span class="lineno"> 2604</span>    $singleAddress = <a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a8e12ef5cafdab7b950132867526d1113">count</a>($eMails) == 1;</div>
<div class="line"><a id="l02605" name="l02605"></a><span class="lineno"> 2605</span> </div>
<div class="line"><a id="l02606" name="l02606"></a><span class="lineno"> 2606</span>    <span class="comment">// One big try-catch block. Using exceptions we do not need to</span></div>
<div class="line"><a id="l02607" name="l02607"></a><span class="lineno"> 2607</span>    <span class="comment">// keep track of all return values, which is quite beneficial</span></div>
<div class="line"><a id="l02608" name="l02608"></a><span class="lineno"> 2608</span>    <span class="comment">// here. Some of the stuff below clearly cannot throw, but then</span></div>
<div class="line"><a id="l02609" name="l02609"></a><span class="lineno"> 2609</span>    <span class="comment">// it doesn&#39;t hurt to keep it in the try-block. All data is</span></div>
<div class="line"><a id="l02610" name="l02610"></a><span class="lineno"> 2610</span>    <span class="comment">// added in the try block. There is another try-catch-construct</span></div>
<div class="line"><a id="l02611" name="l02611"></a><span class="lineno"> 2611</span>    <span class="comment">// surrounding the actual sending of the message.</span></div>
<div class="line"><a id="l02612" name="l02612"></a><span class="lineno"> 2612</span>    <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l02613" name="l02613"></a><span class="lineno"> 2613</span> </div>
<div class="line"><a id="l02614" name="l02614"></a><span class="lineno"> 2614</span>      $phpMailer = $this-&gt;getOutboundService(authenticate: <span class="keyword">true</span>);</div>
<div class="line"><a id="l02615" name="l02615"></a><span class="lineno"> 2615</span>      $messageId = $messageId ?? $phpMailer-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#a47e64d2b15ebd283026c4dbbe135c6fa">generateMessageId</a>();</div>
<div class="line"><a id="l02616" name="l02616"></a><span class="lineno"> 2616</span> </div>
<div class="line"><a id="l02617" name="l02617"></a><span class="lineno"> 2617</span>      <span class="comment">// Provide some progress feed-back to amuse the user</span></div>
<div class="line"><a id="l02618" name="l02618"></a><span class="lineno"> 2618</span>      $progressStatus = $this-&gt;progressStatusService-&gt;get($this-&gt;progressToken);</div>
<div class="line"><a id="l02619" name="l02619"></a><span class="lineno"> 2619</span>      $progressStatus-&gt;update(0, <span class="keyword">null</span>, [</div>
<div class="line"><a id="l02620" name="l02620"></a><span class="lineno"> 2620</span>        <span class="stringliteral">&#39;proto&#39;</span> =&gt; <span class="stringliteral">&#39;smtp&#39;</span>,</div>
<div class="line"><a id="l02621" name="l02621"></a><span class="lineno"> 2621</span>        <span class="stringliteral">&#39;total&#39;</span> =&gt;  $this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_PAYLOAD],</div>
<div class="line"><a id="l02622" name="l02622"></a><span class="lineno"> 2622</span>        <span class="stringliteral">&#39;active&#39;</span> =&gt; $this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_COUNT],</div>
<div class="line"><a id="l02623" name="l02623"></a><span class="lineno"> 2623</span>      ]);</div>
<div class="line"><a id="l02624" name="l02624"></a><span class="lineno"> 2624</span>      $phpMailer-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#a09d71aa2b61683913b0c85db146eaaa5">setProgressCallback</a>(<span class="keyword">function</span>($current, $total) use ($progressStatus) {</div>
<div class="line"><a id="l02625" name="l02625"></a><span class="lineno"> 2625</span>        $oldTime = $progressStatus-&gt;getLastModified()-&gt;getTimestamp();</div>
<div class="line"><a id="l02626" name="l02626"></a><span class="lineno"> 2626</span>        $nowTime = time();</div>
<div class="line"><a id="l02627" name="l02627"></a><span class="lineno"> 2627</span>        <span class="keywordflow">if</span> ($current &gt;= $total</div>
<div class="line"><a id="l02628" name="l02628"></a><span class="lineno"> 2628</span>            || ($current - $progressStatus-&gt;getCurrent() &gt;= self::PROGRESS_CHUNK_SIZE</div>
<div class="line"><a id="l02629" name="l02629"></a><span class="lineno"> 2629</span>                &amp;&amp; $nowTime - $oldTime &gt;= self::PROGRESS_THROTTLE_SECONDS)) {</div>
<div class="line"><a id="l02630" name="l02630"></a><span class="lineno"> 2630</span>          $progressStatus-&gt;update($current, $total);</div>
<div class="line"><a id="l02631" name="l02631"></a><span class="lineno"> 2631</span>        }</div>
<div class="line"><a id="l02632" name="l02632"></a><span class="lineno"> 2632</span>      });</div>
<div class="line"><a id="l02633" name="l02633"></a><span class="lineno"> 2633</span> </div>
<div class="line"><a id="l02634" name="l02634"></a><span class="lineno"> 2634</span>      $phpMailer-&gt;Subject = $this-&gt;messageTag . <span class="charliteral">&#39; &#39;</span> . $this-&gt;subject();</div>
<div class="line"><a id="l02635" name="l02635"></a><span class="lineno"> 2635</span>      $logMessage-&gt;subject = $phpMailer-&gt;Subject;</div>
<div class="line"><a id="l02636" name="l02636"></a><span class="lineno"> 2636</span> </div>
<div class="line"><a id="l02637" name="l02637"></a><span class="lineno"> 2637</span>      $senderName = $this-&gt;fromName();</div>
<div class="line"><a id="l02638" name="l02638"></a><span class="lineno"> 2638</span>      $senderEmail = $this-&gt;fromAddress();</div>
<div class="line"><a id="l02639" name="l02639"></a><span class="lineno"> 2639</span> </div>
<div class="line"><a id="l02640" name="l02640"></a><span class="lineno"> 2640</span>      <span class="keywordflow">if</span> ($doNotReply) {</div>
<div class="line"><a id="l02641" name="l02641"></a><span class="lineno"> 2641</span>        list(,$domain) = explode(<span class="charliteral">&#39;@&#39;</span>, $senderEmail);</div>
<div class="line"><a id="l02642" name="l02642"></a><span class="lineno"> 2642</span>        $phpMailer-&gt;addReplyTo(</div>
<div class="line"><a id="l02643" name="l02643"></a><span class="lineno"> 2643</span>          self::DO_NOT_REPLY_SENDER . <span class="charliteral">&#39;@&#39;</span> . $domain,</div>
<div class="line"><a id="l02644" name="l02644"></a><span class="lineno"> 2644</span>          $this-&gt;l-&gt;t(<span class="stringliteral">&#39;DO NOT REPLY&#39;</span>)</div>
<div class="line"><a id="l02645" name="l02645"></a><span class="lineno"> 2645</span>        );</div>
<div class="line"><a id="l02646" name="l02646"></a><span class="lineno"> 2646</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02647" name="l02647"></a><span class="lineno"> 2647</span>        $phpMailer-&gt;addReplyTo($senderEmail, $senderName);</div>
<div class="line"><a id="l02648" name="l02648"></a><span class="lineno"> 2648</span>      }</div>
<div class="line"><a id="l02649" name="l02649"></a><span class="lineno"> 2649</span>      $phpMailer-&gt;setFrom($senderEmail, $senderName);</div>
<div class="line"><a id="l02650" name="l02650"></a><span class="lineno"> 2650</span> </div>
<div class="line"><a id="l02651" name="l02651"></a><span class="lineno"> 2651</span>      $requirePrivacyNotice = <span class="keyword">false</span>;</div>
<div class="line"><a id="l02652" name="l02652"></a><span class="lineno"> 2652</span> </div>
<div class="line"><a id="l02653" name="l02653"></a><span class="lineno"> 2653</span>      <span class="keywordflow">if</span> (!$this-&gt;constructionMode) {</div>
<div class="line"><a id="l02654" name="l02654"></a><span class="lineno"> 2654</span>        <span class="comment">// Loop over all data-base records and add each recipient in turn</span></div>
<div class="line"><a id="l02655" name="l02655"></a><span class="lineno"> 2655</span>        <span class="keywordflow">foreach</span> ($eMails as $recipient) {</div>
<div class="line"><a id="l02656" name="l02656"></a><span class="lineno"> 2656</span> </div>
<div class="line"><a id="l02657" name="l02657"></a><span class="lineno"> 2657</span>          <span class="keywordflow">if</span> ((!empty($this-&gt;project) &amp;&amp; ($recipient[<span class="stringliteral">&#39;userBase&#39;</span>] &amp; RecipientsFilter::MUSICIANS_EXCEPT_PROJECT))</div>
<div class="line"><a id="l02658" name="l02658"></a><span class="lineno"> 2658</span>              || (empty($this-&gt;project) &amp;&amp; $recipient[<span class="stringliteral">&#39;userBase&#39;</span>] == RecipientsFilter::UNDETERMINED_MUSICIANS)) {</div>
<div class="line"><a id="l02659" name="l02659"></a><span class="lineno"> 2659</span>            $requirePrivacyNotice = <span class="keyword">true</span>;</div>
<div class="line"><a id="l02660" name="l02660"></a><span class="lineno"> 2660</span>          }</div>
<div class="line"><a id="l02661" name="l02661"></a><span class="lineno"> 2661</span> </div>
<div class="line"><a id="l02662" name="l02662"></a><span class="lineno"> 2662</span>          <span class="keywordflow">if</span> ($singleAddress || $recipient[<span class="stringliteral">&#39;status&#39;</span>] == RecipientsFilter::MEMBER_STATUS_OPEN) {</div>
<div class="line"><a id="l02663" name="l02663"></a><span class="lineno"> 2663</span>            $phpMailer-&gt;addAddress($recipient[<span class="stringliteral">&#39;email&#39;</span>], $recipient[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l02664" name="l02664"></a><span class="lineno"> 2664</span>          } elseif ($recipient[<span class="stringliteral">&#39;project&#39;</span>] &lt;= 0 || !$this-&gt;discloseRecipients()) {</div>
<div class="line"><a id="l02665" name="l02665"></a><span class="lineno"> 2665</span>            <span class="comment">// blind copy, don&#39;t expose the victim to the others.</span></div>
<div class="line"><a id="l02666" name="l02666"></a><span class="lineno"> 2666</span>            $phpMailer-&gt;addBCC($recipient[<span class="stringliteral">&#39;email&#39;</span>], $recipient[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l02667" name="l02667"></a><span class="lineno"> 2667</span>          } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02668" name="l02668"></a><span class="lineno"> 2668</span>            <span class="comment">// open recipients list is requested, still some recipients are hidden.</span></div>
<div class="line"><a id="l02669" name="l02669"></a><span class="lineno"> 2669</span>            <span class="keywordflow">if</span> ($recipient[<span class="stringliteral">&#39;status&#39;</span>] == MemberStatus::CONDUCTOR ||</div>
<div class="line"><a id="l02670" name="l02670"></a><span class="lineno"> 2670</span>                $recipient[<span class="stringliteral">&#39;status&#39;</span>] == MemberStatus::SOLOIST) {</div>
<div class="line"><a id="l02671" name="l02671"></a><span class="lineno"> 2671</span>              $phpMailer-&gt;addBCC($recipient[<span class="stringliteral">&#39;email&#39;</span>], $recipient[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l02672" name="l02672"></a><span class="lineno"> 2672</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02673" name="l02673"></a><span class="lineno"> 2673</span>              $phpMailer-&gt;addAddress($recipient[<span class="stringliteral">&#39;email&#39;</span>], $recipient[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l02674" name="l02674"></a><span class="lineno"> 2674</span>            }</div>
<div class="line"><a id="l02675" name="l02675"></a><span class="lineno"> 2675</span>          }</div>
<div class="line"><a id="l02676" name="l02676"></a><span class="lineno"> 2676</span>        }</div>
<div class="line"><a id="l02677" name="l02677"></a><span class="lineno"> 2677</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02678" name="l02678"></a><span class="lineno"> 2678</span>        <span class="comment">// Construction mode: per force only send to the developer</span></div>
<div class="line"><a id="l02679" name="l02679"></a><span class="lineno"> 2679</span>        $phpMailer-&gt;addAddress($this-&gt;catchAllEmail, $this-&gt;catchAllName);</div>
<div class="line"><a id="l02680" name="l02680"></a><span class="lineno"> 2680</span>      }</div>
<div class="line"><a id="l02681" name="l02681"></a><span class="lineno"> 2681</span> </div>
<div class="line"><a id="l02682" name="l02682"></a><span class="lineno"> 2682</span>      <span class="keywordflow">if</span> ($requirePrivacyNotice) {</div>
<div class="line"><a id="l02683" name="l02683"></a><span class="lineno"> 2683</span>        $privacyNotice = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aa57ee6dad7c7f33cff6983ad79080946">getConfigValue</a>(<span class="stringliteral">&#39;bulkEmailPrivacyNotice&#39;</span>);</div>
<div class="line"><a id="l02684" name="l02684"></a><span class="lineno"> 2684</span>        <span class="keywordflow">if</span> (!empty($privacyNotice)) {</div>
<div class="line"><a id="l02685" name="l02685"></a><span class="lineno"> 2685</span>          $strMessage .= <span class="stringliteral">&#39;&lt;br/&gt;&lt;hr&gt;&#39;</span> . $privacyNotice;</div>
<div class="line"><a id="l02686" name="l02686"></a><span class="lineno"> 2686</span>        }</div>
<div class="line"><a id="l02687" name="l02687"></a><span class="lineno"> 2687</span>      }</div>
<div class="line"><a id="l02688" name="l02688"></a><span class="lineno"> 2688</span> </div>
<div class="line"><a id="l02689" name="l02689"></a><span class="lineno"> 2689</span>      <span class="comment">// pass the correct path in order for automatic image conversion</span></div>
<div class="line"><a id="l02690" name="l02690"></a><span class="lineno"> 2690</span>      $phpMailer-&gt;msgHTML($strMessage, __DIR__ . <span class="stringliteral">&#39;/../../&#39;</span>);</div>
<div class="line"><a id="l02691" name="l02691"></a><span class="lineno"> 2691</span>      $logMessage-&gt;message = $strMessage;</div>
<div class="line"><a id="l02692" name="l02692"></a><span class="lineno"> 2692</span> </div>
<div class="line"><a id="l02693" name="l02693"></a><span class="lineno"> 2693</span>      <span class="keywordflow">if</span> ($addCC === <span class="keyword">true</span>) {</div>
<div class="line"><a id="l02694" name="l02694"></a><span class="lineno"> 2694</span>        <span class="comment">// Always drop a copy to the orchestra&#39;s email account for</span></div>
<div class="line"><a id="l02695" name="l02695"></a><span class="lineno"> 2695</span>        <span class="comment">// archiving purposes and to catch illegal usage. It is legel</span></div>
<div class="line"><a id="l02696" name="l02696"></a><span class="lineno"> 2696</span>        <span class="comment">// to modify $this-&gt;sender through the email-form.</span></div>
<div class="line"><a id="l02697" name="l02697"></a><span class="lineno"> 2697</span>        $phpMailer-&gt;addCC($this-&gt;catchAllEmail, $senderName);</div>
<div class="line"><a id="l02698" name="l02698"></a><span class="lineno"> 2698</span>      }</div>
<div class="line"><a id="l02699" name="l02699"></a><span class="lineno"> 2699</span> </div>
<div class="line"><a id="l02700" name="l02700"></a><span class="lineno"> 2700</span>      <span class="comment">// If we have further Cc&#39;s, then add them also</span></div>
<div class="line"><a id="l02701" name="l02701"></a><span class="lineno"> 2701</span>      $stringCC = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l02702" name="l02702"></a><span class="lineno"> 2702</span>      <span class="keywordflow">if</span> ($addCC === <span class="keyword">true</span> &amp;&amp; !empty($this-&gt;onLookers[<span class="stringliteral">&#39;CC&#39;</span>])) {</div>
<div class="line"><a id="l02703" name="l02703"></a><span class="lineno"> 2703</span>        <span class="comment">// Now comes some dirty work: we need to split the string in</span></div>
<div class="line"><a id="l02704" name="l02704"></a><span class="lineno"> 2704</span>        <span class="comment">// names and email addresses. We re-construct $this-&gt;CC in this</span></div>
<div class="line"><a id="l02705" name="l02705"></a><span class="lineno"> 2705</span>        <span class="comment">// context, to normalize it for storage in the email-log.</span></div>
<div class="line"><a id="l02706" name="l02706"></a><span class="lineno"> 2706</span> </div>
<div class="line"><a id="l02707" name="l02707"></a><span class="lineno"> 2707</span>        <span class="keywordflow">foreach</span> ($this-&gt;onLookers[<span class="stringliteral">&#39;CC&#39;</span>] as $value) {</div>
<div class="line"><a id="l02708" name="l02708"></a><span class="lineno"> 2708</span>          $stringCC .= $value[<span class="stringliteral">&#39;name&#39;</span>].<span class="stringliteral">&#39; &lt;&#39;</span>.$value[<span class="stringliteral">&#39;email&#39;</span>].<span class="stringliteral">&#39;&gt;, &#39;</span>;</div>
<div class="line"><a id="l02709" name="l02709"></a><span class="lineno"> 2709</span>          <span class="comment">// PHP-Mailer adds &quot; for itself as needed</span></div>
<div class="line"><a id="l02710" name="l02710"></a><span class="lineno"> 2710</span>          $value[<span class="stringliteral">&#39;name&#39;</span>] = trim($value[<span class="stringliteral">&#39;name&#39;</span>], <span class="charliteral">&#39;&quot;&#39;</span>);</div>
<div class="line"><a id="l02711" name="l02711"></a><span class="lineno"> 2711</span>          $phpMailer-&gt;addCC($value[<span class="stringliteral">&#39;email&#39;</span>], $value[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l02712" name="l02712"></a><span class="lineno"> 2712</span>        }</div>
<div class="line"><a id="l02713" name="l02713"></a><span class="lineno"> 2713</span>        $stringCC = trim($stringCC, <span class="stringliteral">&#39;, &#39;</span>);</div>
<div class="line"><a id="l02714" name="l02714"></a><span class="lineno"> 2714</span>      }</div>
<div class="line"><a id="l02715" name="l02715"></a><span class="lineno"> 2715</span>      $logMessage-&gt;CC = $stringCC;</div>
<div class="line"><a id="l02716" name="l02716"></a><span class="lineno"> 2716</span> </div>
<div class="line"><a id="l02717" name="l02717"></a><span class="lineno"> 2717</span>      <span class="comment">// Do the same for Bcc</span></div>
<div class="line"><a id="l02718" name="l02718"></a><span class="lineno"> 2718</span>      $stringBCC = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l02719" name="l02719"></a><span class="lineno"> 2719</span>      <span class="keywordflow">if</span> ($addCC === <span class="keyword">true</span> &amp;&amp; !empty($this-&gt;onLookers[<span class="stringliteral">&#39;BCC&#39;</span>])) {</div>
<div class="line"><a id="l02720" name="l02720"></a><span class="lineno"> 2720</span>        <span class="comment">// Now comes some dirty work: we need to split the string in</span></div>
<div class="line"><a id="l02721" name="l02721"></a><span class="lineno"> 2721</span>        <span class="comment">// names and email addresses.</span></div>
<div class="line"><a id="l02722" name="l02722"></a><span class="lineno"> 2722</span> </div>
<div class="line"><a id="l02723" name="l02723"></a><span class="lineno"> 2723</span>        <span class="keywordflow">foreach</span> ($this-&gt;onLookers[<span class="stringliteral">&#39;BCC&#39;</span>] as $value) {</div>
<div class="line"><a id="l02724" name="l02724"></a><span class="lineno"> 2724</span>          $stringBCC .= $value[<span class="stringliteral">&#39;name&#39;</span>].<span class="stringliteral">&#39; &lt;&#39;</span>.$value[<span class="stringliteral">&#39;email&#39;</span>].<span class="stringliteral">&#39;&gt;, &#39;</span>;</div>
<div class="line"><a id="l02725" name="l02725"></a><span class="lineno"> 2725</span>          <span class="comment">// PHP-Mailer adds &quot; for itself as needed</span></div>
<div class="line"><a id="l02726" name="l02726"></a><span class="lineno"> 2726</span>          $value[<span class="stringliteral">&#39;name&#39;</span>] = trim($value[<span class="stringliteral">&#39;name&#39;</span>], <span class="charliteral">&#39;&quot;&#39;</span>);</div>
<div class="line"><a id="l02727" name="l02727"></a><span class="lineno"> 2727</span>          $phpMailer-&gt;addBCC($value[<span class="stringliteral">&#39;email&#39;</span>], $value[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l02728" name="l02728"></a><span class="lineno"> 2728</span>        }</div>
<div class="line"><a id="l02729" name="l02729"></a><span class="lineno"> 2729</span>        $stringBCC = trim($stringBCC, <span class="stringliteral">&#39;, &#39;</span>);</div>
<div class="line"><a id="l02730" name="l02730"></a><span class="lineno"> 2730</span>      }</div>
<div class="line"><a id="l02731" name="l02731"></a><span class="lineno"> 2731</span>      $logMessage-&gt;BCC = $stringBCC;</div>
<div class="line"><a id="l02732" name="l02732"></a><span class="lineno"> 2732</span> </div>
<div class="line"><a id="l02733" name="l02733"></a><span class="lineno"> 2733</span>      <span class="comment">// compose all global attachments. May replace large attachments by download-links.</span></div>
<div class="line"><a id="l02734" name="l02734"></a><span class="lineno"> 2734</span>      $this-&gt;composeGlobalAttachments($phpMailer, is_string($references) ? $references : $messageId);</div>
<div class="line"><a id="l02735" name="l02735"></a><span class="lineno"> 2735</span> </div>
<div class="line"><a id="l02736" name="l02736"></a><span class="lineno"> 2736</span>      <span class="comment">// Add to-be-attached events.</span></div>
<div class="line"><a id="l02737" name="l02737"></a><span class="lineno"> 2737</span>      $events = $this-&gt;eventAttachments();</div>
<div class="line"><a id="l02738" name="l02738"></a><span class="lineno"> 2738</span>      <span class="keywordflow">if</span> ($this-&gt;projectId &gt; 0 &amp;&amp; !empty($events)) {</div>
<div class="line"><a id="l02739" name="l02739"></a><span class="lineno"> 2739</span>        <span class="comment">// Construct the calendar</span></div>
<div class="line"><a id="l02740" name="l02740"></a><span class="lineno"> 2740</span>        $calendar = $this-&gt;eventsService-&gt;exportEvents($events, $this-&gt;projectName, hideParticipants: <span class="keyword">true</span>);</div>
<div class="line"><a id="l02741" name="l02741"></a><span class="lineno"> 2741</span> </div>
<div class="line"><a id="l02742" name="l02742"></a><span class="lineno"> 2742</span>        <span class="comment">// Encode it as attachment</span></div>
<div class="line"><a id="l02743" name="l02743"></a><span class="lineno"> 2743</span>        $phpMailer-&gt;addStringEmbeddedImage(</div>
<div class="line"><a id="l02744" name="l02744"></a><span class="lineno"> 2744</span>          $calendar,</div>
<div class="line"><a id="l02745" name="l02745"></a><span class="lineno"> 2745</span>          md5($this-&gt;projectName.<span class="stringliteral">&#39;.ics&#39;</span>),</div>
<div class="line"><a id="l02746" name="l02746"></a><span class="lineno"> 2746</span>          $this-&gt;projectName.<span class="stringliteral">&#39;.ics&#39;</span>,</div>
<div class="line"><a id="l02747" name="l02747"></a><span class="lineno"> 2747</span>          <span class="stringliteral">&#39;quoted-printable&#39;</span>,</div>
<div class="line"><a id="l02748" name="l02748"></a><span class="lineno"> 2748</span>          <span class="stringliteral">&#39;text/calendar&#39;</span>);</div>
<div class="line"><a id="l02749" name="l02749"></a><span class="lineno"> 2749</span>      }</div>
<div class="line"><a id="l02750" name="l02750"></a><span class="lineno"> 2750</span> </div>
<div class="line"><a id="l02751" name="l02751"></a><span class="lineno"> 2751</span>      <span class="comment">// All extra (in particular: personal) attachments.</span></div>
<div class="line"><a id="l02752" name="l02752"></a><span class="lineno"> 2752</span>      <span class="keywordflow">foreach</span> ($extraAttachments as $generator) {</div>
<div class="line"><a id="l02753" name="l02753"></a><span class="lineno"> 2753</span>        $attachment = call_user_func($generator);</div>
<div class="line"><a id="l02754" name="l02754"></a><span class="lineno"> 2754</span>        $this-&gt;addFileAttachment(</div>
<div class="line"><a id="l02755" name="l02755"></a><span class="lineno"> 2755</span>          $phpMailer,</div>
<div class="line"><a id="l02756" name="l02756"></a><span class="lineno"> 2756</span>          is_string($references) ? $references : $messageId,</div>
<div class="line"><a id="l02757" name="l02757"></a><span class="lineno"> 2757</span>          $attachment[<span class="stringliteral">&#39;data&#39;</span>],</div>
<div class="line"><a id="l02758" name="l02758"></a><span class="lineno"> 2758</span>          $attachment[<span class="stringliteral">&#39;fileName&#39;</span>],</div>
<div class="line"><a id="l02759" name="l02759"></a><span class="lineno"> 2759</span>          $attachment[<span class="stringliteral">&#39;encoding&#39;</span>],</div>
<div class="line"><a id="l02760" name="l02760"></a><span class="lineno"> 2760</span>          $attachment[<span class="stringliteral">&#39;mimeType&#39;</span>]</div>
<div class="line"><a id="l02761" name="l02761"></a><span class="lineno"> 2761</span>        );</div>
<div class="line"><a id="l02762" name="l02762"></a><span class="lineno"> 2762</span>      }</div>
<div class="line"><a id="l02763" name="l02763"></a><span class="lineno"> 2763</span> </div>
<div class="line"><a id="l02764" name="l02764"></a><span class="lineno"> 2764</span>    } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l02765" name="l02765"></a><span class="lineno"> 2765</span>      <span class="comment">// popup an alert and abort the form-processing</span></div>
<div class="line"><a id="l02766" name="l02766"></a><span class="lineno"> 2766</span> </div>
<div class="line"><a id="l02767" name="l02767"></a><span class="lineno"> 2767</span>      $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l02768" name="l02768"></a><span class="lineno"> 2768</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_MAILER_EXCEPTIONS][] = $this-&gt;formatExceptionMessage($t);</div>
<div class="line"><a id="l02769" name="l02769"></a><span class="lineno"> 2769</span> </div>
<div class="line"><a id="l02770" name="l02770"></a><span class="lineno"> 2770</span>      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02771" name="l02771"></a><span class="lineno"> 2771</span>    }</div>
<div class="line"><a id="l02772" name="l02772"></a><span class="lineno"> 2772</span> </div>
<div class="line"><a id="l02774" name="l02774"></a><span class="lineno"> 2774</span>    $sentEmail = $this-&gt;sentEmail($logMessage, allowDuplicates: $allowDuplicates);</div>
<div class="line"><a id="l02775" name="l02775"></a><span class="lineno"> 2775</span>    <span class="keywordflow">if</span> (!$sentEmail) {</div>
<div class="line"><a id="l02776" name="l02776"></a><span class="lineno"> 2776</span>      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02777" name="l02777"></a><span class="lineno"> 2777</span>    }</div>
<div class="line"><a id="l02778" name="l02778"></a><span class="lineno"> 2778</span> </div>
<div class="line"><a id="l02779" name="l02779"></a><span class="lineno"> 2779</span>    <span class="comment">// install custom message id if given</span></div>
<div class="line"><a id="l02780" name="l02780"></a><span class="lineno"> 2780</span>    <span class="keywordflow">if</span> (!empty($messageId)) {</div>
<div class="line"><a id="l02781" name="l02781"></a><span class="lineno"> 2781</span>      $phpMailer-&gt;MessageID = $messageId;</div>
<div class="line"><a id="l02782" name="l02782"></a><span class="lineno"> 2782</span>    }</div>
<div class="line"><a id="l02783" name="l02783"></a><span class="lineno"> 2783</span>    <span class="keywordflow">if</span> (!empty($references)) {</div>
<div class="line"><a id="l02784" name="l02784"></a><span class="lineno"> 2784</span>      <span class="keywordflow">if</span> (is_string($references)) {</div>
<div class="line"><a id="l02785" name="l02785"></a><span class="lineno"> 2785</span>        <span class="comment">// the id of the master-copy</span></div>
<div class="line"><a id="l02786" name="l02786"></a><span class="lineno"> 2786</span>        $sentEmail-&gt;setReferencing($this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a99b7aab0b8e4fdf667a5729026a0828f">getReference</a>(Entities\SentEmail::class, $references));</div>
<div class="line"><a id="l02787" name="l02787"></a><span class="lineno"> 2787</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02788" name="l02788"></a><span class="lineno"> 2788</span>        $references = array_merge($references, $this-&gt;referencing);</div>
<div class="line"><a id="l02789" name="l02789"></a><span class="lineno"> 2789</span>        sort($references);</div>
<div class="line"><a id="l02790" name="l02790"></a><span class="lineno"> 2790</span>        <span class="keywordflow">foreach</span> ($references as $reference) {</div>
<div class="line"><a id="l02791" name="l02791"></a><span class="lineno"> 2791</span>          <span class="comment">// Adding references unfortunately is not enough, ORM does not match</span></div>
<div class="line"><a id="l02792" name="l02792"></a><span class="lineno"> 2792</span>          <span class="comment">// &quot;un-flushed&quot; newly persisted objects with reference</span></div>
<div class="line"><a id="l02793" name="l02793"></a><span class="lineno"> 2793</span>          <span class="comment">// objects. However, find() does work and obtains the managed object.</span></div>
<div class="line"><a id="l02794" name="l02794"></a><span class="lineno"> 2794</span>          $referencing = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#ab6f5f4edde190f5e5f1cd1e2fdd402d4">getDatabaseRepository</a>(Entities\SentEmail::class)-&gt;find($reference);</div>
<div class="line"><a id="l02795" name="l02795"></a><span class="lineno"> 2795</span>          $sentEmail-&gt;getReferencedBy()-&gt;set($reference, $referencing);</div>
<div class="line"><a id="l02796" name="l02796"></a><span class="lineno"> 2796</span>          $referencing-&gt;setReferencing($sentEmail);</div>
<div class="line"><a id="l02797" name="l02797"></a><span class="lineno"> 2797</span>        }</div>
<div class="line"><a id="l02798" name="l02798"></a><span class="lineno"> 2798</span>      }</div>
<div class="line"><a id="l02799" name="l02799"></a><span class="lineno"> 2799</span>      $phpMailer-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#a791cd59480e37c707d9d3a3c5bd376bc">setReferences</a>((array)$references);</div>
<div class="line"><a id="l02800" name="l02800"></a><span class="lineno"> 2800</span>    }</div>
<div class="line"><a id="l02801" name="l02801"></a><span class="lineno"> 2801</span>    <span class="keywordflow">if</span> (!empty($this-&gt;inReplyToId)) {</div>
<div class="line"><a id="l02802" name="l02802"></a><span class="lineno"> 2802</span>      $phpMailer-&gt;addCustomHeader(<span class="stringliteral">&#39;In-Reply-To&#39;</span>, $this-&gt;inReplyToId);</div>
<div class="line"><a id="l02803" name="l02803"></a><span class="lineno"> 2803</span>    }</div>
<div class="line"><a id="l02804" name="l02804"></a><span class="lineno"> 2804</span> </div>
<div class="line"><a id="l02805" name="l02805"></a><span class="lineno"> 2805</span>    <span class="comment">// add custom headers as requested</span></div>
<div class="line"><a id="l02806" name="l02806"></a><span class="lineno"> 2806</span>    <span class="keywordflow">foreach</span> ($customHeaders as $key =&gt; $value) {</div>
<div class="line"><a id="l02807" name="l02807"></a><span class="lineno"> 2807</span>      <span class="keywordflow">if</span> (is_array($value)) {</div>
<div class="line"><a id="l02808" name="l02808"></a><span class="lineno"> 2808</span>        <span class="keywordflow">foreach</span> ($value as $key =&gt; $value) {</div>
<div class="line"><a id="l02809" name="l02809"></a><span class="lineno"> 2809</span>          $phpMailer-&gt;addCustomHeader($key, $value);</div>
<div class="line"><a id="l02810" name="l02810"></a><span class="lineno"> 2810</span>        }</div>
<div class="line"><a id="l02811" name="l02811"></a><span class="lineno"> 2811</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02812" name="l02812"></a><span class="lineno"> 2812</span>        $phpMailer-&gt;addCustomHeader($key, $value);</div>
<div class="line"><a id="l02813" name="l02813"></a><span class="lineno"> 2813</span>      }</div>
<div class="line"><a id="l02814" name="l02814"></a><span class="lineno"> 2814</span>    }</div>
<div class="line"><a id="l02815" name="l02815"></a><span class="lineno"> 2815</span> </div>
<div class="line"><a id="l02816" name="l02816"></a><span class="lineno"> 2816</span>    <span class="comment">// Finally the point of no return. Send it out!!!</span></div>
<div class="line"><a id="l02817" name="l02817"></a><span class="lineno"> 2817</span>    <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l02818" name="l02818"></a><span class="lineno"> 2818</span>      <span class="comment">// PHPMailer does only throw \Exception(), but sets the code in order to</span></div>
<div class="line"><a id="l02819" name="l02819"></a><span class="lineno"> 2819</span>      <span class="comment">// distinguish between fatal and not fatal errors.</span></div>
<div class="line"><a id="l02820" name="l02820"></a><span class="lineno"> 2820</span>      <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l02821" name="l02821"></a><span class="lineno"> 2821</span>        $phpMailer-&gt;Send();</div>
<div class="line"><a id="l02822" name="l02822"></a><span class="lineno"> 2822</span>      } <span class="keywordflow">catch</span> (\Exception $e) {</div>
<div class="line"><a id="l02823" name="l02823"></a><span class="lineno"> 2823</span>        <span class="keywordflow">switch</span> ($e-&gt;getCode()) {</div>
<div class="line"><a id="l02824" name="l02824"></a><span class="lineno"> 2824</span>          <span class="keywordflow">case</span> PHPMailer::STOP_CONTINUE:</div>
<div class="line"><a id="l02825" name="l02825"></a><span class="lineno"> 2825</span>            <span class="comment">// this actually just means that some recipients have failed. At</span></div>
<div class="line"><a id="l02826" name="l02826"></a><span class="lineno"> 2826</span>            <span class="comment">// least currently this happens only with smtp, which is just the</span></div>
<div class="line"><a id="l02827" name="l02827"></a><span class="lineno"> 2827</span>            <span class="comment">// send-method we are using.</span></div>
<div class="line"><a id="l02828" name="l02828"></a><span class="lineno"> 2828</span>            $failedRecipients = $phpMailer-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#afdd329740ea48df3134056d10c21ea2e">failedRecipients</a>($e-&gt;getMessage());</div>
<div class="line"><a id="l02829" name="l02829"></a><span class="lineno"> 2829</span>            $this-&gt;diagnostics[self::DIAGNOSTICS_FAILED_RECIPIENTS] = array_merge(</div>
<div class="line"><a id="l02830" name="l02830"></a><span class="lineno"> 2830</span>              $this-&gt;diagnostics[self::DIAGNOSTICS_FAILED_RECIPIENTS],</div>
<div class="line"><a id="l02831" name="l02831"></a><span class="lineno"> 2831</span>              $failedRecipients</div>
<div class="line"><a id="l02832" name="l02832"></a><span class="lineno"> 2832</span>            );</div>
<div class="line"><a id="l02833" name="l02833"></a><span class="lineno"> 2833</span>            <span class="comment">// something was sent in this case, so do not terminate and record</span></div>
<div class="line"><a id="l02834" name="l02834"></a><span class="lineno"> 2834</span>            <span class="comment">// the sent message in the sent-folder and the DB.</span></div>
<div class="line"><a id="l02835" name="l02835"></a><span class="lineno"> 2835</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02836" name="l02836"></a><span class="lineno"> 2836</span>          <span class="keywordflow">case</span> PHPMailer::STOP_MESSAGE:</div>
<div class="line"><a id="l02837" name="l02837"></a><span class="lineno"> 2837</span>            <span class="comment">// fallthrough</span></div>
<div class="line"><a id="l02838" name="l02838"></a><span class="lineno"> 2838</span>          <span class="keywordflow">case</span> PHPMailer::STOP_CRITICAL:</div>
<div class="line"><a id="l02839" name="l02839"></a><span class="lineno"> 2839</span>          <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l02840" name="l02840"></a><span class="lineno"> 2840</span>            <span class="keywordflow">throw</span> $e;</div>
<div class="line"><a id="l02841" name="l02841"></a><span class="lineno"> 2841</span>        }</div>
<div class="line"><a id="l02842" name="l02842"></a><span class="lineno"> 2842</span>      }</div>
<div class="line"><a id="l02843" name="l02843"></a><span class="lineno"> 2843</span>      $sentEmail-&gt;setMessageId($phpMailer-&gt;getLastMessageID());</div>
<div class="line"><a id="l02844" name="l02844"></a><span class="lineno"> 2844</span>      $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a8e9e0e801f3bc1dd0ba6575643dc4704">persist</a>($sentEmail);</div>
<div class="line"><a id="l02845" name="l02845"></a><span class="lineno"> 2845</span>      <span class="comment">// $this-&gt;flush(); // nope, first references between sent emails need to be installed</span></div>
<div class="line"><a id="l02846" name="l02846"></a><span class="lineno"> 2846</span>    } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l02847" name="l02847"></a><span class="lineno"> 2847</span>      $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l02848" name="l02848"></a><span class="lineno"> 2848</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_MAILER_EXCEPTIONS][] = $this-&gt;formatExceptionMessage($t);</div>
<div class="line"><a id="l02849" name="l02849"></a><span class="lineno"> 2849</span>      $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a6d05693fe567b9d34daf71eb6c8aecb4">logException</a>($t);</div>
<div class="line"><a id="l02850" name="l02850"></a><span class="lineno"> 2850</span>      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02851" name="l02851"></a><span class="lineno"> 2851</span>    }</div>
<div class="line"><a id="l02852" name="l02852"></a><span class="lineno"> 2852</span> </div>
<div class="line"><a id="l02853" name="l02853"></a><span class="lineno"> 2853</span>    <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l02854" name="l02854"></a><span class="lineno"> 2854</span>      <span class="stringliteral">&#39;messageId&#39;</span> =&gt; $phpMailer-&gt;getLastMessageID(),</div>
<div class="line"><a id="l02855" name="l02855"></a><span class="lineno"> 2855</span>      <span class="stringliteral">&#39;message&#39;</span> =&gt; $phpMailer-&gt;GetSentMIMEMessage(),</div>
<div class="line"><a id="l02856" name="l02856"></a><span class="lineno"> 2856</span>    ];</div>
<div class="line"><a id="l02857" name="l02857"></a><span class="lineno"> 2857</span>  }</div>
<div class="line"><a id="l02858" name="l02858"></a><span class="lineno"> 2858</span> </div>
<div class="line"><a id="l02867" name="l02867"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a91e639d9817255254574e35ba821deab"> 2867</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a91e639d9817255254574e35ba821deab">recordMessageDiagnostics</a>(<span class="keywordtype">string</span> $mimeMsg):void</div>
<div class="line"><a id="l02868" name="l02868"></a><span class="lineno"> 2868</span>  {</div>
<div class="line"><a id="l02869" name="l02869"></a><span class="lineno"> 2869</span>    <span class="comment">// Positive diagnostics</span></div>
<div class="line"><a id="l02870" name="l02870"></a><span class="lineno"> 2870</span>    $this-&gt;diagnostics[self::DIAGNOSTICS_MESSAGE][<span class="stringliteral">&#39;Text&#39;</span>] = self::head($mimeMsg, 40);</div>
<div class="line"><a id="l02871" name="l02871"></a><span class="lineno"> 2871</span> </div>
<div class="line"><a id="l02872" name="l02872"></a><span class="lineno"> 2872</span>    $this-&gt;diagnostics[self::DIAGNOSTICS_MESSAGE][<span class="stringliteral">&#39;Files&#39;</span>] = [];</div>
<div class="line"><a id="l02873" name="l02873"></a><span class="lineno"> 2873</span>    <span class="keywordflow">foreach</span> ($this-&gt;fileAttachments() as $attachment) {</div>
<div class="line"><a id="l02874" name="l02874"></a><span class="lineno"> 2874</span>      <span class="keywordflow">if</span> ($attachment[<span class="stringliteral">&#39;status&#39;</span>] != <span class="stringliteral">&#39;selected&#39;</span>) {</div>
<div class="line"><a id="l02875" name="l02875"></a><span class="lineno"> 2875</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02876" name="l02876"></a><span class="lineno"> 2876</span>      }</div>
<div class="line"><a id="l02877" name="l02877"></a><span class="lineno"> 2877</span>      $size     = \OCP\Util::humanFileSize($attachment[<span class="stringliteral">&#39;size&#39;</span>]);</div>
<div class="line"><a id="l02878" name="l02878"></a><span class="lineno"> 2878</span>      $name     = basename($attachment[<span class="stringliteral">&#39;name&#39;</span>]).<span class="stringliteral">&#39; (&#39;</span>.$size.<span class="charliteral">&#39;)&#39;</span>;</div>
<div class="line"><a id="l02879" name="l02879"></a><span class="lineno"> 2879</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_MESSAGE][<span class="stringliteral">&#39;Files&#39;</span>][] = $name;</div>
<div class="line"><a id="l02880" name="l02880"></a><span class="lineno"> 2880</span>    }</div>
<div class="line"><a id="l02881" name="l02881"></a><span class="lineno"> 2881</span> </div>
<div class="line"><a id="l02882" name="l02882"></a><span class="lineno"> 2882</span>    <span class="keywordflow">foreach</span> ($this-&gt;personalAttachments() as $attachment) {</div>
<div class="line"><a id="l02883" name="l02883"></a><span class="lineno"> 2883</span>      <span class="keywordflow">if</span> ($attachment[<span class="stringliteral">&#39;status&#39;</span>] != <span class="stringliteral">&#39;selected&#39;</span>) {</div>
<div class="line"><a id="l02884" name="l02884"></a><span class="lineno"> 2884</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02885" name="l02885"></a><span class="lineno"> 2885</span>      }</div>
<div class="line"><a id="l02886" name="l02886"></a><span class="lineno"> 2886</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_MESSAGE][<span class="stringliteral">&#39;Files&#39;</span>][] = $attachment[<span class="stringliteral">&#39;name&#39;</span>];</div>
<div class="line"><a id="l02887" name="l02887"></a><span class="lineno"> 2887</span>    }</div>
<div class="line"><a id="l02888" name="l02888"></a><span class="lineno"> 2888</span> </div>
<div class="line"><a id="l02889" name="l02889"></a><span class="lineno"> 2889</span>    $this-&gt;diagnostics[self::DIAGNOSTICS_MESSAGE][<span class="stringliteral">&#39;Events&#39;</span>] = [];</div>
<div class="line"><a id="l02890" name="l02890"></a><span class="lineno"> 2890</span>    $events = $this-&gt;eventAttachments();</div>
<div class="line"><a id="l02891" name="l02891"></a><span class="lineno"> 2891</span>    $locale = $this-&gt;getLocale();</div>
<div class="line"><a id="l02892" name="l02892"></a><span class="lineno"> 2892</span>    $timezone = $this-&gt;getTimezone();</div>
<div class="line"><a id="l02893" name="l02893"></a><span class="lineno"> 2893</span>    <span class="keywordflow">foreach</span> (array_keys($events) as $eventUri) {</div>
<div class="line"><a id="l02894" name="l02894"></a><span class="lineno"> 2894</span>      $event = $this-&gt;eventsService-&gt;fetchEvent($this-&gt;projectId, $eventUri);</div>
<div class="line"><a id="l02895" name="l02895"></a><span class="lineno"> 2895</span>      $datestring = $this-&gt;eventsService-&gt;briefEventDate($event, $timezone, $locale);</div>
<div class="line"><a id="l02896" name="l02896"></a><span class="lineno"> 2896</span>      $name = stripslashes($event[<span class="stringliteral">&#39;summary&#39;</span>]).<span class="stringliteral">&#39;, &#39;</span>.$datestring;</div>
<div class="line"><a id="l02897" name="l02897"></a><span class="lineno"> 2897</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_MESSAGE][<span class="stringliteral">&#39;Events&#39;</span>][] = $name;</div>
<div class="line"><a id="l02898" name="l02898"></a><span class="lineno"> 2898</span>    }</div>
<div class="line"><a id="l02899" name="l02899"></a><span class="lineno"> 2899</span>  }</div>
<div class="line"><a id="l02900" name="l02900"></a><span class="lineno"> 2900</span> </div>
<div class="line"><a id="l02908" name="l02908"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#add8504b52466d3419381680a483a652f"> 2908</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#add8504b52466d3419381680a483a652f">copyToSentFolder</a>(<span class="keywordtype">string</span> $mimeMessage):bool</div>
<div class="line"><a id="l02909" name="l02909"></a><span class="lineno"> 2909</span>  {</div>
<div class="line"><a id="l02910" name="l02910"></a><span class="lineno"> 2910</span>    <span class="comment">// PEAR IMAP works without the c-client library</span></div>
<div class="line"><a id="l02911" name="l02911"></a><span class="lineno"> 2911</span>    ini_set(<span class="stringliteral">&#39;error_reporting&#39;</span>, ini_get(<span class="stringliteral">&#39;error_reporting&#39;</span>) &amp; ~E_STRICT);</div>
<div class="line"><a id="l02912" name="l02912"></a><span class="lineno"> 2912</span> </div>
<div class="line"><a id="l02913" name="l02913"></a><span class="lineno"> 2913</span>    $imapHost   = $this-&gt;getConfigValue(<span class="stringliteral">&#39;imapserver&#39;</span>);</div>
<div class="line"><a id="l02914" name="l02914"></a><span class="lineno"> 2914</span>    $imapPort   = $this-&gt;getConfigValue(<span class="stringliteral">&#39;imapport&#39;</span>);</div>
<div class="line"><a id="l02915" name="l02915"></a><span class="lineno"> 2915</span>    $imapSecurity = $this-&gt;getConfigValue(<span class="stringliteral">&#39;imapsecurity&#39;</span>);</div>
<div class="line"><a id="l02916" name="l02916"></a><span class="lineno"> 2916</span> </div>
<div class="line"><a id="l02917" name="l02917"></a><span class="lineno"> 2917</span>    $progressStatus = $this-&gt;progressStatusService-&gt;get($this-&gt;progressToken);</div>
<div class="line"><a id="l02918" name="l02918"></a><span class="lineno"> 2918</span>    $progressStatus-&gt;update(0, <span class="keyword">null</span>, [</div>
<div class="line"><a id="l02919" name="l02919"></a><span class="lineno"> 2919</span>      <span class="stringliteral">&#39;proto&#39;</span> =&gt; <span class="stringliteral">&#39;imap&#39;</span>,</div>
<div class="line"><a id="l02920" name="l02920"></a><span class="lineno"> 2920</span>      <span class="stringliteral">&#39;total&#39;</span> =&gt;  $this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_PAYLOAD],</div>
<div class="line"><a id="l02921" name="l02921"></a><span class="lineno"> 2921</span>      <span class="stringliteral">&#39;active&#39;</span> =&gt; $this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_COUNT],</div>
<div class="line"><a id="l02922" name="l02922"></a><span class="lineno"> 2922</span>    ]);</div>
<div class="line"><a id="l02923" name="l02923"></a><span class="lineno"> 2923</span>    $imap = <span class="keyword">new</span> Net_IMAP(</div>
<div class="line"><a id="l02924" name="l02924"></a><span class="lineno"> 2924</span>      $imapHost,</div>
<div class="line"><a id="l02925" name="l02925"></a><span class="lineno"> 2925</span>      $imapPort,</div>
<div class="line"><a id="l02926" name="l02926"></a><span class="lineno"> 2926</span>      $imapSecurity == <span class="stringliteral">&#39;starttls&#39;</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>, <span class="stringliteral">&#39;UTF-8&#39;</span>,</div>
<div class="line"><a id="l02927" name="l02927"></a><span class="lineno"> 2927</span>      <span class="keyword">function</span>($current, $total) use ($progressStatus) {</div>
<div class="line"><a id="l02928" name="l02928"></a><span class="lineno"> 2928</span>        <span class="keywordflow">if</span> ($total &lt; 128) {</div>
<div class="line"><a id="l02929" name="l02929"></a><span class="lineno"> 2929</span>          <span class="keywordflow">return</span>; <span class="comment">// ignore non-data transfers</span></div>
<div class="line"><a id="l02930" name="l02930"></a><span class="lineno"> 2930</span>        }</div>
<div class="line"><a id="l02931" name="l02931"></a><span class="lineno"> 2931</span>        $progressStatus-&gt;update($current, $total);</div>
<div class="line"><a id="l02932" name="l02932"></a><span class="lineno"> 2932</span>      },</div>
<div class="line"><a id="l02933" name="l02933"></a><span class="lineno"> 2933</span>      self::PROGRESS_CHUNK_SIZE); <span class="comment">// 4 kb chunk-size</span></div>
<div class="line"><a id="l02934" name="l02934"></a><span class="lineno"> 2934</span> </div>
<div class="line"><a id="l02935" name="l02935"></a><span class="lineno"> 2935</span>    $user = $this-&gt;getConfigValue(<span class="stringliteral">&#39;emailuser&#39;</span>);</div>
<div class="line"><a id="l02936" name="l02936"></a><span class="lineno"> 2936</span>    $pass = $this-&gt;getConfigValue(<span class="stringliteral">&#39;emailpassword&#39;</span>);</div>
<div class="line"><a id="l02937" name="l02937"></a><span class="lineno"> 2937</span>    $ret = $imap-&gt;login($user, $pass);</div>
<div class="line"><a id="l02938" name="l02938"></a><span class="lineno"> 2938</span>    <span class="keywordflow">if</span> ($ret !== <span class="keyword">true</span>) {</div>
<div class="line"><a id="l02939" name="l02939"></a><span class="lineno"> 2939</span>      $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l02940" name="l02940"></a><span class="lineno"> 2940</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_COPY_TO_SENT][<span class="stringliteral">&#39;login&#39;</span>] = $ret-&gt;toString();</div>
<div class="line"><a id="l02941" name="l02941"></a><span class="lineno"> 2941</span>      $imap-&gt;disconnect();</div>
<div class="line"><a id="l02942" name="l02942"></a><span class="lineno"> 2942</span>      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02943" name="l02943"></a><span class="lineno"> 2943</span>    }</div>
<div class="line"><a id="l02944" name="l02944"></a><span class="lineno"> 2944</span> </div>
<div class="line"><a id="l02945" name="l02945"></a><span class="lineno"> 2945</span>    $ret1 = $imap-&gt;selectMailbox(<span class="stringliteral">&#39;Sent&#39;</span>);</div>
<div class="line"><a id="l02946" name="l02946"></a><span class="lineno"> 2946</span>    <span class="keywordflow">if</span> ($ret1 === <span class="keyword">true</span>) {</div>
<div class="line"><a id="l02947" name="l02947"></a><span class="lineno"> 2947</span>      $ret1 = $imap-&gt;appendMessage($mimeMessage, <span class="stringliteral">&#39;Sent&#39;</span>);</div>
<div class="line"><a id="l02948" name="l02948"></a><span class="lineno"> 2948</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02949" name="l02949"></a><span class="lineno"> 2949</span>      $ret2 = $imap-&gt;selectMailbox(<span class="stringliteral">&#39;INBOX.Sent&#39;</span>);</div>
<div class="line"><a id="l02950" name="l02950"></a><span class="lineno"> 2950</span>      <span class="keywordflow">if</span> ($ret === <span class="keyword">true</span>) {</div>
<div class="line"><a id="l02951" name="l02951"></a><span class="lineno"> 2951</span>        $ret2 = $imap-&gt;appendMessage($mimeMessage, <span class="stringliteral">&#39;INBOX.Sent&#39;</span>);</div>
<div class="line"><a id="l02952" name="l02952"></a><span class="lineno"> 2952</span>      }</div>
<div class="line"><a id="l02953" name="l02953"></a><span class="lineno"> 2953</span>    }</div>
<div class="line"><a id="l02954" name="l02954"></a><span class="lineno"> 2954</span>    <span class="keywordflow">if</span> ($ret1 !== <span class="keyword">true</span> &amp;&amp; $ret2 !== <span class="keyword">true</span>) {</div>
<div class="line"><a id="l02955" name="l02955"></a><span class="lineno"> 2955</span>      $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l02956" name="l02956"></a><span class="lineno"> 2956</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_COPY_TO_SENT][<span class="stringliteral">&#39;copy&#39;</span>] = [</div>
<div class="line"><a id="l02957" name="l02957"></a><span class="lineno"> 2957</span>        <span class="stringliteral">&#39;Sent&#39;</span> =&gt; $ret1-&gt;toString(),</div>
<div class="line"><a id="l02958" name="l02958"></a><span class="lineno"> 2958</span>        <span class="stringliteral">&#39;INBOX.Sent&#39;</span> =&gt; $ret2-&gt;toString(),</div>
<div class="line"><a id="l02959" name="l02959"></a><span class="lineno"> 2959</span>      ];</div>
<div class="line"><a id="l02960" name="l02960"></a><span class="lineno"> 2960</span>      $imap-&gt;disconnect();</div>
<div class="line"><a id="l02961" name="l02961"></a><span class="lineno"> 2961</span>      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02962" name="l02962"></a><span class="lineno"> 2962</span>    }</div>
<div class="line"><a id="l02963" name="l02963"></a><span class="lineno"> 2963</span>    $imap-&gt;disconnect();</div>
<div class="line"><a id="l02964" name="l02964"></a><span class="lineno"> 2964</span> </div>
<div class="line"><a id="l02965" name="l02965"></a><span class="lineno"> 2965</span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l02966" name="l02966"></a><span class="lineno"> 2966</span>  }</div>
<div class="line"><a id="l02967" name="l02967"></a><span class="lineno"> 2967</span> </div>
<div class="line"><a id="l02979" name="l02979"></a><span class="lineno"> 2979</span>  <span class="keyword">private</span> <span class="keyword">function</span> sentEmail(<a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_sent_email_d_t_o.html">SentEmailDTO</a> $logMessage, <span class="keywordtype">bool</span> $allowDuplicates = <span class="keyword">false</span>)</div>
<div class="line"><a id="l02980" name="l02980"></a><span class="lineno"> 2980</span>  {</div>
<div class="line"><a id="l02982" name="l02982"></a><span class="lineno"> 2982</span>    $sentEmail = <span class="keyword">new</span> Entities\SentEmail;</div>
<div class="line"><a id="l02983" name="l02983"></a><span class="lineno"> 2983</span> </div>
<div class="line"><a id="l02984" name="l02984"></a><span class="lineno"> 2984</span>    <span class="comment">// Construct one MD5 for recipients subject and html-text</span></div>
<div class="line"><a id="l02985" name="l02985"></a><span class="lineno"> 2985</span>    $bulkRecipients = array_map(<span class="keyword">function</span>($pair) {</div>
<div class="line"><a id="l02986" name="l02986"></a><span class="lineno"> 2986</span>      <span class="keywordflow">return</span> $pair[<span class="stringliteral">&#39;name&#39;</span>].<span class="stringliteral">&#39; &lt;&#39;</span>.$pair[<span class="stringliteral">&#39;email&#39;</span>].<span class="charliteral">&#39;&gt;&#39;</span>;</div>
<div class="line"><a id="l02987" name="l02987"></a><span class="lineno"> 2987</span>    }, $logMessage-&gt;recipients);</div>
<div class="line"><a id="l02988" name="l02988"></a><span class="lineno"> 2988</span> </div>
<div class="line"><a id="l02989" name="l02989"></a><span class="lineno"> 2989</span>    $sentEmail-&gt;setProject($this-&gt;project)</div>
<div class="line"><a id="l02990" name="l02990"></a><span class="lineno"> 2990</span>              -&gt;setBulkRecipients(implode(<span class="charliteral">&#39;;&#39;</span>, $bulkRecipients))</div>
<div class="line"><a id="l02991" name="l02991"></a><span class="lineno"> 2991</span>              -&gt;setCc($logMessage-&gt;CC)</div>
<div class="line"><a id="l02992" name="l02992"></a><span class="lineno"> 2992</span>              -&gt;setBcc($logMessage-&gt;BCC)</div>
<div class="line"><a id="l02993" name="l02993"></a><span class="lineno"> 2993</span>              -&gt;setSubject($logMessage-&gt;subject)</div>
<div class="line"><a id="l02994" name="l02994"></a><span class="lineno"> 2994</span>              -&gt;setHtmlBody($logMessage-&gt;message)</div>
<div class="line"><a id="l02995" name="l02995"></a><span class="lineno"> 2995</span>      <span class="comment">// cannot wait for the slug-handler here</span></div>
<div class="line"><a id="l02996" name="l02996"></a><span class="lineno"> 2996</span>              -&gt;setBulkRecipientsHash(hash(<span class="stringliteral">&#39;md5&#39;</span>, $sentEmail-&gt;getBulkRecipients()))</div>
<div class="line"><a id="l02997" name="l02997"></a><span class="lineno"> 2997</span>              -&gt;setSubjectHash(hash(<span class="stringliteral">&#39;md5&#39;</span>, $sentEmail-&gt;getSubject()))</div>
<div class="line"><a id="l02998" name="l02998"></a><span class="lineno"> 2998</span>              -&gt;setHtmlBodyHash(hash(<span class="stringliteral">&#39;md5&#39;</span>, $sentEmail-&gt;getHtmlBody()));</div>
<div class="line"><a id="l02999" name="l02999"></a><span class="lineno"> 2999</span> </div>
<div class="line"><a id="l03000" name="l03000"></a><span class="lineno"> 3000</span>    <span class="comment">// Now logging is ready to execute. But first check for</span></div>
<div class="line"><a id="l03001" name="l03001"></a><span class="lineno"> 3001</span>    <span class="comment">// duplicate sending attempts. This takes only the recipients,</span></div>
<div class="line"><a id="l03002" name="l03002"></a><span class="lineno"> 3002</span>    <span class="comment">// the subject and the message body into account. Rationale: if</span></div>
<div class="line"><a id="l03003" name="l03003"></a><span class="lineno"> 3003</span>    <span class="comment">// you want to send an updated attachment, then you really</span></div>
<div class="line"><a id="l03004" name="l03004"></a><span class="lineno"> 3004</span>    <span class="comment">// should write a comment on that. Still the test is flaky</span></div>
<div class="line"><a id="l03005" name="l03005"></a><span class="lineno"> 3005</span>    <span class="comment">// enough.</span></div>
<div class="line"><a id="l03006" name="l03006"></a><span class="lineno"> 3006</span> </div>
<div class="line"><a id="l03007" name="l03007"></a><span class="lineno"> 3007</span>    <span class="keywordflow">if</span> ($allowDuplicates !== <span class="keyword">true</span>) {</div>
<div class="line"><a id="l03008" name="l03008"></a><span class="lineno"> 3008</span> </div>
<div class="line"><a id="l03009" name="l03009"></a><span class="lineno"> 3009</span>      $duplicates = $this-&gt;getDatabaseRepository(Entities\SentEmail::class)-&gt;findBy([</div>
<div class="line"><a id="l03010" name="l03010"></a><span class="lineno"> 3010</span>        <span class="stringliteral">&#39;bulkRecipientsHash&#39;</span> =&gt; $sentEmail-&gt;getBulkRecipientsHash(),</div>
<div class="line"><a id="l03011" name="l03011"></a><span class="lineno"> 3011</span>        <span class="stringliteral">&#39;subjectHash&#39;</span> =&gt; $sentEmail-&gt;getSubjectHash(),</div>
<div class="line"><a id="l03012" name="l03012"></a><span class="lineno"> 3012</span>        <span class="stringliteral">&#39;htmlBodyHash&#39;</span> =&gt; $sentEmail-&gt;getHtmlBodyHash(),</div>
<div class="line"><a id="l03013" name="l03013"></a><span class="lineno"> 3013</span>      ]);</div>
<div class="line"><a id="l03014" name="l03014"></a><span class="lineno"> 3014</span> </div>
<div class="line"><a id="l03015" name="l03015"></a><span class="lineno"> 3015</span>      $loggedDates = [];</div>
<div class="line"><a id="l03016" name="l03016"></a><span class="lineno"> 3016</span>      $loggedUsers = [];</div>
<div class="line"><a id="l03018" name="l03018"></a><span class="lineno"> 3018</span>      <span class="keywordflow">foreach</span> ($duplicates as $duplicate) {</div>
<div class="line"><a id="l03019" name="l03019"></a><span class="lineno"> 3019</span>        $loggedDates[] = $duplicate-&gt;getCreated();</div>
<div class="line"><a id="l03020" name="l03020"></a><span class="lineno"> 3020</span>        $loggedUsers[] = $duplicate-&gt;getCreatedBy();</div>
<div class="line"><a id="l03021" name="l03021"></a><span class="lineno"> 3021</span>      }</div>
<div class="line"><a id="l03022" name="l03022"></a><span class="lineno"> 3022</span> </div>
<div class="line"><a id="l03023" name="l03023"></a><span class="lineno"> 3023</span>      <span class="keywordflow">if</span> (!empty($duplicates)) {</div>
<div class="line"><a id="l03024" name="l03024"></a><span class="lineno"> 3024</span>        $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03025" name="l03025"></a><span class="lineno"> 3025</span>        $this-&gt;diagnostics[self::DIAGNOSTICS_DUPLICATES][] = [</div>
<div class="line"><a id="l03026" name="l03026"></a><span class="lineno"> 3026</span>          <span class="stringliteral">&#39;dates&#39;</span> =&gt; $loggedDates,</div>
<div class="line"><a id="l03027" name="l03027"></a><span class="lineno"> 3027</span>          <span class="stringliteral">&#39;authors&#39;</span> =&gt; $loggedUsers,</div>
<div class="line"><a id="l03028" name="l03028"></a><span class="lineno"> 3028</span>          <span class="stringliteral">&#39;text&#39;</span> =&gt; $logMessage-&gt;message,</div>
<div class="line"><a id="l03029" name="l03029"></a><span class="lineno"> 3029</span>          <span class="stringliteral">&#39;recipients&#39;</span> =&gt; $bulkRecipients</div>
<div class="line"><a id="l03030" name="l03030"></a><span class="lineno"> 3030</span>        ];</div>
<div class="line"><a id="l03031" name="l03031"></a><span class="lineno"> 3031</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03032" name="l03032"></a><span class="lineno"> 3032</span>      }</div>
<div class="line"><a id="l03033" name="l03033"></a><span class="lineno"> 3033</span>    }</div>
<div class="line"><a id="l03034" name="l03034"></a><span class="lineno"> 3034</span> </div>
<div class="line"><a id="l03035" name="l03035"></a><span class="lineno"> 3035</span>    <span class="keywordflow">return</span> $sentEmail;</div>
<div class="line"><a id="l03036" name="l03036"></a><span class="lineno"> 3036</span>  }</div>
<div class="line"><a id="l03037" name="l03037"></a><span class="lineno"> 3037</span> </div>
<div class="line"><a id="l03075" name="l03075"></a><span class="lineno"> 3075</span>  <span class="keyword">private</span> <span class="keyword">function</span> composeAndExport(</div>
<div class="line"><a id="l03076" name="l03076"></a><span class="lineno"> 3076</span>    <span class="keywordtype">string</span> $strMessage,</div>
<div class="line"><a id="l03077" name="l03077"></a><span class="lineno"> 3077</span>    array $eMails,</div>
<div class="line"><a id="l03078" name="l03078"></a><span class="lineno"> 3078</span>    array $extraAttachments = [],</div>
<div class="line"><a id="l03079" name="l03079"></a><span class="lineno"> 3079</span>    <span class="keywordtype">bool</span> $addCC = <span class="keyword">true</span>,</div>
<div class="line"><a id="l03080" name="l03080"></a><span class="lineno"> 3080</span>    ?<span class="keywordtype">string</span> $messageId = <span class="keyword">null</span>,</div>
<div class="line"><a id="l03081" name="l03081"></a><span class="lineno"> 3081</span>    mixed $references = <span class="keyword">null</span>,</div>
<div class="line"><a id="l03082" name="l03082"></a><span class="lineno"> 3082</span>    array $customHeaders = [],</div>
<div class="line"><a id="l03083" name="l03083"></a><span class="lineno"> 3083</span>    <span class="keywordtype">bool</span> $doNotReply = <span class="keyword">false</span>,</div>
<div class="line"><a id="l03084" name="l03084"></a><span class="lineno"> 3084</span>  ) {</div>
<div class="line"><a id="l03085" name="l03085"></a><span class="lineno"> 3085</span>    <span class="comment">// Construct an array for the data-base log</span></div>
<div class="line"><a id="l03086" name="l03086"></a><span class="lineno"> 3086</span>    $logMessage = <span class="keyword">new</span> stdClass;</div>
<div class="line"><a id="l03087" name="l03087"></a><span class="lineno"> 3087</span>    $logMessage-&gt;recipients = $eMails;</div>
<div class="line"><a id="l03088" name="l03088"></a><span class="lineno"> 3088</span> </div>
<div class="line"><a id="l03089" name="l03089"></a><span class="lineno"> 3089</span>    $customHeaders[] = self::HEADER_MARKER;</div>
<div class="line"><a id="l03090" name="l03090"></a><span class="lineno"> 3090</span> </div>
<div class="line"><a id="l03091" name="l03091"></a><span class="lineno"> 3091</span>    <span class="comment">// If we are sending to a single address (i.e. if $strMessage has</span></div>
<div class="line"><a id="l03092" name="l03092"></a><span class="lineno"> 3092</span>    <span class="comment">// been constructed with per-member variable substitution), then</span></div>
<div class="line"><a id="l03093" name="l03093"></a><span class="lineno"> 3093</span>    <span class="comment">// we do not need to send via BCC.</span></div>
<div class="line"><a id="l03094" name="l03094"></a><span class="lineno"> 3094</span>    $singleAddress = <a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a8e12ef5cafdab7b950132867526d1113">count</a>($eMails) == 1;</div>
<div class="line"><a id="l03095" name="l03095"></a><span class="lineno"> 3095</span> </div>
<div class="line"><a id="l03096" name="l03096"></a><span class="lineno"> 3096</span>    <span class="comment">// First part: go through the composition part of PHPMailer in</span></div>
<div class="line"><a id="l03097" name="l03097"></a><span class="lineno"> 3097</span>    <span class="comment">// order to have some consistency checks. If this works, we</span></div>
<div class="line"><a id="l03098" name="l03098"></a><span class="lineno"> 3098</span>    <span class="comment">// export the message text, with a short header.</span></div>
<div class="line"><a id="l03099" name="l03099"></a><span class="lineno"> 3099</span>    <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l03100" name="l03100"></a><span class="lineno"> 3100</span> </div>
<div class="line"><a id="l03101" name="l03101"></a><span class="lineno"> 3101</span>      $phpMailer = $this-&gt;getOutboundService();</div>
<div class="line"><a id="l03102" name="l03102"></a><span class="lineno"> 3102</span>      $messageId = $messageId ?? $phpMailer-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#a47e64d2b15ebd283026c4dbbe135c6fa">generateMessageId</a>();</div>
<div class="line"><a id="l03103" name="l03103"></a><span class="lineno"> 3103</span> </div>
<div class="line"><a id="l03104" name="l03104"></a><span class="lineno"> 3104</span>      $phpMailer-&gt;Subject = $this-&gt;messageTag . <span class="charliteral">&#39; &#39;</span> . $this-&gt;subject();</div>
<div class="line"><a id="l03105" name="l03105"></a><span class="lineno"> 3105</span>      $logMessage-&gt;subject = $phpMailer-&gt;Subject;</div>
<div class="line"><a id="l03106" name="l03106"></a><span class="lineno"> 3106</span> </div>
<div class="line"><a id="l03107" name="l03107"></a><span class="lineno"> 3107</span>      $senderName = $this-&gt;fromName();</div>
<div class="line"><a id="l03108" name="l03108"></a><span class="lineno"> 3108</span>      $senderEmail = $this-&gt;fromAddress();</div>
<div class="line"><a id="l03109" name="l03109"></a><span class="lineno"> 3109</span> </div>
<div class="line"><a id="l03110" name="l03110"></a><span class="lineno"> 3110</span>      <span class="keywordflow">if</span> ($doNotReply) {</div>
<div class="line"><a id="l03111" name="l03111"></a><span class="lineno"> 3111</span>        list(,$domain) = explode(<span class="charliteral">&#39;@&#39;</span>, $senderEmail);</div>
<div class="line"><a id="l03112" name="l03112"></a><span class="lineno"> 3112</span>        $phpMailer-&gt;addReplyTo(</div>
<div class="line"><a id="l03113" name="l03113"></a><span class="lineno"> 3113</span>          self::DO_NOT_REPLY_SENDER . <span class="charliteral">&#39;@&#39;</span> . $domain,</div>
<div class="line"><a id="l03114" name="l03114"></a><span class="lineno"> 3114</span>          $this-&gt;l-&gt;t(<span class="stringliteral">&#39;DO NOT REPLY&#39;</span>)</div>
<div class="line"><a id="l03115" name="l03115"></a><span class="lineno"> 3115</span>        );</div>
<div class="line"><a id="l03116" name="l03116"></a><span class="lineno"> 3116</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03117" name="l03117"></a><span class="lineno"> 3117</span>        $phpMailer-&gt;addReplyTo($senderEmail, $senderName);</div>
<div class="line"><a id="l03118" name="l03118"></a><span class="lineno"> 3118</span>      }</div>
<div class="line"><a id="l03119" name="l03119"></a><span class="lineno"> 3119</span> </div>
<div class="line"><a id="l03120" name="l03120"></a><span class="lineno"> 3120</span>      $phpMailer-&gt;SetFrom($senderEmail, $senderName);</div>
<div class="line"><a id="l03121" name="l03121"></a><span class="lineno"> 3121</span> </div>
<div class="line"><a id="l03122" name="l03122"></a><span class="lineno"> 3122</span>      $requirePrivacyNotice = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03123" name="l03123"></a><span class="lineno"> 3123</span> </div>
<div class="line"><a id="l03124" name="l03124"></a><span class="lineno"> 3124</span>      <span class="comment">// Loop over all data-base records and add each recipient in turn</span></div>
<div class="line"><a id="l03125" name="l03125"></a><span class="lineno"> 3125</span>      <span class="keywordflow">foreach</span> ($eMails as $recipient) {</div>
<div class="line"><a id="l03126" name="l03126"></a><span class="lineno"> 3126</span> </div>
<div class="line"><a id="l03127" name="l03127"></a><span class="lineno"> 3127</span>        <span class="keywordflow">if</span> ((!empty($this-&gt;project) &amp;&amp; ($recipient[<span class="stringliteral">&#39;userBase&#39;</span>] &amp; RecipientsFilter::MUSICIANS_EXCEPT_PROJECT))</div>
<div class="line"><a id="l03128" name="l03128"></a><span class="lineno"> 3128</span>            || (empty($this-&gt;project) &amp;&amp; $recipient[<span class="stringliteral">&#39;userBase&#39;</span>] == RecipientsFilter::UNDETERMINED_MUSICIANS)) {</div>
<div class="line"><a id="l03129" name="l03129"></a><span class="lineno"> 3129</span>          $requirePrivacyNotice = <span class="keyword">true</span>;</div>
<div class="line"><a id="l03130" name="l03130"></a><span class="lineno"> 3130</span>        }</div>
<div class="line"><a id="l03131" name="l03131"></a><span class="lineno"> 3131</span> </div>
<div class="line"><a id="l03132" name="l03132"></a><span class="lineno"> 3132</span>        <span class="keywordflow">if</span> ($singleAddress || $recipient[<span class="stringliteral">&#39;status&#39;</span>] == RecipientsFilter::MEMBER_STATUS_OPEN) {</div>
<div class="line"><a id="l03133" name="l03133"></a><span class="lineno"> 3133</span>          $phpMailer-&gt;addAddress($recipient[<span class="stringliteral">&#39;email&#39;</span>], $recipient[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l03134" name="l03134"></a><span class="lineno"> 3134</span>        } elseif ($recipient[<span class="stringliteral">&#39;project&#39;</span>] &lt;= 0 || !$this-&gt;discloseRecipients()) {</div>
<div class="line"><a id="l03135" name="l03135"></a><span class="lineno"> 3135</span>          <span class="comment">// blind copy, don&#39;t expose the victim to the others.</span></div>
<div class="line"><a id="l03136" name="l03136"></a><span class="lineno"> 3136</span>          $phpMailer-&gt;addBCC($recipient[<span class="stringliteral">&#39;email&#39;</span>], $recipient[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l03137" name="l03137"></a><span class="lineno"> 3137</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03138" name="l03138"></a><span class="lineno"> 3138</span>          <span class="comment">// open recipients list is requested, still some recipients are hidden.</span></div>
<div class="line"><a id="l03139" name="l03139"></a><span class="lineno"> 3139</span>          <span class="keywordflow">if</span> ($recipient[<span class="stringliteral">&#39;status&#39;</span>] == MemberStatus::CONDUCTOR ||</div>
<div class="line"><a id="l03140" name="l03140"></a><span class="lineno"> 3140</span>              $recipient[<span class="stringliteral">&#39;status&#39;</span>] == MemberStatus::SOLOIST) {</div>
<div class="line"><a id="l03141" name="l03141"></a><span class="lineno"> 3141</span>            $phpMailer-&gt;addBCC($recipient[<span class="stringliteral">&#39;email&#39;</span>], $recipient[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l03142" name="l03142"></a><span class="lineno"> 3142</span>          } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03143" name="l03143"></a><span class="lineno"> 3143</span>            $phpMailer-&gt;addAddress($recipient[<span class="stringliteral">&#39;email&#39;</span>], $recipient[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l03144" name="l03144"></a><span class="lineno"> 3144</span>          }</div>
<div class="line"><a id="l03145" name="l03145"></a><span class="lineno"> 3145</span>        }</div>
<div class="line"><a id="l03146" name="l03146"></a><span class="lineno"> 3146</span>      }</div>
<div class="line"><a id="l03147" name="l03147"></a><span class="lineno"> 3147</span> </div>
<div class="line"><a id="l03148" name="l03148"></a><span class="lineno"> 3148</span>      <span class="keywordflow">if</span> ($requirePrivacyNotice) {</div>
<div class="line"><a id="l03149" name="l03149"></a><span class="lineno"> 3149</span>        $privacyNotice = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aa57ee6dad7c7f33cff6983ad79080946">getConfigValue</a>(<span class="stringliteral">&#39;bulkEmailPrivacyNotice&#39;</span>);</div>
<div class="line"><a id="l03150" name="l03150"></a><span class="lineno"> 3150</span>        <span class="keywordflow">if</span> (!empty($privacyNotice)) {</div>
<div class="line"><a id="l03151" name="l03151"></a><span class="lineno"> 3151</span>          $strMessage .= <span class="stringliteral">&#39;&lt;br/&gt;&lt;hr&gt;&#39;</span> . $privacyNotice;</div>
<div class="line"><a id="l03152" name="l03152"></a><span class="lineno"> 3152</span>        }</div>
<div class="line"><a id="l03153" name="l03153"></a><span class="lineno"> 3153</span>      }</div>
<div class="line"><a id="l03154" name="l03154"></a><span class="lineno"> 3154</span> </div>
<div class="line"><a id="l03155" name="l03155"></a><span class="lineno"> 3155</span>      <span class="comment">// pass the correct path in order for automatic image conversion</span></div>
<div class="line"><a id="l03156" name="l03156"></a><span class="lineno"> 3156</span>      $phpMailer-&gt;msgHTML($strMessage, __DIR__.<span class="stringliteral">&#39;/../../&#39;</span>);</div>
<div class="line"><a id="l03157" name="l03157"></a><span class="lineno"> 3157</span>      $logMessage-&gt;message = $strMessage;</div>
<div class="line"><a id="l03158" name="l03158"></a><span class="lineno"> 3158</span> </div>
<div class="line"><a id="l03159" name="l03159"></a><span class="lineno"> 3159</span>      <span class="keywordflow">if</span> ($addCC === <span class="keyword">true</span>) {</div>
<div class="line"><a id="l03160" name="l03160"></a><span class="lineno"> 3160</span>        <span class="comment">// Always drop a copy to the orchestra&#39;s email account for</span></div>
<div class="line"><a id="l03161" name="l03161"></a><span class="lineno"> 3161</span>        <span class="comment">// archiving purposes and to catch illegal usage. It is legel</span></div>
<div class="line"><a id="l03162" name="l03162"></a><span class="lineno"> 3162</span>        <span class="comment">// to modify $this-&gt;sender through the email-form.</span></div>
<div class="line"><a id="l03163" name="l03163"></a><span class="lineno"> 3163</span>        $phpMailer-&gt;addCC($this-&gt;catchAllEmail, $senderName);</div>
<div class="line"><a id="l03164" name="l03164"></a><span class="lineno"> 3164</span>      }</div>
<div class="line"><a id="l03165" name="l03165"></a><span class="lineno"> 3165</span> </div>
<div class="line"><a id="l03166" name="l03166"></a><span class="lineno"> 3166</span>      <span class="comment">// If we have further Cc&#39;s, then add them also</span></div>
<div class="line"><a id="l03167" name="l03167"></a><span class="lineno"> 3167</span>      $stringCC = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l03168" name="l03168"></a><span class="lineno"> 3168</span>      <span class="keywordflow">if</span> ($addCC === <span class="keyword">true</span> &amp;&amp; !empty($this-&gt;onLookers[<span class="stringliteral">&#39;CC&#39;</span>])) {</div>
<div class="line"><a id="l03169" name="l03169"></a><span class="lineno"> 3169</span>        <span class="comment">// Now comes some dirty work: we need to split the string in</span></div>
<div class="line"><a id="l03170" name="l03170"></a><span class="lineno"> 3170</span>        <span class="comment">// names and email addresses. We re-construct $this-&gt;CC in this</span></div>
<div class="line"><a id="l03171" name="l03171"></a><span class="lineno"> 3171</span>        <span class="comment">// context, to normalize it for storage in the email-log.</span></div>
<div class="line"><a id="l03172" name="l03172"></a><span class="lineno"> 3172</span> </div>
<div class="line"><a id="l03173" name="l03173"></a><span class="lineno"> 3173</span>        <span class="keywordflow">foreach</span> ($this-&gt;onLookers[<span class="stringliteral">&#39;CC&#39;</span>] as $value) {</div>
<div class="line"><a id="l03174" name="l03174"></a><span class="lineno"> 3174</span>          $stringCC .= $value[<span class="stringliteral">&#39;name&#39;</span>].<span class="stringliteral">&#39; &lt;&#39;</span>.$value[<span class="stringliteral">&#39;email&#39;</span>].<span class="stringliteral">&#39;&gt;, &#39;</span>;</div>
<div class="line"><a id="l03175" name="l03175"></a><span class="lineno"> 3175</span>          <span class="comment">// PHP-Mailer adds &quot; for itself as needed</span></div>
<div class="line"><a id="l03176" name="l03176"></a><span class="lineno"> 3176</span>          $value[<span class="stringliteral">&#39;name&#39;</span>] = trim($value[<span class="stringliteral">&#39;name&#39;</span>], <span class="charliteral">&#39;&quot;&#39;</span>);</div>
<div class="line"><a id="l03177" name="l03177"></a><span class="lineno"> 3177</span>          $phpMailer-&gt;addCC($value[<span class="stringliteral">&#39;email&#39;</span>], $value[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l03178" name="l03178"></a><span class="lineno"> 3178</span>        }</div>
<div class="line"><a id="l03179" name="l03179"></a><span class="lineno"> 3179</span>        $stringCC = trim($stringCC, <span class="stringliteral">&#39;, &#39;</span>);</div>
<div class="line"><a id="l03180" name="l03180"></a><span class="lineno"> 3180</span>      }</div>
<div class="line"><a id="l03181" name="l03181"></a><span class="lineno"> 3181</span>      $logMessage-&gt;CC = $stringCC;</div>
<div class="line"><a id="l03182" name="l03182"></a><span class="lineno"> 3182</span> </div>
<div class="line"><a id="l03183" name="l03183"></a><span class="lineno"> 3183</span>      <span class="comment">// Do the same for Bcc</span></div>
<div class="line"><a id="l03184" name="l03184"></a><span class="lineno"> 3184</span>      $stringBCC = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l03185" name="l03185"></a><span class="lineno"> 3185</span>      <span class="keywordflow">if</span> ($addCC === <span class="keyword">true</span> &amp;&amp; !empty($this-&gt;onLookers[<span class="stringliteral">&#39;BCC&#39;</span>])) {</div>
<div class="line"><a id="l03186" name="l03186"></a><span class="lineno"> 3186</span>        <span class="comment">// Now comes some dirty work: we need to split the string in</span></div>
<div class="line"><a id="l03187" name="l03187"></a><span class="lineno"> 3187</span>        <span class="comment">// names and email addresses.</span></div>
<div class="line"><a id="l03188" name="l03188"></a><span class="lineno"> 3188</span> </div>
<div class="line"><a id="l03189" name="l03189"></a><span class="lineno"> 3189</span>        <span class="keywordflow">foreach</span> ($this-&gt;onLookers[<span class="stringliteral">&#39;BCC&#39;</span>] as $value) {</div>
<div class="line"><a id="l03190" name="l03190"></a><span class="lineno"> 3190</span>          $stringBCC .= $value[<span class="stringliteral">&#39;name&#39;</span>].<span class="stringliteral">&#39; &lt;&#39;</span>.$value[<span class="stringliteral">&#39;email&#39;</span>].<span class="stringliteral">&#39;&gt;, &#39;</span>;</div>
<div class="line"><a id="l03191" name="l03191"></a><span class="lineno"> 3191</span>          <span class="comment">// PHP-Mailer adds &quot; for itself as needed</span></div>
<div class="line"><a id="l03192" name="l03192"></a><span class="lineno"> 3192</span>          $value[<span class="stringliteral">&#39;name&#39;</span>] = trim($value[<span class="stringliteral">&#39;name&#39;</span>], <span class="charliteral">&#39;&quot;&#39;</span>);</div>
<div class="line"><a id="l03193" name="l03193"></a><span class="lineno"> 3193</span>          $phpMailer-&gt;addBCC($value[<span class="stringliteral">&#39;email&#39;</span>], $value[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l03194" name="l03194"></a><span class="lineno"> 3194</span>        }</div>
<div class="line"><a id="l03195" name="l03195"></a><span class="lineno"> 3195</span>        $stringBCC = trim($stringBCC, <span class="stringliteral">&#39;, &#39;</span>);</div>
<div class="line"><a id="l03196" name="l03196"></a><span class="lineno"> 3196</span>      }</div>
<div class="line"><a id="l03197" name="l03197"></a><span class="lineno"> 3197</span>      $logMessage-&gt;BCC = $stringBCC;</div>
<div class="line"><a id="l03198" name="l03198"></a><span class="lineno"> 3198</span> </div>
<div class="line"><a id="l03199" name="l03199"></a><span class="lineno"> 3199</span>      <span class="comment">// compose all global attachments. May replace large attachments by download-links.</span></div>
<div class="line"><a id="l03200" name="l03200"></a><span class="lineno"> 3200</span>      $this-&gt;composeGlobalAttachments($phpMailer, is_string($references) ? $references : $messageId);</div>
<div class="line"><a id="l03201" name="l03201"></a><span class="lineno"> 3201</span> </div>
<div class="line"><a id="l03202" name="l03202"></a><span class="lineno"> 3202</span>      <span class="comment">// Finally possibly to-be-attached events. This cannot throw,</span></div>
<div class="line"><a id="l03203" name="l03203"></a><span class="lineno"> 3203</span>      <span class="comment">// but it does not hurt to keep it here. This way we are just</span></div>
<div class="line"><a id="l03204" name="l03204"></a><span class="lineno"> 3204</span>      <span class="comment">// ready with adding data to the message inside the try-block.</span></div>
<div class="line"><a id="l03205" name="l03205"></a><span class="lineno"> 3205</span>      $events = $this-&gt;eventAttachments();</div>
<div class="line"><a id="l03206" name="l03206"></a><span class="lineno"> 3206</span>      <span class="keywordflow">if</span> ($this-&gt;projectId &gt; 0 &amp;&amp; !empty($events)) {</div>
<div class="line"><a id="l03207" name="l03207"></a><span class="lineno"> 3207</span>        <span class="comment">// Construct the calendar</span></div>
<div class="line"><a id="l03208" name="l03208"></a><span class="lineno"> 3208</span>        $calendar = $this-&gt;eventsService-&gt;exportEvents($events, $this-&gt;projectName, hideParticipants: <span class="keyword">true</span>);</div>
<div class="line"><a id="l03209" name="l03209"></a><span class="lineno"> 3209</span> </div>
<div class="line"><a id="l03210" name="l03210"></a><span class="lineno"> 3210</span>        <span class="comment">// Encode it as attachment</span></div>
<div class="line"><a id="l03211" name="l03211"></a><span class="lineno"> 3211</span>        $phpMailer-&gt;addStringEmbeddedImage(</div>
<div class="line"><a id="l03212" name="l03212"></a><span class="lineno"> 3212</span>          $calendar,</div>
<div class="line"><a id="l03213" name="l03213"></a><span class="lineno"> 3213</span>          md5($this-&gt;projectName.<span class="stringliteral">&#39;.ics&#39;</span>),</div>
<div class="line"><a id="l03214" name="l03214"></a><span class="lineno"> 3214</span>          $this-&gt;projectName.<span class="stringliteral">&#39;.ics&#39;</span>,</div>
<div class="line"><a id="l03215" name="l03215"></a><span class="lineno"> 3215</span>          <span class="stringliteral">&#39;quoted-printable&#39;</span>,</div>
<div class="line"><a id="l03216" name="l03216"></a><span class="lineno"> 3216</span>          <span class="stringliteral">&#39;text/calendar&#39;</span>,</div>
<div class="line"><a id="l03217" name="l03217"></a><span class="lineno"> 3217</span>        );</div>
<div class="line"><a id="l03218" name="l03218"></a><span class="lineno"> 3218</span>      }</div>
<div class="line"><a id="l03219" name="l03219"></a><span class="lineno"> 3219</span> </div>
<div class="line"><a id="l03220" name="l03220"></a><span class="lineno"> 3220</span>      <span class="comment">// All extra (in particular: personal) attachments.</span></div>
<div class="line"><a id="l03221" name="l03221"></a><span class="lineno"> 3221</span>      <span class="keywordflow">foreach</span> ($extraAttachments as $generator) {</div>
<div class="line"><a id="l03222" name="l03222"></a><span class="lineno"> 3222</span>        $attachment = call_user_func($generator);</div>
<div class="line"><a id="l03223" name="l03223"></a><span class="lineno"> 3223</span>        $this-&gt;addFileAttachment(</div>
<div class="line"><a id="l03224" name="l03224"></a><span class="lineno"> 3224</span>          $phpMailer,</div>
<div class="line"><a id="l03225" name="l03225"></a><span class="lineno"> 3225</span>          is_string($references) ? $references : $messageId,</div>
<div class="line"><a id="l03226" name="l03226"></a><span class="lineno"> 3226</span>          $attachment[<span class="stringliteral">&#39;data&#39;</span>],</div>
<div class="line"><a id="l03227" name="l03227"></a><span class="lineno"> 3227</span>          $attachment[<span class="stringliteral">&#39;fileName&#39;</span>],</div>
<div class="line"><a id="l03228" name="l03228"></a><span class="lineno"> 3228</span>          $attachment[<span class="stringliteral">&#39;encoding&#39;</span>],</div>
<div class="line"><a id="l03229" name="l03229"></a><span class="lineno"> 3229</span>          $attachment[<span class="stringliteral">&#39;mimeType&#39;</span>]</div>
<div class="line"><a id="l03230" name="l03230"></a><span class="lineno"> 3230</span>        );</div>
<div class="line"><a id="l03231" name="l03231"></a><span class="lineno"> 3231</span>      }</div>
<div class="line"><a id="l03232" name="l03232"></a><span class="lineno"> 3232</span>    } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l03233" name="l03233"></a><span class="lineno"> 3233</span>      $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a6d05693fe567b9d34daf71eb6c8aecb4">logException</a>($t);</div>
<div class="line"><a id="l03234" name="l03234"></a><span class="lineno"> 3234</span>      <span class="comment">// popup an alert and abort the form-processing</span></div>
<div class="line"><a id="l03235" name="l03235"></a><span class="lineno"> 3235</span> </div>
<div class="line"><a id="l03236" name="l03236"></a><span class="lineno"> 3236</span>      $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03237" name="l03237"></a><span class="lineno"> 3237</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_MAILER_EXCEPTIONS][] = $this-&gt;formatExceptionMessage($t);</div>
<div class="line"><a id="l03238" name="l03238"></a><span class="lineno"> 3238</span> </div>
<div class="line"><a id="l03239" name="l03239"></a><span class="lineno"> 3239</span>      <span class="keywordflow">return</span> <span class="keyword">null</span>;</div>
<div class="line"><a id="l03240" name="l03240"></a><span class="lineno"> 3240</span>    }</div>
<div class="line"><a id="l03241" name="l03241"></a><span class="lineno"> 3241</span> </div>
<div class="line"><a id="l03242" name="l03242"></a><span class="lineno"> 3242</span>    <span class="comment">// install custom message id if given</span></div>
<div class="line"><a id="l03243" name="l03243"></a><span class="lineno"> 3243</span>    <span class="keywordflow">if</span> (!empty($messageId)) {</div>
<div class="line"><a id="l03244" name="l03244"></a><span class="lineno"> 3244</span>      $phpMailer-&gt;MessageID = $messageId;</div>
<div class="line"><a id="l03245" name="l03245"></a><span class="lineno"> 3245</span>    }</div>
<div class="line"><a id="l03246" name="l03246"></a><span class="lineno"> 3246</span>    <span class="keywordflow">if</span> (!empty($references)) {</div>
<div class="line"><a id="l03247" name="l03247"></a><span class="lineno"> 3247</span>      $phpMailer-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#a791cd59480e37c707d9d3a3c5bd376bc">setReferences</a>((array)$references);</div>
<div class="line"><a id="l03248" name="l03248"></a><span class="lineno"> 3248</span>    }</div>
<div class="line"><a id="l03249" name="l03249"></a><span class="lineno"> 3249</span>    <span class="keywordflow">if</span> (!empty($this-&gt;inReplyToId)) {</div>
<div class="line"><a id="l03250" name="l03250"></a><span class="lineno"> 3250</span>      $phpMailer-&gt;addCustomHeader(<span class="stringliteral">&#39;In-Reply-To&#39;</span>, $this-&gt;inReplyToId);</div>
<div class="line"><a id="l03251" name="l03251"></a><span class="lineno"> 3251</span>    }</div>
<div class="line"><a id="l03252" name="l03252"></a><span class="lineno"> 3252</span>    <span class="keywordflow">foreach</span> ($this-&gt;referencing as $referenceMessageId) {</div>
<div class="line"><a id="l03253" name="l03253"></a><span class="lineno"> 3253</span>      $phpMailer-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#ac4f5ea2807846c4cfb8123f501a43959">addReference</a>($referenceMessageId);</div>
<div class="line"><a id="l03254" name="l03254"></a><span class="lineno"> 3254</span>    }</div>
<div class="line"><a id="l03255" name="l03255"></a><span class="lineno"> 3255</span> </div>
<div class="line"><a id="l03256" name="l03256"></a><span class="lineno"> 3256</span>    <span class="comment">// add custom headers as requested</span></div>
<div class="line"><a id="l03257" name="l03257"></a><span class="lineno"> 3257</span>    <span class="keywordflow">foreach</span> ($customHeaders as $key =&gt; $value) {</div>
<div class="line"><a id="l03258" name="l03258"></a><span class="lineno"> 3258</span>      <span class="keywordflow">if</span> (is_array($value)) {</div>
<div class="line"><a id="l03259" name="l03259"></a><span class="lineno"> 3259</span>        <span class="keywordflow">foreach</span> ($value as $key =&gt; $value) {</div>
<div class="line"><a id="l03260" name="l03260"></a><span class="lineno"> 3260</span>          $phpMailer-&gt;addCustomHeader($key, $value);</div>
<div class="line"><a id="l03261" name="l03261"></a><span class="lineno"> 3261</span>        }</div>
<div class="line"><a id="l03262" name="l03262"></a><span class="lineno"> 3262</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03263" name="l03263"></a><span class="lineno"> 3263</span>        $phpMailer-&gt;addCustomHeader($key, $value);</div>
<div class="line"><a id="l03264" name="l03264"></a><span class="lineno"> 3264</span>      }</div>
<div class="line"><a id="l03265" name="l03265"></a><span class="lineno"> 3265</span>    }</div>
<div class="line"><a id="l03266" name="l03266"></a><span class="lineno"> 3266</span> </div>
<div class="line"><a id="l03267" name="l03267"></a><span class="lineno"> 3267</span>    <span class="comment">// Finally the point of no return. Send it out!!! Well. PRE-send it out ...</span></div>
<div class="line"><a id="l03268" name="l03268"></a><span class="lineno"> 3268</span>    <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l03269" name="l03269"></a><span class="lineno"> 3269</span>      $phpMailer-&gt;preSend();</div>
<div class="line"><a id="l03270" name="l03270"></a><span class="lineno"> 3270</span>    } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l03271" name="l03271"></a><span class="lineno"> 3271</span>      $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a6d05693fe567b9d34daf71eb6c8aecb4">logException</a>($t);</div>
<div class="line"><a id="l03272" name="l03272"></a><span class="lineno"> 3272</span>      $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03273" name="l03273"></a><span class="lineno"> 3273</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_MAILER_EXCEPTIONS][] = $this-&gt;formatExceptionMessage($t);</div>
<div class="line"><a id="l03274" name="l03274"></a><span class="lineno"> 3274</span> </div>
<div class="line"><a id="l03275" name="l03275"></a><span class="lineno"> 3275</span>      <span class="keywordflow">return</span> <span class="keyword">null</span>;</div>
<div class="line"><a id="l03276" name="l03276"></a><span class="lineno"> 3276</span>    }</div>
<div class="line"><a id="l03277" name="l03277"></a><span class="lineno"> 3277</span> </div>
<div class="line"><a id="l03278" name="l03278"></a><span class="lineno"> 3278</span>    <span class="comment">// decode the somewhat cryptic fields to a more readable variant and</span></div>
<div class="line"><a id="l03279" name="l03279"></a><span class="lineno"> 3279</span>    <span class="comment">// generate a temporary cache file in order to be able to review the</span></div>
<div class="line"><a id="l03280" name="l03280"></a><span class="lineno"> 3280</span>    <span class="comment">// generated attachments.</span></div>
<div class="line"><a id="l03281" name="l03281"></a><span class="lineno"> 3281</span>    $attachments = [];</div>
<div class="line"><a id="l03282" name="l03282"></a><span class="lineno"> 3282</span>    <span class="keywordflow">foreach</span> ($phpMailer-&gt;getAttachments() as $mailerAttachment) {</div>
<div class="line"><a id="l03283" name="l03283"></a><span class="lineno"> 3283</span>      $attachment = [</div>
<div class="line"><a id="l03284" name="l03284"></a><span class="lineno"> 3284</span>        <span class="stringliteral">&#39;data&#39;</span> =&gt; <span class="keyword">null</span>,</div>
<div class="line"><a id="l03285" name="l03285"></a><span class="lineno"> 3285</span>        <span class="stringliteral">&#39;name&#39;</span> =&gt; $mailerAttachment[PHPMailer::ATTACHMENT_INDEX_NAME],</div>
<div class="line"><a id="l03286" name="l03286"></a><span class="lineno"> 3286</span>        <span class="stringliteral">&#39;size&#39;</span> =&gt; strlen($mailerAttachment[PHPMailer::ATTACHMENT_INDEX_DATA]),</div>
<div class="line"><a id="l03287" name="l03287"></a><span class="lineno"> 3287</span>        <span class="stringliteral">&#39;encoding&#39;</span> =&gt; $mailerAttachment[PHPMailer::ATTACHMENT_INDEX_ENCODING],</div>
<div class="line"><a id="l03288" name="l03288"></a><span class="lineno"> 3288</span>        <span class="stringliteral">&#39;mimeType&#39;</span> =&gt; $mailerAttachment[PHPMailer::ATTACHMENT_INDEX_MIME_TYPE],</div>
<div class="line"><a id="l03289" name="l03289"></a><span class="lineno"> 3289</span>      ];</div>
<div class="line"><a id="l03290" name="l03290"></a><span class="lineno"> 3290</span>      <span class="comment">// generate a cache file for the preview page</span></div>
<div class="line"><a id="l03292" name="l03292"></a><span class="lineno"> 3292</span><span class="comment"></span>      $cloudCache = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(\OCP\ICache::class);</div>
<div class="line"><a id="l03293" name="l03293"></a><span class="lineno"> 3293</span>      $cacheKey = (string)Uuid::create();</div>
<div class="line"><a id="l03294" name="l03294"></a><span class="lineno"> 3294</span> </div>
<div class="line"><a id="l03295" name="l03295"></a><span class="lineno"> 3295</span> </div>
<div class="line"><a id="l03296" name="l03296"></a><span class="lineno"> 3296</span>      $attachment[<span class="stringliteral">&#39;data&#39;</span>] =</div>
<div class="line"><a id="l03297" name="l03297"></a><span class="lineno"> 3297</span>        $cloudCache-&gt;set($cacheKey, $mailerAttachment[PHPMailer::ATTACHMENT_INDEX_DATA] ?: $this-&gt;l-&gt;t(<span class="stringliteral">&#39;*** empty content ***&#39;</span>), self::ATTACHMENT_PREVIEW_CACHE_TTL)</div>
<div class="line"><a id="l03298" name="l03298"></a><span class="lineno"> 3298</span>        ? $cacheKey</div>
<div class="line"><a id="l03299" name="l03299"></a><span class="lineno"> 3299</span>        : <span class="keyword">null</span>;</div>
<div class="line"><a id="l03300" name="l03300"></a><span class="lineno"> 3300</span>      $cloudCache-&gt;set($cacheKey . <span class="stringliteral">&#39;-meta&#39;</span>, json_encode($attachment));</div>
<div class="line"><a id="l03301" name="l03301"></a><span class="lineno"> 3301</span>      $attachments[] = $attachment;</div>
<div class="line"><a id="l03302" name="l03302"></a><span class="lineno"> 3302</span>    }</div>
<div class="line"><a id="l03303" name="l03303"></a><span class="lineno"> 3303</span> </div>
<div class="line"><a id="l03304" name="l03304"></a><span class="lineno"> 3304</span>    <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l03305" name="l03305"></a><span class="lineno"> 3305</span>      <span class="stringliteral">&#39;messageId&#39;</span> =&gt; $phpMailer-&gt;getLastMessageID(),</div>
<div class="line"><a id="l03306" name="l03306"></a><span class="lineno"> 3306</span>      <span class="stringliteral">&#39;headers&#39;</span> =&gt; $phpMailer-&gt;<a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#ad7a38b4a534c0c810df6f217af6ffcb3">getMailHeaders</a>(),</div>
<div class="line"><a id="l03307" name="l03307"></a><span class="lineno"> 3307</span>      <span class="stringliteral">&#39;body&#39;</span> =&gt; $strMessage,</div>
<div class="line"><a id="l03308" name="l03308"></a><span class="lineno"> 3308</span>      <span class="stringliteral">&#39;attachments&#39;</span> =&gt; $attachments,</div>
<div class="line"><a id="l03309" name="l03309"></a><span class="lineno"> 3309</span>    ];</div>
<div class="line"><a id="l03310" name="l03310"></a><span class="lineno"> 3310</span>  }</div>
<div class="line"><a id="l03311" name="l03311"></a><span class="lineno"> 3311</span> </div>
<div class="line"><a id="l03326" name="l03326"></a><span class="lineno"> 3326</span>  <span class="keyword">public</span> <span class="keyword">function</span> previewMessages()</div>
<div class="line"><a id="l03327" name="l03327"></a><span class="lineno"> 3327</span>  {</div>
<div class="line"><a id="l03328" name="l03328"></a><span class="lineno"> 3328</span>    $this-&gt;diagnostics[self::DIAGNOSTICS_STAGE] = self::DIAGNOSTICS_STAGE_PREVIEW;</div>
<div class="line"><a id="l03329" name="l03329"></a><span class="lineno"> 3329</span> </div>
<div class="line"><a id="l03330" name="l03330"></a><span class="lineno"> 3330</span>    $previewRecipients = $this-&gt;recipients;</div>
<div class="line"><a id="l03331" name="l03331"></a><span class="lineno"> 3331</span>    <span class="keywordflow">if</span> (empty($previewRecipients)) {</div>
<div class="line"><a id="l03333" name="l03333"></a><span class="lineno"> 3333</span>      $dummy = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a3a2983317152273aaf635e4bd61f0c7a">appContainer</a>()-&gt;get(InstrumentationService::class)-&gt;getDummyMusician($this-&gt;project);</div>
<div class="line"><a id="l03334" name="l03334"></a><span class="lineno"> 3334</span>      $previewRecipients = [</div>
<div class="line"><a id="l03335" name="l03335"></a><span class="lineno"> 3335</span>        $dummy-&gt;getId() =&gt; [</div>
<div class="line"><a id="l03336" name="l03336"></a><span class="lineno"> 3336</span>          <span class="stringliteral">&#39;email&#39;</span> =&gt; $dummy-&gt;getEmail(),</div>
<div class="line"><a id="l03337" name="l03337"></a><span class="lineno"> 3337</span>          <span class="stringliteral">&#39;name&#39;</span> =&gt; $dummy-&gt;getPublicName(<span class="keyword">true</span>),</div>
<div class="line"><a id="l03338" name="l03338"></a><span class="lineno"> 3338</span>          <span class="stringliteral">&#39;dbdata&#39;</span> =&gt; $dummy,</div>
<div class="line"><a id="l03339" name="l03339"></a><span class="lineno"> 3339</span>          <span class="stringliteral">&#39;userBase&#39;</span> =&gt; 0,</div>
<div class="line"><a id="l03340" name="l03340"></a><span class="lineno"> 3340</span>        ],</div>
<div class="line"><a id="l03341" name="l03341"></a><span class="lineno"> 3341</span>      ];</div>
<div class="line"><a id="l03342" name="l03342"></a><span class="lineno"> 3342</span>    }</div>
<div class="line"><a id="l03343" name="l03343"></a><span class="lineno"> 3343</span> </div>
<div class="line"><a id="l03344" name="l03344"></a><span class="lineno"> 3344</span>    <span class="comment">/* $status = */</span> $this-&gt;preComposeValidation($previewRecipients);</div>
<div class="line"><a id="l03345" name="l03345"></a><span class="lineno"> 3345</span> </div>
<div class="line"><a id="l03346" name="l03346"></a><span class="lineno"> 3346</span>    <span class="comment">// Preliminary checks passed, let&#39;s see what happens. The mailer may throw</span></div>
<div class="line"><a id="l03347" name="l03347"></a><span class="lineno"> 3347</span>    <span class="comment">// any kind of &quot;nasty&quot; exceptions.</span></div>
<div class="line"><a id="l03348" name="l03348"></a><span class="lineno"> 3348</span>    $preview = $this-&gt;exportMessages($previewRecipients);</div>
<div class="line"><a id="l03349" name="l03349"></a><span class="lineno"> 3349</span> </div>
<div class="line"><a id="l03350" name="l03350"></a><span class="lineno"> 3350</span>    <span class="keywordflow">if</span> ($this-&gt;executionStatus()) {</div>
<div class="line"><a id="l03351" name="l03351"></a><span class="lineno"> 3351</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_CAPTION] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Message(s) exported successfully!&#39;</span>);</div>
<div class="line"><a id="l03352" name="l03352"></a><span class="lineno"> 3352</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03353" name="l03353"></a><span class="lineno"> 3353</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_CAPTION] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Prewiew generation detected errors!&#39;</span>);</div>
<div class="line"><a id="l03354" name="l03354"></a><span class="lineno"> 3354</span>    }</div>
<div class="line"><a id="l03355" name="l03355"></a><span class="lineno"> 3355</span> </div>
<div class="line"><a id="l03356" name="l03356"></a><span class="lineno"> 3356</span>    <span class="keywordflow">return</span> $preview;</div>
<div class="line"><a id="l03357" name="l03357"></a><span class="lineno"> 3357</span>  }</div>
<div class="line"><a id="l03358" name="l03358"></a><span class="lineno"> 3358</span> </div>
<div class="line"><a id="l03371" name="l03371"></a><span class="lineno"> 3371</span>  <span class="keyword">private</span> <span class="keyword">function</span> exportMessages(?array $recipients = <span class="keyword">null</span>):?array</div>
<div class="line"><a id="l03372" name="l03372"></a><span class="lineno"> 3372</span>  {</div>
<div class="line"><a id="l03373" name="l03373"></a><span class="lineno"> 3373</span>    <span class="comment">// @todo yield needs more care concerning error management</span></div>
<div class="line"><a id="l03374" name="l03374"></a><span class="lineno"> 3374</span>    $messages = [];</div>
<div class="line"><a id="l03375" name="l03375"></a><span class="lineno"> 3375</span> </div>
<div class="line"><a id="l03376" name="l03376"></a><span class="lineno"> 3376</span>    $this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_COUNT] =</div>
<div class="line"><a id="l03377" name="l03377"></a><span class="lineno"> 3377</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_FAILED_COUNT] = 0;</div>
<div class="line"><a id="l03378" name="l03378"></a><span class="lineno"> 3378</span> </div>
<div class="line"><a id="l03379" name="l03379"></a><span class="lineno"> 3379</span>    <span class="comment">// The following cannot fail, in principle. $message is then</span></div>
<div class="line"><a id="l03380" name="l03380"></a><span class="lineno"> 3380</span>    <span class="comment">// the current template without any left-over globals.</span></div>
<div class="line"><a id="l03381" name="l03381"></a><span class="lineno"> 3381</span> </div>
<div class="line"><a id="l03382" name="l03382"></a><span class="lineno"> 3382</span>    $messageTemplate = implode(<span class="stringliteral">&quot;\n&quot;</span>, array_map(<span class="keyword">function</span>($style) {</div>
<div class="line"><a id="l03383" name="l03383"></a><span class="lineno"> 3383</span>      <span class="keywordflow">return</span> self::emitHtmlBodyStyle($style, self::EMAIL_PREVIEW_SELECTOR);</div>
<div class="line"><a id="l03384" name="l03384"></a><span class="lineno"> 3384</span>    }, self::DEFAULT_HTML_STYLES))</div>
<div class="line"><a id="l03385" name="l03385"></a><span class="lineno"> 3385</span>      . $this-&gt;replaceFormVariables(self::GLOBAL_NAMESPACE);</div>
<div class="line"><a id="l03386" name="l03386"></a><span class="lineno"> 3386</span> </div>
<div class="line"><a id="l03387" name="l03387"></a><span class="lineno"> 3387</span>    <span class="keywordflow">if</span> (!$this-&gt;validateMessageHtml($messageTemplate)) {</div>
<div class="line"><a id="l03388" name="l03388"></a><span class="lineno"> 3388</span>      $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#ab8e67cfd6a09d264ed60634dd794bb30">logInfo</a>(<span class="stringliteral">&#39;LINK VALIDATION FAILED&#39;</span>);</div>
<div class="line"><a id="l03389" name="l03389"></a><span class="lineno"> 3389</span>    }</div>
<div class="line"><a id="l03390" name="l03390"></a><span class="lineno"> 3390</span> </div>
<div class="line"><a id="l03391" name="l03391"></a><span class="lineno"> 3391</span>    $hasPersonalSubstitutions = $this-&gt;hasSubstitutionNamespace(self::MEMBER_NAMESPACE, $messageTemplate);</div>
<div class="line"><a id="l03392" name="l03392"></a><span class="lineno"> 3392</span>    $hasPersonalAttachments = $this-&gt;activePersonalAttachments() &gt; 0;</div>
<div class="line"><a id="l03393" name="l03393"></a><span class="lineno"> 3393</span> </div>
<div class="line"><a id="l03394" name="l03394"></a><span class="lineno"> 3394</span>    $references = [];</div>
<div class="line"><a id="l03395" name="l03395"></a><span class="lineno"> 3395</span>    $templateMessageId = $this-&gt;getOutboundService()-&gt;generateMessageId();</div>
<div class="line"><a id="l03396" name="l03396"></a><span class="lineno"> 3396</span> </div>
<div class="line"><a id="l03397" name="l03397"></a><span class="lineno"> 3397</span>    <span class="keywordflow">if</span> ($hasPersonalSubstitutions || $hasPersonalAttachments) {</div>
<div class="line"><a id="l03398" name="l03398"></a><span class="lineno"> 3398</span> </div>
<div class="line"><a id="l03399" name="l03399"></a><span class="lineno"> 3399</span>      <span class="keywordflow">if</span> ($this-&gt;recipientsFilter-&gt;announcementsMailingList()) {</div>
<div class="line"><a id="l03400" name="l03400"></a><span class="lineno"> 3400</span>        $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03401" name="l03401"></a><span class="lineno"> 3401</span>        $this-&gt;diagnostics[self::DIAGNOSTICS_TEMPLATE_VALIDATION][<span class="stringliteral">&#39;PreconditionError&#39;</span>] = [</div>
<div class="line"><a id="l03402" name="l03402"></a><span class="lineno"> 3402</span>          $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Cannot substitute personal information in mailing list post. Personalized emails have to be send individually.&#39;</span>),</div>
<div class="line"><a id="l03403" name="l03403"></a><span class="lineno"> 3403</span>        ];</div>
<div class="line"><a id="l03404" name="l03404"></a><span class="lineno"> 3404</span>        <span class="keywordflow">if</span> ($hasPersonalSubstitutions) {</div>
<div class="line"><a id="l03405" name="l03405"></a><span class="lineno"> 3405</span>          $this-&gt;diagnostics[self::DIAGNOSTICS_TEMPLATE_VALIDATION][<span class="stringliteral">&#39;PreconditionError&#39;</span>][] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;The email text contains personalized substitutions.&#39;</span>);</div>
<div class="line"><a id="l03406" name="l03406"></a><span class="lineno"> 3406</span>        }</div>
<div class="line"><a id="l03407" name="l03407"></a><span class="lineno"> 3407</span>        <span class="keywordflow">if</span> ($hasPersonalAttachments) {</div>
<div class="line"><a id="l03408" name="l03408"></a><span class="lineno"> 3408</span>          $this-&gt;diagnostics[self::DIAGNOSTICS_TEMPLATE_VALIDATION][<span class="stringliteral">&#39;PreconditionError&#39;</span>][] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;The email contains personalized attachments.&#39;</span>);</div>
<div class="line"><a id="l03409" name="l03409"></a><span class="lineno"> 3409</span>        }</div>
<div class="line"><a id="l03410" name="l03410"></a><span class="lineno"> 3410</span>        <span class="keywordflow">return</span> <span class="keyword">null</span>;</div>
<div class="line"><a id="l03411" name="l03411"></a><span class="lineno"> 3411</span>      }</div>
<div class="line"><a id="l03412" name="l03412"></a><span class="lineno"> 3412</span> </div>
<div class="line"><a id="l03413" name="l03413"></a><span class="lineno"> 3413</span>      $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#ab8e67cfd6a09d264ed60634dd794bb30">logInfo</a>(</div>
<div class="line"><a id="l03414" name="l03414"></a><span class="lineno"> 3414</span>        <span class="stringliteral">&#39;Composing separately because of personal substitutions / attachments &#39;</span></div>
<div class="line"><a id="l03415" name="l03415"></a><span class="lineno"> 3415</span>        . (<span class="keywordtype">int</span>)$hasPersonalSubstitutions</div>
<div class="line"><a id="l03416" name="l03416"></a><span class="lineno"> 3416</span>        . <span class="stringliteral">&#39; / &#39;</span></div>
<div class="line"><a id="l03417" name="l03417"></a><span class="lineno"> 3417</span>        . (<span class="keywordtype">int</span>)$hasPersonalAttachments);</div>
<div class="line"><a id="l03418" name="l03418"></a><span class="lineno"> 3418</span> </div>
<div class="line"><a id="l03419" name="l03419"></a><span class="lineno"> 3419</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_PAYLOAD] = <a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a8e12ef5cafdab7b950132867526d1113">count</a>($recipients)+1;</div>
<div class="line"><a id="l03420" name="l03420"></a><span class="lineno"> 3420</span> </div>
<div class="line"><a id="l03421" name="l03421"></a><span class="lineno"> 3421</span>      <span class="keywordflow">foreach</span> ($recipients as $recipient) {</div>
<div class="line"><a id="l03423" name="l03423"></a><span class="lineno"> 3423</span>        $musician = $recipient[<span class="stringliteral">&#39;dbdata&#39;</span>];</div>
<div class="line"><a id="l03424" name="l03424"></a><span class="lineno"> 3424</span> </div>
<div class="line"><a id="l03425" name="l03425"></a><span class="lineno"> 3425</span>        $this-&gt;implicitFileAttachments = [];</div>
<div class="line"><a id="l03426" name="l03426"></a><span class="lineno"> 3426</span>        $strMessage = $this-&gt;replaceFormVariables(self::MEMBER_NAMESPACE, $musician, $messageTemplate);</div>
<div class="line"><a id="l03427" name="l03427"></a><span class="lineno"> 3427</span>        $strMessage = $this-&gt;finalizeSubstitutions($strMessage);</div>
<div class="line"><a id="l03428" name="l03428"></a><span class="lineno"> 3428</span> </div>
<div class="line"><a id="l03429" name="l03429"></a><span class="lineno"> 3429</span>        $this-&gt;implicitFileAttachments = array_values(array_unique($this-&gt;implicitFileAttachments));</div>
<div class="line"><a id="l03430" name="l03430"></a><span class="lineno"> 3430</span>        <span class="keywordflow">if</span> (!empty($this-&gt;implicitFileAttachments)) {</div>
<div class="line"><a id="l03431" name="l03431"></a><span class="lineno"> 3431</span>          $this-&gt;personalFileAttachments = <span class="keyword">null</span>; <span class="comment">// have to void it ...</span></div>
<div class="line"><a id="l03432" name="l03432"></a><span class="lineno"> 3432</span>          $this-&gt;cgiData[<span class="stringliteral">&#39;attachedFiles&#39;</span>] = array_values(</div>
<div class="line"><a id="l03433" name="l03433"></a><span class="lineno"> 3433</span>            array_unique(</div>
<div class="line"><a id="l03434" name="l03434"></a><span class="lineno"> 3434</span>              array_merge(</div>
<div class="line"><a id="l03435" name="l03435"></a><span class="lineno"> 3435</span>                $this-&gt;cgiData[<span class="stringliteral">&#39;attachedFiles&#39;</span>]??[],</div>
<div class="line"><a id="l03436" name="l03436"></a><span class="lineno"> 3436</span>                $this-&gt;implicitFileAttachments??[]</div>
<div class="line"><a id="l03437" name="l03437"></a><span class="lineno"> 3437</span>              )));</div>
<div class="line"><a id="l03438" name="l03438"></a><span class="lineno"> 3438</span>        }</div>
<div class="line"><a id="l03439" name="l03439"></a><span class="lineno"> 3439</span> </div>
<div class="line"><a id="l03440" name="l03440"></a><span class="lineno"> 3440</span>        $personalAttachments = $this-&gt;composePersonalAttachments($musician);</div>
<div class="line"><a id="l03441" name="l03441"></a><span class="lineno"> 3441</span> </div>
<div class="line"><a id="l03442" name="l03442"></a><span class="lineno"> 3442</span>        ++$this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_COUNT];</div>
<div class="line"><a id="l03443" name="l03443"></a><span class="lineno"> 3443</span>        $message = $this-&gt;composeAndExport(</div>
<div class="line"><a id="l03444" name="l03444"></a><span class="lineno"> 3444</span>          $strMessage,</div>
<div class="line"><a id="l03445" name="l03445"></a><span class="lineno"> 3445</span>          [ $recipient ],</div>
<div class="line"><a id="l03446" name="l03446"></a><span class="lineno"> 3446</span>          $personalAttachments,</div>
<div class="line"><a id="l03447" name="l03447"></a><span class="lineno"> 3447</span>          addCC: <span class="keyword">false</span>,</div>
<div class="line"><a id="l03448" name="l03448"></a><span class="lineno"> 3448</span>          references: $templateMessageId,</div>
<div class="line"><a id="l03449" name="l03449"></a><span class="lineno"> 3449</span>          customHeaders: self::HEADER_MARKER_RECIPIENT,</div>
<div class="line"><a id="l03450" name="l03450"></a><span class="lineno"> 3450</span>        );</div>
<div class="line"><a id="l03451" name="l03451"></a><span class="lineno"> 3451</span>        <span class="keywordflow">if</span> (empty($message) || !empty($this-&gt;diagnostics[self::DIAGNOSTICS_ATTACHMENT_VALIDATION])) {</div>
<div class="line"><a id="l03452" name="l03452"></a><span class="lineno"> 3452</span>          ++$this-&gt;diagnostics[self::DIAGNOSTICS_FAILED_COUNT];</div>
<div class="line"><a id="l03453" name="l03453"></a><span class="lineno"> 3453</span>        }</div>
<div class="line"><a id="l03454" name="l03454"></a><span class="lineno"> 3454</span> </div>
<div class="line"><a id="l03455" name="l03455"></a><span class="lineno"> 3455</span>        <span class="keywordflow">if</span> (!empty($message)) {</div>
<div class="line"><a id="l03456" name="l03456"></a><span class="lineno"> 3456</span>          $messages[] = $message;</div>
<div class="line"><a id="l03457" name="l03457"></a><span class="lineno"> 3457</span>          $references[] = $message[<span class="stringliteral">&#39;messageId&#39;</span>];</div>
<div class="line"><a id="l03458" name="l03458"></a><span class="lineno"> 3458</span>        }</div>
<div class="line"><a id="l03459" name="l03459"></a><span class="lineno"> 3459</span>      }</div>
<div class="line"><a id="l03460" name="l03460"></a><span class="lineno"> 3460</span> </div>
<div class="line"><a id="l03461" name="l03461"></a><span class="lineno"> 3461</span>      <span class="comment">// Finally send one message without template substitution (as</span></div>
<div class="line"><a id="l03462" name="l03462"></a><span class="lineno"> 3462</span>      <span class="comment">// this makes no sense) to all Cc:, Bcc: recipients and the</span></div>
<div class="line"><a id="l03463" name="l03463"></a><span class="lineno"> 3463</span>      <span class="comment">// catch-all. This Message also gets copied to the Sent-folder</span></div>
<div class="line"><a id="l03464" name="l03464"></a><span class="lineno"> 3464</span>      <span class="comment">// on the imap server.</span></div>
<div class="line"><a id="l03465" name="l03465"></a><span class="lineno"> 3465</span>      $messageTemplate = $this-&gt;finalizeSubstitutions($messageTemplate);</div>
<div class="line"><a id="l03466" name="l03466"></a><span class="lineno"> 3466</span>      ++$this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_COUNT];</div>
<div class="line"><a id="l03467" name="l03467"></a><span class="lineno"> 3467</span>      $message = $this-&gt;composeAndExport(</div>
<div class="line"><a id="l03468" name="l03468"></a><span class="lineno"> 3468</span>        $messageTemplate, [], [],</div>
<div class="line"><a id="l03469" name="l03469"></a><span class="lineno"> 3469</span>        addCC: <span class="keyword">true</span>,</div>
<div class="line"><a id="l03470" name="l03470"></a><span class="lineno"> 3470</span>        messageId: $templateMessageId,</div>
<div class="line"><a id="l03471" name="l03471"></a><span class="lineno"> 3471</span>        references: $references,</div>
<div class="line"><a id="l03472" name="l03472"></a><span class="lineno"> 3472</span>        customHeaders: self::HEADER_MARKER_SENT,</div>
<div class="line"><a id="l03473" name="l03473"></a><span class="lineno"> 3473</span>        doNotReply: <span class="keyword">true</span>,</div>
<div class="line"><a id="l03474" name="l03474"></a><span class="lineno"> 3474</span>      );</div>
<div class="line"><a id="l03475" name="l03475"></a><span class="lineno"> 3475</span>      <span class="keywordflow">if</span> (empty($message) || !empty($this-&gt;diagnostics[self::DIAGNOSTICS_ATTACHMENT_VALIDATION])) {</div>
<div class="line"><a id="l03476" name="l03476"></a><span class="lineno"> 3476</span>        ++$this-&gt;diagnostics[self::DIAGNOSTICS_FAILED_COUNT];</div>
<div class="line"><a id="l03477" name="l03477"></a><span class="lineno"> 3477</span>      }</div>
<div class="line"><a id="l03478" name="l03478"></a><span class="lineno"> 3478</span> </div>
<div class="line"><a id="l03479" name="l03479"></a><span class="lineno"> 3479</span>      <span class="keywordflow">if</span> (!empty($message)) {</div>
<div class="line"><a id="l03480" name="l03480"></a><span class="lineno"> 3480</span>        $messages[] = $message;</div>
<div class="line"><a id="l03481" name="l03481"></a><span class="lineno"> 3481</span>      }</div>
<div class="line"><a id="l03482" name="l03482"></a><span class="lineno"> 3482</span> </div>
<div class="line"><a id="l03483" name="l03483"></a><span class="lineno"> 3483</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03484" name="l03484"></a><span class="lineno"> 3484</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_PAYLOAD] = 1;</div>
<div class="line"><a id="l03485" name="l03485"></a><span class="lineno"> 3485</span>      ++$this-&gt;diagnostics[self::DIAGNOSTICS_TOTAL_COUNT]; <span class="comment">// this is ONE then ...</span></div>
<div class="line"><a id="l03486" name="l03486"></a><span class="lineno"> 3486</span>      $messageTemplate = $this-&gt;finalizeSubstitutions($messageTemplate);</div>
<div class="line"><a id="l03487" name="l03487"></a><span class="lineno"> 3487</span> </div>
<div class="line"><a id="l03488" name="l03488"></a><span class="lineno"> 3488</span>      <span class="comment">// if possible use the announcements mailing list</span></div>
<div class="line"><a id="l03489" name="l03489"></a><span class="lineno"> 3489</span> </div>
<div class="line"><a id="l03490" name="l03490"></a><span class="lineno"> 3490</span>      $announcementsList = $this-&gt;recipientsFilter-&gt;substituteAnnouncementsMailingList($recipients);</div>
<div class="line"><a id="l03491" name="l03491"></a><span class="lineno"> 3491</span>      <span class="keywordflow">if</span> ($announcementsList) {</div>
<div class="line"><a id="l03492" name="l03492"></a><span class="lineno"> 3492</span>        $this-&gt;setSubjectTag(RecipientsFilter::ANNOUNCEMENTS_MAILING_LIST);</div>
<div class="line"><a id="l03493" name="l03493"></a><span class="lineno"> 3493</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03494" name="l03494"></a><span class="lineno"> 3494</span>        <span class="comment">// if in project mode potentially send to the mailing list instead of the individual recipients ...</span></div>
<div class="line"><a id="l03495" name="l03495"></a><span class="lineno"> 3495</span>        $projectList = $this-&gt;recipientsFilter-&gt;substituteProjectMailingList($recipients);</div>
<div class="line"><a id="l03496" name="l03496"></a><span class="lineno"> 3496</span>        <span class="keywordflow">if</span> ($projectList) {</div>
<div class="line"><a id="l03497" name="l03497"></a><span class="lineno"> 3497</span>          $this-&gt;setSubjectTag(RecipientsFilter::PROJECT_MAILING_LIST);</div>
<div class="line"><a id="l03498" name="l03498"></a><span class="lineno"> 3498</span>        }</div>
<div class="line"><a id="l03499" name="l03499"></a><span class="lineno"> 3499</span>      }</div>
<div class="line"><a id="l03500" name="l03500"></a><span class="lineno"> 3500</span> </div>
<div class="line"><a id="l03501" name="l03501"></a><span class="lineno"> 3501</span>      $message = $this-&gt;composeAndExport($messageTemplate, $recipients);</div>
<div class="line"><a id="l03502" name="l03502"></a><span class="lineno"> 3502</span>      <span class="keywordflow">if</span> (empty($message) || !empty($this-&gt;diagnostics[self::DIAGNOSTICS_ATTACHMENT_VALIDATION])) {</div>
<div class="line"><a id="l03503" name="l03503"></a><span class="lineno"> 3503</span>        ++$this-&gt;diagnostics[self::DIAGNOSTICS_FAILED_COUNT];</div>
<div class="line"><a id="l03504" name="l03504"></a><span class="lineno"> 3504</span>      }</div>
<div class="line"><a id="l03505" name="l03505"></a><span class="lineno"> 3505</span>      <span class="keywordflow">if</span> (!empty($message)) {</div>
<div class="line"><a id="l03506" name="l03506"></a><span class="lineno"> 3506</span>        $messages[] = $message;</div>
<div class="line"><a id="l03507" name="l03507"></a><span class="lineno"> 3507</span>      }</div>
<div class="line"><a id="l03508" name="l03508"></a><span class="lineno"> 3508</span>    }</div>
<div class="line"><a id="l03509" name="l03509"></a><span class="lineno"> 3509</span>    <span class="keywordflow">return</span> $messages;</div>
<div class="line"><a id="l03510" name="l03510"></a><span class="lineno"> 3510</span>  }</div>
<div class="line"><a id="l03511" name="l03511"></a><span class="lineno"> 3511</span> </div>
<div class="line"><a id="l03530" name="l03530"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a3022527659976cc7e4ce7ea8eed647a2"> 3530</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a3022527659976cc7e4ce7ea8eed647a2">preComposeValidation</a>(array $recipients):bool</div>
<div class="line"><a id="l03531" name="l03531"></a><span class="lineno"> 3531</span>  {</div>
<div class="line"><a id="l03532" name="l03532"></a><span class="lineno"> 3532</span>    <span class="comment">// Basic boolean stuff</span></div>
<div class="line"><a id="l03533" name="l03533"></a><span class="lineno"> 3533</span>    <span class="keywordflow">if</span> ($this-&gt;subject() == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a id="l03534" name="l03534"></a><span class="lineno"> 3534</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_SUBJECT_VALIDATION] = $this-&gt;messageTag;</div>
<div class="line"><a id="l03535" name="l03535"></a><span class="lineno"> 3535</span>      $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03536" name="l03536"></a><span class="lineno"> 3536</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03537" name="l03537"></a><span class="lineno"> 3537</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_SUBJECT_VALIDATION] = <span class="keyword">true</span>;</div>
<div class="line"><a id="l03538" name="l03538"></a><span class="lineno"> 3538</span>    }</div>
<div class="line"><a id="l03539" name="l03539"></a><span class="lineno"> 3539</span>    <span class="keywordflow">if</span> ($this-&gt;fromName() == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a id="l03540" name="l03540"></a><span class="lineno"> 3540</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_FROM_VALIDATION] = $this-&gt;catchAllName;</div>
<div class="line"><a id="l03541" name="l03541"></a><span class="lineno"> 3541</span>      $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03542" name="l03542"></a><span class="lineno"> 3542</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03543" name="l03543"></a><span class="lineno"> 3543</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_FROM_VALIDATION] = <span class="keyword">true</span>;</div>
<div class="line"><a id="l03544" name="l03544"></a><span class="lineno"> 3544</span>    }</div>
<div class="line"><a id="l03545" name="l03545"></a><span class="lineno"> 3545</span>    <span class="keywordflow">if</span> (empty($recipients)) {</div>
<div class="line"><a id="l03546" name="l03546"></a><span class="lineno"> 3546</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_ADDRESS_VALIDATION][<span class="stringliteral">&#39;Empty&#39;</span>] = <span class="keyword">true</span>;</div>
<div class="line"><a id="l03547" name="l03547"></a><span class="lineno"> 3547</span>      $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03548" name="l03548"></a><span class="lineno"> 3548</span>    }</div>
<div class="line"><a id="l03549" name="l03549"></a><span class="lineno"> 3549</span> </div>
<div class="line"><a id="l03550" name="l03550"></a><span class="lineno"> 3550</span>    <span class="comment">// As a special hack deny templates containing references to</span></div>
<div class="line"><a id="l03551" name="l03551"></a><span class="lineno"> 3551</span>    <span class="comment">//</span></div>
<div class="line"><a id="l03552" name="l03552"></a><span class="lineno"> 3552</span>    <span class="comment">// datenschutz-opt-out@cafev.de</span></div>
<div class="line"><a id="l03553" name="l03553"></a><span class="lineno"> 3553</span>    <span class="comment">//</span></div>
<div class="line"><a id="l03554" name="l03554"></a><span class="lineno"> 3554</span>    <span class="comment">// This is here as a temporary hack to catch ignorant copy&#39;n paste</span></div>
<div class="line"><a id="l03555" name="l03555"></a><span class="lineno"> 3555</span>    <span class="comment">// messages</span></div>
<div class="line"><a id="l03556" name="l03556"></a><span class="lineno"> 3556</span>    $this-&gt;diagnostics[self::DIAGNOSTICS_PRIVACY_NOTICE_VALIDATION] = [</div>
<div class="line"><a id="l03557" name="l03557"></a><span class="lineno"> 3557</span>      <span class="stringliteral">&#39;status&#39;</span> =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l03558" name="l03558"></a><span class="lineno"> 3558</span>    ];</div>
<div class="line"><a id="l03559" name="l03559"></a><span class="lineno"> 3559</span>    $forbiddenString = <span class="stringliteral">&#39;datenschutz-opt-out@cafev.de&#39;</span>;</div>
<div class="line"><a id="l03560" name="l03560"></a><span class="lineno"> 3560</span>    <span class="keywordflow">if</span> (strpos($this-&gt;messageContents, $forbiddenString) !== <span class="keyword">false</span>) {</div>
<div class="line"><a id="l03561" name="l03561"></a><span class="lineno"> 3561</span>      $this-&gt;logInfo(<span class="stringliteral">&#39;FORBIDDEN PRIVACY NOTICE&#39;</span>);</div>
<div class="line"><a id="l03562" name="l03562"></a><span class="lineno"> 3562</span>      <span class="keywordflow">if</span> (empty($this-&gt;getConfigValue(<span class="stringliteral">&#39;bulkEmailPrivacyNotice&#39;</span>))) {</div>
<div class="line"><a id="l03563" name="l03563"></a><span class="lineno"> 3563</span>        $this-&gt;logInfo(<span class="stringliteral">&#39;PRIVACY NOTICE UNCONFIGURED, IGNORING FORBIDDEN OPT-OUT LINK&#39;</span>);</div>
<div class="line"><a id="l03564" name="l03564"></a><span class="lineno"> 3564</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03565" name="l03565"></a><span class="lineno"> 3565</span>        $this-&gt;diagnostics[self::DIAGNOSTICS_PRIVACY_NOTICE_VALIDATION] = [</div>
<div class="line"><a id="l03566" name="l03566"></a><span class="lineno"> 3566</span>          <span class="stringliteral">&#39;status&#39;</span> =&gt; <span class="keyword">false</span>,</div>
<div class="line"><a id="l03567" name="l03567"></a><span class="lineno"> 3567</span>          <span class="stringliteral">&#39;forbiddenAddress&#39;</span> =&gt; $forbiddenString,</div>
<div class="line"><a id="l03568" name="l03568"></a><span class="lineno"> 3568</span>        ];</div>
<div class="line"><a id="l03569" name="l03569"></a><span class="lineno"> 3569</span>        $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03570" name="l03570"></a><span class="lineno"> 3570</span>      }</div>
<div class="line"><a id="l03571" name="l03571"></a><span class="lineno"> 3571</span>    }</div>
<div class="line"><a id="l03572" name="l03572"></a><span class="lineno"> 3572</span> </div>
<div class="line"><a id="l03573" name="l03573"></a><span class="lineno"> 3573</span>    <span class="comment">// Template validation (i.e. variable substituions)</span></div>
<div class="line"><a id="l03574" name="l03574"></a><span class="lineno"> 3574</span>    $this-&gt;validateTemplate($this-&gt;messageContents);</div>
<div class="line"><a id="l03575" name="l03575"></a><span class="lineno"> 3575</span> </div>
<div class="line"><a id="l03576" name="l03576"></a><span class="lineno"> 3576</span>    <span class="comment">// Validate message contents, e.g. reachability of links</span></div>
<div class="line"><a id="l03577" name="l03577"></a><span class="lineno"> 3577</span>    $this-&gt;validateMessageHtml($this-&gt;messageContents);</div>
<div class="line"><a id="l03578" name="l03578"></a><span class="lineno"> 3578</span> </div>
<div class="line"><a id="l03579" name="l03579"></a><span class="lineno"> 3579</span>    <span class="keywordflow">if</span> (strpos($this-&gt;messageContents, <span class="stringliteral">&#39;GLOBAL::PROJECT_PUBLIC_SHARE&#39;</span>) !== <span class="keyword">false</span>) {</div>
<div class="line"><a id="l03580" name="l03580"></a><span class="lineno"> 3580</span>      $shareStatus = <span class="keyword">true</span>;</div>
<div class="line"><a id="l03581" name="l03581"></a><span class="lineno"> 3581</span> </div>
<div class="line"><a id="l03582" name="l03582"></a><span class="lineno"> 3582</span>      $projectService = $this-&gt;di(ProjectService::class);</div>
<div class="line"><a id="l03583" name="l03583"></a><span class="lineno"> 3583</span>      list(<span class="stringliteral">&#39;share&#39;</span> =&gt; $share, <span class="stringliteral">&#39;folder&#39;</span> =&gt; $folder) = $projectService-&gt;ensureDownloadsShare($this-&gt;project, noCreate: <span class="keyword">false</span>);</div>
<div class="line"><a id="l03584" name="l03584"></a><span class="lineno"> 3584</span> </div>
<div class="line"><a id="l03585" name="l03585"></a><span class="lineno"> 3585</span>      <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l03586" name="l03586"></a><span class="lineno"> 3586</span>        $headers = get_headers($share);</div>
<div class="line"><a id="l03587" name="l03587"></a><span class="lineno"> 3587</span>      } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l03588" name="l03588"></a><span class="lineno"> 3588</span>        $headers = <span class="keyword">null</span>;</div>
<div class="line"><a id="l03589" name="l03589"></a><span class="lineno"> 3589</span>      }</div>
<div class="line"><a id="l03590" name="l03590"></a><span class="lineno"> 3590</span>      <span class="keywordflow">if</span> ($headers &amp;&amp; count($headers) &gt; 0) {</div>
<div class="line"><a id="l03591" name="l03591"></a><span class="lineno"> 3591</span>        $code = (int)substr($headers[0], 9, 3);</div>
<div class="line"><a id="l03592" name="l03592"></a><span class="lineno"> 3592</span>        <span class="keywordflow">if</span> ($code &lt; 200 &amp;&amp; $code &gt;= 400) {</div>
<div class="line"><a id="l03593" name="l03593"></a><span class="lineno"> 3593</span>          $shareStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03594" name="l03594"></a><span class="lineno"> 3594</span>        }</div>
<div class="line"><a id="l03595" name="l03595"></a><span class="lineno"> 3595</span>      }</div>
<div class="line"><a id="l03596" name="l03596"></a><span class="lineno"> 3596</span> </div>
<div class="line"><a id="l03597" name="l03597"></a><span class="lineno"> 3597</span>      $filesCount = $this-&gt;userStorage-&gt;folderWalk($folder);</div>
<div class="line"><a id="l03598" name="l03598"></a><span class="lineno"> 3598</span>      $this-&gt;logInfo(<span class="stringliteral">&#39;FILES COUNT DOWNLOAD FOLDER &#39;</span> . $filesCount);</div>
<div class="line"><a id="l03599" name="l03599"></a><span class="lineno"> 3599</span>      <span class="keywordflow">if</span> ($filesCount == 0) {</div>
<div class="line"><a id="l03600" name="l03600"></a><span class="lineno"> 3600</span>        $shareStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03601" name="l03601"></a><span class="lineno"> 3601</span>      }</div>
<div class="line"><a id="l03602" name="l03602"></a><span class="lineno"> 3602</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_SHARE_LINK_VALIDATION] = [</div>
<div class="line"><a id="l03603" name="l03603"></a><span class="lineno"> 3603</span>        <span class="stringliteral">&#39;status&#39;</span> =&gt; $shareStatus,</div>
<div class="line"><a id="l03604" name="l03604"></a><span class="lineno"> 3604</span>        <span class="stringliteral">&#39;filesCount&#39;</span> =&gt; $filesCount,</div>
<div class="line"><a id="l03605" name="l03605"></a><span class="lineno"> 3605</span>        <span class="stringliteral">&#39;httpCode&#39;</span> =&gt; $code,</div>
<div class="line"><a id="l03606" name="l03606"></a><span class="lineno"> 3606</span>        <span class="stringliteral">&#39;folder&#39;</span> =&gt; $folder,</div>
<div class="line"><a id="l03607" name="l03607"></a><span class="lineno"> 3607</span>        <span class="stringliteral">&#39;appLink&#39;</span> =&gt; $this-&gt;userStorage-&gt;getFilesAppLink($folder, subDir: <span class="keyword">true</span>),</div>
<div class="line"><a id="l03608" name="l03608"></a><span class="lineno"> 3608</span>        <span class="stringliteral">&#39;share&#39;</span> =&gt; $share,</div>
<div class="line"><a id="l03609" name="l03609"></a><span class="lineno"> 3609</span>      ];</div>
<div class="line"><a id="l03610" name="l03610"></a><span class="lineno"> 3610</span> </div>
<div class="line"><a id="l03611" name="l03611"></a><span class="lineno"> 3611</span>      $this-&gt;executionStatus = $this-&gt;executionStatus &amp;&amp; $shareStatus;</div>
<div class="line"><a id="l03612" name="l03612"></a><span class="lineno"> 3612</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03613" name="l03613"></a><span class="lineno"> 3613</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_SHARE_LINK_VALIDATION] = [</div>
<div class="line"><a id="l03614" name="l03614"></a><span class="lineno"> 3614</span>        <span class="stringliteral">&#39;status&#39;</span> =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l03615" name="l03615"></a><span class="lineno"> 3615</span>        <span class="stringliteral">&#39;filesCount&#39;</span> =&gt; 0,</div>
<div class="line"><a id="l03616" name="l03616"></a><span class="lineno"> 3616</span>        <span class="stringliteral">&#39;httpCode&#39;</span> =&gt; 200,</div>
<div class="line"><a id="l03617" name="l03617"></a><span class="lineno"> 3617</span>        <span class="stringliteral">&#39;folder&#39;</span> =&gt; <span class="keyword">null</span>,</div>
<div class="line"><a id="l03618" name="l03618"></a><span class="lineno"> 3618</span>        <span class="stringliteral">&#39;appLink&#39;</span> =&gt; <span class="keyword">null</span>,</div>
<div class="line"><a id="l03619" name="l03619"></a><span class="lineno"> 3619</span>        <span class="stringliteral">&#39;share&#39;</span> =&gt; <span class="keyword">null</span>,</div>
<div class="line"><a id="l03620" name="l03620"></a><span class="lineno"> 3620</span>      ];</div>
<div class="line"><a id="l03621" name="l03621"></a><span class="lineno"> 3621</span>    }</div>
<div class="line"><a id="l03622" name="l03622"></a><span class="lineno"> 3622</span> </div>
<div class="line"><a id="l03623" name="l03623"></a><span class="lineno"> 3623</span>    <span class="comment">// Cc: and Bcc: validation</span></div>
<div class="line"><a id="l03624" name="l03624"></a><span class="lineno"> 3624</span>    <span class="keywordflow">foreach</span> ([ <span class="stringliteral">&#39;CC&#39;</span> =&gt; $this-&gt;carbonCopy(),</div>
<div class="line"><a id="l03625" name="l03625"></a><span class="lineno"> 3625</span>               <span class="stringliteral">&#39;BCC&#39;</span> =&gt; $this-&gt;blindCarbonCopy(), ] as $key =&gt; $emails) {</div>
<div class="line"><a id="l03626" name="l03626"></a><span class="lineno"> 3626</span>      $this-&gt;onLookers[$key] = $this-&gt;validateFreeFormAddresses($key, $emails);</div>
<div class="line"><a id="l03627" name="l03627"></a><span class="lineno"> 3627</span>    }</div>
<div class="line"><a id="l03628" name="l03628"></a><span class="lineno"> 3628</span> </div>
<div class="line"><a id="l03629" name="l03629"></a><span class="lineno"> 3629</span>    <span class="comment">// file attachments, check the selected ones for readability</span></div>
<div class="line"><a id="l03630" name="l03630"></a><span class="lineno"> 3630</span>    $attachments = $this-&gt;fileAttachments();</div>
<div class="line"><a id="l03631" name="l03631"></a><span class="lineno"> 3631</span>    <span class="keywordflow">foreach</span> ($attachments as $attachment) {</div>
<div class="line"><a id="l03632" name="l03632"></a><span class="lineno"> 3632</span>      <span class="keywordflow">if</span> ($attachment[<span class="stringliteral">&#39;status&#39;</span>] != <span class="stringliteral">&#39;selected&#39;</span>) {</div>
<div class="line"><a id="l03633" name="l03633"></a><span class="lineno"> 3633</span>        <span class="keywordflow">continue</span>; <span class="comment">// don&#39;t bother</span></div>
<div class="line"><a id="l03634" name="l03634"></a><span class="lineno"> 3634</span>      }</div>
<div class="line"><a id="l03635" name="l03635"></a><span class="lineno"> 3635</span>      <span class="keywordflow">if</span> (!$this-&gt;appStorage-&gt;fileExists($attachment[<span class="stringliteral">&#39;tmp_name&#39;</span>])) {</div>
<div class="line"><a id="l03636" name="l03636"></a><span class="lineno"> 3636</span>        $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03637" name="l03637"></a><span class="lineno"> 3637</span>        $attachment[<span class="stringliteral">&#39;status&#39;</span>] = <span class="stringliteral">&#39;unreadable&#39;</span>;</div>
<div class="line"><a id="l03638" name="l03638"></a><span class="lineno"> 3638</span>        $this-&gt;diagnostics[self::DIAGNOSTICS_ATTACHMENT_VALIDATION][<span class="stringliteral">&#39;Files&#39;</span>][] = $attachment;</div>
<div class="line"><a id="l03639" name="l03639"></a><span class="lineno"> 3639</span>      }</div>
<div class="line"><a id="l03640" name="l03640"></a><span class="lineno"> 3640</span>    }</div>
<div class="line"><a id="l03641" name="l03641"></a><span class="lineno"> 3641</span> </div>
<div class="line"><a id="l03642" name="l03642"></a><span class="lineno"> 3642</span>    <span class="comment">// event attachment</span></div>
<div class="line"><a id="l03643" name="l03643"></a><span class="lineno"> 3643</span>    $events = $this-&gt;eventAttachments();</div>
<div class="line"><a id="l03644" name="l03644"></a><span class="lineno"> 3644</span>    <span class="keywordflow">foreach</span> (array_keys($events) as $eventUri) {</div>
<div class="line"><a id="l03645" name="l03645"></a><span class="lineno"> 3645</span>      <span class="keywordflow">if</span> (!$this-&gt;eventsService-&gt;fetchEvent($this-&gt;projectId, $eventUri)) {</div>
<div class="line"><a id="l03646" name="l03646"></a><span class="lineno"> 3646</span>        $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03647" name="l03647"></a><span class="lineno"> 3647</span>        $this-&gt;diagnostics[self::DIAGNOSTICS_ATTACHMENT_VALIDATION][<span class="stringliteral">&#39;Events&#39;</span>][] = $eventUri;</div>
<div class="line"><a id="l03648" name="l03648"></a><span class="lineno"> 3648</span>      }</div>
<div class="line"><a id="l03649" name="l03649"></a><span class="lineno"> 3649</span>    }</div>
<div class="line"><a id="l03650" name="l03650"></a><span class="lineno"> 3650</span> </div>
<div class="line"><a id="l03651" name="l03651"></a><span class="lineno"> 3651</span>    <span class="keywordflow">if</span> (!$this-&gt;executionStatus) {</div>
<div class="line"><a id="l03652" name="l03652"></a><span class="lineno"> 3652</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_CAPTION] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Pre-composition validation has failed!&#39;</span>);</div>
<div class="line"><a id="l03653" name="l03653"></a><span class="lineno"> 3653</span>    }</div>
<div class="line"><a id="l03654" name="l03654"></a><span class="lineno"> 3654</span> </div>
<div class="line"><a id="l03655" name="l03655"></a><span class="lineno"> 3655</span>    <span class="keywordflow">return</span> $this-&gt;executionStatus;</div>
<div class="line"><a id="l03656" name="l03656"></a><span class="lineno"> 3656</span>  }</div>
<div class="line"><a id="l03657" name="l03657"></a><span class="lineno"> 3657</span> </div>
<div class="line"><a id="l03669" name="l03669"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad74240dcb020960b41df6447a5b0e1ff"> 3669</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad74240dcb020960b41df6447a5b0e1ff">setSubjectTag</a>(?<span class="keywordtype">int</span> $recipientsSet = <span class="keyword">null</span>):void</div>
<div class="line"><a id="l03670" name="l03670"></a><span class="lineno"> 3670</span>  {</div>
<div class="line"><a id="l03671" name="l03671"></a><span class="lineno"> 3671</span>    $recipientsSet = $recipientsSet ?? $this-&gt;recipientsFilter-&gt;getUserBase();</div>
<div class="line"><a id="l03672" name="l03672"></a><span class="lineno"> 3672</span>    <span class="keywordflow">if</span> ($recipientsSet &amp; RecipientsFilter::ANNOUNCEMENTS_MAILING_LIST) {</div>
<div class="line"><a id="l03673" name="l03673"></a><span class="lineno"> 3673</span>      <span class="keywordflow">if</span> ($this-&gt;projectId &lt;= 0 || $this-&gt;projectName == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a id="l03674" name="l03674"></a><span class="lineno"> 3674</span>        $this-&gt;messageTag = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// the mailing list has its own tag</span></div>
<div class="line"><a id="l03675" name="l03675"></a><span class="lineno"> 3675</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03676" name="l03676"></a><span class="lineno"> 3676</span>        $this-&gt;messageTag = <span class="charliteral">&#39;[&#39;</span> . $this-&gt;projectName . <span class="charliteral">&#39;]&#39;</span>; <span class="comment">// keep the project name as tag</span></div>
<div class="line"><a id="l03677" name="l03677"></a><span class="lineno"> 3677</span>      }</div>
<div class="line"><a id="l03678" name="l03678"></a><span class="lineno"> 3678</span>    } elseif ($recipientsSet &amp; RecipientsFilter::PROJECT_MAILING_LIST) {</div>
<div class="line"><a id="l03679" name="l03679"></a><span class="lineno"> 3679</span>      $this-&gt;messageTag = <span class="stringliteral">&#39;&#39;</span>; <span class="comment">// the mailing list has its own tag</span></div>
<div class="line"><a id="l03680" name="l03680"></a><span class="lineno"> 3680</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03681" name="l03681"></a><span class="lineno"> 3681</span>      $tagPrefix = $this-&gt;getConfigValue(<span class="stringliteral">&#39;bulkEmailSubjectTag&#39;</span>);</div>
<div class="line"><a id="l03682" name="l03682"></a><span class="lineno"> 3682</span>      <span class="keywordflow">if</span> (!empty($tagPrefix)) {</div>
<div class="line"><a id="l03683" name="l03683"></a><span class="lineno"> 3683</span>        $tagPrefix = $tagPrefix . <span class="charliteral">&#39;-&#39;</span>;</div>
<div class="line"><a id="l03684" name="l03684"></a><span class="lineno"> 3684</span>      }</div>
<div class="line"><a id="l03685" name="l03685"></a><span class="lineno"> 3685</span>      <span class="keywordflow">if</span> ($this-&gt;projectId &lt;= 0 || $this-&gt;projectName == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a id="l03686" name="l03686"></a><span class="lineno"> 3686</span>        <span class="comment">// TRANSLATORS: email prefix when writing to all musicians</span></div>
<div class="line"><a id="l03687" name="l03687"></a><span class="lineno"> 3687</span>        $this-&gt;messageTag = <span class="charliteral">&#39;[&#39;</span> . $tagPrefix . ucfirst($this-&gt;l-&gt;t(<span class="stringliteral">&#39;ALL_PERSONS: musicians&#39;</span>)) . <span class="charliteral">&#39;]&#39;</span>;</div>
<div class="line"><a id="l03688" name="l03688"></a><span class="lineno"> 3688</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03689" name="l03689"></a><span class="lineno"> 3689</span>        $this-&gt;messageTag = <span class="charliteral">&#39;[&#39;</span> . $tagPrefix . $this-&gt;projectName . <span class="charliteral">&#39;]&#39;</span>;</div>
<div class="line"><a id="l03690" name="l03690"></a><span class="lineno"> 3690</span>      }</div>
<div class="line"><a id="l03691" name="l03691"></a><span class="lineno"> 3691</span>    }</div>
<div class="line"><a id="l03692" name="l03692"></a><span class="lineno"> 3692</span>  }</div>
<div class="line"><a id="l03693" name="l03693"></a><span class="lineno"> 3693</span> </div>
<div class="line"><a id="l03705" name="l03705"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a3985e2723a7cdac4576e7163d9bfc943"> 3705</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a3985e2723a7cdac4576e7163d9bfc943">validateFreeFormAddresses</a>(<span class="keywordtype">string</span> $header, <span class="keywordtype">string</span> $freeForm):mixed</div>
<div class="line"><a id="l03706" name="l03706"></a><span class="lineno"> 3706</span>  {</div>
<div class="line"><a id="l03707" name="l03707"></a><span class="lineno"> 3707</span>    <span class="keywordflow">if</span> (empty($freeForm)) {</div>
<div class="line"><a id="l03708" name="l03708"></a><span class="lineno"> 3708</span>      <span class="keywordflow">return</span> [];</div>
<div class="line"><a id="l03709" name="l03709"></a><span class="lineno"> 3709</span>    }</div>
<div class="line"><a id="l03710" name="l03710"></a><span class="lineno"> 3710</span> </div>
<div class="line"><a id="l03711" name="l03711"></a><span class="lineno"> 3711</span>    $phpMailer = <span class="keyword">new</span> <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html">PHPMailer</a>(exceptions: <span class="keyword">true</span>);</div>
<div class="line"><a id="l03712" name="l03712"></a><span class="lineno"> 3712</span>    $parser = <span class="keyword">new</span> Mail_RFC822(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</div>
<div class="line"><a id="l03713" name="l03713"></a><span class="lineno"> 3713</span> </div>
<div class="line"><a id="l03714" name="l03714"></a><span class="lineno"> 3714</span>    $brokenRecipients = [];</div>
<div class="line"><a id="l03715" name="l03715"></a><span class="lineno"> 3715</span>    $parsedRecipients = $parser-&gt;parseAddressList($freeForm);</div>
<div class="line"><a id="l03716" name="l03716"></a><span class="lineno"> 3716</span>    $parseError = $parser-&gt;parseError();</div>
<div class="line"><a id="l03717" name="l03717"></a><span class="lineno"> 3717</span>    <span class="keywordflow">if</span> ($parseError !== <span class="keyword">false</span>) {</div>
<div class="line"><a id="l03718" name="l03718"></a><span class="lineno"> 3718</span>      $this-&gt;logDebug(<span class="stringliteral">&quot;Parse-error on email address list: &quot;</span>.</div>
<div class="line"><a id="l03719" name="l03719"></a><span class="lineno"> 3719</span>                      vsprintf($parseError[<span class="stringliteral">&#39;message&#39;</span>], $parseError[<span class="stringliteral">&#39;data&#39;</span>]));</div>
<div class="line"><a id="l03720" name="l03720"></a><span class="lineno"> 3720</span>      <span class="comment">// We report the entire string.</span></div>
<div class="line"><a id="l03721" name="l03721"></a><span class="lineno"> 3721</span>      $brokenRecipients[] = $this-&gt;l-&gt;t($parseError[<span class="stringliteral">&#39;message&#39;</span>], $parseError[<span class="stringliteral">&#39;data&#39;</span>]);</div>
<div class="line"><a id="l03722" name="l03722"></a><span class="lineno"> 3722</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03723" name="l03723"></a><span class="lineno"> 3723</span>      $this-&gt;logDebug(<span class="stringliteral">&quot;Parsed address list: &quot;</span>. print_r($parsedRecipients, <span class="keyword">true</span>));</div>
<div class="line"><a id="l03724" name="l03724"></a><span class="lineno"> 3724</span>      $recipients = [];</div>
<div class="line"><a id="l03725" name="l03725"></a><span class="lineno"> 3725</span>      <span class="keywordflow">foreach</span> ($parsedRecipients as $emailRecord) {</div>
<div class="line"><a id="l03726" name="l03726"></a><span class="lineno"> 3726</span>        $email = $emailRecord-&gt;mailbox.<span class="charliteral">&#39;@&#39;</span>.$emailRecord-&gt;host;</div>
<div class="line"><a id="l03727" name="l03727"></a><span class="lineno"> 3727</span>        $name  = $emailRecord-&gt;personal;</div>
<div class="line"><a id="l03728" name="l03728"></a><span class="lineno"> 3728</span>        <span class="keywordflow">if</span> ($name === <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a id="l03729" name="l03729"></a><span class="lineno"> 3729</span>          $recipient = $email;</div>
<div class="line"><a id="l03730" name="l03730"></a><span class="lineno"> 3730</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03731" name="l03731"></a><span class="lineno"> 3731</span>          $recipient = $name.<span class="stringliteral">&#39; &lt;&#39;</span>.$email.<span class="charliteral">&#39;&gt;&#39;</span>;</div>
<div class="line"><a id="l03732" name="l03732"></a><span class="lineno"> 3732</span>        }</div>
<div class="line"><a id="l03733" name="l03733"></a><span class="lineno"> 3733</span>        <span class="keywordflow">if</span> ($emailRecord-&gt;host === <span class="stringliteral">&#39;localhost&#39;</span>) {</div>
<div class="line"><a id="l03734" name="l03734"></a><span class="lineno"> 3734</span>          $brokenRecipients[] = htmlspecialchars($recipient);</div>
<div class="line"><a id="l03735" name="l03735"></a><span class="lineno"> 3735</span>        } elseif (!$phpMailer-&gt;validateAddress($email)) {</div>
<div class="line"><a id="l03736" name="l03736"></a><span class="lineno"> 3736</span>          $brokenRecipients[] = htmlspecialchars($recipient);</div>
<div class="line"><a id="l03737" name="l03737"></a><span class="lineno"> 3737</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03738" name="l03738"></a><span class="lineno"> 3738</span>          $recipients[] = [</div>
<div class="line"><a id="l03739" name="l03739"></a><span class="lineno"> 3739</span>            <span class="stringliteral">&#39;email&#39;</span> =&gt; $email,</div>
<div class="line"><a id="l03740" name="l03740"></a><span class="lineno"> 3740</span>            <span class="stringliteral">&#39;name&#39;</span> =&gt; $name,</div>
<div class="line"><a id="l03741" name="l03741"></a><span class="lineno"> 3741</span>          ];</div>
<div class="line"><a id="l03742" name="l03742"></a><span class="lineno"> 3742</span>        }</div>
<div class="line"><a id="l03743" name="l03743"></a><span class="lineno"> 3743</span>      }</div>
<div class="line"><a id="l03744" name="l03744"></a><span class="lineno"> 3744</span>    }</div>
<div class="line"><a id="l03745" name="l03745"></a><span class="lineno"> 3745</span>    <span class="keywordflow">if</span> (!empty($brokenRecipients)) {</div>
<div class="line"><a id="l03746" name="l03746"></a><span class="lineno"> 3746</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_ADDRESS_VALIDATION][$header] = $brokenRecipients;</div>
<div class="line"><a id="l03747" name="l03747"></a><span class="lineno"> 3747</span>      $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03748" name="l03748"></a><span class="lineno"> 3748</span>      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03749" name="l03749"></a><span class="lineno"> 3749</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03750" name="l03750"></a><span class="lineno"> 3750</span>      $this-&gt;logDebug(<span class="stringliteral">&quot;Returned address list: &quot;</span>.print_r($recipients, <span class="keyword">true</span>));</div>
<div class="line"><a id="l03751" name="l03751"></a><span class="lineno"> 3751</span>      <span class="keywordflow">return</span> $recipients;</div>
<div class="line"><a id="l03752" name="l03752"></a><span class="lineno"> 3752</span>    }</div>
<div class="line"><a id="l03753" name="l03753"></a><span class="lineno"> 3753</span>  }</div>
<div class="line"><a id="l03754" name="l03754"></a><span class="lineno"> 3754</span> </div>
<div class="line"><a id="l03767" name="l03767"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a64951c106ffa52c954480dfeaace1db6"> 3767</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a64951c106ffa52c954480dfeaace1db6">validateTemplate</a>(<span class="keywordtype">string</span> $template = <span class="keyword">null</span>):bool</div>
<div class="line"><a id="l03768" name="l03768"></a><span class="lineno"> 3768</span>  {</div>
<div class="line"><a id="l03769" name="l03769"></a><span class="lineno"> 3769</span>    <span class="keywordflow">if</span> (empty($template)) {</div>
<div class="line"><a id="l03770" name="l03770"></a><span class="lineno"> 3770</span>      $template = $this-&gt;messageText();</div>
<div class="line"><a id="l03771" name="l03771"></a><span class="lineno"> 3771</span>    }</div>
<div class="line"><a id="l03772" name="l03772"></a><span class="lineno"> 3772</span> </div>
<div class="line"><a id="l03773" name="l03773"></a><span class="lineno"> 3773</span>    $templateError = [];</div>
<div class="line"><a id="l03774" name="l03774"></a><span class="lineno"> 3774</span> </div>
<div class="line"><a id="l03775" name="l03775"></a><span class="lineno"> 3775</span>    <span class="comment">// Check for per-member stubstitutions</span></div>
<div class="line"><a id="l03776" name="l03776"></a><span class="lineno"> 3776</span>    $this-&gt;generateSubstitutionHandlers();</div>
<div class="line"><a id="l03777" name="l03777"></a><span class="lineno"> 3777</span> </div>
<div class="line"><a id="l03778" name="l03778"></a><span class="lineno"> 3778</span>    $dummy = $template;</div>
<div class="line"><a id="l03779" name="l03779"></a><span class="lineno"> 3779</span> </div>
<div class="line"><a id="l03780" name="l03780"></a><span class="lineno"> 3780</span>    <span class="keywordflow">if</span> ($this-&gt;hasSubstitutionNamespace(self::MEMBER_NAMESPACE, $dummy)) {</div>
<div class="line"><a id="l03781" name="l03781"></a><span class="lineno"> 3781</span>      $failures = [];</div>
<div class="line"><a id="l03782" name="l03782"></a><span class="lineno"> 3782</span>      $dummy = $this-&gt;replaceFormVariables(self::MEMBER_NAMESPACE, <span class="keyword">null</span>, $dummy, $failures);</div>
<div class="line"><a id="l03783" name="l03783"></a><span class="lineno"> 3783</span>      <span class="keywordflow">if</span> (!empty($failures)) {</div>
<div class="line"><a id="l03784" name="l03784"></a><span class="lineno"> 3784</span>        $templateError[] = <span class="stringliteral">&#39;member&#39;</span>;</div>
<div class="line"><a id="l03785" name="l03785"></a><span class="lineno"> 3785</span>        <span class="keywordflow">foreach</span> ($failures as $failure) {</div>
<div class="line"><a id="l03786" name="l03786"></a><span class="lineno"> 3786</span>          <span class="keywordflow">if</span> ($failure[<span class="stringliteral">&#39;error&#39;</span>] == <span class="stringliteral">&#39;unknown&#39;</span>) {</div>
<div class="line"><a id="l03787" name="l03787"></a><span class="lineno"> 3787</span>            $this-&gt;diagnostics[self::DIAGNOSTICS_TEMPLATE_VALIDATION][<span class="stringliteral">&#39;MemberErrors&#39;</span>][] =</div>
<div class="line"><a id="l03788" name="l03788"></a><span class="lineno"> 3788</span>              $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Unknown substitution &quot;%s&quot;.&#39;</span>, $failure[<span class="stringliteral">&#39;namespace&#39;</span>].<span class="stringliteral">&#39;::&#39;</span>.implode(<span class="charliteral">&#39;:&#39;</span>, $failure[<span class="stringliteral">&#39;variable&#39;</span>]));</div>
<div class="line"><a id="l03789" name="l03789"></a><span class="lineno"> 3789</span>          } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03790" name="l03790"></a><span class="lineno"> 3790</span>            $this-&gt;diagnostics[self::DIAGNOSTICS_TEMPLATE_VALIDATION][<span class="stringliteral">&#39;MemberErrors&#39;</span>] = $failures;</div>
<div class="line"><a id="l03791" name="l03791"></a><span class="lineno"> 3791</span>          }</div>
<div class="line"><a id="l03792" name="l03792"></a><span class="lineno"> 3792</span>        }</div>
<div class="line"><a id="l03793" name="l03793"></a><span class="lineno"> 3793</span>      }</div>
<div class="line"><a id="l03794" name="l03794"></a><span class="lineno"> 3794</span>    }</div>
<div class="line"><a id="l03795" name="l03795"></a><span class="lineno"> 3795</span> </div>
<div class="line"><a id="l03796" name="l03796"></a><span class="lineno"> 3796</span>    <span class="keywordflow">if</span> ($this-&gt;hasSubstitutionNamespace(self::GLOBAL_NAMESPACE)) {</div>
<div class="line"><a id="l03797" name="l03797"></a><span class="lineno"> 3797</span>      $failures = [];</div>
<div class="line"><a id="l03798" name="l03798"></a><span class="lineno"> 3798</span>      $dummy = $this-&gt;replaceFormVariables(self::GLOBAL_NAMESPACE, <span class="keyword">null</span>, $dummy, $failures);</div>
<div class="line"><a id="l03799" name="l03799"></a><span class="lineno"> 3799</span>      <span class="keywordflow">if</span> (!empty($failures)) {</div>
<div class="line"><a id="l03800" name="l03800"></a><span class="lineno"> 3800</span>        $templateError[] = <span class="stringliteral">&#39;global&#39;</span>;</div>
<div class="line"><a id="l03801" name="l03801"></a><span class="lineno"> 3801</span>        <span class="keywordflow">foreach</span> ($failures as $failure) {</div>
<div class="line"><a id="l03802" name="l03802"></a><span class="lineno"> 3802</span>          <span class="keywordflow">if</span> ($failure[<span class="stringliteral">&#39;error&#39;</span>] == <span class="stringliteral">&#39;unknown&#39;</span>) {</div>
<div class="line"><a id="l03803" name="l03803"></a><span class="lineno"> 3803</span>            $this-&gt;diagnostics[self::DIAGNOSTICS_TEMPLATE_VALIDATION][<span class="stringliteral">&#39;GlobalErrors&#39;</span>][] =</div>
<div class="line"><a id="l03804" name="l03804"></a><span class="lineno"> 3804</span>              $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Unknown substitution &quot;%s&quot;.&#39;</span>, $failure[<span class="stringliteral">&#39;namespace&#39;</span>].<span class="stringliteral">&#39;::&#39;</span>.implode(<span class="charliteral">&#39;:&#39;</span>, $failure[<span class="stringliteral">&#39;variable&#39;</span>]));</div>
<div class="line"><a id="l03805" name="l03805"></a><span class="lineno"> 3805</span>          } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03806" name="l03806"></a><span class="lineno"> 3806</span>            $this-&gt;diagnostics[self::DIAGNOSTICS_TEMPLATE_VALIDATION][<span class="stringliteral">&#39;GlobalErrors&#39;</span>][] = $failure;</div>
<div class="line"><a id="l03807" name="l03807"></a><span class="lineno"> 3807</span>          }</div>
<div class="line"><a id="l03808" name="l03808"></a><span class="lineno"> 3808</span>        }</div>
<div class="line"><a id="l03809" name="l03809"></a><span class="lineno"> 3809</span>      }</div>
<div class="line"><a id="l03810" name="l03810"></a><span class="lineno"> 3810</span>    }</div>
<div class="line"><a id="l03811" name="l03811"></a><span class="lineno"> 3811</span> </div>
<div class="line"><a id="l03812" name="l03812"></a><span class="lineno"> 3812</span>    <span class="comment">// No substitutions should remain. Check for that.</span></div>
<div class="line"><a id="l03813" name="l03813"></a><span class="lineno"> 3813</span>    <span class="keywordflow">if</span> (preg_match(<span class="stringliteral">&#39;!([^$]|^)([$]|%24)({|%7B)[^}]+(}|%7D)?!&#39;</span>, $dummy, $leftOver)) {</div>
<div class="line"><a id="l03814" name="l03814"></a><span class="lineno"> 3814</span>      $templateError[] = <span class="stringliteral">&#39;spurious&#39;</span>;</div>
<div class="line"><a id="l03815" name="l03815"></a><span class="lineno"> 3815</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_TEMPLATE_VALIDATION][<span class="stringliteral">&#39;SpuriousErrors&#39;</span>] = $leftOver;</div>
<div class="line"><a id="l03816" name="l03816"></a><span class="lineno"> 3816</span>    }</div>
<div class="line"><a id="l03817" name="l03817"></a><span class="lineno"> 3817</span> </div>
<div class="line"><a id="l03818" name="l03818"></a><span class="lineno"> 3818</span>    <span class="keywordflow">if</span> (empty($templateError)) {</div>
<div class="line"><a id="l03819" name="l03819"></a><span class="lineno"> 3819</span>      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l03820" name="l03820"></a><span class="lineno"> 3820</span>    }</div>
<div class="line"><a id="l03821" name="l03821"></a><span class="lineno"> 3821</span> </div>
<div class="line"><a id="l03822" name="l03822"></a><span class="lineno"> 3822</span>    $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l03823" name="l03823"></a><span class="lineno"> 3823</span> </div>
<div class="line"><a id="l03824" name="l03824"></a><span class="lineno"> 3824</span>    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l03825" name="l03825"></a><span class="lineno"> 3825</span>  }</div>
<div class="line"><a id="l03826" name="l03826"></a><span class="lineno"> 3826</span> </div>
<div class="line"><a id="l03832" name="l03832"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a346f94effc8c8dfea565e54bc6a27ba7"> 3832</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a346f94effc8c8dfea565e54bc6a27ba7">setDefaultTemplate</a>():void</div>
<div class="line"><a id="l03833" name="l03833"></a><span class="lineno"> 3833</span>  {</div>
<div class="line"><a id="l03834" name="l03834"></a><span class="lineno"> 3834</span>    <span class="comment">// Make sure that at least the default template exists and install</span></div>
<div class="line"><a id="l03835" name="l03835"></a><span class="lineno"> 3835</span>    <span class="comment">// that as default text</span></div>
<div class="line"><a id="l03836" name="l03836"></a><span class="lineno"> 3836</span>    $this-&gt;initialTemplate = self::DEFAULT_TEMPLATE;</div>
<div class="line"><a id="l03837" name="l03837"></a><span class="lineno"> 3837</span> </div>
<div class="line"><a id="l03838" name="l03838"></a><span class="lineno"> 3838</span>    $dbTemplate = $this-&gt;fetchTemplate(self::DEFAULT_TEMPLATE_NAME, exact: <span class="keyword">false</span>);</div>
<div class="line"><a id="l03839" name="l03839"></a><span class="lineno"> 3839</span>    <span class="keywordflow">if</span> (empty($dbTemplate)) {</div>
<div class="line"><a id="l03840" name="l03840"></a><span class="lineno"> 3840</span>      $this-&gt;storeTemplate(self::DEFAULT_TEMPLATE_NAME, <span class="stringliteral">&#39;&#39;</span>, $this-&gt;initialTemplate);</div>
<div class="line"><a id="l03841" name="l03841"></a><span class="lineno"> 3841</span>      $this-&gt;templateName = self::DEFAULT_TEMPLATE_NAME;</div>
<div class="line"><a id="l03842" name="l03842"></a><span class="lineno"> 3842</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03843" name="l03843"></a><span class="lineno"> 3843</span>      $this-&gt;initialTemplate = $dbTemplate-&gt;getContents();</div>
<div class="line"><a id="l03844" name="l03844"></a><span class="lineno"> 3844</span>      $this-&gt;templateName = $dbTemplate-&gt;getTag();</div>
<div class="line"><a id="l03845" name="l03845"></a><span class="lineno"> 3845</span>    }</div>
<div class="line"><a id="l03846" name="l03846"></a><span class="lineno"> 3846</span>    $this-&gt;messageContents = $this-&gt;initialTemplate;</div>
<div class="line"><a id="l03847" name="l03847"></a><span class="lineno"> 3847</span>  }</div>
<div class="line"><a id="l03848" name="l03848"></a><span class="lineno"> 3848</span> </div>
<div class="line"><a id="l03856" name="l03856"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a24e7fbb14ed9dce86eee44d9f81c2e06"> 3856</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a24e7fbb14ed9dce86eee44d9f81c2e06">setCatchAll</a>():void</div>
<div class="line"><a id="l03857" name="l03857"></a><span class="lineno"> 3857</span>  {</div>
<div class="line"><a id="l03858" name="l03858"></a><span class="lineno"> 3858</span>    <span class="keywordflow">if</span> ($this-&gt;constructionMode) {</div>
<div class="line"><a id="l03859" name="l03859"></a><span class="lineno"> 3859</span>      $this-&gt;catchAllEmail = $this-&gt;getConfigValue(<span class="stringliteral">&#39;emailtestaddress&#39;</span>);</div>
<div class="line"><a id="l03860" name="l03860"></a><span class="lineno"> 3860</span>      $this-&gt;catchAllName  = $this-&gt;getConfigValue(</div>
<div class="line"><a id="l03861" name="l03861"></a><span class="lineno"> 3861</span>        <span class="stringliteral">&#39;emailtestname&#39;</span>,</div>
<div class="line"><a id="l03862" name="l03862"></a><span class="lineno"> 3862</span>        $this-&gt;getConfigValue(<span class="stringliteral">&#39;emailfromname&#39;</span>)</div>
<div class="line"><a id="l03863" name="l03863"></a><span class="lineno"> 3863</span>      );</div>
<div class="line"><a id="l03864" name="l03864"></a><span class="lineno"> 3864</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03865" name="l03865"></a><span class="lineno"> 3865</span>      $this-&gt;catchAllEmail = $this-&gt;getConfigValue(<span class="stringliteral">&#39;emailfromaddress&#39;</span>);</div>
<div class="line"><a id="l03866" name="l03866"></a><span class="lineno"> 3866</span>      $this-&gt;catchAllName  = $this-&gt;getConfigValue(<span class="stringliteral">&#39;emailfromname&#39;</span>);</div>
<div class="line"><a id="l03867" name="l03867"></a><span class="lineno"> 3867</span>    }</div>
<div class="line"><a id="l03868" name="l03868"></a><span class="lineno"> 3868</span>  }</div>
<div class="line"><a id="l03869" name="l03869"></a><span class="lineno"> 3869</span> </div>
<div class="line"><a id="l03884" name="l03884"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a699971615de166d76a02ec9aec1c4200"> 3884</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a699971615de166d76a02ec9aec1c4200">dateSubstitution</a>(array $arg, <span class="keywordtype">string</span> $nameSpace, mixed $data = <span class="keyword">null</span>):string</div>
<div class="line"><a id="l03885" name="l03885"></a><span class="lineno"> 3885</span>  {</div>
<div class="line"><a id="l03886" name="l03886"></a><span class="lineno"> 3886</span>    <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l03887" name="l03887"></a><span class="lineno"> 3887</span>      $dateString = $arg[1];</div>
<div class="line"><a id="l03888" name="l03888"></a><span class="lineno"> 3888</span>      $dateFormat = $arg[2]??<span class="stringliteral">&#39;long&#39;</span>;</div>
<div class="line"><a id="l03889" name="l03889"></a><span class="lineno"> 3889</span> </div>
<div class="line"><a id="l03890" name="l03890"></a><span class="lineno"> 3890</span>      <span class="keywordflow">if</span> (filter_var($dateString, FILTER_VALIDATE_INT) === <span class="keyword">false</span>) {</div>
<div class="line"><a id="l03891" name="l03891"></a><span class="lineno"> 3891</span>        <span class="keywordflow">if</span> (!empty($this-&gt;substitutions[$nameSpace][$dateString])) {</div>
<div class="line"><a id="l03892" name="l03892"></a><span class="lineno"> 3892</span>          <span class="comment">// allow other global replacement variables as date-time source</span></div>
<div class="line"><a id="l03893" name="l03893"></a><span class="lineno"> 3893</span>          $dateString = call_user_func(</div>
<div class="line"><a id="l03894" name="l03894"></a><span class="lineno"> 3894</span>            $this-&gt;substitutions[$nameSpace][$dateString],</div>
<div class="line"><a id="l03895" name="l03895"></a><span class="lineno"> 3895</span>            [ $dateString, <span class="stringliteral">&#39;medium&#39;</span> ],</div>
<div class="line"><a id="l03896" name="l03896"></a><span class="lineno"> 3896</span>            $data);</div>
<div class="line"><a id="l03897" name="l03897"></a><span class="lineno"> 3897</span>          <span class="keywordflow">if</span> (empty($dateString)) {</div>
<div class="line"><a id="l03898" name="l03898"></a><span class="lineno"> 3898</span>            <span class="keywordflow">return</span> $arg[0];</div>
<div class="line"><a id="l03899" name="l03899"></a><span class="lineno"> 3899</span>          }</div>
<div class="line"><a id="l03900" name="l03900"></a><span class="lineno"> 3900</span>        }</div>
<div class="line"><a id="l03901" name="l03901"></a><span class="lineno"> 3901</span>        $stamp = strtotime($dateString);</div>
<div class="line"><a id="l03902" name="l03902"></a><span class="lineno"> 3902</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l03903" name="l03903"></a><span class="lineno"> 3903</span>        $stamp = $dateString;</div>
<div class="line"><a id="l03904" name="l03904"></a><span class="lineno"> 3904</span>      }</div>
<div class="line"><a id="l03905" name="l03905"></a><span class="lineno"> 3905</span>      <span class="keywordflow">if</span> (\array_search($dateFormat, [<span class="stringliteral">&#39;full&#39;</span>, <span class="stringliteral">&#39;long&#39;</span>, <span class="stringliteral">&#39;medium&#39;</span>, <span class="stringliteral">&#39;short&#39;</span>]) !== <span class="keyword">false</span>) {</div>
<div class="line"><a id="l03906" name="l03906"></a><span class="lineno"> 3906</span>        <span class="keywordflow">return</span> $this-&gt;formatDate($stamp, $dateFormat);</div>
<div class="line"><a id="l03907" name="l03907"></a><span class="lineno"> 3907</span>      }</div>
<div class="line"><a id="l03908" name="l03908"></a><span class="lineno"> 3908</span>      $oldLocale = setlocale(LC_TIME, <span class="charliteral">&#39;0&#39;</span>);</div>
<div class="line"><a id="l03909" name="l03909"></a><span class="lineno"> 3909</span>      setlocale(LC_TIME, $this-&gt;getLocale());</div>
<div class="line"><a id="l03910" name="l03910"></a><span class="lineno"> 3910</span>      $oldTimezone = \date_default_timezone_get();</div>
<div class="line"><a id="l03911" name="l03911"></a><span class="lineno"> 3911</span>      \date_default_timezone_set($this-&gt;getTimezone());</div>
<div class="line"><a id="l03912" name="l03912"></a><span class="lineno"> 3912</span>      $result = strftime($dateFormat, $stamp);</div>
<div class="line"><a id="l03913" name="l03913"></a><span class="lineno"> 3913</span>      \date_default_timezone_set($oldTimezone);</div>
<div class="line"><a id="l03914" name="l03914"></a><span class="lineno"> 3914</span>      setlocale(LC_TIME, $oldLocale);</div>
<div class="line"><a id="l03915" name="l03915"></a><span class="lineno"> 3915</span>      <span class="keywordflow">return</span> $result;</div>
<div class="line"><a id="l03916" name="l03916"></a><span class="lineno"> 3916</span>    } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l03917" name="l03917"></a><span class="lineno"> 3917</span>      <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_exceptions_1_1_substitution_exception.html">Exceptions\SubstitutionException</a>($this-&gt;l-&gt;t(<span class="stringliteral">&#39;Date-time substitution of &quot;%s&quot; / &quot;%s&quot; failed.&#39;</span>, [ $dateString, $dateFormat ]), $t-&gt;getCode(), $t);</div>
<div class="line"><a id="l03918" name="l03918"></a><span class="lineno"> 3918</span>    }</div>
<div class="line"><a id="l03919" name="l03919"></a><span class="lineno"> 3919</span>  }</div>
<div class="line"><a id="l03920" name="l03920"></a><span class="lineno"> 3920</span> </div>
<div class="line"><a id="l03928" name="l03928"></a><span class="lineno"> 3928</span>  <span class="keyword">private</span> <span class="keyword">function</span> generateGlobalSubstitutionHandlers()</div>
<div class="line"><a id="l03929" name="l03929"></a><span class="lineno"> 3929</span>  {</div>
<div class="line"><a id="l03931" name="l03931"></a><span class="lineno"> 3931</span>    $formatter = $this-&gt;appContainer()-&gt;get(IDateTimeFormatter::class);</div>
<div class="line"><a id="l03932" name="l03932"></a><span class="lineno"> 3932</span> </div>
<div class="line"><a id="l03933" name="l03933"></a><span class="lineno"> 3933</span>    $organizationalRoleContact = <span class="keyword">function</span>(array $arg) {</div>
<div class="line"><a id="l03934" name="l03934"></a><span class="lineno"> 3934</span>      $role = strtolower($arg[0]);</div>
<div class="line"><a id="l03935" name="l03935"></a><span class="lineno"> 3935</span>      $contact = $this-&gt;organizationalRolesService-&gt;dedicatedBoardMemberContact($role);</div>
<div class="line"><a id="l03936" name="l03936"></a><span class="lineno"> 3936</span>      <span class="keywordflow">if</span> (empty($contact)) {</div>
<div class="line"><a id="l03937" name="l03937"></a><span class="lineno"> 3937</span>        <span class="comment">// TRANSLATORS: %s is substituted by the dedicated role of a member of the organization</span></div>
<div class="line"><a id="l03938" name="l03938"></a><span class="lineno"> 3938</span>        <span class="comment">// TRANSLATORS: team, like e.g. &quot;treasurer&quot;.</span></div>
<div class="line"><a id="l03939" name="l03939"></a><span class="lineno"> 3939</span>        <span class="keywordflow">return</span> $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Nothing known about &quot;%s&quot;&#39;</span>, $role);</div>
<div class="line"><a id="l03940" name="l03940"></a><span class="lineno"> 3940</span>      }</div>
<div class="line"><a id="l03941" name="l03941"></a><span class="lineno"> 3941</span>      $subField = Util::dashesToCamelCase(strtolower($arg[1]));</div>
<div class="line"><a id="l03942" name="l03942"></a><span class="lineno"> 3942</span>      <span class="keywordflow">if</span> (empty($subField)) {</div>
<div class="line"><a id="l03943" name="l03943"></a><span class="lineno"> 3943</span>        <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_exceptions_1_1_substitution_exception.html">Exceptions\SubstitutionException</a>($this-&gt;l-&gt;t(<span class="stringliteral">&#39;Contact subfield for &quot;%1$s&quot; is missing, should be one of %2$s.&#39;</span>, [</div>
<div class="line"><a id="l03944" name="l03944"></a><span class="lineno"> 3944</span>          $arg[0],</div>
<div class="line"><a id="l03945" name="l03945"></a><span class="lineno"> 3945</span>          implode(<span class="stringliteral">&#39;, &#39;</span>, array_map(<span class="stringliteral">&#39;strtoupper&#39;</span>, array_keys($contact)))</div>
<div class="line"><a id="l03946" name="l03946"></a><span class="lineno"> 3946</span>        ]));</div>
<div class="line"><a id="l03947" name="l03947"></a><span class="lineno"> 3947</span>      }</div>
<div class="line"><a id="l03948" name="l03948"></a><span class="lineno"> 3948</span>      <span class="keywordflow">if</span> (!isset($contact[$subField])) {</div>
<div class="line"><a id="l03949" name="l03949"></a><span class="lineno"> 3949</span>        <span class="keywordflow">throw</span> <span class="keyword">new</span> Exceptions\SubstitutionException($this-&gt;l-&gt;t(<span class="stringliteral">&#39;Contact subfield &quot;%3$s&quot;&quot; for &quot;%1$s&quot; is unknown, should be one of %2$s.&#39;</span>, [</div>
<div class="line"><a id="l03950" name="l03950"></a><span class="lineno"> 3950</span>          $arg[0],</div>
<div class="line"><a id="l03951" name="l03951"></a><span class="lineno"> 3951</span>          implode(<span class="stringliteral">&#39;, &#39;</span>, array_map(<span class="stringliteral">&#39;strtoupper&#39;</span>, array_keys($contact))),</div>
<div class="line"><a id="l03952" name="l03952"></a><span class="lineno"> 3952</span>          $arg[1],</div>
<div class="line"><a id="l03953" name="l03953"></a><span class="lineno"> 3953</span>        ]));</div>
<div class="line"><a id="l03954" name="l03954"></a><span class="lineno"> 3954</span>      }</div>
<div class="line"><a id="l03955" name="l03955"></a><span class="lineno"> 3955</span>      <span class="keywordflow">return</span> $contact[$subField];</div>
<div class="line"><a id="l03956" name="l03956"></a><span class="lineno"> 3956</span>    };</div>
<div class="line"><a id="l03957" name="l03957"></a><span class="lineno"> 3957</span> </div>
<div class="line"><a id="l03958" name="l03958"></a><span class="lineno"> 3958</span>    $this-&gt;substitutions[self::GLOBAL_NAMESPACE] = [</div>
<div class="line"><a id="l03959" name="l03959"></a><span class="lineno"> 3959</span>      <span class="stringliteral">&#39;ORGANIZER&#39;</span> =&gt; <span class="keyword">function</span>($key) {</div>
<div class="line"><a id="l03960" name="l03960"></a><span class="lineno"> 3960</span>        <span class="keywordflow">return</span> $this-&gt;fetchExecutiveBoard();</div>
<div class="line"><a id="l03961" name="l03961"></a><span class="lineno"> 3961</span>      },</div>
<div class="line"><a id="l03962" name="l03962"></a><span class="lineno"> 3962</span>      <span class="stringliteral">&#39;PRESIDENT&#39;</span> =&gt; $organizationalRoleContact,</div>
<div class="line"><a id="l03963" name="l03963"></a><span class="lineno"> 3963</span>      <span class="stringliteral">&#39;TREASURER&#39;</span> =&gt; $organizationalRoleContact,</div>
<div class="line"><a id="l03964" name="l03964"></a><span class="lineno"> 3964</span>      <span class="stringliteral">&#39;SECRETARY&#39;</span> =&gt; $organizationalRoleContact,</div>
<div class="line"><a id="l03965" name="l03965"></a><span class="lineno"> 3965</span>      <span class="stringliteral">&#39;CREDITOR_IDENTIFIER&#39;</span> =&gt; <span class="keyword">function</span>($key) {</div>
<div class="line"><a id="l03966" name="l03966"></a><span class="lineno"> 3966</span>        <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aa57ee6dad7c7f33cff6983ad79080946">getConfigValue</a>(<span class="stringliteral">&#39;bankAccountCreditorIdentifier&#39;</span>);</div>
<div class="line"><a id="l03967" name="l03967"></a><span class="lineno"> 3967</span>      },</div>
<div class="line"><a id="l03968" name="l03968"></a><span class="lineno"> 3968</span>      <span class="stringliteral">&#39;ADDRESS&#39;</span> =&gt; <span class="keyword">function</span>($key) {</div>
<div class="line"><a id="l03969" name="l03969"></a><span class="lineno"> 3969</span>        <span class="keywordflow">return</span> $this-&gt;streetAddress();</div>
<div class="line"><a id="l03970" name="l03970"></a><span class="lineno"> 3970</span>      },</div>
<div class="line"><a id="l03971" name="l03971"></a><span class="lineno"> 3971</span>      <span class="stringliteral">&#39;BANK_ACCOUNT&#39;</span> =&gt; <span class="keyword">function</span>($key) {</div>
<div class="line"><a id="l03972" name="l03972"></a><span class="lineno"> 3972</span>        <span class="keywordflow">return</span> $this-&gt;bankAccount();</div>
<div class="line"><a id="l03973" name="l03973"></a><span class="lineno"> 3973</span>      },</div>
<div class="line"><a id="l03974" name="l03974"></a><span class="lineno"> 3974</span> </div>
<div class="line"><a id="l03975" name="l03975"></a><span class="lineno"> 3975</span>      <span class="stringliteral">&#39;PROJECT&#39;</span> =&gt; <span class="keyword">function</span>($key) {</div>
<div class="line"><a id="l03976" name="l03976"></a><span class="lineno"> 3976</span>        <span class="keywordflow">return</span> $this-&gt;projectName != <span class="stringliteral">&#39;&#39;</span> ? $this-&gt;projectName : $this-&gt;l-&gt;t(<span class="stringliteral">&#39;no project involved&#39;</span>);</div>
<div class="line"><a id="l03977" name="l03977"></a><span class="lineno"> 3977</span>      },</div>
<div class="line"><a id="l03978" name="l03978"></a><span class="lineno"> 3978</span> </div>
<div class="line"><a id="l03979" name="l03979"></a><span class="lineno"> 3979</span>      self::t(<span class="stringliteral">&#39;PROJECT_PUBLIC_SHARE&#39;</span>) =&gt; <span class="keyword">function</span>(array $key) {</div>
<div class="line"><a id="l03980" name="l03980"></a><span class="lineno"> 3980</span>        <span class="keywordflow">if</span> (empty($this-&gt;project)) {</div>
<div class="line"><a id="l03981" name="l03981"></a><span class="lineno"> 3981</span>          <span class="keywordflow">return</span> $key[0];</div>
<div class="line"><a id="l03982" name="l03982"></a><span class="lineno"> 3982</span>        }</div>
<div class="line"><a id="l03984" name="l03984"></a><span class="lineno"> 3984</span>        $projectService = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(ProjectService::class);</div>
<div class="line"><a id="l03985" name="l03985"></a><span class="lineno"> 3985</span>        list(<span class="stringliteral">&#39;share&#39;</span> =&gt; $share,) =  $projectService-&gt;ensureDownloadsShare($this-&gt;project, noCreate: <span class="keyword">false</span>);</div>
<div class="line"><a id="l03986" name="l03986"></a><span class="lineno"> 3986</span>        <span class="keywordflow">return</span> $share;</div>
<div class="line"><a id="l03987" name="l03987"></a><span class="lineno"> 3987</span>      },</div>
<div class="line"><a id="l03988" name="l03988"></a><span class="lineno"> 3988</span> </div>
<div class="line"><a id="l03989" name="l03989"></a><span class="lineno"> 3989</span>      self::t(<span class="stringliteral">&#39;PROJECT_PUBLIC_SHARE_EXPIRATION&#39;</span>) =&gt; <span class="keyword">function</span>(array $key) {</div>
<div class="line"><a id="l03990" name="l03990"></a><span class="lineno"> 3990</span>        <span class="keywordflow">if</span> (empty($this-&gt;project)) {</div>
<div class="line"><a id="l03991" name="l03991"></a><span class="lineno"> 3991</span>          <span class="keywordflow">return</span> $key[0];</div>
<div class="line"><a id="l03992" name="l03992"></a><span class="lineno"> 3992</span>        }</div>
<div class="line"><a id="l03994" name="l03994"></a><span class="lineno"> 3994</span>        $projectService = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">di</a>(ProjectService::class);</div>
<div class="line"><a id="l03995" name="l03995"></a><span class="lineno"> 3995</span>        list(<span class="stringliteral">&#39;expires&#39;</span> =&gt; $expires,) =  $projectService-&gt;ensureDownloadsShare($this-&gt;project, noCreate: <span class="keyword">true</span>);</div>
<div class="line"><a id="l03996" name="l03996"></a><span class="lineno"> 3996</span>        <span class="keywordflow">if</span> (empty($expires)) {</div>
<div class="line"><a id="l03997" name="l03997"></a><span class="lineno"> 3997</span>          <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><a id="l03998" name="l03998"></a><span class="lineno"> 3998</span>        }</div>
<div class="line"><a id="l03999" name="l03999"></a><span class="lineno"> 3999</span>        $phrase = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04000" name="l04000"></a><span class="lineno"> 4000</span>        $keyWordIndex = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04001" name="l04001"></a><span class="lineno"> 4001</span>        <span class="keywordflow">foreach</span> ([<span class="stringliteral">&#39;phrase&#39;</span>, $this-&gt;l-&gt;t(<span class="stringliteral">&#39;phrase&#39;</span>)] as $keyWord) {</div>
<div class="line"><a id="l04002" name="l04002"></a><span class="lineno"> 4002</span>          $keyWordIndex = array_search($keyWord, $key);</div>
<div class="line"><a id="l04003" name="l04003"></a><span class="lineno"> 4003</span>          <span class="keywordflow">if</span> ($keyWordIndex !== <span class="keyword">false</span>) {</div>
<div class="line"><a id="l04004" name="l04004"></a><span class="lineno"> 4004</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l04005" name="l04005"></a><span class="lineno"> 4005</span>          }</div>
<div class="line"><a id="l04006" name="l04006"></a><span class="lineno"> 4006</span>        }</div>
<div class="line"><a id="l04007" name="l04007"></a><span class="lineno"> 4007</span>        <span class="keywordflow">if</span> ($keyWordIndex !== <span class="keyword">false</span>) {</div>
<div class="line"><a id="l04008" name="l04008"></a><span class="lineno"> 4008</span>          unset($key[$keyWordIndex]);</div>
<div class="line"><a id="l04009" name="l04009"></a><span class="lineno"> 4009</span>          $key = array_values($key);</div>
<div class="line"><a id="l04010" name="l04010"></a><span class="lineno"> 4010</span>          $phrase = <span class="keyword">true</span>;</div>
<div class="line"><a id="l04011" name="l04011"></a><span class="lineno"> 4011</span>        }</div>
<div class="line"><a id="l04012" name="l04012"></a><span class="lineno"> 4012</span>        $key[2] = $key[1] ?? <span class="keyword">null</span>;</div>
<div class="line"><a id="l04013" name="l04013"></a><span class="lineno"> 4013</span>        $key[1] = $expires-&gt;getTimestamp();</div>
<div class="line"><a id="l04014" name="l04014"></a><span class="lineno"> 4014</span> </div>
<div class="line"><a id="l04015" name="l04015"></a><span class="lineno"> 4015</span>        $date = $this-&gt;dateSubstitution($key, self::GLOBAL_NAMESPACE, <span class="keyword">null</span>);</div>
<div class="line"><a id="l04016" name="l04016"></a><span class="lineno"> 4016</span> </div>
<div class="line"><a id="l04017" name="l04017"></a><span class="lineno"> 4017</span>        <span class="keywordflow">if</span> ($phrase) {</div>
<div class="line"><a id="l04018" name="l04018"></a><span class="lineno"> 4018</span>          <span class="keywordflow">return</span> <span class="charliteral">&#39; &#39;</span> . $this-&gt;l-&gt;t(<span class="stringliteral">&#39;(expires at %s)&#39;</span>, $date);</div>
<div class="line"><a id="l04019" name="l04019"></a><span class="lineno"> 4019</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l04020" name="l04020"></a><span class="lineno"> 4020</span>          <span class="keywordflow">return</span> $date;</div>
<div class="line"><a id="l04021" name="l04021"></a><span class="lineno"> 4021</span>        }</div>
<div class="line"><a id="l04022" name="l04022"></a><span class="lineno"> 4022</span>      },</div>
<div class="line"><a id="l04023" name="l04023"></a><span class="lineno"> 4023</span> </div>
<div class="line"><a id="l04024" name="l04024"></a><span class="lineno"> 4024</span>      <span class="stringliteral">&#39;BANK_TRANSACTION_DUE_DATE&#39;</span> =&gt; fn($key) =&gt; <span class="stringliteral">&#39;&#39;</span>,</div>
<div class="line"><a id="l04025" name="l04025"></a><span class="lineno"> 4025</span>      <span class="stringliteral">&#39;BANK_TRANSACTION_DUE_DAYS&#39;</span> =&gt; fn($key) =&gt; <span class="stringliteral">&#39;&#39;</span>,</div>
<div class="line"><a id="l04026" name="l04026"></a><span class="lineno"> 4026</span>      <span class="stringliteral">&#39;BANK_TRANSACTION_SUBMIT_DATE&#39;</span> =&gt; fn($key) =&gt; <span class="stringliteral">&#39;&#39;</span>,</div>
<div class="line"><a id="l04027" name="l04027"></a><span class="lineno"> 4027</span>      <span class="stringliteral">&#39;BANK_TRANSACTION_SUBMIT_DAYS&#39;</span> =&gt; fn($key) =&gt; <span class="stringliteral">&#39;&#39;</span>,</div>
<div class="line"><a id="l04028" name="l04028"></a><span class="lineno"> 4028</span> </div>
<div class="line"><a id="l04037" name="l04037"></a><span class="lineno"> 4037</span>      <span class="stringliteral">&#39;DATE&#39;</span> =&gt; <span class="keyword">function</span>(array $arg) {</div>
<div class="line"><a id="l04038" name="l04038"></a><span class="lineno"> 4038</span>        <span class="keywordflow">return</span> $this-&gt;dateSubstitution($arg, self::GLOBAL_NAMESPACE);</div>
<div class="line"><a id="l04039" name="l04039"></a><span class="lineno"> 4039</span>      },</div>
<div class="line"><a id="l04040" name="l04040"></a><span class="lineno"> 4040</span>      <span class="stringliteral">&#39;TIME&#39;</span> =&gt; <span class="keyword">function</span>(array $arg) use ($formatter) {</div>
<div class="line"><a id="l04041" name="l04041"></a><span class="lineno"> 4041</span>        <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l04042" name="l04042"></a><span class="lineno"> 4042</span>          $dateString = $arg[1];</div>
<div class="line"><a id="l04043" name="l04043"></a><span class="lineno"> 4043</span>          $dateFormat = $arg[2]?:<span class="stringliteral">&#39;long&#39;</span>;</div>
<div class="line"><a id="l04044" name="l04044"></a><span class="lineno"> 4044</span>          $stamp = strtotime($dateString);</div>
<div class="line"><a id="l04045" name="l04045"></a><span class="lineno"> 4045</span>          <span class="keywordflow">return</span> $formatter-&gt;formatTime($stamp, $dateFormat);</div>
<div class="line"><a id="l04046" name="l04046"></a><span class="lineno"> 4046</span>        } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l04047" name="l04047"></a><span class="lineno"> 4047</span>          <span class="keywordflow">throw</span> <span class="keyword">new</span> Exceptions\SubstitutionException($this-&gt;l-&gt;t(<span class="stringliteral">&#39;Date-time substitution of &quot;%s&quot; / &quot;%s&quot; failed.&#39;</span>, [ $dateString, $dateFormat ]), $t-&gt;getCode(), $t);</div>
<div class="line"><a id="l04048" name="l04048"></a><span class="lineno"> 4048</span>        }</div>
<div class="line"><a id="l04049" name="l04049"></a><span class="lineno"> 4049</span>      },</div>
<div class="line"><a id="l04050" name="l04050"></a><span class="lineno"> 4050</span>      <span class="stringliteral">&#39;DATETIME&#39;</span> =&gt; <span class="keyword">function</span>(array $arg) {</div>
<div class="line"><a id="l04051" name="l04051"></a><span class="lineno"> 4051</span>        <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l04052" name="l04052"></a><span class="lineno"> 4052</span>          $dateString = $arg[1];</div>
<div class="line"><a id="l04053" name="l04053"></a><span class="lineno"> 4053</span>          $dateFormat = $arg[2]?:<span class="stringliteral">&#39;long&#39;</span>;</div>
<div class="line"><a id="l04054" name="l04054"></a><span class="lineno"> 4054</span>          $stamp = strtotime($dateString);</div>
<div class="line"><a id="l04055" name="l04055"></a><span class="lineno"> 4055</span>          <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#ad0e227937c98eb3733d82ea455977862">formatDateTime</a>($stamp, $dateFormat);</div>
<div class="line"><a id="l04056" name="l04056"></a><span class="lineno"> 4056</span>        } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l04057" name="l04057"></a><span class="lineno"> 4057</span>          <span class="keywordflow">throw</span> <span class="keyword">new</span> Exceptions\SubstitutionException($this-&gt;l-&gt;t(<span class="stringliteral">&#39;Date-time substitution of &quot;%s&quot; / &quot;%s&quot; failed.&#39;</span>, [ $dateString, $dateFormat ]), $t-&gt;getCode(), $t);</div>
<div class="line"><a id="l04058" name="l04058"></a><span class="lineno"> 4058</span>        }</div>
<div class="line"><a id="l04059" name="l04059"></a><span class="lineno"> 4059</span>      },</div>
<div class="line"><a id="l04060" name="l04060"></a><span class="lineno"> 4060</span>    ];</div>
<div class="line"><a id="l04061" name="l04061"></a><span class="lineno"> 4061</span> </div>
<div class="line"><a id="l04062" name="l04062"></a><span class="lineno"> 4062</span>    <span class="keywordflow">if</span> (!empty($this-&gt;bulkTransaction)) {</div>
<div class="line"><a id="l04063" name="l04063"></a><span class="lineno"> 4063</span> </div>
<div class="line"><a id="l04064" name="l04064"></a><span class="lineno"> 4064</span>      $this-&gt;substitutions[self::GLOBAL_NAMESPACE] = array_merge(</div>
<div class="line"><a id="l04065" name="l04065"></a><span class="lineno"> 4065</span>        $this-&gt;substitutions[self::GLOBAL_NAMESPACE], [</div>
<div class="line"><a id="l04066" name="l04066"></a><span class="lineno"> 4066</span>          <span class="stringliteral">&#39;BANK_TRANSACTION_DUE_DAYS&#39;</span> =&gt; <span class="keyword">function</span>($key) {</div>
<div class="line"><a id="l04067" name="l04067"></a><span class="lineno"> 4067</span>            <span class="keywordflow">return</span> (<span class="keyword">new</span> DateTimeImmutable())-&gt;diff($this-&gt;bulkTransaction-&gt;getDueDate())-&gt;format(<span class="stringliteral">&#39;%r%a&#39;</span>);</div>
<div class="line"><a id="l04068" name="l04068"></a><span class="lineno"> 4068</span>          },</div>
<div class="line"><a id="l04069" name="l04069"></a><span class="lineno"> 4069</span>          <span class="stringliteral">&#39;BANK_TRANSACTION_SUBMIT_DAYS&#39;</span> =&gt; <span class="keyword">function</span>($key) {</div>
<div class="line"><a id="l04070" name="l04070"></a><span class="lineno"> 4070</span>            <span class="keywordflow">return</span> (<span class="keyword">new</span> DateTimeImmutable())-&gt;diff($this-&gt;bulkTransaction-&gt;getSubmissionDeadline())-&gt;format(<span class="stringliteral">&#39;%r%a&#39;</span>);</div>
<div class="line"><a id="l04071" name="l04071"></a><span class="lineno"> 4071</span>          },</div>
<div class="line"><a id="l04072" name="l04072"></a><span class="lineno"> 4072</span>          <span class="stringliteral">&#39;BANK_TRANSACTION_DUE_DATE&#39;</span> =&gt; <span class="keyword">function</span>($key) {</div>
<div class="line"><a id="l04073" name="l04073"></a><span class="lineno"> 4073</span>            <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a010c9c0626aa3587f7062ffbcc9ff64e">formatDate</a>($this-&gt;bulkTransaction-&gt;getDueDate(), <span class="stringliteral">&#39;medium&#39;</span>);</div>
<div class="line"><a id="l04074" name="l04074"></a><span class="lineno"> 4074</span>          },</div>
<div class="line"><a id="l04075" name="l04075"></a><span class="lineno"> 4075</span>          <span class="stringliteral">&#39;BANK_TRANSACTION_SUBMIT_DATE&#39;</span> =&gt; <span class="keyword">function</span>($key) {</div>
<div class="line"><a id="l04076" name="l04076"></a><span class="lineno"> 4076</span>            <span class="keywordflow">return</span> $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a010c9c0626aa3587f7062ffbcc9ff64e">formatDate</a>($this-&gt;bulkTransaction-&gt;getSubmissionDeadline(), <span class="stringliteral">&#39;medium&#39;</span>);</div>
<div class="line"><a id="l04077" name="l04077"></a><span class="lineno"> 4077</span>          },</div>
<div class="line"><a id="l04078" name="l04078"></a><span class="lineno"> 4078</span>        ]);</div>
<div class="line"><a id="l04079" name="l04079"></a><span class="lineno"> 4079</span>    }</div>
<div class="line"><a id="l04080" name="l04080"></a><span class="lineno"> 4080</span>  }</div>
<div class="line"><a id="l04081" name="l04081"></a><span class="lineno"> 4081</span> </div>
<div class="line"><a id="l04083" name="l04083"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa6773d095ef2595974297b6e90fe2199"> 4083</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa6773d095ef2595974297b6e90fe2199">streetAddress</a>():string</div>
<div class="line"><a id="l04084" name="l04084"></a><span class="lineno"> 4084</span>  {</div>
<div class="line"><a id="l04085" name="l04085"></a><span class="lineno"> 4085</span>    <span class="keywordflow">return</span></div>
<div class="line"><a id="l04086" name="l04086"></a><span class="lineno"> 4086</span>      $this-&gt;getConfigValue(<span class="stringliteral">&#39;streetAddressName01&#39;</span>).<span class="stringliteral">&quot;&lt;br/&gt;\n&quot;</span>.</div>
<div class="line"><a id="l04087" name="l04087"></a><span class="lineno"> 4087</span>      $this-&gt;getConfigValue(<span class="stringliteral">&#39;streetAddressName02&#39;</span>).<span class="stringliteral">&quot;&lt;br/&gt;\n&quot;</span>.</div>
<div class="line"><a id="l04088" name="l04088"></a><span class="lineno"> 4088</span>      $this-&gt;getConfigValue(<span class="stringliteral">&#39;streetAddressStreet&#39;</span>).<span class="stringliteral">&quot;&amp;nbsp;&quot;</span>.</div>
<div class="line"><a id="l04089" name="l04089"></a><span class="lineno"> 4089</span>      $this-&gt;getConfigValue(<span class="stringliteral">&#39;streetAddressHouseNumber&#39;</span>).<span class="stringliteral">&quot;&lt;br/&gt;\n&quot;</span>.</div>
<div class="line"><a id="l04090" name="l04090"></a><span class="lineno"> 4090</span>      $this-&gt;getConfigValue(<span class="stringliteral">&#39;streetAddressZIP&#39;</span>).<span class="stringliteral">&quot;&amp;nbsp;&quot;</span>.</div>
<div class="line"><a id="l04091" name="l04091"></a><span class="lineno"> 4091</span>      $this-&gt;getConfigValue(<span class="stringliteral">&#39;streetAddressCity&#39;</span>);</div>
<div class="line"><a id="l04092" name="l04092"></a><span class="lineno"> 4092</span>  }</div>
<div class="line"><a id="l04093" name="l04093"></a><span class="lineno"> 4093</span> </div>
<div class="line"><a id="l04095" name="l04095"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a1277a745b6d92dd38773bb7d361f3b58"> 4095</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a1277a745b6d92dd38773bb7d361f3b58">bankAccount</a>():string</div>
<div class="line"><a id="l04096" name="l04096"></a><span class="lineno"> 4096</span>  {</div>
<div class="line"><a id="l04097" name="l04097"></a><span class="lineno"> 4097</span>    $iban = <span class="keyword">new</span> PHP_IBAN\IBAN($this-&gt;getConfigValue(<span class="stringliteral">&#39;bankAccountIBAN&#39;</span>));</div>
<div class="line"><a id="l04098" name="l04098"></a><span class="lineno"> 4098</span>    $financeService = $this-&gt;di(FinanceService::class);</div>
<div class="line"><a id="l04099" name="l04099"></a><span class="lineno"> 4099</span>    $info = $financeService-&gt;getIbanInfo($iban-&gt;MachineFormat());</div>
<div class="line"><a id="l04100" name="l04100"></a><span class="lineno"> 4100</span>    <span class="keywordflow">return</span> ($info[<span class="stringliteral">&#39;bank&#39;</span>] . <span class="stringliteral">&quot;&lt;br/&gt;\n&quot;</span></div>
<div class="line"><a id="l04101" name="l04101"></a><span class="lineno"> 4101</span>          . $this-&gt;getConfigValue(<span class="stringliteral">&#39;bankAccountOwner&#39;</span>) . <span class="stringliteral">&quot;&lt;br/&gt;\n&quot;</span></div>
<div class="line"><a id="l04102" name="l04102"></a><span class="lineno"> 4102</span>          . <span class="stringliteral">&quot;IBAN &quot;</span>.$iban-&gt;HumanFormat() . <span class="stringliteral">&quot; (&quot;</span> . $iban-&gt;MachineFormat() . <span class="stringliteral">&quot;)&lt;br/&gt;\n&quot;</span></div>
<div class="line"><a id="l04103" name="l04103"></a><span class="lineno"> 4103</span>          . <span class="stringliteral">&quot;BIC &quot;</span> . $this-&gt;getConfigValue(<span class="stringliteral">&#39;bankAccountBIC&#39;</span>)</div>
<div class="line"><a id="l04104" name="l04104"></a><span class="lineno"> 4104</span>    );</div>
<div class="line"><a id="l04105" name="l04105"></a><span class="lineno"> 4105</span>  }</div>
<div class="line"><a id="l04106" name="l04106"></a><span class="lineno"> 4106</span> </div>
<div class="line"><a id="l04113" name="l04113"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#af6fe2b68e7e9ad882d4bca0d4409df3d"> 4113</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#af6fe2b68e7e9ad882d4bca0d4409df3d">fetchExecutiveBoard</a>():string</div>
<div class="line"><a id="l04114" name="l04114"></a><span class="lineno"> 4114</span>  {</div>
<div class="line"><a id="l04115" name="l04115"></a><span class="lineno"> 4115</span>    $executiveBoardId = $this-&gt;getExecutiveBoardProjectId();</div>
<div class="line"><a id="l04116" name="l04116"></a><span class="lineno"> 4116</span> </div>
<div class="line"><a id="l04117" name="l04117"></a><span class="lineno"> 4117</span>    $executiveBoardNames = $this</div>
<div class="line"><a id="l04118" name="l04118"></a><span class="lineno"> 4118</span>      -&gt;getDatabaseRepository(Entities\ProjectParticipant::class)</div>
<div class="line"><a id="l04119" name="l04119"></a><span class="lineno"> 4119</span>      -&gt;fetchParticipantNames($executiveBoardId, [</div>
<div class="line"><a id="l04120" name="l04120"></a><span class="lineno"> 4120</span>        <span class="stringliteral">&#39;nickName&#39;</span> =&gt; <span class="stringliteral">&#39;ASC&#39;</span>,</div>
<div class="line"><a id="l04121" name="l04121"></a><span class="lineno"> 4121</span>        <span class="stringliteral">&#39;firstName&#39;</span> =&gt; <span class="stringliteral">&#39;ASC&#39;</span>,</div>
<div class="line"><a id="l04122" name="l04122"></a><span class="lineno"> 4122</span>        <span class="stringliteral">&#39;displayName&#39;</span> =&gt; <span class="stringliteral">&#39;ASC&#39;</span>,</div>
<div class="line"><a id="l04123" name="l04123"></a><span class="lineno"> 4123</span>        <span class="stringliteral">&#39;surName&#39;</span> =&gt; <span class="stringliteral">&#39;ASC&#39;</span>,</div>
<div class="line"><a id="l04124" name="l04124"></a><span class="lineno"> 4124</span>      ]);</div>
<div class="line"><a id="l04125" name="l04125"></a><span class="lineno"> 4125</span> </div>
<div class="line"><a id="l04126" name="l04126"></a><span class="lineno"> 4126</span>    $executiveBoardNickNames = [];</div>
<div class="line"><a id="l04127" name="l04127"></a><span class="lineno"> 4127</span>    <span class="keywordflow">foreach</span> ($executiveBoardNames as $names) {</div>
<div class="line"><a id="l04128" name="l04128"></a><span class="lineno"> 4128</span>      $executiveBoardNickNames[] = $names[<span class="stringliteral">&#39;nickName&#39;</span>];</div>
<div class="line"><a id="l04129" name="l04129"></a><span class="lineno"> 4129</span>    }</div>
<div class="line"><a id="l04130" name="l04130"></a><span class="lineno"> 4130</span> </div>
<div class="line"><a id="l04131" name="l04131"></a><span class="lineno"> 4131</span>    <span class="keywordflow">return</span> $this-&gt;implodeSloppy($executiveBoardNickNames);</div>
<div class="line"><a id="l04132" name="l04132"></a><span class="lineno"> 4132</span>  }</div>
<div class="line"><a id="l04133" name="l04133"></a><span class="lineno"> 4133</span> </div>
<div class="line"><a id="l04141" name="l04141"></a><span class="lineno"> 4141</span>  <span class="keyword">public</span> <span class="keyword">function</span> loadSentEmail(<span class="keywordtype">string</span> $messageId):bool</div>
<div class="line"><a id="l04142" name="l04142"></a><span class="lineno"> 4142</span>  {</div>
<div class="line"><a id="l04143" name="l04143"></a><span class="lineno"> 4143</span>    $messageId = trim($messageId, <span class="stringliteral">&quot; \n\r\t\v\x00&quot;</span>);</div>
<div class="line"><a id="l04145" name="l04145"></a><span class="lineno"> 4145</span>    $sentEmail = $this-&gt;getDatabaseRepository(Entities\SentEmail::class)-&gt;findOneLike([ <span class="stringliteral">&#39;messageId&#39;</span> =&gt; <span class="charliteral">&#39;%&#39;</span> . trim($messageId) . <span class="charliteral">&#39;%&#39;</span> ]);</div>
<div class="line"><a id="l04146" name="l04146"></a><span class="lineno"> 4146</span>    <span class="keywordflow">if</span> (empty($sentEmail)) {</div>
<div class="line"><a id="l04147" name="l04147"></a><span class="lineno"> 4147</span>      $this-&gt;logInfo(<span class="stringliteral">&#39;UNABLE TO FETCH &quot;&#39;</span> . $messageId . <span class="charliteral">&#39;&quot;&#39;</span>);</div>
<div class="line"><a id="l04148" name="l04148"></a><span class="lineno"> 4148</span>      <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04149" name="l04149"></a><span class="lineno"> 4149</span>    }</div>
<div class="line"><a id="l04150" name="l04150"></a><span class="lineno"> 4150</span> </div>
<div class="line"><a id="l04151" name="l04151"></a><span class="lineno"> 4151</span>    <span class="comment">// The following seems to be used by TB</span></div>
<div class="line"><a id="l04152" name="l04152"></a><span class="lineno"> 4152</span>    <span class="comment">// &lt;blockquote type=&quot;cite&quot; cite=&quot;mid:f1bfe41b-1f3e-8ea9-be96-374b2eaca6ea@ruhr-uni-bochum.de&quot;&gt;</span></div>
<div class="line"><a id="l04153" name="l04153"></a><span class="lineno"> 4153</span>    <span class="comment">// Am 12.04.22 um 17:50 schrieb DIE ZEIT:</span></div>
<div class="line"><a id="l04154" name="l04154"></a><span class="lineno"> 4154</span>    <span class="comment">// On 12.04.22 17:50, DIE ZEIT wrote:</span></div>
<div class="line"><a id="l04155" name="l04155"></a><span class="lineno"> 4155</span> </div>
<div class="line"><a id="l04156" name="l04156"></a><span class="lineno"> 4156</span>    $dateSent = $sentEmail-&gt;getCreated();</div>
<div class="line"><a id="l04157" name="l04157"></a><span class="lineno"> 4157</span>    $this-&gt;messageContents = <span class="stringliteral">&#39;&lt;p&gt;&#39;</span></div>
<div class="line"><a id="l04158" name="l04158"></a><span class="lineno"> 4158</span>      . $this-&gt;l-&gt;t(<span class="stringliteral">&#39;REPLYTO: On %1$s %2$s, %3$s wrote:&#39;</span>, [</div>
<div class="line"><a id="l04159" name="l04159"></a><span class="lineno"> 4159</span>        $this-&gt;dateTimeFormatter()-&gt;formatDate($dateSent, <span class="stringliteral">&#39;medium&#39;</span>),</div>
<div class="line"><a id="l04160" name="l04160"></a><span class="lineno"> 4160</span>        $this-&gt;dateTimeFormatter()-&gt;formatTime($dateSent, <span class="stringliteral">&#39;medium&#39;</span>),</div>
<div class="line"><a id="l04161" name="l04161"></a><span class="lineno"> 4161</span>        $this-&gt;fromName(),</div>
<div class="line"><a id="l04162" name="l04162"></a><span class="lineno"> 4162</span>      ])</div>
<div class="line"><a id="l04163" name="l04163"></a><span class="lineno"> 4163</span>      . <span class="stringliteral">&#39;&lt;/p&gt;&#39;</span>;</div>
<div class="line"><a id="l04164" name="l04164"></a><span class="lineno"> 4164</span>    $this-&gt;messageContents .= <span class="stringliteral">&#39;&lt;blockquote type=&quot;cite&quot; style=&quot;&quot; cite=&quot;mid:&#39;</span> . trim($messageId, <span class="stringliteral">&#39;&lt;&gt;&#39;</span>) . <span class="stringliteral">&#39;&quot;&gt;&#39;</span> . $sentEmail-&gt;getHtmlBody() . <span class="stringliteral">&#39;&lt;/blockquote&gt;&#39;</span>;</div>
<div class="line"><a id="l04165" name="l04165"></a><span class="lineno"> 4165</span>    $this-&gt;cgiData[<span class="stringliteral">&#39;subject&#39;</span>] = preg_replace(<span class="stringliteral">&#39;/\[[^]]*\]\s+/&#39;</span>, <span class="stringliteral">&#39;Re: &#39;</span>, $sentEmail-&gt;getSubject());</div>
<div class="line"><a id="l04166" name="l04166"></a><span class="lineno"> 4166</span> </div>
<div class="line"><a id="l04167" name="l04167"></a><span class="lineno"> 4167</span>    $this-&gt;cgiData[<span class="stringliteral">&#39;BCC&#39;</span>] = $sentEmail-&gt;getBcc();</div>
<div class="line"><a id="l04168" name="l04168"></a><span class="lineno"> 4168</span>    $this-&gt;cgiData[<span class="stringliteral">&#39;CC&#39;</span>] = $sentEmail-&gt;getCc();</div>
<div class="line"><a id="l04169" name="l04169"></a><span class="lineno"> 4169</span>    $this-&gt;cgiData[<span class="stringliteral">&#39;inReplyTo&#39;</span>] = $this-&gt;inReplyToId = $messageId;</div>
<div class="line"><a id="l04170" name="l04170"></a><span class="lineno"> 4170</span> </div>
<div class="line"><a id="l04171" name="l04171"></a><span class="lineno"> 4171</span> </div>
<div class="line"><a id="l04172" name="l04172"></a><span class="lineno"> 4172</span>    $this-&gt;referencing = [ $this-&gt;inReplyTo() ];</div>
<div class="line"><a id="l04173" name="l04173"></a><span class="lineno"> 4173</span>    $referencing = $sentEmail-&gt;getReferencing();</div>
<div class="line"><a id="l04174" name="l04174"></a><span class="lineno"> 4174</span>    <span class="keywordflow">if</span> (!empty($referencing)) {</div>
<div class="line"><a id="l04175" name="l04175"></a><span class="lineno"> 4175</span>      $this-&gt;referencing[] = $referencing-&gt;getMessageId();</div>
<div class="line"><a id="l04176" name="l04176"></a><span class="lineno"> 4176</span>    }</div>
<div class="line"><a id="l04177" name="l04177"></a><span class="lineno"> 4177</span>    $referencedBy = $sentEmail-&gt;getReferencedBy();</div>
<div class="line"><a id="l04178" name="l04178"></a><span class="lineno"> 4178</span>    <span class="keywordflow">foreach</span> ($referencedBy as $referrer) {</div>
<div class="line"><a id="l04179" name="l04179"></a><span class="lineno"> 4179</span>      $this-&gt;referencing[] = $referrer -&gt;getMessageId();</div>
<div class="line"><a id="l04180" name="l04180"></a><span class="lineno"> 4180</span>    }</div>
<div class="line"><a id="l04181" name="l04181"></a><span class="lineno"> 4181</span>    $this-&gt;cgiData[<span class="stringliteral">&#39;referencing&#39;</span>] = $this-&gt;referencing;</div>
<div class="line"><a id="l04182" name="l04182"></a><span class="lineno"> 4182</span> </div>
<div class="line"><a id="l04183" name="l04183"></a><span class="lineno"> 4183</span>    $this-&gt;draftId = 0; <span class="comment">// avoid accidental overwriting</span></div>
<div class="line"><a id="l04184" name="l04184"></a><span class="lineno"> 4184</span> </div>
<div class="line"><a id="l04185" name="l04185"></a><span class="lineno"> 4185</span>    $parser = <span class="keyword">new</span> Mail_RFC822(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</div>
<div class="line"><a id="l04186" name="l04186"></a><span class="lineno"> 4186</span>    $recipients = [];</div>
<div class="line"><a id="l04187" name="l04187"></a><span class="lineno"> 4187</span>    <span class="keywordflow">foreach</span> (explode(<span class="charliteral">&#39;;&#39;</span>, $sentEmail-&gt;getBulkRecipients()) as $recipient) {</div>
<div class="line"><a id="l04188" name="l04188"></a><span class="lineno"> 4188</span>      $emailRecord = $parser-&gt;parseAddressList($recipient);</div>
<div class="line"><a id="l04189" name="l04189"></a><span class="lineno"> 4189</span>      $parseError = $parser-&gt;parseError();</div>
<div class="line"><a id="l04190" name="l04190"></a><span class="lineno"> 4190</span>      <span class="keywordflow">if</span> ($parseError !== <span class="keyword">false</span> || count($emailRecord) != 1) {</div>
<div class="line"><a id="l04191" name="l04191"></a><span class="lineno"> 4191</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l04192" name="l04192"></a><span class="lineno"> 4192</span>      }</div>
<div class="line"><a id="l04193" name="l04193"></a><span class="lineno"> 4193</span>      $emailRecord = reset($emailRecord);</div>
<div class="line"><a id="l04194" name="l04194"></a><span class="lineno"> 4194</span>      $recipients[] = $emailRecord-&gt;mailbox . <span class="charliteral">&#39;@&#39;</span> . $emailRecord-&gt;host;</div>
<div class="line"><a id="l04195" name="l04195"></a><span class="lineno"> 4195</span>    }</div>
<div class="line"><a id="l04196" name="l04196"></a><span class="lineno"> 4196</span>    $musicianIds = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#ab6f5f4edde190f5e5f1cd1e2fdd402d4">getDatabaseRepository</a>(Entities\Musician::class)-&gt;fetchIds([ <span class="stringliteral">&#39;email&#39;</span> =&gt; $recipients ]);</div>
<div class="line"><a id="l04197" name="l04197"></a><span class="lineno"> 4197</span> </div>
<div class="line"><a id="l04198" name="l04198"></a><span class="lineno"> 4198</span>    $this-&gt;recipientsFilter-&gt;setSelectedRecipients($musicianIds);</div>
<div class="line"><a id="l04199" name="l04199"></a><span class="lineno"> 4199</span>    $this-&gt;recipients = $this-&gt;recipientsFilter-&gt;selectedRecipients();</div>
<div class="line"><a id="l04200" name="l04200"></a><span class="lineno"> 4200</span> </div>
<div class="line"><a id="l04201" name="l04201"></a><span class="lineno"> 4201</span>    <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">true</span>;</div>
<div class="line"><a id="l04202" name="l04202"></a><span class="lineno"> 4202</span>  }</div>
<div class="line"><a id="l04203" name="l04203"></a><span class="lineno"> 4203</span> </div>
<div class="line"><a id="l04204" name="l04204"></a><span class="lineno"> 4204</span> </div>
<div class="line"><a id="l04218" name="l04218"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a983520de1e3cc2a8f002055bf82ad3a8"> 4218</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a983520de1e3cc2a8f002055bf82ad3a8">storeTemplate</a>(<span class="keywordtype">string</span> $templateName, ?<span class="keywordtype">string</span> $subject = <span class="keyword">null</span>, ?<span class="keywordtype">string</span> $contents = <span class="keyword">null</span>):void</div>
<div class="line"><a id="l04219" name="l04219"></a><span class="lineno"> 4219</span>  {</div>
<div class="line"><a id="l04220" name="l04220"></a><span class="lineno"> 4220</span>    <span class="keywordflow">if</span> (empty($subject)) {</div>
<div class="line"><a id="l04221" name="l04221"></a><span class="lineno"> 4221</span>      $subject = $this-&gt;subject();</div>
<div class="line"><a id="l04222" name="l04222"></a><span class="lineno"> 4222</span>    }</div>
<div class="line"><a id="l04223" name="l04223"></a><span class="lineno"> 4223</span>    <span class="keywordflow">if</span> (empty($contents)) {</div>
<div class="line"><a id="l04224" name="l04224"></a><span class="lineno"> 4224</span>      $contents = $this-&gt;messageText();</div>
<div class="line"><a id="l04225" name="l04225"></a><span class="lineno"> 4225</span>    }</div>
<div class="line"><a id="l04226" name="l04226"></a><span class="lineno"> 4226</span> </div>
<div class="line"><a id="l04227" name="l04227"></a><span class="lineno"> 4227</span>    $template = $this</div>
<div class="line"><a id="l04228" name="l04228"></a><span class="lineno"> 4228</span>      -&gt;getDatabaseRepository(Entities\EmailTemplate::class)</div>
<div class="line"><a id="l04229" name="l04229"></a><span class="lineno"> 4229</span>      -&gt;findOneBy([ <span class="stringliteral">&#39;tag&#39;</span> =&gt; $templateName ]);</div>
<div class="line"><a id="l04230" name="l04230"></a><span class="lineno"> 4230</span>    <span class="keywordflow">if</span> (empty($template)) {</div>
<div class="line"><a id="l04231" name="l04231"></a><span class="lineno"> 4231</span>      $template = Entities\EmailTemplate::create();</div>
<div class="line"><a id="l04232" name="l04232"></a><span class="lineno"> 4232</span>    }</div>
<div class="line"><a id="l04233" name="l04233"></a><span class="lineno"> 4233</span>    $template-&gt;setTag($templateName)</div>
<div class="line"><a id="l04234" name="l04234"></a><span class="lineno"> 4234</span>      -&gt;setSubject($subject)</div>
<div class="line"><a id="l04235" name="l04235"></a><span class="lineno"> 4235</span>      -&gt;setContents($contents);</div>
<div class="line"><a id="l04236" name="l04236"></a><span class="lineno"> 4236</span>    $this-&gt;persist($template); <span class="comment">// could probably moved into the empty() if clause above.</span></div>
<div class="line"><a id="l04237" name="l04237"></a><span class="lineno"> 4237</span>    $this-&gt;flush();</div>
<div class="line"><a id="l04238" name="l04238"></a><span class="lineno"> 4238</span>  }</div>
<div class="line"><a id="l04239" name="l04239"></a><span class="lineno"> 4239</span> </div>
<div class="line"><a id="l04245" name="l04245"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a79652808b8c32f885da0e02c13dff113"> 4245</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a79652808b8c32f885da0e02c13dff113">deleteTemplate</a>(<span class="keywordtype">string</span> $templateName):void</div>
<div class="line"><a id="l04246" name="l04246"></a><span class="lineno"> 4246</span>  {</div>
<div class="line"><a id="l04247" name="l04247"></a><span class="lineno"> 4247</span>    $template = $this</div>
<div class="line"><a id="l04248" name="l04248"></a><span class="lineno"> 4248</span>      -&gt;getDatabaseRepository(Entities\EmailTemplate::class)</div>
<div class="line"><a id="l04249" name="l04249"></a><span class="lineno"> 4249</span>      -&gt;findOneBy([ <span class="stringliteral">&#39;tag&#39;</span> =&gt; $templateName ]);</div>
<div class="line"><a id="l04250" name="l04250"></a><span class="lineno"> 4250</span>    <span class="keywordflow">if</span> (!empty($template)) {</div>
<div class="line"><a id="l04251" name="l04251"></a><span class="lineno"> 4251</span>      $this-&gt;<span class="keyword">remove</span>($template, <span class="keyword">true</span>);</div>
<div class="line"><a id="l04252" name="l04252"></a><span class="lineno"> 4252</span>    }</div>
<div class="line"><a id="l04253" name="l04253"></a><span class="lineno"> 4253</span>  }</div>
<div class="line"><a id="l04254" name="l04254"></a><span class="lineno"> 4254</span> </div>
<div class="line"><a id="l04260" name="l04260"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a82ee6dc3fe4830272788180d197340fd"> 4260</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a82ee6dc3fe4830272788180d197340fd">loadTemplate</a>(<span class="keywordtype">string</span> $templateIdentifier):bool</div>
<div class="line"><a id="l04261" name="l04261"></a><span class="lineno"> 4261</span>  {</div>
<div class="line"><a id="l04262" name="l04262"></a><span class="lineno"> 4262</span>    $template = $this-&gt;fetchTemplate($templateIdentifier);</div>
<div class="line"><a id="l04263" name="l04263"></a><span class="lineno"> 4263</span>    <span class="keywordflow">if</span> (empty($template)) {</div>
<div class="line"><a id="l04264" name="l04264"></a><span class="lineno"> 4264</span>      <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04265" name="l04265"></a><span class="lineno"> 4265</span>    }</div>
<div class="line"><a id="l04266" name="l04266"></a><span class="lineno"> 4266</span>    $this-&gt;templateName = $template-&gt;getTag();</div>
<div class="line"><a id="l04267" name="l04267"></a><span class="lineno"> 4267</span>    $this-&gt;messageContents = $template-&gt;getContents();</div>
<div class="line"><a id="l04268" name="l04268"></a><span class="lineno"> 4268</span>    $this-&gt;draftId = 0; <span class="comment">// avoid accidental overwriting</span></div>
<div class="line"><a id="l04269" name="l04269"></a><span class="lineno"> 4269</span> </div>
<div class="line"><a id="l04270" name="l04270"></a><span class="lineno"> 4270</span>    <span class="comment">// clear references, as this is a new shot</span></div>
<div class="line"><a id="l04271" name="l04271"></a><span class="lineno"> 4271</span>    $this-&gt;inReplyToId = $this-&gt;cgiData[<span class="stringliteral">&#39;inReplyTo&#39;</span>] = <span class="keyword">null</span>;</div>
<div class="line"><a id="l04272" name="l04272"></a><span class="lineno"> 4272</span>    $this-&gt;referencing = $this-&gt;cgiData[<span class="stringliteral">&#39;referencing&#39;</span>] = [];</div>
<div class="line"><a id="l04273" name="l04273"></a><span class="lineno"> 4273</span> </div>
<div class="line"><a id="l04274" name="l04274"></a><span class="lineno"> 4274</span>    <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">true</span>;</div>
<div class="line"><a id="l04275" name="l04275"></a><span class="lineno"> 4275</span>  }</div>
<div class="line"><a id="l04276" name="l04276"></a><span class="lineno"> 4276</span> </div>
<div class="line"><a id="l04287" name="l04287"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a28c3e766ec95a8d1201a7dc1c857b0b3"> 4287</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a28c3e766ec95a8d1201a7dc1c857b0b3">normalizeTemplateName</a>(<span class="keywordtype">string</span> $templateName):array</div>
<div class="line"><a id="l04288" name="l04288"></a><span class="lineno"> 4288</span>  {</div>
<div class="line"><a id="l04289" name="l04289"></a><span class="lineno"> 4289</span>    $normalizedName = Util::dashesToCamelCase(</div>
<div class="line"><a id="l04290" name="l04290"></a><span class="lineno"> 4290</span>      Util::normalizeSpaces($templateName), <span class="keyword">true</span>, <span class="stringliteral">&#39;_- &#39;</span>);</div>
<div class="line"><a id="l04291" name="l04291"></a><span class="lineno"> 4291</span>    $result = [ $normalizedName ];</div>
<div class="line"><a id="l04292" name="l04292"></a><span class="lineno"> 4292</span>    $translation = (string)$this-&gt;l-&gt;t($normalizedName);</div>
<div class="line"><a id="l04293" name="l04293"></a><span class="lineno"> 4293</span>    <span class="keywordflow">if</span> ($translation != $normalizedName) {</div>
<div class="line"><a id="l04294" name="l04294"></a><span class="lineno"> 4294</span>      array_unshift($result, $translation);</div>
<div class="line"><a id="l04295" name="l04295"></a><span class="lineno"> 4295</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l04296" name="l04296"></a><span class="lineno"> 4296</span>      $words = [];</div>
<div class="line"><a id="l04297" name="l04297"></a><span class="lineno"> 4297</span>      <span class="keywordflow">foreach</span> (explode(<span class="charliteral">&#39; &#39;</span>, Util::camelCaseToDashes($normalizedName, <span class="charliteral">&#39; &#39;</span>)) as $word) {</div>
<div class="line"><a id="l04298" name="l04298"></a><span class="lineno"> 4298</span>        $wordVariants = [</div>
<div class="line"><a id="l04299" name="l04299"></a><span class="lineno"> 4299</span>          $word,</div>
<div class="line"><a id="l04300" name="l04300"></a><span class="lineno"> 4300</span>          strtolower($word),</div>
<div class="line"><a id="l04301" name="l04301"></a><span class="lineno"> 4301</span>          ucfirst(strtolower($word)),</div>
<div class="line"><a id="l04302" name="l04302"></a><span class="lineno"> 4302</span>          strtoupper($word),</div>
<div class="line"><a id="l04303" name="l04303"></a><span class="lineno"> 4303</span>        ];</div>
<div class="line"><a id="l04304" name="l04304"></a><span class="lineno"> 4304</span>        $translatedWord = $word;</div>
<div class="line"><a id="l04305" name="l04305"></a><span class="lineno"> 4305</span>        <span class="keywordflow">foreach</span> ($wordVariants as $variant) {</div>
<div class="line"><a id="l04306" name="l04306"></a><span class="lineno"> 4306</span>          $translatedVariant = $this-&gt;l-&gt;t($variant);</div>
<div class="line"><a id="l04307" name="l04307"></a><span class="lineno"> 4307</span>          <span class="keywordflow">if</span> ($translatedVariant != $variant) {</div>
<div class="line"><a id="l04308" name="l04308"></a><span class="lineno"> 4308</span>            $translatedWord = $translatedVariant;</div>
<div class="line"><a id="l04309" name="l04309"></a><span class="lineno"> 4309</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l04310" name="l04310"></a><span class="lineno"> 4310</span>          }</div>
<div class="line"><a id="l04311" name="l04311"></a><span class="lineno"> 4311</span>        }</div>
<div class="line"><a id="l04312" name="l04312"></a><span class="lineno"> 4312</span>        $words[] = strtolower($this-&gt;transliterate($translatedWord));</div>
<div class="line"><a id="l04313" name="l04313"></a><span class="lineno"> 4313</span>      }</div>
<div class="line"><a id="l04314" name="l04314"></a><span class="lineno"> 4314</span>      <span class="keywordflow">if</span> (!empty($words)) {</div>
<div class="line"><a id="l04315" name="l04315"></a><span class="lineno"> 4315</span>        $translation = Util::dashesToCamelCase(implode(<span class="charliteral">&#39; &#39;</span>, $words), <span class="keyword">true</span>, <span class="charliteral">&#39; &#39;</span>);</div>
<div class="line"><a id="l04316" name="l04316"></a><span class="lineno"> 4316</span>        array_unshift($result, $translation);</div>
<div class="line"><a id="l04317" name="l04317"></a><span class="lineno"> 4317</span>      }</div>
<div class="line"><a id="l04318" name="l04318"></a><span class="lineno"> 4318</span>    }</div>
<div class="line"><a id="l04319" name="l04319"></a><span class="lineno"> 4319</span>    <span class="keywordflow">return</span> array_unique($result);</div>
<div class="line"><a id="l04320" name="l04320"></a><span class="lineno"> 4320</span>  }</div>
<div class="line"><a id="l04321" name="l04321"></a><span class="lineno"> 4321</span> </div>
<div class="line"><a id="l04335" name="l04335"></a><span class="lineno"> 4335</span>  <span class="keyword">private</span> <span class="keyword">function</span> fetchTemplate($templateIdentifier, <span class="keywordtype">bool</span> $exact = <span class="keyword">true</span>):?Entities\<a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_entities_1_1_email_template.html">EmailTemplate</a></div>
<div class="line"><a id="l04336" name="l04336"></a><span class="lineno"> 4336</span>  {</div>
<div class="line"><a id="l04337" name="l04337"></a><span class="lineno"> 4337</span>    <span class="keywordflow">if</span> (!($templateIdentifier instanceof Entities\<a class="code hl_class" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_entities_1_1_email_template.html">EmailTemplate</a>)) {</div>
<div class="line"><a id="l04338" name="l04338"></a><span class="lineno"> 4338</span>      <span class="keywordflow">if</span> (filter_var($templateIdentifier, FILTER_VALIDATE_INT) !== <span class="keyword">false</span>) {</div>
<div class="line"><a id="l04339" name="l04339"></a><span class="lineno"> 4339</span>        $template = $this</div>
<div class="line"><a id="l04340" name="l04340"></a><span class="lineno"> 4340</span>          -&gt;getDatabaseRepository(Entities\EmailTemplate::class)</div>
<div class="line"><a id="l04341" name="l04341"></a><span class="lineno"> 4341</span>          -&gt;find($templateIdentifier);</div>
<div class="line"><a id="l04342" name="l04342"></a><span class="lineno"> 4342</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l04343" name="l04343"></a><span class="lineno"> 4343</span>        $templateNames = $this-&gt;normalizeTemplateName($templateIdentifier);</div>
<div class="line"><a id="l04344" name="l04344"></a><span class="lineno"> 4344</span> </div>
<div class="line"><a id="l04345" name="l04345"></a><span class="lineno"> 4345</span>        <span class="keywordflow">if</span> (!$exact) {</div>
<div class="line"><a id="l04346" name="l04346"></a><span class="lineno"> 4346</span>          <span class="comment">// $templateNames = array_merge($templateNames, array_map(fn($name) =&gt; &#39;%-&#39; . $name, $templateNames));</span></div>
<div class="line"><a id="l04347" name="l04347"></a><span class="lineno"> 4347</span>          $templateNames = implode(<span class="charliteral">&#39;|&#39;</span>, array_map(fn($name) =&gt; <span class="stringliteral">&#39;([0-9]+-)?&#39;</span> . $name, $templateNames));</div>
<div class="line"><a id="l04348" name="l04348"></a><span class="lineno"> 4348</span>        }</div>
<div class="line"><a id="l04349" name="l04349"></a><span class="lineno"> 4349</span> </div>
<div class="line"><a id="l04351" name="l04351"></a><span class="lineno"> 4351</span>        $template = $this</div>
<div class="line"><a id="l04352" name="l04352"></a><span class="lineno"> 4352</span>          -&gt;getDatabaseRepository(Entities\EmailTemplate::class)</div>
<div class="line"><a id="l04353" name="l04353"></a><span class="lineno"> 4353</span>          -&gt;findOneBy(</div>
<div class="line"><a id="l04354" name="l04354"></a><span class="lineno"> 4354</span>            criteria: [</div>
<div class="line"><a id="l04355" name="l04355"></a><span class="lineno"> 4355</span>              <span class="comment">// Attention: DQL needs SINGLE quotes.</span></div>
<div class="line"><a id="l04356" name="l04356"></a><span class="lineno"> 4356</span>              <span class="stringliteral">&quot;tag#REGEXP(%s, &#39;^&quot;</span> . $templateNames . <span class="stringliteral">&quot;$&#39;)&quot;</span> =&gt; 1,</div>
<div class="line"><a id="l04357" name="l04357"></a><span class="lineno"> 4357</span>            ],</div>
<div class="line"><a id="l04358" name="l04358"></a><span class="lineno"> 4358</span>            orderBy: [</div>
<div class="line"><a id="l04359" name="l04359"></a><span class="lineno"> 4359</span>              <span class="stringliteral">&#39;tag&#39;</span> =&gt; <span class="stringliteral">&#39;ASC&#39;</span>,</div>
<div class="line"><a id="l04360" name="l04360"></a><span class="lineno"> 4360</span>            ],</div>
<div class="line"><a id="l04361" name="l04361"></a><span class="lineno"> 4361</span>          );</div>
<div class="line"><a id="l04362" name="l04362"></a><span class="lineno"> 4362</span>      }</div>
<div class="line"><a id="l04363" name="l04363"></a><span class="lineno"> 4363</span>    }</div>
<div class="line"><a id="l04364" name="l04364"></a><span class="lineno"> 4364</span> </div>
<div class="line"><a id="l04365" name="l04365"></a><span class="lineno"> 4365</span>    <span class="keywordflow">if</span> (empty($template)) {</div>
<div class="line"><a id="l04366" name="l04366"></a><span class="lineno"> 4366</span>      <span class="keywordflow">return</span> <span class="keyword">null</span>;</div>
<div class="line"><a id="l04367" name="l04367"></a><span class="lineno"> 4367</span>    }</div>
<div class="line"><a id="l04368" name="l04368"></a><span class="lineno"> 4368</span> </div>
<div class="line"><a id="l04369" name="l04369"></a><span class="lineno"> 4369</span>    $templateName = $template-&gt;getTag();</div>
<div class="line"><a id="l04370" name="l04370"></a><span class="lineno"> 4370</span> </div>
<div class="line"><a id="l04371" name="l04371"></a><span class="lineno"> 4371</span>    <span class="keywordflow">if</span> ($templateName !== self::DEFAULT_TEMPLATE_NAME &amp;&amp; !empty($template[<span class="stringliteral">&#39;subject&#39;</span>])) {</div>
<div class="line"><a id="l04372" name="l04372"></a><span class="lineno"> 4372</span>      $this-&gt;cgiData[<span class="stringliteral">&#39;subject&#39;</span>] = $template[<span class="stringliteral">&#39;subject&#39;</span>];</div>
<div class="line"><a id="l04373" name="l04373"></a><span class="lineno"> 4373</span>    }</div>
<div class="line"><a id="l04374" name="l04374"></a><span class="lineno"> 4374</span> </div>
<div class="line"><a id="l04375" name="l04375"></a><span class="lineno"> 4375</span>    <span class="keywordflow">return</span> $template;</div>
<div class="line"><a id="l04376" name="l04376"></a><span class="lineno"> 4376</span>  }</div>
<div class="line"><a id="l04377" name="l04377"></a><span class="lineno"> 4377</span> </div>
<div class="line"><a id="l04379" name="l04379"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a771ab1f79b7a4747ccd2ff0a69164a43"> 4379</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a771ab1f79b7a4747ccd2ff0a69164a43">fetchTemplatesList</a>():array</div>
<div class="line"><a id="l04380" name="l04380"></a><span class="lineno"> 4380</span>  {</div>
<div class="line"><a id="l04381" name="l04381"></a><span class="lineno"> 4381</span>    <span class="keywordflow">return</span> $this-&gt;getDatabaseRepository(Entities\EmailTemplate::class)-&gt;list();</div>
<div class="line"><a id="l04382" name="l04382"></a><span class="lineno"> 4382</span>  }</div>
<div class="line"><a id="l04383" name="l04383"></a><span class="lineno"> 4383</span> </div>
<div class="line"><a id="l04390" name="l04390"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8c51518ac57ca5c9bdf846051ac17f0a"> 4390</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8c51518ac57ca5c9bdf846051ac17f0a">fetchDraftsList</a>():array</div>
<div class="line"><a id="l04391" name="l04391"></a><span class="lineno"> 4391</span>  {</div>
<div class="line"><a id="l04392" name="l04392"></a><span class="lineno"> 4392</span>    <span class="keywordflow">return</span> $this-&gt;getDatabaseRepository(Entities\EmailDraft::class)-&gt;list();</div>
<div class="line"><a id="l04393" name="l04393"></a><span class="lineno"> 4393</span>  }</div>
<div class="line"><a id="l04394" name="l04394"></a><span class="lineno"> 4394</span> </div>
<div class="line"><a id="l04399" name="l04399"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a2d844a225351b80afb7da14fee0e6edc"> 4399</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a2d844a225351b80afb7da14fee0e6edc">fetchSentEmailsList</a>()</div>
<div class="line"><a id="l04400" name="l04400"></a><span class="lineno"> 4400</span>  {</div>
<div class="line"><a id="l04401" name="l04401"></a><span class="lineno"> 4401</span>    <span class="keywordflow">return</span> $this-&gt;getDatabaseRepository(Entities\SentEmail::class)-&gt;findBy([</div>
<div class="line"><a id="l04402" name="l04402"></a><span class="lineno"> 4402</span>      <span class="stringliteral">&#39;project&#39;</span> =&gt; $this-&gt;project</div>
<div class="line"><a id="l04403" name="l04403"></a><span class="lineno"> 4403</span>    ], [</div>
<div class="line"><a id="l04404" name="l04404"></a><span class="lineno"> 4404</span>      <span class="stringliteral">&#39;created&#39;</span> =&gt; <span class="stringliteral">&#39;DESC&#39;</span>,</div>
<div class="line"><a id="l04405" name="l04405"></a><span class="lineno"> 4405</span>    ]);</div>
<div class="line"><a id="l04406" name="l04406"></a><span class="lineno"> 4406</span>  }</div>
<div class="line"><a id="l04407" name="l04407"></a><span class="lineno"> 4407</span> </div>
<div class="line"><a id="l04415" name="l04415"></a><span class="lineno"> 4415</span>  <span class="keyword">public</span> <span class="keyword">function</span> storeDraft():bool</div>
<div class="line"><a id="l04416" name="l04416"></a><span class="lineno"> 4416</span>  {</div>
<div class="line"><a id="l04417" name="l04417"></a><span class="lineno"> 4417</span>    <span class="keywordflow">if</span> ($this-&gt;subject() == <span class="stringliteral">&#39;&#39;</span>) {</div>
<div class="line"><a id="l04418" name="l04418"></a><span class="lineno"> 4418</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_SUBJECT_VALIDATION] = $this-&gt;messageTag;</div>
<div class="line"><a id="l04419" name="l04419"></a><span class="lineno"> 4419</span>      <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04420" name="l04420"></a><span class="lineno"> 4420</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l04421" name="l04421"></a><span class="lineno"> 4421</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_SUBJECT_VALIDATION] = <span class="keyword">true</span>;</div>
<div class="line"><a id="l04422" name="l04422"></a><span class="lineno"> 4422</span>    }</div>
<div class="line"><a id="l04423" name="l04423"></a><span class="lineno"> 4423</span> </div>
<div class="line"><a id="l04424" name="l04424"></a><span class="lineno"> 4424</span>    <span class="comment">// autoSave is the flag programmatically submitted by the ajax-call,</span></div>
<div class="line"><a id="l04425" name="l04425"></a><span class="lineno"> 4425</span>    <span class="comment">// draftAutoSave is that state of the auto-save enable button.</span></div>
<div class="line"><a id="l04426" name="l04426"></a><span class="lineno"> 4426</span>    $autoSave = $this-&gt;parameterService[self::POST_TAG][<span class="stringliteral">&#39;autoSave&#39;</span>] ?? <span class="keyword">null</span>;</div>
<div class="line"><a id="l04427" name="l04427"></a><span class="lineno"> 4427</span>    <span class="keywordflow">if</span> ($autoSave === <span class="keyword">null</span>) {</div>
<div class="line"><a id="l04428" name="l04428"></a><span class="lineno"> 4428</span>      $autoSave = $this-&gt;parameterService[self::POST_TAG][<span class="stringliteral">&#39;draftAutoSave&#39;</span>] ?? <span class="keyword">false</span>;</div>
<div class="line"><a id="l04429" name="l04429"></a><span class="lineno"> 4429</span>    }</div>
<div class="line"><a id="l04430" name="l04430"></a><span class="lineno"> 4430</span>    $autoSave = filter_var($autoSave, FILTER_VALIDATE_BOOLEAN);</div>
<div class="line"><a id="l04431" name="l04431"></a><span class="lineno"> 4431</span> </div>
<div class="line"><a id="l04432" name="l04432"></a><span class="lineno"> 4432</span>    $draftData = [</div>
<div class="line"><a id="l04433" name="l04433"></a><span class="lineno"> 4433</span>      <span class="stringliteral">&#39;projectId&#39;</span> =&gt; $this-&gt;parameterService[<span class="stringliteral">&#39;projectId&#39;</span>],</div>
<div class="line"><a id="l04434" name="l04434"></a><span class="lineno"> 4434</span>      <span class="stringliteral">&#39;projectName&#39;</span> =&gt; $this-&gt;parameterService[<span class="stringliteral">&#39;projectName&#39;</span>],</div>
<div class="line"><a id="l04435" name="l04435"></a><span class="lineno"> 4435</span>      <span class="stringliteral">&#39;bulkTransactionId&#39;</span> =&gt; $this-&gt;parameterService[<span class="stringliteral">&#39;bulkTransactionId&#39;</span>],</div>
<div class="line"><a id="l04436" name="l04436"></a><span class="lineno"> 4436</span>      self::POST_TAG =&gt; $this-&gt;parameterService[self::POST_TAG],</div>
<div class="line"><a id="l04437" name="l04437"></a><span class="lineno"> 4437</span>      RecipientsFilter::POST_TAG =&gt; $this-&gt;parameterService[RecipientsFilter::POST_TAG],</div>
<div class="line"><a id="l04438" name="l04438"></a><span class="lineno"> 4438</span>    ];</div>
<div class="line"><a id="l04439" name="l04439"></a><span class="lineno"> 4439</span> </div>
<div class="line"><a id="l04440" name="l04440"></a><span class="lineno"> 4440</span>    unset($draftData[self::POST_TAG][<span class="stringliteral">&#39;request&#39;</span>]);</div>
<div class="line"><a id="l04441" name="l04441"></a><span class="lineno"> 4441</span>    unset($draftData[self::POST_TAG][<span class="stringliteral">&#39;submitAll&#39;</span>]);</div>
<div class="line"><a id="l04442" name="l04442"></a><span class="lineno"> 4442</span>    unset($draftData[self::POST_TAG][<span class="stringliteral">&#39;saveMessage&#39;</span>]);</div>
<div class="line"><a id="l04443" name="l04443"></a><span class="lineno"> 4443</span>    unset($draftData[self::POST_TAG][<span class="stringliteral">&#39;draftAutoSave&#39;</span>]);</div>
<div class="line"><a id="l04444" name="l04444"></a><span class="lineno"> 4444</span> </div>
<div class="line"><a id="l04445" name="l04445"></a><span class="lineno"> 4445</span>    <span class="comment">// $dataJSON = json_encode($draftData);</span></div>
<div class="line"><a id="l04446" name="l04446"></a><span class="lineno"> 4446</span>    $subject = $this-&gt;subjectTag() . <span class="charliteral">&#39; &#39;</span> . $this-&gt;subject();</div>
<div class="line"><a id="l04447" name="l04447"></a><span class="lineno"> 4447</span> </div>
<div class="line"><a id="l04450" name="l04450"></a><span class="lineno"> 4450</span>    <span class="keywordflow">if</span> ($this-&gt;draftId &gt; 0) {</div>
<div class="line"><a id="l04451" name="l04451"></a><span class="lineno"> 4451</span>      $draft = $this-&gt;getDatabaseRepository(Entities\EmailDraft::class)</div>
<div class="line"><a id="l04452" name="l04452"></a><span class="lineno"> 4452</span>                    -&gt;find($this-&gt;draftId);</div>
<div class="line"><a id="l04453" name="l04453"></a><span class="lineno"> 4453</span>      <span class="keywordflow">if</span> (!empty($draft)) {</div>
<div class="line"><a id="l04454" name="l04454"></a><span class="lineno"> 4454</span>        $draft-&gt;setSubject($subject)</div>
<div class="line"><a id="l04455" name="l04455"></a><span class="lineno"> 4455</span>          -&gt;setData($draftData)</div>
<div class="line"><a id="l04456" name="l04456"></a><span class="lineno"> 4456</span>          -&gt;setAutoGenerated($draft-&gt;getAutoGenerated() &amp;&amp; $autoSave);</div>
<div class="line"><a id="l04457" name="l04457"></a><span class="lineno"> 4457</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l04458" name="l04458"></a><span class="lineno"> 4458</span>        $this-&gt;draftId = 0;</div>
<div class="line"><a id="l04459" name="l04459"></a><span class="lineno"> 4459</span>      }</div>
<div class="line"><a id="l04460" name="l04460"></a><span class="lineno"> 4460</span>    }</div>
<div class="line"><a id="l04461" name="l04461"></a><span class="lineno"> 4461</span>    <span class="keywordflow">if</span> (empty($draft)) {</div>
<div class="line"><a id="l04462" name="l04462"></a><span class="lineno"> 4462</span>      $draft = Entities\EmailDraft::create()</div>
<div class="line"><a id="l04463" name="l04463"></a><span class="lineno"> 4463</span>        -&gt;setSubject($subject)</div>
<div class="line"><a id="l04464" name="l04464"></a><span class="lineno"> 4464</span>        -&gt;setData($draftData)</div>
<div class="line"><a id="l04465" name="l04465"></a><span class="lineno"> 4465</span>        -&gt;setAutoGenerated($autoSave);</div>
<div class="line"><a id="l04466" name="l04466"></a><span class="lineno"> 4466</span>      $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a8e9e0e801f3bc1dd0ba6575643dc4704">persist</a>($draft);</div>
<div class="line"><a id="l04467" name="l04467"></a><span class="lineno"> 4467</span>    }</div>
<div class="line"><a id="l04468" name="l04468"></a><span class="lineno"> 4468</span>    $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#ad9f7964d2ea3ec421dd166a41e4ff17d">flush</a>();</div>
<div class="line"><a id="l04469" name="l04469"></a><span class="lineno"> 4469</span>    $this-&gt;draftId = $draft-&gt;getId();</div>
<div class="line"><a id="l04470" name="l04470"></a><span class="lineno"> 4470</span> </div>
<div class="line"><a id="l04471" name="l04471"></a><span class="lineno"> 4471</span>    <span class="comment">// Update the list of attachments, if any</span></div>
<div class="line"><a id="l04472" name="l04472"></a><span class="lineno"> 4472</span>    <span class="keywordflow">foreach</span> ($this-&gt;fileAttachments() as $attachment) {</div>
<div class="line"><a id="l04473" name="l04473"></a><span class="lineno"> 4473</span>      $this-&gt;rememberTemporaryFile($attachment[<span class="stringliteral">&#39;tmp_name&#39;</span>], $attachment[<span class="stringliteral">&#39;origin&#39;</span>]);</div>
<div class="line"><a id="l04474" name="l04474"></a><span class="lineno"> 4474</span>    }</div>
<div class="line"><a id="l04475" name="l04475"></a><span class="lineno"> 4475</span> </div>
<div class="line"><a id="l04476" name="l04476"></a><span class="lineno"> 4476</span>    <span class="keywordflow">return</span> $this-&gt;executionStatus;</div>
<div class="line"><a id="l04477" name="l04477"></a><span class="lineno"> 4477</span>  }</div>
<div class="line"><a id="l04478" name="l04478"></a><span class="lineno"> 4478</span> </div>
<div class="line"><a id="l04487" name="l04487"></a><span class="lineno"> 4487</span>  <span class="keyword">public</span> <span class="keyword">function</span> loadDraft(?<span class="keywordtype">int</span> $draftId = <span class="keyword">null</span>)</div>
<div class="line"><a id="l04488" name="l04488"></a><span class="lineno"> 4488</span>  {</div>
<div class="line"><a id="l04489" name="l04489"></a><span class="lineno"> 4489</span>    <span class="keywordflow">if</span> ($draftId === <span class="keyword">null</span>) {</div>
<div class="line"><a id="l04490" name="l04490"></a><span class="lineno"> 4490</span>      $draftId = $this-&gt;draftId;</div>
<div class="line"><a id="l04491" name="l04491"></a><span class="lineno"> 4491</span>    }</div>
<div class="line"><a id="l04492" name="l04492"></a><span class="lineno"> 4492</span>    <span class="keywordflow">if</span> ($draftId &lt;= 0) {</div>
<div class="line"><a id="l04493" name="l04493"></a><span class="lineno"> 4493</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_CAPTION] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Unable to load draft without id&#39;</span>);</div>
<div class="line"><a id="l04494" name="l04494"></a><span class="lineno"> 4494</span>      <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04495" name="l04495"></a><span class="lineno"> 4495</span>    }</div>
<div class="line"><a id="l04496" name="l04496"></a><span class="lineno"> 4496</span> </div>
<div class="line"><a id="l04497" name="l04497"></a><span class="lineno"> 4497</span>    <span class="comment">// clear references, as this is a new shot</span></div>
<div class="line"><a id="l04498" name="l04498"></a><span class="lineno"> 4498</span>    $this-&gt;inReplyToId = $this-&gt;cgiData[<span class="stringliteral">&#39;inReplyTo&#39;</span>] = <span class="keyword">null</span>;</div>
<div class="line"><a id="l04499" name="l04499"></a><span class="lineno"> 4499</span>    $this-&gt;referencing = $this-&gt;cgiData[<span class="stringliteral">&#39;referencing&#39;</span>] = [];</div>
<div class="line"><a id="l04500" name="l04500"></a><span class="lineno"> 4500</span> </div>
<div class="line"><a id="l04502" name="l04502"></a><span class="lineno"> 4502</span>    $draft = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#ab6f5f4edde190f5e5f1cd1e2fdd402d4">getDatabaseRepository</a>(Entities\EmailDraft::class)</div>
<div class="line"><a id="l04503" name="l04503"></a><span class="lineno"> 4503</span>      -&gt;find($draftId);</div>
<div class="line"><a id="l04504" name="l04504"></a><span class="lineno"> 4504</span>    <span class="keywordflow">if</span> (empty($draft)) {</div>
<div class="line"><a id="l04505" name="l04505"></a><span class="lineno"> 4505</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_CAPTION] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Draft %s could not be loaded&#39;</span>, $draftId);</div>
<div class="line"><a id="l04506" name="l04506"></a><span class="lineno"> 4506</span>      <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04507" name="l04507"></a><span class="lineno"> 4507</span>    }</div>
<div class="line"><a id="l04508" name="l04508"></a><span class="lineno"> 4508</span> </div>
<div class="line"><a id="l04509" name="l04509"></a><span class="lineno"> 4509</span>    $draftData = $draft-&gt;getData();</div>
<div class="line"><a id="l04510" name="l04510"></a><span class="lineno"> 4510</span> </div>
<div class="line"><a id="l04511" name="l04511"></a><span class="lineno"> 4511</span>    <span class="comment">// undo request actions</span></div>
<div class="line"><a id="l04512" name="l04512"></a><span class="lineno"> 4512</span>    unset($draftData[self::POST_TAG][<span class="stringliteral">&#39;request&#39;</span>]);</div>
<div class="line"><a id="l04513" name="l04513"></a><span class="lineno"> 4513</span>    unset($draftData[self::POST_TAG][<span class="stringliteral">&#39;submitAll&#39;</span>]);</div>
<div class="line"><a id="l04514" name="l04514"></a><span class="lineno"> 4514</span>    unset($draftData[self::POST_TAG][<span class="stringliteral">&#39;saveMessage&#39;</span>]);</div>
<div class="line"><a id="l04515" name="l04515"></a><span class="lineno"> 4515</span> </div>
<div class="line"><a id="l04516" name="l04516"></a><span class="lineno"> 4516</span>    <span class="keywordflow">if</span> (empty($draftData[<span class="stringliteral">&#39;bulkTransactionId&#39;</span>])) {</div>
<div class="line"><a id="l04517" name="l04517"></a><span class="lineno"> 4517</span>      $draftData[<span class="stringliteral">&#39;bulkTransactionId&#39;</span>] = <span class="keyword">null</span>;</div>
<div class="line"><a id="l04518" name="l04518"></a><span class="lineno"> 4518</span>    }</div>
<div class="line"><a id="l04519" name="l04519"></a><span class="lineno"> 4519</span> </div>
<div class="line"><a id="l04520" name="l04520"></a><span class="lineno"> 4520</span>    $this-&gt;draftId = $draftId;</div>
<div class="line"><a id="l04521" name="l04521"></a><span class="lineno"> 4521</span> </div>
<div class="line"><a id="l04522" name="l04522"></a><span class="lineno"> 4522</span>    $this-&gt;executionStatus = <span class="keyword">true</span>;</div>
<div class="line"><a id="l04523" name="l04523"></a><span class="lineno"> 4523</span> </div>
<div class="line"><a id="l04524" name="l04524"></a><span class="lineno"> 4524</span>    <span class="comment">// Clear auto-flag once the draft was actively reviewed</span></div>
<div class="line"><a id="l04525" name="l04525"></a><span class="lineno"> 4525</span>    $draft-&gt;setAutoGenerated(<span class="keyword">false</span>);</div>
<div class="line"><a id="l04526" name="l04526"></a><span class="lineno"> 4526</span>    <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l04527" name="l04527"></a><span class="lineno"> 4527</span>      $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#ad9f7964d2ea3ec421dd166a41e4ff17d">flush</a>();</div>
<div class="line"><a id="l04528" name="l04528"></a><span class="lineno"> 4528</span>    } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l04529" name="l04529"></a><span class="lineno"> 4529</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_CAPTION] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Could not clear auto-generated flag of draft %s, &quot;%s&quot;.&#39;</span>, [</div>
<div class="line"><a id="l04530" name="l04530"></a><span class="lineno"> 4530</span>        $draftId, $draft-&gt;getSubject(), ]);</div>
<div class="line"><a id="l04531" name="l04531"></a><span class="lineno"> 4531</span>      $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04532" name="l04532"></a><span class="lineno"> 4532</span>    }</div>
<div class="line"><a id="l04533" name="l04533"></a><span class="lineno"> 4533</span> </div>
<div class="line"><a id="l04534" name="l04534"></a><span class="lineno"> 4534</span>    <span class="keywordflow">return</span> $draftData;</div>
<div class="line"><a id="l04535" name="l04535"></a><span class="lineno"> 4535</span>  }</div>
<div class="line"><a id="l04536" name="l04536"></a><span class="lineno"> 4536</span> </div>
<div class="line"><a id="l04544" name="l04544"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a4dfa28837b25f75555b35e1fb69d6fc2"> 4544</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a4dfa28837b25f75555b35e1fb69d6fc2">deleteDraft</a>(?<span class="keywordtype">int</span> $draftId = <span class="keyword">null</span>):bool</div>
<div class="line"><a id="l04545" name="l04545"></a><span class="lineno"> 4545</span>  {</div>
<div class="line"><a id="l04546" name="l04546"></a><span class="lineno"> 4546</span>    $draftId = $draftId??$this-&gt;draftId;</div>
<div class="line"><a id="l04547" name="l04547"></a><span class="lineno"> 4547</span>    <span class="keywordflow">if</span> ($draftId &gt; 0) {</div>
<div class="line"><a id="l04548" name="l04548"></a><span class="lineno"> 4548</span>      <span class="comment">// detach any attachnments for later clean-up</span></div>
<div class="line"><a id="l04549" name="l04549"></a><span class="lineno"> 4549</span>      <span class="keywordflow">if</span> (!$this-&gt;detachTemporaryFiles($draftId)) {</div>
<div class="line"><a id="l04550" name="l04550"></a><span class="lineno"> 4550</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l04551" name="l04551"></a><span class="lineno"> 4551</span>      }</div>
<div class="line"><a id="l04552" name="l04552"></a><span class="lineno"> 4552</span> </div>
<div class="line"><a id="l04553" name="l04553"></a><span class="lineno"> 4553</span>      <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l04554" name="l04554"></a><span class="lineno"> 4554</span>        $this-&gt;setDatabaseRepository(Entities\EmailDraft::class);</div>
<div class="line"><a id="l04555" name="l04555"></a><span class="lineno"> 4555</span>        $this-&gt;<span class="keyword">remove</span>($draftId, <span class="keyword">true</span>);</div>
<div class="line"><a id="l04556" name="l04556"></a><span class="lineno"> 4556</span>      } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l04557" name="l04557"></a><span class="lineno"> 4557</span>        $this-&gt;entityManager-&gt;reopen();</div>
<div class="line"><a id="l04558" name="l04558"></a><span class="lineno"> 4558</span>        $this-&gt;logException($t);</div>
<div class="line"><a id="l04559" name="l04559"></a><span class="lineno"> 4559</span>        $this-&gt;diagnostics[self::DIAGNOSTICS_CAPTION] = $this-&gt;l-&gt;t(</div>
<div class="line"><a id="l04560" name="l04560"></a><span class="lineno"> 4560</span>          <span class="stringliteral">&#39;Deleting draft with id %d failed: %s&#39;</span>,</div>
<div class="line"><a id="l04561" name="l04561"></a><span class="lineno"> 4561</span>          [ $this-&gt;draftId, $t-&gt;getMessage() ]);</div>
<div class="line"><a id="l04562" name="l04562"></a><span class="lineno"> 4562</span>        <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04563" name="l04563"></a><span class="lineno"> 4563</span>      }</div>
<div class="line"><a id="l04564" name="l04564"></a><span class="lineno"> 4564</span> </div>
<div class="line"><a id="l04565" name="l04565"></a><span class="lineno"> 4565</span>      <span class="comment">// Mark as gone</span></div>
<div class="line"><a id="l04566" name="l04566"></a><span class="lineno"> 4566</span>      <span class="keywordflow">if</span> ($draftId == $this-&gt;draftId) {</div>
<div class="line"><a id="l04567" name="l04567"></a><span class="lineno"> 4567</span>        $this-&gt;draftId = -1;</div>
<div class="line"><a id="l04568" name="l04568"></a><span class="lineno"> 4568</span>      }</div>
<div class="line"><a id="l04569" name="l04569"></a><span class="lineno"> 4569</span>    }</div>
<div class="line"><a id="l04570" name="l04570"></a><span class="lineno"> 4570</span>    <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">true</span>;</div>
<div class="line"><a id="l04571" name="l04571"></a><span class="lineno"> 4571</span>  }</div>
<div class="line"><a id="l04572" name="l04572"></a><span class="lineno"> 4572</span> </div>
<div class="line"><a id="l04583" name="l04583"></a><span class="lineno"> 4583</span>  <span class="keyword">public</span> <span class="keyword">function</span> cleanDrafts(<span class="keywordtype">int</span> $age = 60*60*24):void</div>
<div class="line"><a id="l04584" name="l04584"></a><span class="lineno"> 4584</span>  {</div>
<div class="line"><a id="l04585" name="l04585"></a><span class="lineno"> 4585</span>    $updatedTime = (<span class="keyword">new</span> DateTimeImmutable)</div>
<div class="line"><a id="l04586" name="l04586"></a><span class="lineno"> 4586</span>      -&gt;modify(<span class="charliteral">&#39;-&#39;</span> . $age . <span class="stringliteral">&#39; seconds&#39;</span>)</div>
<div class="line"><a id="l04587" name="l04587"></a><span class="lineno"> 4587</span>      -&gt;setTimezone($this-&gt;getDateTimeZone());</div>
<div class="line"><a id="l04588" name="l04588"></a><span class="lineno"> 4588</span>    $autoGeneratedDrafts = $this-&gt;getDatabaseRepository(Entities\EmailDraft::class)-&gt;findBy([</div>
<div class="line"><a id="l04589" name="l04589"></a><span class="lineno"> 4589</span>      <span class="stringliteral">&#39;autoGenerated&#39;</span> =&gt; <span class="keyword">true</span>,</div>
<div class="line"><a id="l04590" name="l04590"></a><span class="lineno"> 4590</span>      <span class="stringliteral">&#39;&lt;updated&#39;</span> =&gt; $updatedTime,</div>
<div class="line"><a id="l04591" name="l04591"></a><span class="lineno"> 4591</span>    ]);</div>
<div class="line"><a id="l04593" name="l04593"></a><span class="lineno"> 4593</span>    <span class="keywordflow">foreach</span> ($autoGeneratedDrafts as $draft) {</div>
<div class="line"><a id="l04594" name="l04594"></a><span class="lineno"> 4594</span>      $this-&gt;logInfo(<span class="stringliteral">&#39;Cleaning draft with id &#39;</span> . $draft-&gt;getId());</div>
<div class="line"><a id="l04595" name="l04595"></a><span class="lineno"> 4595</span>      $this-&gt;deleteDraft($draft-&gt;getId());</div>
<div class="line"><a id="l04596" name="l04596"></a><span class="lineno"> 4596</span>    }</div>
<div class="line"><a id="l04597" name="l04597"></a><span class="lineno"> 4597</span>  }</div>
<div class="line"><a id="l04598" name="l04598"></a><span class="lineno"> 4598</span> </div>
<div class="line"><a id="l04599" name="l04599"></a><span class="lineno"> 4599</span>  <span class="comment">// temporary file utilities</span></div>
<div class="line"><a id="l04600" name="l04600"></a><span class="lineno"> 4600</span> </div>
<div class="line"><a id="l04612" name="l04612"></a><span class="lineno"> 4612</span>  <span class="keyword">public</span> <span class="keyword">function</span> cleanTemporaries(array $fileAttach = []):bool</div>
<div class="line"><a id="l04613" name="l04613"></a><span class="lineno"> 4613</span>  {</div>
<div class="line"><a id="l04614" name="l04614"></a><span class="lineno"> 4614</span>    <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l04615" name="l04615"></a><span class="lineno"> 4615</span>      $tmpFiles = $this</div>
<div class="line"><a id="l04616" name="l04616"></a><span class="lineno"> 4616</span>        -&gt;getDatabaseRepository(Entities\EmailAttachment::class)</div>
<div class="line"><a id="l04617" name="l04617"></a><span class="lineno"> 4617</span>        -&gt;findBy([ <span class="stringliteral">&#39;draft&#39;</span> =&gt; <span class="keyword">null</span> ]);</div>
<div class="line"><a id="l04618" name="l04618"></a><span class="lineno"> 4618</span>    } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l04619" name="l04619"></a><span class="lineno"> 4619</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_CAPTION] = $this-&gt;l-&gt;t(</div>
<div class="line"><a id="l04620" name="l04620"></a><span class="lineno"> 4620</span>        <span class="stringliteral">&#39;Cleaning temporary files failed: %s&#39;</span>, $t-&gt;getMessage());</div>
<div class="line"><a id="l04621" name="l04621"></a><span class="lineno"> 4621</span>      <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04622" name="l04622"></a><span class="lineno"> 4622</span>    }</div>
<div class="line"><a id="l04623" name="l04623"></a><span class="lineno"> 4623</span> </div>
<div class="line"><a id="l04624" name="l04624"></a><span class="lineno"> 4624</span>    $toKeep = [];</div>
<div class="line"><a id="l04625" name="l04625"></a><span class="lineno"> 4625</span>    <span class="keywordflow">foreach</span> ($fileAttach as $files) {</div>
<div class="line"><a id="l04626" name="l04626"></a><span class="lineno"> 4626</span>      $tmp = basename($files[<span class="stringliteral">&#39;tmp_name&#39;</span>]);</div>
<div class="line"><a id="l04627" name="l04627"></a><span class="lineno"> 4627</span>      <span class="keywordflow">if</span> ($this-&gt;appStorage-&gt;draftExists($tmp)) {</div>
<div class="line"><a id="l04628" name="l04628"></a><span class="lineno"> 4628</span>        $toKeep[] = $tmp;</div>
<div class="line"><a id="l04629" name="l04629"></a><span class="lineno"> 4629</span>      }</div>
<div class="line"><a id="l04630" name="l04630"></a><span class="lineno"> 4630</span>    }</div>
<div class="line"><a id="l04631" name="l04631"></a><span class="lineno"> 4631</span> </div>
<div class="line"><a id="l04633" name="l04633"></a><span class="lineno"> 4633</span>    <span class="keywordflow">foreach</span> ($tmpFiles as $tmpFile) {</div>
<div class="line"><a id="l04634" name="l04634"></a><span class="lineno"> 4634</span>      $fileName = $tmpFile-&gt;getFileName();</div>
<div class="line"><a id="l04635" name="l04635"></a><span class="lineno"> 4635</span>      <span class="keywordflow">if</span> (array_search($fileName, $toKeep) !== <span class="keyword">false</span>) {</div>
<div class="line"><a id="l04636" name="l04636"></a><span class="lineno"> 4636</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l04637" name="l04637"></a><span class="lineno"> 4637</span>      }</div>
<div class="line"><a id="l04638" name="l04638"></a><span class="lineno"> 4638</span>      <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l04639" name="l04639"></a><span class="lineno"> 4639</span>        $file = $this-&gt;appStorage-&gt;getDraftsFile($fileName);</div>
<div class="line"><a id="l04640" name="l04640"></a><span class="lineno"> 4640</span>        <span class="keywordflow">if</span> (!empty($file)) {</div>
<div class="line"><a id="l04641" name="l04641"></a><span class="lineno"> 4641</span>          $file-&gt;delete();</div>
<div class="line"><a id="l04642" name="l04642"></a><span class="lineno"> 4642</span>          $file = <span class="keyword">null</span>;</div>
<div class="line"><a id="l04643" name="l04643"></a><span class="lineno"> 4643</span>        }</div>
<div class="line"><a id="l04644" name="l04644"></a><span class="lineno"> 4644</span>      } <span class="keywordflow">catch</span> (\OCP\Files\NotFoundException $e) {</div>
<div class="line"><a id="l04645" name="l04645"></a><span class="lineno"> 4645</span>        <span class="comment">// this is ok, we just wanted to delete it anyway</span></div>
<div class="line"><a id="l04646" name="l04646"></a><span class="lineno"> 4646</span>        $file = <span class="keyword">null</span>;</div>
<div class="line"><a id="l04647" name="l04647"></a><span class="lineno"> 4647</span>      }</div>
<div class="line"><a id="l04648" name="l04648"></a><span class="lineno"> 4648</span>      <span class="keywordflow">if</span> (empty($file)) {</div>
<div class="line"><a id="l04649" name="l04649"></a><span class="lineno"> 4649</span>        <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l04650" name="l04650"></a><span class="lineno"> 4650</span>          $this-&gt;forgetTemporaryFile($fileName);</div>
<div class="line"><a id="l04651" name="l04651"></a><span class="lineno"> 4651</span>        } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l04652" name="l04652"></a><span class="lineno"> 4652</span>          $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a6d05693fe567b9d34daf71eb6c8aecb4">logException</a>($t, <span class="stringliteral">&#39;Unable to remove temporary file.&#39;</span>);</div>
<div class="line"><a id="l04653" name="l04653"></a><span class="lineno"> 4653</span>        }</div>
<div class="line"><a id="l04654" name="l04654"></a><span class="lineno"> 4654</span>      }</div>
<div class="line"><a id="l04655" name="l04655"></a><span class="lineno"> 4655</span>    }</div>
<div class="line"><a id="l04656" name="l04656"></a><span class="lineno"> 4656</span>    $this-&gt;diagnostics[self::DIAGNOSTICS_CAPTION] = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Cleaning temporary files succeeded.&#39;</span>);</div>
<div class="line"><a id="l04657" name="l04657"></a><span class="lineno"> 4657</span>    <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">true</span>;</div>
<div class="line"><a id="l04658" name="l04658"></a><span class="lineno"> 4658</span>  }</div>
<div class="line"><a id="l04659" name="l04659"></a><span class="lineno"> 4659</span> </div>
<div class="line"><a id="l04667" name="l04667"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ab1086dcea02fd293a5b40f89c685f1af"> 4667</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ab1086dcea02fd293a5b40f89c685f1af">detachTemporaryFiles</a>(<span class="keywordtype">int</span> $draftId)</div>
<div class="line"><a id="l04668" name="l04668"></a><span class="lineno"> 4668</span>  {</div>
<div class="line"><a id="l04669" name="l04669"></a><span class="lineno"> 4669</span>    <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l04670" name="l04670"></a><span class="lineno"> 4670</span>      $this-&gt;queryBuilder()</div>
<div class="line"><a id="l04671" name="l04671"></a><span class="lineno"> 4671</span>           -&gt;update(Entities\EmailAttachment::class, <span class="stringliteral">&#39;ea&#39;</span>)</div>
<div class="line"><a id="l04672" name="l04672"></a><span class="lineno"> 4672</span>           -&gt;set(<span class="stringliteral">&#39;ea.draft&#39;</span>, <span class="stringliteral">&#39;null&#39;</span>)</div>
<div class="line"><a id="l04673" name="l04673"></a><span class="lineno"> 4673</span>           -&gt;where($this-&gt;expr()-&gt;eq(<span class="stringliteral">&#39;ea.draft&#39;</span>, <span class="stringliteral">&#39;:id&#39;</span>))</div>
<div class="line"><a id="l04674" name="l04674"></a><span class="lineno"> 4674</span>           -&gt;setParameter(<span class="stringliteral">&#39;id&#39;</span>, $draftId)</div>
<div class="line"><a id="l04675" name="l04675"></a><span class="lineno"> 4675</span>           -&gt;getQuery()</div>
<div class="line"><a id="l04676" name="l04676"></a><span class="lineno"> 4676</span>           -&gt;execute();</div>
<div class="line"><a id="l04677" name="l04677"></a><span class="lineno"> 4677</span>      $this-&gt;flush();</div>
<div class="line"><a id="l04678" name="l04678"></a><span class="lineno"> 4678</span>    } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l04679" name="l04679"></a><span class="lineno"> 4679</span>      $this-&gt;logException($t);</div>
<div class="line"><a id="l04680" name="l04680"></a><span class="lineno"> 4680</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_CAPTION] = $this-&gt;l-&gt;t(</div>
<div class="line"><a id="l04681" name="l04681"></a><span class="lineno"> 4681</span>        <span class="stringliteral">&#39;Detaching temporary file attachments from draft %d failed: %s&#39;</span>,</div>
<div class="line"><a id="l04682" name="l04682"></a><span class="lineno"> 4682</span>        [ $this-&gt;draftId, $t-&gt;getMessage() ]);</div>
<div class="line"><a id="l04683" name="l04683"></a><span class="lineno"> 4683</span>      <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04684" name="l04684"></a><span class="lineno"> 4684</span>    }</div>
<div class="line"><a id="l04685" name="l04685"></a><span class="lineno"> 4685</span>    <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">true</span>;</div>
<div class="line"><a id="l04686" name="l04686"></a><span class="lineno"> 4686</span>  }</div>
<div class="line"><a id="l04687" name="l04687"></a><span class="lineno"> 4687</span> </div>
<div class="line"><a id="l04699" name="l04699"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a5764bbb364eac41ce21eeeec75f64e1b"> 4699</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a5764bbb364eac41ce21eeeec75f64e1b">rememberTemporaryFile</a>(<span class="keywordtype">string</span> $tmpFile, mixed $origin):bool</div>
<div class="line"><a id="l04700" name="l04700"></a><span class="lineno"> 4700</span>  {</div>
<div class="line"><a id="l04701" name="l04701"></a><span class="lineno"> 4701</span>    <span class="keywordflow">if</span> ($origin == AttachmentOrigin::PARTICIPANT_FIELD) {</div>
<div class="line"><a id="l04702" name="l04702"></a><span class="lineno"> 4702</span>      <span class="comment">// no need to save, we just need the field-id which is stored anyway</span></div>
<div class="line"><a id="l04703" name="l04703"></a><span class="lineno"> 4703</span>      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l04704" name="l04704"></a><span class="lineno"> 4704</span>    }</div>
<div class="line"><a id="l04705" name="l04705"></a><span class="lineno"> 4705</span>    $tmpFile = basename($tmpFile);</div>
<div class="line"><a id="l04706" name="l04706"></a><span class="lineno"> 4706</span>    <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l04707" name="l04707"></a><span class="lineno"> 4707</span>      $attachment = $this</div>
<div class="line"><a id="l04708" name="l04708"></a><span class="lineno"> 4708</span>        -&gt;getDatabaseRepository(Entities\EmailAttachment::class)</div>
<div class="line"><a id="l04709" name="l04709"></a><span class="lineno"> 4709</span>        -&gt;findOneBy([</div>
<div class="line"><a id="l04710" name="l04710"></a><span class="lineno"> 4710</span>          <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $tmpFile,</div>
<div class="line"><a id="l04711" name="l04711"></a><span class="lineno"> 4711</span>        ]);</div>
<div class="line"><a id="l04712" name="l04712"></a><span class="lineno"> 4712</span>      <span class="keywordflow">if</span> (empty($attachment)) {</div>
<div class="line"><a id="l04713" name="l04713"></a><span class="lineno"> 4713</span>        $attachment = (<span class="keyword">new</span> Entities\EmailAttachment())</div>
<div class="line"><a id="l04714" name="l04714"></a><span class="lineno"> 4714</span>                    -&gt;setFileName($tmpFile);</div>
<div class="line"><a id="l04715" name="l04715"></a><span class="lineno"> 4715</span>      }</div>
<div class="line"><a id="l04716" name="l04716"></a><span class="lineno"> 4716</span>      <span class="keywordflow">if</span> ($this-&gt;draftId &gt; 0) {</div>
<div class="line"><a id="l04717" name="l04717"></a><span class="lineno"> 4717</span>        $attachment-&gt;setDraft($this-&gt;getReference(Entities\EmailDraft::class, $this-&gt;draftId));</div>
<div class="line"><a id="l04718" name="l04718"></a><span class="lineno"> 4718</span>      }</div>
<div class="line"><a id="l04719" name="l04719"></a><span class="lineno"> 4719</span>      $this-&gt;persist($attachment);</div>
<div class="line"><a id="l04720" name="l04720"></a><span class="lineno"> 4720</span>      $this-&gt;flush();</div>
<div class="line"><a id="l04721" name="l04721"></a><span class="lineno"> 4721</span>    } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l04722" name="l04722"></a><span class="lineno"> 4722</span>      $this-&gt;logException($t);</div>
<div class="line"><a id="l04723" name="l04723"></a><span class="lineno"> 4723</span>      <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04724" name="l04724"></a><span class="lineno"> 4724</span>    }</div>
<div class="line"><a id="l04725" name="l04725"></a><span class="lineno"> 4725</span>    <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">true</span>;</div>
<div class="line"><a id="l04726" name="l04726"></a><span class="lineno"> 4726</span>  }</div>
<div class="line"><a id="l04727" name="l04727"></a><span class="lineno"> 4727</span> </div>
<div class="line"><a id="l04735" name="l04735"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a6dfede44ffd8068052baa8a06ad05260"> 4735</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a6dfede44ffd8068052baa8a06ad05260">forgetTemporaryFile</a>(<span class="keywordtype">string</span> $tmpFile):bool</div>
<div class="line"><a id="l04736" name="l04736"></a><span class="lineno"> 4736</span>  {</div>
<div class="line"><a id="l04737" name="l04737"></a><span class="lineno"> 4737</span>    $tmpFile = basename($tmpFile);</div>
<div class="line"><a id="l04738" name="l04738"></a><span class="lineno"> 4738</span>    <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l04739" name="l04739"></a><span class="lineno"> 4739</span>      <span class="keywordflow">if</span> (is_string($tmpFile)) {</div>
<div class="line"><a id="l04740" name="l04740"></a><span class="lineno"> 4740</span>        $tmpFile = $this</div>
<div class="line"><a id="l04741" name="l04741"></a><span class="lineno"> 4741</span>          -&gt;getDatabaseRepository(Entities\EmailAttachment::class)</div>
<div class="line"><a id="l04742" name="l04742"></a><span class="lineno"> 4742</span>          -&gt;findOneBy([ <span class="stringliteral">&#39;fileName&#39;</span> =&gt; $tmpFile ]);</div>
<div class="line"><a id="l04743" name="l04743"></a><span class="lineno"> 4743</span>      }</div>
<div class="line"><a id="l04744" name="l04744"></a><span class="lineno"> 4744</span>      $this-&gt;<span class="keyword">remove</span>($tmpFile, <span class="keyword">true</span>);</div>
<div class="line"><a id="l04745" name="l04745"></a><span class="lineno"> 4745</span>    } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l04746" name="l04746"></a><span class="lineno"> 4746</span>      $this-&gt;diagnostics[self::DIAGNOSTICS_CAPTION] = $this-&gt;l-&gt;t(</div>
<div class="line"><a id="l04747" name="l04747"></a><span class="lineno"> 4747</span>        <span class="stringliteral">&#39;Cleaning temporary files failed: %s&#39;</span>, $t-&gt;getMessage());</div>
<div class="line"><a id="l04748" name="l04748"></a><span class="lineno"> 4748</span>      <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l04749" name="l04749"></a><span class="lineno"> 4749</span>    }</div>
<div class="line"><a id="l04750" name="l04750"></a><span class="lineno"> 4750</span>    <span class="keywordflow">return</span> $this-&gt;executionStatus = <span class="keyword">true</span>;</div>
<div class="line"><a id="l04751" name="l04751"></a><span class="lineno"> 4751</span>  }</div>
<div class="line"><a id="l04752" name="l04752"></a><span class="lineno"> 4752</span> </div>
<div class="line"><a id="l04765" name="l04765"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a9e1ded8474fe53124cbc5887bc2705cc"> 4765</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a9e1ded8474fe53124cbc5887bc2705cc">saveAttachment</a>(array &amp;$fileRecord)</div>
<div class="line"><a id="l04766" name="l04766"></a><span class="lineno"> 4766</span>  {</div>
<div class="line"><a id="l04767" name="l04767"></a><span class="lineno"> 4767</span>    <span class="keywordflow">if</span> (!empty($fileRecord[<span class="stringliteral">&#39;name&#39;</span>])) {</div>
<div class="line"><a id="l04768" name="l04768"></a><span class="lineno"> 4768</span> </div>
<div class="line"><a id="l04769" name="l04769"></a><span class="lineno"> 4769</span>      $tmpFile = $this-&gt;appStorage-&gt;newTemporaryFile(AppStorage::DRAFTS_FOLDER);</div>
<div class="line"><a id="l04770" name="l04770"></a><span class="lineno"> 4770</span> </div>
<div class="line"><a id="l04771" name="l04771"></a><span class="lineno"> 4771</span>      $tmpFilePath = AppStorage::PATH_SEP .AppStorage::DRAFTS_FOLDER .AppStorage::PATH_SEP . $tmpFile-&gt;getName();</div>
<div class="line"><a id="l04772" name="l04772"></a><span class="lineno"> 4772</span> </div>
<div class="line"><a id="l04773" name="l04773"></a><span class="lineno"> 4773</span>      $origin = empty($fileRecord[<span class="stringliteral">&#39;node&#39;</span>]) ? AttachmentOrigin::UPLOAD() : AttachmentOrigin::CLOUD();</div>
<div class="line"><a id="l04774" name="l04774"></a><span class="lineno"> 4774</span> </div>
<div class="line"><a id="l04775" name="l04775"></a><span class="lineno"> 4775</span>      <span class="comment">// Remember the file in the data-base for cleaning up later</span></div>
<div class="line"><a id="l04776" name="l04776"></a><span class="lineno"> 4776</span>      $this-&gt;rememberTemporaryFile($tmpFilePath, $origin);</div>
<div class="line"><a id="l04777" name="l04777"></a><span class="lineno"> 4777</span> </div>
<div class="line"><a id="l04778" name="l04778"></a><span class="lineno"> 4778</span>      <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l04779" name="l04779"></a><span class="lineno"> 4779</span>        <span class="keywordflow">if</span> (!empty($fileRecord[<span class="stringliteral">&#39;node&#39;</span>])) {</div>
<div class="line"><a id="l04780" name="l04780"></a><span class="lineno"> 4780</span>          <span class="comment">// cloud file</span></div>
<div class="line"><a id="l04781" name="l04781"></a><span class="lineno"> 4781</span>          $tmpFile-&gt;putContent($fileRecord[<span class="stringliteral">&#39;node&#39;</span>]-&gt;getContent());</div>
<div class="line"><a id="l04782" name="l04782"></a><span class="lineno"> 4782</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l04783" name="l04783"></a><span class="lineno"> 4783</span>          <span class="comment">// file-system file</span></div>
<div class="line"><a id="l04784" name="l04784"></a><span class="lineno"> 4784</span>          $this-&gt;appStorage-&gt;moveFileSystemFile($fileRecord[<span class="stringliteral">&#39;tmp_name&#39;</span>], $tmpFile);</div>
<div class="line"><a id="l04785" name="l04785"></a><span class="lineno"> 4785</span>        }</div>
<div class="line"><a id="l04786" name="l04786"></a><span class="lineno"> 4786</span> </div>
<div class="line"><a id="l04787" name="l04787"></a><span class="lineno"> 4787</span>        $fileRecord[<span class="stringliteral">&#39;tmp_name&#39;</span>] = $tmpFilePath;</div>
<div class="line"><a id="l04788" name="l04788"></a><span class="lineno"> 4788</span>        $fileRecord[<span class="stringliteral">&#39;origin&#39;</span>] = $origin;</div>
<div class="line"><a id="l04789" name="l04789"></a><span class="lineno"> 4789</span> </div>
<div class="line"><a id="l04790" name="l04790"></a><span class="lineno"> 4790</span>      } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l04791" name="l04791"></a><span class="lineno"> 4791</span>        $this-&gt;logException($t);</div>
<div class="line"><a id="l04792" name="l04792"></a><span class="lineno"> 4792</span>        $tmpFile-&gt;delete();</div>
<div class="line"><a id="l04793" name="l04793"></a><span class="lineno"> 4793</span>        $this-&gt;forgetTemporaryFile($tmpFilePath);</div>
<div class="line"><a id="l04794" name="l04794"></a><span class="lineno"> 4794</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l04795" name="l04795"></a><span class="lineno"> 4795</span>      }</div>
<div class="line"><a id="l04796" name="l04796"></a><span class="lineno"> 4796</span> </div>
<div class="line"><a id="l04797" name="l04797"></a><span class="lineno"> 4797</span>      <span class="keywordflow">return</span> $fileRecord;</div>
<div class="line"><a id="l04798" name="l04798"></a><span class="lineno"> 4798</span>    }</div>
<div class="line"><a id="l04799" name="l04799"></a><span class="lineno"> 4799</span>    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l04800" name="l04800"></a><span class="lineno"> 4800</span>  }</div>
<div class="line"><a id="l04801" name="l04801"></a><span class="lineno"> 4801</span> </div>
<div class="line"><a id="l04807" name="l04807"></a><span class="lineno"> 4807</span>  <span class="keyword">public</span> <span class="keyword">function</span> registerAttachmentDownloadsCleaner():void</div>
<div class="line"><a id="l04808" name="l04808"></a><span class="lineno"> 4808</span>  {</div>
<div class="line"><a id="l04810" name="l04810"></a><span class="lineno"> 4810</span>    $jobList = $this-&gt;di(\OCP\BackgroundJob\IJobList::class);</div>
<div class="line"><a id="l04811" name="l04811"></a><span class="lineno"> 4811</span> </div>
<div class="line"><a id="l04812" name="l04812"></a><span class="lineno"> 4812</span>    <span class="comment">// the job-list takes care by itself that no duplicates are added</span></div>
<div class="line"><a id="l04813" name="l04813"></a><span class="lineno"> 4813</span>    $jobList-&gt;add(CleanupExpiredDownloads::class, [</div>
<div class="line"><a id="l04814" name="l04814"></a><span class="lineno"> 4814</span>      <span class="stringliteral">&#39;paths&#39;</span> =&gt; [ $this-&gt;getOutBoxFolderPath(), ],</div>
<div class="line"><a id="l04815" name="l04815"></a><span class="lineno"> 4815</span>      <span class="stringliteral">&#39;uid&#39;</span> =&gt; $this-&gt;shareOwnerId(),</div>
<div class="line"><a id="l04816" name="l04816"></a><span class="lineno"> 4816</span>    ]);</div>
<div class="line"><a id="l04817" name="l04817"></a><span class="lineno"> 4817</span>  }</div>
<div class="line"><a id="l04818" name="l04818"></a><span class="lineno"> 4818</span> </div>
<div class="line"><a id="l04827" name="l04827"></a><span class="lineno"> 4827</span>  <span class="keyword">public</span> <span class="keyword">function</span> cleanAttachmentDownloads():void</div>
<div class="line"><a id="l04828" name="l04828"></a><span class="lineno"> 4828</span>  {</div>
<div class="line"><a id="l04829" name="l04829"></a><span class="lineno"> 4829</span>    $outBoxFolderPath = $this-&gt;getOutBoxFolderPath();</div>
<div class="line"><a id="l04830" name="l04830"></a><span class="lineno"> 4830</span>    <span class="keywordflow">if</span> (empty($outBoxFolderPath)) {</div>
<div class="line"><a id="l04831" name="l04831"></a><span class="lineno"> 4831</span>      $this-&gt;logError(<span class="stringliteral">&#39;Outbox folder path &quot;&#39;</span> . $this-&gt;getOutBoxFolderPath() . <span class="stringliteral">&#39;&quot; not configured&#39;</span>);</div>
<div class="line"><a id="l04832" name="l04832"></a><span class="lineno"> 4832</span>      <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l04833" name="l04833"></a><span class="lineno"> 4833</span>    }</div>
<div class="line"><a id="l04834" name="l04834"></a><span class="lineno"> 4834</span>    $outboxFolder = $this-&gt;userStorage-&gt;getFolder($this-&gt;getOutBoxFolderPath());</div>
<div class="line"><a id="l04835" name="l04835"></a><span class="lineno"> 4835</span>    <span class="keywordflow">if</span> (empty($outboxFolder)) {</div>
<div class="line"><a id="l04836" name="l04836"></a><span class="lineno"> 4836</span>      $this-&gt;logError(<span class="stringliteral">&#39;Outbox folder &quot;&#39;</span> . $this-&gt;getOutBoxFolderPath() . <span class="stringliteral">&#39;&quot; could not be found&#39;</span>);</div>
<div class="line"><a id="l04837" name="l04837"></a><span class="lineno"> 4837</span>      <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l04838" name="l04838"></a><span class="lineno"> 4838</span>    }</div>
<div class="line"><a id="l04839" name="l04839"></a><span class="lineno"> 4839</span> </div>
<div class="line"><a id="l04840" name="l04840"></a><span class="lineno"> 4840</span>    $numChangedShares = 0;</div>
<div class="line"><a id="l04841" name="l04841"></a><span class="lineno"> 4841</span> </div>
<div class="line"><a id="l04843" name="l04843"></a><span class="lineno"> 4843</span>    <span class="keywordflow">foreach</span> ($outboxFolder-&gt;getDirectoryListing() as $node) {</div>
<div class="line"><a id="l04844" name="l04844"></a><span class="lineno"> 4844</span>      <span class="keywordflow">if</span> ($node-&gt;getType() != \OCP\Files\Node::TYPE_FOLDER</div>
<div class="line"><a id="l04845" name="l04845"></a><span class="lineno"> 4845</span>          || strpos($node-&gt;getName(), self::MSG_ID_AT) === <span class="keyword">false</span>) {</div>
<div class="line"><a id="l04846" name="l04846"></a><span class="lineno"> 4846</span>        $this-&gt;logDebug(<span class="stringliteral">&#39;The node &#39;</span> . $node-&gt;getName() . <span class="stringliteral">&#39; does not look like originating from a message id, skipping.&#39;</span>);</div>
<div class="line"><a id="l04847" name="l04847"></a><span class="lineno"> 4847</span>        <span class="keywordflow">continue</span>; <span class="comment">// does not appear to be a message id</span></div>
<div class="line"><a id="l04848" name="l04848"></a><span class="lineno"> 4848</span>      }</div>
<div class="line"><a id="l04849" name="l04849"></a><span class="lineno"> 4849</span>      $messageId = self::messageIdFromOutBoxSubFolder($node-&gt;getName());</div>
<div class="line"><a id="l04850" name="l04850"></a><span class="lineno"> 4850</span>      $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a4d87f4e47d18fb535d235414c357f821">logDebug</a>(<span class="stringliteral">&#39;LOOK FOR MESSAGE ID &#39;</span> . $messageId);</div>
<div class="line"><a id="l04851" name="l04851"></a><span class="lineno"> 4851</span>      $sentEmail = $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#ab6f5f4edde190f5e5f1cd1e2fdd402d4">getDatabaseRepository</a>(Entities\SentEmail::class)-&gt;find($messageId);</div>
<div class="line"><a id="l04852" name="l04852"></a><span class="lineno"> 4852</span>      <span class="keywordflow">if</span> (empty($sentEmail)) {</div>
<div class="line"><a id="l04853" name="l04853"></a><span class="lineno"> 4853</span>        $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a4d87f4e47d18fb535d235414c357f821">logDebug</a>(<span class="stringliteral">&#39;No sent-email with name id &quot;&#39;</span> . $messageId . <span class="stringliteral">&#39;&quot; found, could delete.&#39;</span>);</div>
<div class="line"><a id="l04855" name="l04855"></a><span class="lineno"> 4855</span>        <span class="keywordflow">foreach</span> ($node-&gt;getDirectoryListing() as $fileAttachment) {</div>
<div class="line"><a id="l04856" name="l04856"></a><span class="lineno"> 4856</span>          $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a4d87f4e47d18fb535d235414c357f821">logDebug</a>(<span class="stringliteral">&#39;TRY EXPIRE &#39;</span> . $fileAttachment-&gt;getName());</div>
<div class="line"><a id="l04857" name="l04857"></a><span class="lineno"> 4857</span>          $numChangedShares +=</div>
<div class="line"><a id="l04858" name="l04858"></a><span class="lineno"> 4858</span>            $this-&gt;simpleSharingService-&gt;expire($fileAttachment, $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a41c11b7ac132f68b944624210a5135be">shareOwnerId</a>());</div>
<div class="line"><a id="l04859" name="l04859"></a><span class="lineno"> 4859</span>        }</div>
<div class="line"><a id="l04860" name="l04860"></a><span class="lineno"> 4860</span>      }</div>
<div class="line"><a id="l04861" name="l04861"></a><span class="lineno"> 4861</span>    }</div>
<div class="line"><a id="l04862" name="l04862"></a><span class="lineno"> 4862</span>    <span class="keywordflow">if</span> ($numChangedShares &gt; 0) {</div>
<div class="line"><a id="l04863" name="l04863"></a><span class="lineno"> 4863</span>      <span class="comment">// make sure the clean-up service runs</span></div>
<div class="line"><a id="l04864" name="l04864"></a><span class="lineno"> 4864</span>      $this-&gt;registerAttachmentDownloadsCleaner();</div>
<div class="line"><a id="l04865" name="l04865"></a><span class="lineno"> 4865</span>    }</div>
<div class="line"><a id="l04866" name="l04866"></a><span class="lineno"> 4866</span>  }</div>
<div class="line"><a id="l04867" name="l04867"></a><span class="lineno"> 4867</span> </div>
<div class="line"><a id="l04868" name="l04868"></a><span class="lineno"> 4868</span>  <span class="comment">// public methods exporting data needed by the web-page template</span></div>
<div class="line"><a id="l04869" name="l04869"></a><span class="lineno"> 4869</span> </div>
<div class="line"><a id="l04871" name="l04871"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#af025be7c6d229803717a6b717854a0a3"> 4871</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#af025be7c6d229803717a6b717854a0a3">formData</a>():array</div>
<div class="line"><a id="l04872" name="l04872"></a><span class="lineno"> 4872</span>  {</div>
<div class="line"><a id="l04873" name="l04873"></a><span class="lineno"> 4873</span>    <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l04874" name="l04874"></a><span class="lineno"> 4874</span>      <span class="stringliteral">&#39;formStatus&#39;</span> =&gt; <span class="stringliteral">&#39;submitted&#39;</span>,</div>
<div class="line"><a id="l04875" name="l04875"></a><span class="lineno"> 4875</span>      <span class="stringliteral">&#39;messageDraftId&#39;</span> =&gt; $this-&gt;draftId,</div>
<div class="line"><a id="l04876" name="l04876"></a><span class="lineno"> 4876</span>      <span class="stringliteral">&#39;inReplyTo&#39;</span> =&gt; $this-&gt;inReplyToId,</div>
<div class="line"><a id="l04877" name="l04877"></a><span class="lineno"> 4877</span>      <span class="stringliteral">&#39;referencing&#39;</span> =&gt; $this-&gt;referencing,</div>
<div class="line"><a id="l04878" name="l04878"></a><span class="lineno"> 4878</span>    ];</div>
<div class="line"><a id="l04879" name="l04879"></a><span class="lineno"> 4879</span>  }</div>
<div class="line"><a id="l04880" name="l04880"></a><span class="lineno"> 4880</span> </div>
<div class="line"><a id="l04882" name="l04882"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a0abfd59485d4c62afddeb31fcfbc7ec5"> 4882</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a0abfd59485d4c62afddeb31fcfbc7ec5">catchAllEmail</a>():string</div>
<div class="line"><a id="l04883" name="l04883"></a><span class="lineno"> 4883</span>  {</div>
<div class="line"><a id="l04884" name="l04884"></a><span class="lineno"> 4884</span>    <span class="keywordflow">return</span> htmlspecialchars($this-&gt;catchAllName.<span class="stringliteral">&#39; &lt;&#39;</span>.$this-&gt;catchAllEmail.<span class="charliteral">&#39;&gt;&#39;</span>);</div>
<div class="line"><a id="l04885" name="l04885"></a><span class="lineno"> 4885</span>  }</div>
<div class="line"><a id="l04886" name="l04886"></a><span class="lineno"> 4886</span> </div>
<div class="line"><a id="l04894" name="l04894"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a462c7fe31c4345bb890b366c50621cfa"> 4894</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a462c7fe31c4345bb890b366c50621cfa">toStringArray</a>():array</div>
<div class="line"><a id="l04895" name="l04895"></a><span class="lineno"> 4895</span>  {</div>
<div class="line"><a id="l04896" name="l04896"></a><span class="lineno"> 4896</span>    $toString = [];</div>
<div class="line"><a id="l04897" name="l04897"></a><span class="lineno"> 4897</span>    <span class="keywordflow">foreach</span> ($this-&gt;recipients as $recipient) {</div>
<div class="line"><a id="l04898" name="l04898"></a><span class="lineno"> 4898</span>      $name = trim($recipient[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l04899" name="l04899"></a><span class="lineno"> 4899</span>      $email = trim($recipient[<span class="stringliteral">&#39;email&#39;</span>]);</div>
<div class="line"><a id="l04900" name="l04900"></a><span class="lineno"> 4900</span>      <span class="keywordflow">if</span> (!empty($name)) {</div>
<div class="line"><a id="l04901" name="l04901"></a><span class="lineno"> 4901</span>        $email = $name.<span class="stringliteral">&#39; &lt;&#39;</span>.$email.<span class="charliteral">&#39;&gt;&#39;</span>;</div>
<div class="line"><a id="l04902" name="l04902"></a><span class="lineno"> 4902</span>      }</div>
<div class="line"><a id="l04903" name="l04903"></a><span class="lineno"> 4903</span>      $toString[] = Util::htmlEscape($email);</div>
<div class="line"><a id="l04904" name="l04904"></a><span class="lineno"> 4904</span>    }</div>
<div class="line"><a id="l04905" name="l04905"></a><span class="lineno"> 4905</span>    <span class="keywordflow">return</span> $toString;</div>
<div class="line"><a id="l04906" name="l04906"></a><span class="lineno"> 4906</span>  }</div>
<div class="line"><a id="l04907" name="l04907"></a><span class="lineno"> 4907</span> </div>
<div class="line"><a id="l04915" name="l04915"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a5558c5d549f41597377fa1ea8a1cefa3"> 4915</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a5558c5d549f41597377fa1ea8a1cefa3">toString</a>():string</div>
<div class="line"><a id="l04916" name="l04916"></a><span class="lineno"> 4916</span>  {</div>
<div class="line"><a id="l04917" name="l04917"></a><span class="lineno"> 4917</span>    <span class="keywordflow">return</span> implode(<span class="stringliteral">&#39;, &#39;</span>, $this-&gt;toStringArray());</div>
<div class="line"><a id="l04918" name="l04918"></a><span class="lineno"> 4918</span>  }</div>
<div class="line"><a id="l04919" name="l04919"></a><span class="lineno"> 4919</span> </div>
<div class="line"><a id="l04926" name="l04926"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a30ead6103e6fb25a10628774c18ed36a"> 4926</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a30ead6103e6fb25a10628774c18ed36a">storedEmails</a>():array</div>
<div class="line"><a id="l04927" name="l04927"></a><span class="lineno"> 4927</span>  {</div>
<div class="line"><a id="l04928" name="l04928"></a><span class="lineno"> 4928</span>    $drafts = $this-&gt;fetchDraftsList();</div>
<div class="line"><a id="l04929" name="l04929"></a><span class="lineno"> 4929</span>    $templates = $this-&gt;fetchTemplatesList();</div>
<div class="line"><a id="l04930" name="l04930"></a><span class="lineno"> 4930</span> </div>
<div class="line"><a id="l04931" name="l04931"></a><span class="lineno"> 4931</span>    <span class="keywordflow">return</span> [</div>
<div class="line"><a id="l04932" name="l04932"></a><span class="lineno"> 4932</span>      <span class="stringliteral">&#39;drafts&#39;</span> =&gt; $drafts,</div>
<div class="line"><a id="l04933" name="l04933"></a><span class="lineno"> 4933</span>      <span class="stringliteral">&#39;templates&#39;</span> =&gt; $templates,</div>
<div class="line"><a id="l04934" name="l04934"></a><span class="lineno"> 4934</span>    ];</div>
<div class="line"><a id="l04935" name="l04935"></a><span class="lineno"> 4935</span>  }</div>
<div class="line"><a id="l04936" name="l04936"></a><span class="lineno"> 4936</span> </div>
<div class="line"><a id="l04942" name="l04942"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a0bd93e4267049cfd7b9bb36bdaae694b"> 4942</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a0bd93e4267049cfd7b9bb36bdaae694b">sentEmails</a>()</div>
<div class="line"><a id="l04943" name="l04943"></a><span class="lineno"> 4943</span>  {</div>
<div class="line"><a id="l04944" name="l04944"></a><span class="lineno"> 4944</span>    <span class="keywordflow">return</span> $this-&gt;fetchSentEmailsList();</div>
<div class="line"><a id="l04945" name="l04945"></a><span class="lineno"> 4945</span>  }</div>
<div class="line"><a id="l04946" name="l04946"></a><span class="lineno"> 4946</span> </div>
<div class="line"><a id="l04948" name="l04948"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a27966bf10334cb5a39f4df8dc8f2a151"> 4948</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a27966bf10334cb5a39f4df8dc8f2a151">currentEmailTemplate</a>():string</div>
<div class="line"><a id="l04949" name="l04949"></a><span class="lineno"> 4949</span>  {</div>
<div class="line"><a id="l04950" name="l04950"></a><span class="lineno"> 4950</span>    <span class="keywordflow">return</span> $this-&gt;templateName;</div>
<div class="line"><a id="l04951" name="l04951"></a><span class="lineno"> 4951</span>  }</div>
<div class="line"><a id="l04952" name="l04952"></a><span class="lineno"> 4952</span> </div>
<div class="line"><a id="l04954" name="l04954"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad898ece7f3ae7d21feaedaef97802604"> 4954</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad898ece7f3ae7d21feaedaef97802604">messageDraftId</a>():?int</div>
<div class="line"><a id="l04955" name="l04955"></a><span class="lineno"> 4955</span>  {</div>
<div class="line"><a id="l04956" name="l04956"></a><span class="lineno"> 4956</span>    <span class="keywordflow">return</span> $this-&gt;draftId;</div>
<div class="line"><a id="l04957" name="l04957"></a><span class="lineno"> 4957</span>  }</div>
<div class="line"><a id="l04958" name="l04958"></a><span class="lineno"> 4958</span> </div>
<div class="line"><a id="l04960" name="l04960"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ae220f15c10e5298f7e1f74bc69a15743"> 4960</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ae220f15c10e5298f7e1f74bc69a15743">inReplyTo</a>():?string</div>
<div class="line"><a id="l04961" name="l04961"></a><span class="lineno"> 4961</span>  {</div>
<div class="line"><a id="l04962" name="l04962"></a><span class="lineno"> 4962</span>    <span class="keywordflow">return</span> $this-&gt;inReplyToId;</div>
<div class="line"><a id="l04963" name="l04963"></a><span class="lineno"> 4963</span>  }</div>
<div class="line"><a id="l04964" name="l04964"></a><span class="lineno"> 4964</span> </div>
<div class="line"><a id="l04966" name="l04966"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac9f13bb428d2f8fba2e6cdf565df683f"> 4966</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac9f13bb428d2f8fba2e6cdf565df683f">subjectTag</a>():string</div>
<div class="line"><a id="l04967" name="l04967"></a><span class="lineno"> 4967</span>  {</div>
<div class="line"><a id="l04968" name="l04968"></a><span class="lineno"> 4968</span>    <span class="keywordflow">return</span> $this-&gt;messageTag;</div>
<div class="line"><a id="l04969" name="l04969"></a><span class="lineno"> 4969</span>  }</div>
<div class="line"><a id="l04970" name="l04970"></a><span class="lineno"> 4970</span> </div>
<div class="line"><a id="l04974" name="l04974"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#afce9302bd8ab508408cc457cb24786e5"> 4974</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#afce9302bd8ab508408cc457cb24786e5">fromName</a>():string</div>
<div class="line"><a id="l04975" name="l04975"></a><span class="lineno"> 4975</span>  {</div>
<div class="line"><a id="l04976" name="l04976"></a><span class="lineno"> 4976</span>    <span class="keywordflow">return</span> $this-&gt;cgiValue(<span class="stringliteral">&#39;fromName&#39;</span>, $this-&gt;catchAllName);</div>
<div class="line"><a id="l04977" name="l04977"></a><span class="lineno"> 4977</span>  }</div>
<div class="line"><a id="l04978" name="l04978"></a><span class="lineno"> 4978</span> </div>
<div class="line"><a id="l04980" name="l04980"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#adb1dd030a0eed2cad2054a2678608536"> 4980</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#adb1dd030a0eed2cad2054a2678608536">fromAddress</a>():string</div>
<div class="line"><a id="l04981" name="l04981"></a><span class="lineno"> 4981</span>  {</div>
<div class="line"><a id="l04982" name="l04982"></a><span class="lineno"> 4982</span>    <span class="keywordflow">return</span> htmlspecialchars($this-&gt;catchAllEmail);</div>
<div class="line"><a id="l04983" name="l04983"></a><span class="lineno"> 4983</span>  }</div>
<div class="line"><a id="l04984" name="l04984"></a><span class="lineno"> 4984</span> </div>
<div class="line"><a id="l04986" name="l04986"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a016db532796f0e82eb53352cd95baf70"> 4986</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a016db532796f0e82eb53352cd95baf70">messageText</a>():string</div>
<div class="line"><a id="l04987" name="l04987"></a><span class="lineno"> 4987</span>  {</div>
<div class="line"><a id="l04988" name="l04988"></a><span class="lineno"> 4988</span>    <span class="keywordflow">return</span> $this-&gt;messageContents;</div>
<div class="line"><a id="l04989" name="l04989"></a><span class="lineno"> 4989</span>  }</div>
<div class="line"><a id="l04990" name="l04990"></a><span class="lineno"> 4990</span> </div>
<div class="line"><a id="l04992" name="l04992"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a099a1eac786c0fc2c4d7b8c3108b7d13"> 4992</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a099a1eac786c0fc2c4d7b8c3108b7d13">blindCarbonCopy</a>():string</div>
<div class="line"><a id="l04993" name="l04993"></a><span class="lineno"> 4993</span>  {</div>
<div class="line"><a id="l04994" name="l04994"></a><span class="lineno"> 4994</span>    <span class="keywordflow">return</span> $this-&gt;cgiValue(<span class="stringliteral">&#39;BCC&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);</div>
<div class="line"><a id="l04995" name="l04995"></a><span class="lineno"> 4995</span>  }</div>
<div class="line"><a id="l04996" name="l04996"></a><span class="lineno"> 4996</span> </div>
<div class="line"><a id="l04998" name="l04998"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a1dc30339bb1489c3f4a9586dff31066d"> 4998</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a1dc30339bb1489c3f4a9586dff31066d">carbonCopy</a>():string</div>
<div class="line"><a id="l04999" name="l04999"></a><span class="lineno"> 4999</span>  {</div>
<div class="line"><a id="l05000" name="l05000"></a><span class="lineno"> 5000</span>    <span class="keywordflow">return</span> $this-&gt;cgiValue(<span class="stringliteral">&#39;CC&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);</div>
<div class="line"><a id="l05001" name="l05001"></a><span class="lineno"> 5001</span>  }</div>
<div class="line"><a id="l05002" name="l05002"></a><span class="lineno"> 5002</span> </div>
<div class="line"><a id="l05004" name="l05004"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad647aec9f224f570e5c79be0a9ddd3d1"> 5004</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad647aec9f224f570e5c79be0a9ddd3d1">subject</a>():string</div>
<div class="line"><a id="l05005" name="l05005"></a><span class="lineno"> 5005</span>  {</div>
<div class="line"><a id="l05006" name="l05006"></a><span class="lineno"> 5006</span>    <span class="keywordflow">return</span> $this-&gt;cgiValue(<span class="stringliteral">&#39;subject&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);</div>
<div class="line"><a id="l05007" name="l05007"></a><span class="lineno"> 5007</span>  }</div>
<div class="line"><a id="l05008" name="l05008"></a><span class="lineno"> 5008</span> </div>
<div class="line"><a id="l05017" name="l05017"></a><span class="lineno"> 5017</span>  <span class="keyword">private</span> <span class="keyword">function</span> sanitizeMessageHtml(?<span class="keywordtype">string</span> $message = <span class="keyword">null</span>):string</div>
<div class="line"><a id="l05018" name="l05018"></a><span class="lineno"> 5018</span>  {</div>
<div class="line"><a id="l05019" name="l05019"></a><span class="lineno"> 5019</span>    $message = $message ?? $this-&gt;messageContents;</div>
<div class="line"><a id="l05020" name="l05020"></a><span class="lineno"> 5020</span> </div>
<div class="line"><a id="l05021" name="l05021"></a><span class="lineno"> 5021</span>    <span class="comment">// $this-&gt;logInfo(&#39;MESSAGE BEFORE &#39; . $message);</span></div>
<div class="line"><a id="l05022" name="l05022"></a><span class="lineno"> 5022</span> </div>
<div class="line"><a id="l05023" name="l05023"></a><span class="lineno"> 5023</span>    $doc = <span class="keyword">new</span> DOMDocument(<span class="stringliteral">&#39;1.0&#39;</span>, <span class="stringliteral">&#39;UTF-8&#39;</span>);</div>
<div class="line"><a id="l05024" name="l05024"></a><span class="lineno"> 5024</span>    $doc-&gt;encoding = <span class="stringliteral">&#39;UTF-8&#39;</span>;</div>
<div class="line"><a id="l05025" name="l05025"></a><span class="lineno"> 5025</span>    <span class="comment">// $doc-&gt;substituteEntities = true;</span></div>
<div class="line"><a id="l05026" name="l05026"></a><span class="lineno"> 5026</span>    $doc-&gt;loadHTML(<span class="stringliteral">&#39;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;/head&gt;&lt;body&gt;&#39;</span> . $message . <span class="stringliteral">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span>);</div>
<div class="line"><a id="l05027" name="l05027"></a><span class="lineno"> 5027</span>    $links = $doc-&gt;getElementsByTagName(<span class="charliteral">&#39;a&#39;</span>);</div>
<div class="line"><a id="l05029" name="l05029"></a><span class="lineno"> 5029</span>    <span class="keywordflow">foreach</span> ($links as $item) {</div>
<div class="line"><a id="l05030" name="l05030"></a><span class="lineno"> 5030</span>      <span class="comment">// add a target=&quot;_blank&quot; attribute to all links.</span></div>
<div class="line"><a id="l05031" name="l05031"></a><span class="lineno"> 5031</span>      <span class="keywordflow">if</span> (!$item-&gt;hasAttribute(<span class="stringliteral">&#39;target&#39;</span>)) {</div>
<div class="line"><a id="l05032" name="l05032"></a><span class="lineno"> 5032</span>        $item-&gt;setAttribute(<span class="stringliteral">&#39;target&#39;</span>, <span class="stringliteral">&#39;_blank&#39;</span>);</div>
<div class="line"><a id="l05033" name="l05033"></a><span class="lineno"> 5033</span>      }</div>
<div class="line"><a id="l05034" name="l05034"></a><span class="lineno"> 5034</span>      <span class="comment">// Remove relative links. We assume that any iteration of /?../ can be</span></div>
<div class="line"><a id="l05035" name="l05035"></a><span class="lineno"> 5035</span>      <span class="comment">// replaced by the base-url, so</span></div>
<div class="line"><a id="l05036" name="l05036"></a><span class="lineno"> 5036</span>      <span class="comment">//</span></div>
<div class="line"><a id="l05037" name="l05037"></a><span class="lineno"> 5037</span>      <span class="comment">// ../../../index.php/s/tPTQRskrHCoqeJY -&gt; BASE_URL/index.php/s/tPTQRskrHCoqeJY</span></div>
<div class="line"><a id="l05038" name="l05038"></a><span class="lineno"> 5038</span>      $href = $item-&gt;getAttribute(<span class="stringliteral">&#39;href&#39;</span>);</div>
<div class="line"><a id="l05039" name="l05039"></a><span class="lineno"> 5039</span>      <span class="keywordflow">if</span> ($this-&gt;hasSubstitutionNamespace(self::GLOBAL_NAMESPACE, urldecode($href))</div>
<div class="line"><a id="l05040" name="l05040"></a><span class="lineno"> 5040</span>          || str_starts_with($href, <span class="stringliteral">&#39;mailto:&#39;</span>)</div>
<div class="line"><a id="l05041" name="l05041"></a><span class="lineno"> 5041</span>          || isset(parse_url($href)[<span class="stringliteral">&#39;host&#39;</span>])) {</div>
<div class="line"><a id="l05042" name="l05042"></a><span class="lineno"> 5042</span>        $this-&gt;logDebug(<span class="stringliteral">&#39;KEEP HREF AS &#39;</span> . $href);</div>
<div class="line"><a id="l05043" name="l05043"></a><span class="lineno"> 5043</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l05044" name="l05044"></a><span class="lineno"> 5044</span>      }</div>
<div class="line"><a id="l05045" name="l05045"></a><span class="lineno"> 5045</span>      $baseUrl = $this-&gt;urlGenerator()-&gt;getBaseUrl();</div>
<div class="line"><a id="l05046" name="l05046"></a><span class="lineno"> 5046</span>      $href = $baseUrl . preg_replace(<span class="stringliteral">&#39;|/?(\.\./)+|&#39;</span>, <span class="charliteral">&#39;/&#39;</span>, $href);</div>
<div class="line"><a id="l05047" name="l05047"></a><span class="lineno"> 5047</span>      $item-&gt;setAttribute(<span class="stringliteral">&#39;href&#39;</span>, $href);</div>
<div class="line"><a id="l05048" name="l05048"></a><span class="lineno"> 5048</span>    }</div>
<div class="line"><a id="l05049" name="l05049"></a><span class="lineno"> 5049</span> </div>
<div class="line"><a id="l05050" name="l05050"></a><span class="lineno"> 5050</span>    $body = $doc-&gt;getElementsByTagName(<span class="stringliteral">&#39;body&#39;</span>)-&gt;item(0);</div>
<div class="line"><a id="l05051" name="l05051"></a><span class="lineno"> 5051</span>    $content = substr(substr($doc-&gt;saveHTML($body), strlen(<span class="stringliteral">&#39;&lt;body&gt;&#39;</span>)), 0, -strlen(<span class="stringliteral">&#39;&lt;/body&gt;&#39;</span>));</div>
<div class="line"><a id="l05052" name="l05052"></a><span class="lineno"> 5052</span> </div>
<div class="line"><a id="l05053" name="l05053"></a><span class="lineno"> 5053</span>    <span class="comment">// $this-&gt;logInfo(&#39;MESSAGE AFTER &#39; . $content);</span></div>
<div class="line"><a id="l05054" name="l05054"></a><span class="lineno"> 5054</span> </div>
<div class="line"><a id="l05055" name="l05055"></a><span class="lineno"> 5055</span>    <span class="keywordflow">return</span> $content;</div>
<div class="line"><a id="l05056" name="l05056"></a><span class="lineno"> 5056</span>  }</div>
<div class="line"><a id="l05057" name="l05057"></a><span class="lineno"> 5057</span> </div>
<div class="line"><a id="l05066" name="l05066"></a><span class="lineno"> 5066</span>  <span class="keyword">private</span> <span class="keyword">function</span> validateMessageHtml(?<span class="keywordtype">string</span> $message = <span class="keyword">null</span>):bool</div>
<div class="line"><a id="l05067" name="l05067"></a><span class="lineno"> 5067</span>  {</div>
<div class="line"><a id="l05068" name="l05068"></a><span class="lineno"> 5068</span>    $message = $message ?? $this-&gt;messageContents;</div>
<div class="line"><a id="l05069" name="l05069"></a><span class="lineno"> 5069</span> </div>
<div class="line"><a id="l05070" name="l05070"></a><span class="lineno"> 5070</span>    $linkStatus = [];</div>
<div class="line"><a id="l05071" name="l05071"></a><span class="lineno"> 5071</span>    $hasErrors = <span class="keyword">false</span>;</div>
<div class="line"><a id="l05072" name="l05072"></a><span class="lineno"> 5072</span> </div>
<div class="line"><a id="l05073" name="l05073"></a><span class="lineno"> 5073</span>    $doc = <span class="keyword">new</span> DOMDocument();</div>
<div class="line"><a id="l05074" name="l05074"></a><span class="lineno"> 5074</span>    $doc-&gt;loadHTML(<span class="stringliteral">&#39;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;/head&gt;&lt;body&gt;&#39;</span> . $message . <span class="stringliteral">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span>);</div>
<div class="line"><a id="l05075" name="l05075"></a><span class="lineno"> 5075</span>    $links = $doc-&gt;getElementsByTagName(<span class="charliteral">&#39;a&#39;</span>);</div>
<div class="line"><a id="l05077" name="l05077"></a><span class="lineno"> 5077</span>    <span class="keywordflow">foreach</span> ($links as $item) {</div>
<div class="line"><a id="l05078" name="l05078"></a><span class="lineno"> 5078</span>      $thisLinkGood = <span class="keyword">false</span>;</div>
<div class="line"><a id="l05079" name="l05079"></a><span class="lineno"> 5079</span>      $href = $item-&gt;getAttribute(<span class="stringliteral">&#39;href&#39;</span>);</div>
<div class="line"><a id="l05080" name="l05080"></a><span class="lineno"> 5080</span>      <span class="keywordflow">if</span> ($this-&gt;hasSubstitutionNamespace(self::GLOBAL_NAMESPACE, urldecode($href))</div>
<div class="line"><a id="l05081" name="l05081"></a><span class="lineno"> 5081</span>          || str_starts_with($href, <span class="stringliteral">&#39;mailto:&#39;</span>)</div>
<div class="line"><a id="l05082" name="l05082"></a><span class="lineno"> 5082</span>      ) {</div>
<div class="line"><a id="l05083" name="l05083"></a><span class="lineno"> 5083</span>        $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#ab8e67cfd6a09d264ed60634dd794bb30">logInfo</a>(<span class="stringliteral">&#39;KEEP HREF UNCHECKED &#39;</span> . $href);</div>
<div class="line"><a id="l05084" name="l05084"></a><span class="lineno"> 5084</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l05085" name="l05085"></a><span class="lineno"> 5085</span>      }</div>
<div class="line"><a id="l05086" name="l05086"></a><span class="lineno"> 5086</span>      $this-&gt;<a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#ab8e67cfd6a09d264ed60634dd794bb30">logInfo</a>(<span class="stringliteral">&#39;CHECK HREF &#39;</span> . $href);</div>
<div class="line"><a id="l05087" name="l05087"></a><span class="lineno"> 5087</span>      $text = $item-&gt;nodeValue;</div>
<div class="line"><a id="l05088" name="l05088"></a><span class="lineno"> 5088</span>      <span class="keywordflow">try</span> {</div>
<div class="line"><a id="l05089" name="l05089"></a><span class="lineno"> 5089</span>        $headers = get_headers($href);</div>
<div class="line"><a id="l05090" name="l05090"></a><span class="lineno"> 5090</span>      } <span class="keywordflow">catch</span> (\Throwable $t) {</div>
<div class="line"><a id="l05091" name="l05091"></a><span class="lineno"> 5091</span>        $headers = <span class="keyword">null</span>;</div>
<div class="line"><a id="l05092" name="l05092"></a><span class="lineno"> 5092</span>      }</div>
<div class="line"><a id="l05093" name="l05093"></a><span class="lineno"> 5093</span>      <span class="keywordflow">if</span> ($headers &amp;&amp; <a class="code hl_function" href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a8e12ef5cafdab7b950132867526d1113">count</a>($headers) &gt; 0) {</div>
<div class="line"><a id="l05094" name="l05094"></a><span class="lineno"> 5094</span>        $code = (int)substr($headers[0], 9, 3);</div>
<div class="line"><a id="l05095" name="l05095"></a><span class="lineno"> 5095</span>        <span class="keywordflow">if</span> ($code &gt;= 200 &amp;&amp; $code &lt; 400) {</div>
<div class="line"><a id="l05096" name="l05096"></a><span class="lineno"> 5096</span>          $thisLinkGood = <span class="keyword">true</span>;</div>
<div class="line"><a id="l05097" name="l05097"></a><span class="lineno"> 5097</span>        }</div>
<div class="line"><a id="l05098" name="l05098"></a><span class="lineno"> 5098</span>      }</div>
<div class="line"><a id="l05099" name="l05099"></a><span class="lineno"> 5099</span>      $linkStatus[] = [</div>
<div class="line"><a id="l05100" name="l05100"></a><span class="lineno"> 5100</span>        <span class="stringliteral">&#39;url&#39;</span> =&gt; $href,</div>
<div class="line"><a id="l05101" name="l05101"></a><span class="lineno"> 5101</span>        <span class="stringliteral">&#39;text&#39;</span> =&gt; $text,</div>
<div class="line"><a id="l05102" name="l05102"></a><span class="lineno"> 5102</span>        <span class="stringliteral">&#39;status&#39;</span> =&gt; $thisLinkGood,</div>
<div class="line"><a id="l05103" name="l05103"></a><span class="lineno"> 5103</span>      ];</div>
<div class="line"><a id="l05104" name="l05104"></a><span class="lineno"> 5104</span>      $hasErrors = $hasErrors || ! $thisLinkGood;</div>
<div class="line"><a id="l05105" name="l05105"></a><span class="lineno"> 5105</span>    }</div>
<div class="line"><a id="l05106" name="l05106"></a><span class="lineno"> 5106</span> </div>
<div class="line"><a id="l05107" name="l05107"></a><span class="lineno"> 5107</span>    $goodLinks = array_filter($linkStatus, fn($info) =&gt; $info[<span class="stringliteral">&#39;status&#39;</span>]);</div>
<div class="line"><a id="l05108" name="l05108"></a><span class="lineno"> 5108</span>    $badLinks =  array_filter($linkStatus, fn($info) =&gt; !$info[<span class="stringliteral">&#39;status&#39;</span>]);</div>
<div class="line"><a id="l05109" name="l05109"></a><span class="lineno"> 5109</span>    $this-&gt;diagnostics[self::DIAGNOSTICS_EXTERNAL_LINK_VALIDATION] = [</div>
<div class="line"><a id="l05110" name="l05110"></a><span class="lineno"> 5110</span>      <span class="stringliteral">&#39;Status&#39;</span> =&gt; !$hasErrors,</div>
<div class="line"><a id="l05111" name="l05111"></a><span class="lineno"> 5111</span>      <span class="stringliteral">&#39;All&#39;</span> =&gt; $linkStatus,</div>
<div class="line"><a id="l05112" name="l05112"></a><span class="lineno"> 5112</span>      <span class="stringliteral">&#39;Good&#39;</span> =&gt; $goodLinks,</div>
<div class="line"><a id="l05113" name="l05113"></a><span class="lineno"> 5113</span>      <span class="stringliteral">&#39;Bad&#39;</span> =&gt;  $badLinks,</div>
<div class="line"><a id="l05114" name="l05114"></a><span class="lineno"> 5114</span>    ];</div>
<div class="line"><a id="l05115" name="l05115"></a><span class="lineno"> 5115</span> </div>
<div class="line"><a id="l05116" name="l05116"></a><span class="lineno"> 5116</span>    <span class="keywordflow">if</span> ($hasErrors) {</div>
<div class="line"><a id="l05117" name="l05117"></a><span class="lineno"> 5117</span>      $this-&gt;executionStatus = <span class="keyword">false</span>;</div>
<div class="line"><a id="l05118" name="l05118"></a><span class="lineno"> 5118</span>    }</div>
<div class="line"><a id="l05119" name="l05119"></a><span class="lineno"> 5119</span> </div>
<div class="line"><a id="l05120" name="l05120"></a><span class="lineno"> 5120</span>    <span class="keywordflow">return</span> !$hasErrors;</div>
<div class="line"><a id="l05121" name="l05121"></a><span class="lineno"> 5121</span>  }</div>
<div class="line"><a id="l05122" name="l05122"></a><span class="lineno"> 5122</span> </div>
<div class="line"><a id="l05133" name="l05133"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#adda03ec92a7028324dd0f3d882e975ba"> 5133</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#adda03ec92a7028324dd0f3d882e975ba">blankTemplateAttachments</a>():array</div>
<div class="line"><a id="l05134" name="l05134"></a><span class="lineno"> 5134</span>  {</div>
<div class="line"><a id="l05135" name="l05135"></a><span class="lineno"> 5135</span>    <span class="keywordflow">if</span> ($this-&gt;templateFileAttachments !== <span class="keyword">null</span>) {</div>
<div class="line"><a id="l05136" name="l05136"></a><span class="lineno"> 5136</span>      <span class="keywordflow">return</span> $this-&gt;templateFileAttachments;</div>
<div class="line"><a id="l05137" name="l05137"></a><span class="lineno"> 5137</span>    }</div>
<div class="line"><a id="l05138" name="l05138"></a><span class="lineno"> 5138</span> </div>
<div class="line"><a id="l05139" name="l05139"></a><span class="lineno"> 5139</span>    $selectedAttachments = array_flip($this-&gt;cgiValue(<span class="stringliteral">&#39;attachedFiles&#39;</span>, []));</div>
<div class="line"><a id="l05140" name="l05140"></a><span class="lineno"> 5140</span> </div>
<div class="line"><a id="l05141" name="l05141"></a><span class="lineno"> 5141</span>    $this-&gt;templateFileAttachments = [];</div>
<div class="line"><a id="l05142" name="l05142"></a><span class="lineno"> 5142</span> </div>
<div class="line"><a id="l05143" name="l05143"></a><span class="lineno"> 5143</span>    $origin = AttachmentOrigin::TEMPLATE;</div>
<div class="line"><a id="l05144" name="l05144"></a><span class="lineno"> 5144</span> </div>
<div class="line"><a id="l05145" name="l05145"></a><span class="lineno"> 5145</span>    $templateAttachments = [];</div>
<div class="line"><a id="l05146" name="l05146"></a><span class="lineno"> 5146</span>    <span class="keywordflow">foreach</span> (ConfigService::DOCUMENT_TEMPLATES as $templateId =&gt; $documentTemplate) {</div>
<div class="line"><a id="l05147" name="l05147"></a><span class="lineno"> 5147</span>      <span class="keywordflow">if</span> ($documentTemplate[<span class="stringliteral">&#39;type&#39;</span>] != ConfigService::DOCUMENT_TYPE_TEMPLATE</div>
<div class="line"><a id="l05148" name="l05148"></a><span class="lineno"> 5148</span>          || !$documentTemplate[<span class="stringliteral">&#39;blank&#39;</span>]) {</div>
<div class="line"><a id="l05149" name="l05149"></a><span class="lineno"> 5149</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l05150" name="l05150"></a><span class="lineno"> 5150</span>      }</div>
<div class="line"><a id="l05151" name="l05151"></a><span class="lineno"> 5151</span>      $attachment = [</div>
<div class="line"><a id="l05152" name="l05152"></a><span class="lineno"> 5152</span>        <span class="stringliteral">&#39;value&#39;</span> =&gt; <span class="stringliteral">&#39;template_id&#39;</span>,</div>
<div class="line"><a id="l05153" name="l05153"></a><span class="lineno"> 5153</span>        <span class="stringliteral">&#39;template_id&#39;</span> =&gt; $templateId,</div>
<div class="line"><a id="l05154" name="l05154"></a><span class="lineno"> 5154</span>        <span class="stringliteral">&#39;name&#39;</span> =&gt; $this-&gt;l-&gt;t($documentTemplate[<span class="stringliteral">&#39;name&#39;</span>]),</div>
<div class="line"><a id="l05155" name="l05155"></a><span class="lineno"> 5155</span>        <span class="stringliteral">&#39;origin&#39;</span> =&gt; $origin,</div>
<div class="line"><a id="l05156" name="l05156"></a><span class="lineno"> 5156</span>        <span class="stringliteral">&#39;sub_selection&#39;</span> =&gt; <span class="keyword">false</span>,</div>
<div class="line"><a id="l05157" name="l05157"></a><span class="lineno"> 5157</span>      ];</div>
<div class="line"><a id="l05158" name="l05158"></a><span class="lineno"> 5158</span>      <span class="keywordflow">if</span> (isset($selectedAttachments[$origin . <span class="charliteral">&#39;:&#39;</span> . $attachment[$attachment[<span class="stringliteral">&#39;value&#39;</span>]]])) {</div>
<div class="line"><a id="l05159" name="l05159"></a><span class="lineno"> 5159</span>        $attachment[<span class="stringliteral">&#39;status&#39;</span>] = <span class="stringliteral">&#39;selected&#39;</span>;</div>
<div class="line"><a id="l05160" name="l05160"></a><span class="lineno"> 5160</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l05161" name="l05161"></a><span class="lineno"> 5161</span>        $attachment[<span class="stringliteral">&#39;status&#39;</span>] = <span class="stringliteral">&#39;inactive&#39;</span>;</div>
<div class="line"><a id="l05162" name="l05162"></a><span class="lineno"> 5162</span>      }</div>
<div class="line"><a id="l05163" name="l05163"></a><span class="lineno"> 5163</span>      $templateAttachments[] = $attachment;</div>
<div class="line"><a id="l05164" name="l05164"></a><span class="lineno"> 5164</span>    }</div>
<div class="line"><a id="l05165" name="l05165"></a><span class="lineno"> 5165</span> </div>
<div class="line"><a id="l05166" name="l05166"></a><span class="lineno"> 5166</span>    $comparator = <span class="keyword">function</span>($a, $b) {</div>
<div class="line"><a id="l05167" name="l05167"></a><span class="lineno"> 5167</span>      <span class="keywordflow">return</span> strcmp(</div>
<div class="line"><a id="l05168" name="l05168"></a><span class="lineno"> 5168</span>        $a[<span class="stringliteral">&#39;origin&#39;</span>].$a[<span class="stringliteral">&#39;name&#39;</span>],</div>
<div class="line"><a id="l05169" name="l05169"></a><span class="lineno"> 5169</span>        $b[<span class="stringliteral">&#39;origin&#39;</span>].$b[<span class="stringliteral">&#39;name&#39;</span>]</div>
<div class="line"><a id="l05170" name="l05170"></a><span class="lineno"> 5170</span>      );</div>
<div class="line"><a id="l05171" name="l05171"></a><span class="lineno"> 5171</span>    };</div>
<div class="line"><a id="l05172" name="l05172"></a><span class="lineno"> 5172</span>    usort($templateAttachments, $comparator);</div>
<div class="line"><a id="l05173" name="l05173"></a><span class="lineno"> 5173</span> </div>
<div class="line"><a id="l05174" name="l05174"></a><span class="lineno"> 5174</span>    <span class="keywordflow">return</span> $this-&gt;templateFileAttachments = $templateAttachments;</div>
<div class="line"><a id="l05175" name="l05175"></a><span class="lineno"> 5175</span>  }</div>
<div class="line"><a id="l05176" name="l05176"></a><span class="lineno"> 5176</span> </div>
<div class="line"><a id="l05194" name="l05194"></a><span class="lineno"> 5194</span>  <span class="keyword">private</span> <span class="keyword">function</span> personalAttachments()</div>
<div class="line"><a id="l05195" name="l05195"></a><span class="lineno"> 5195</span>  {</div>
<div class="line"><a id="l05196" name="l05196"></a><span class="lineno"> 5196</span>    <span class="keywordflow">if</span> ($this-&gt;personalFileAttachments !== <span class="keyword">null</span>) {</div>
<div class="line"><a id="l05197" name="l05197"></a><span class="lineno"> 5197</span>      <span class="keywordflow">return</span> $this-&gt;personalFileAttachments;</div>
<div class="line"><a id="l05198" name="l05198"></a><span class="lineno"> 5198</span>    }</div>
<div class="line"><a id="l05199" name="l05199"></a><span class="lineno"> 5199</span> </div>
<div class="line"><a id="l05200" name="l05200"></a><span class="lineno"> 5200</span>    <span class="keywordflow">if</span> (empty($this-&gt;project)) {</div>
<div class="line"><a id="l05201" name="l05201"></a><span class="lineno"> 5201</span>      $this-&gt;personalFileAttachments = [];</div>
<div class="line"><a id="l05202" name="l05202"></a><span class="lineno"> 5202</span>      <span class="keywordflow">return</span> $this-&gt;personalFileAttachments;</div>
<div class="line"><a id="l05203" name="l05203"></a><span class="lineno"> 5203</span>    }</div>
<div class="line"><a id="l05204" name="l05204"></a><span class="lineno"> 5204</span>    $selectedAttachments = array_flip($this-&gt;cgiValue(<span class="stringliteral">&#39;attachedFiles&#39;</span>, []));</div>
<div class="line"><a id="l05205" name="l05205"></a><span class="lineno"> 5205</span> </div>
<div class="line"><a id="l05206" name="l05206"></a><span class="lineno"> 5206</span>    <span class="comment">// add participant fields data if present</span></div>
<div class="line"><a id="l05207" name="l05207"></a><span class="lineno"> 5207</span>    $this-&gt;personalFileAttachments = [];</div>
<div class="line"><a id="l05208" name="l05208"></a><span class="lineno"> 5208</span> </div>
<div class="line"><a id="l05209" name="l05209"></a><span class="lineno"> 5209</span>    $origin = AttachmentOrigin::PARTICIPANT_FIELD;</div>
<div class="line"><a id="l05210" name="l05210"></a><span class="lineno"> 5210</span> </div>
<div class="line"><a id="l05211" name="l05211"></a><span class="lineno"> 5211</span>    $generalAttachments = [];</div>
<div class="line"><a id="l05212" name="l05212"></a><span class="lineno"> 5212</span>    $serviceFeeAttachments = [];</div>
<div class="line"><a id="l05213" name="l05213"></a><span class="lineno"> 5213</span>    $templateAttachments = [];</div>
<div class="line"><a id="l05214" name="l05214"></a><span class="lineno"> 5214</span> </div>
<div class="line"><a id="l05216" name="l05216"></a><span class="lineno"> 5216</span>    <span class="keywordflow">foreach</span> ($this-&gt;project-&gt;getParticipantFields() as $participantField) {</div>
<div class="line"><a id="l05217" name="l05217"></a><span class="lineno"> 5217</span>      $fieldType = $participantField-&gt;getDataType();</div>
<div class="line"><a id="l05218" name="l05218"></a><span class="lineno"> 5218</span>      <span class="keywordflow">if</span> ($fieldType != FieldType::CLOUD_FILE</div>
<div class="line"><a id="l05219" name="l05219"></a><span class="lineno"> 5219</span>          &amp;&amp; $fieldType != FieldType::CLOUD_FOLDER</div>
<div class="line"><a id="l05220" name="l05220"></a><span class="lineno"> 5220</span>          &amp;&amp; $fieldType != FieldType::DB_FILE</div>
<div class="line"><a id="l05221" name="l05221"></a><span class="lineno"> 5221</span>          &amp;&amp; $fieldType != FieldType::RECEIVABLES</div>
<div class="line"><a id="l05222" name="l05222"></a><span class="lineno"> 5222</span>          &amp;&amp; $fieldType != FieldType::LIABILITIES</div>
<div class="line"><a id="l05223" name="l05223"></a><span class="lineno"> 5223</span>      ) {</div>
<div class="line"><a id="l05224" name="l05224"></a><span class="lineno"> 5224</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l05225" name="l05225"></a><span class="lineno"> 5225</span>      }</div>
<div class="line"><a id="l05226" name="l05226"></a><span class="lineno"> 5226</span>      $fieldId = $participantField-&gt;getId();</div>
<div class="line"><a id="l05227" name="l05227"></a><span class="lineno"> 5227</span>      $fieldName = $participantField-&gt;getName();</div>
<div class="line"><a id="l05228" name="l05228"></a><span class="lineno"> 5228</span>      $attachment = [</div>
<div class="line"><a id="l05229" name="l05229"></a><span class="lineno"> 5229</span>        <span class="stringliteral">&#39;value&#39;</span> =&gt; <span class="stringliteral">&#39;field_id&#39;</span>,</div>
<div class="line"><a id="l05230" name="l05230"></a><span class="lineno"> 5230</span>        <span class="stringliteral">&#39;field_id&#39;</span> =&gt; $fieldId,</div>
<div class="line"><a id="l05231" name="l05231"></a><span class="lineno"> 5231</span>        <span class="stringliteral">&#39;name&#39;</span> =&gt; $fieldName,</div>
<div class="line"><a id="l05232" name="l05232"></a><span class="lineno"> 5232</span>        <span class="stringliteral">&#39;origin&#39;</span> =&gt; $origin,</div>
<div class="line"><a id="l05233" name="l05233"></a><span class="lineno"> 5233</span>        <span class="stringliteral">&#39;sub_selection&#39;</span> =&gt; <span class="keyword">false</span>,</div>
<div class="line"><a id="l05234" name="l05234"></a><span class="lineno"> 5234</span>        <span class="stringliteral">&#39;sub_options&#39;</span> =&gt; [],</div>
<div class="line"><a id="l05235" name="l05235"></a><span class="lineno"> 5235</span>      ];</div>
<div class="line"><a id="l05236" name="l05236"></a><span class="lineno"> 5236</span>      <span class="keywordflow">if</span> (isset($selectedAttachments[$origin . <span class="charliteral">&#39;:&#39;</span> . $attachment[$attachment[<span class="stringliteral">&#39;value&#39;</span>]]])) {</div>
<div class="line"><a id="l05237" name="l05237"></a><span class="lineno"> 5237</span>        $attachment[<span class="stringliteral">&#39;status&#39;</span>] = <span class="stringliteral">&#39;selected&#39;</span>;</div>
<div class="line"><a id="l05238" name="l05238"></a><span class="lineno"> 5238</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l05239" name="l05239"></a><span class="lineno"> 5239</span>        $attachment[<span class="stringliteral">&#39;status&#39;</span>] = <span class="stringliteral">&#39;inactive&#39;</span>;</div>
<div class="line"><a id="l05240" name="l05240"></a><span class="lineno"> 5240</span>      }</div>
<div class="line"><a id="l05241" name="l05241"></a><span class="lineno"> 5241</span>      <span class="keywordflow">if</span> ($fieldType == FieldType::RECEIVABLES || $fieldType == FieldType::LIABILITIES) {</div>
<div class="line"><a id="l05242" name="l05242"></a><span class="lineno"> 5242</span>        $attachment[<span class="stringliteral">&#39;sub_topic&#39;</span>] = <span class="stringliteral">&#39;bills and receipts&#39;</span>;</div>
<div class="line"><a id="l05243" name="l05243"></a><span class="lineno"> 5243</span>        <span class="comment">// split only the recurring receivables as there may be so many of them ...</span></div>
<div class="line"><a id="l05244" name="l05244"></a><span class="lineno"> 5244</span>        <span class="keywordflow">if</span> ($participantField-&gt;getMultiplicity() == FieldMultiplicity::RECURRING) {</div>
<div class="line"><a id="l05245" name="l05245"></a><span class="lineno"> 5245</span>          <span class="comment">// add sub-options in the same manner</span></div>
<div class="line"><a id="l05247" name="l05247"></a><span class="lineno"> 5247</span><span class="comment"></span>          <span class="keywordflow">foreach</span> ($participantField-&gt;getSelectableOptions() as $option) {</div>
<div class="line"><a id="l05248" name="l05248"></a><span class="lineno"> 5248</span>            $label = $option-&gt;getLabel();</div>
<div class="line"><a id="l05249" name="l05249"></a><span class="lineno"> 5249</span>            <span class="keywordflow">if</span> (strpos($label, $fieldName) !== 0) {</div>
<div class="line"><a id="l05250" name="l05250"></a><span class="lineno"> 5250</span>              $label = $fieldName . <span class="stringliteral">&#39; - &#39;</span> . $label;</div>
<div class="line"><a id="l05251" name="l05251"></a><span class="lineno"> 5251</span>            }</div>
<div class="line"><a id="l05252" name="l05252"></a><span class="lineno"> 5252</span>            $subOption = [</div>
<div class="line"><a id="l05253" name="l05253"></a><span class="lineno"> 5253</span>              <span class="stringliteral">&#39;value&#39;</span> =&gt; <span class="stringliteral">&#39;option_key&#39;</span>,</div>
<div class="line"><a id="l05254" name="l05254"></a><span class="lineno"> 5254</span>              <span class="stringliteral">&#39;option_key&#39;</span> =&gt; (string)$option-&gt;getKey(),</div>
<div class="line"><a id="l05255" name="l05255"></a><span class="lineno"> 5255</span>              <span class="stringliteral">&#39;name&#39;</span> =&gt; $label,</div>
<div class="line"><a id="l05256" name="l05256"></a><span class="lineno"> 5256</span>              <span class="stringliteral">&#39;origin&#39;</span> =&gt; $origin . <span class="stringliteral">&#39;-option&#39;</span>,</div>
<div class="line"><a id="l05257" name="l05257"></a><span class="lineno"> 5257</span>            ];</div>
<div class="line"><a id="l05258" name="l05258"></a><span class="lineno"> 5258</span>            <span class="keywordflow">if</span> (isset($selectedAttachments[$origin . <span class="charliteral">&#39;:&#39;</span> . $attachment[$attachment[<span class="stringliteral">&#39;value&#39;</span>]] . <span class="charliteral">&#39;:&#39;</span> . $subOption[$subOption[<span class="stringliteral">&#39;value&#39;</span>]]])) {</div>
<div class="line"><a id="l05259" name="l05259"></a><span class="lineno"> 5259</span>              $subOption[<span class="stringliteral">&#39;status&#39;</span>] = <span class="stringliteral">&#39;selected&#39;</span>;</div>
<div class="line"><a id="l05260" name="l05260"></a><span class="lineno"> 5260</span>              $attachment[<span class="stringliteral">&#39;sub_selection&#39;</span>] = <span class="keyword">true</span>;</div>
<div class="line"><a id="l05261" name="l05261"></a><span class="lineno"> 5261</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l05262" name="l05262"></a><span class="lineno"> 5262</span>              $subOption[<span class="stringliteral">&#39;status&#39;</span>] = <span class="stringliteral">&#39;inactive&#39;</span>;</div>
<div class="line"><a id="l05263" name="l05263"></a><span class="lineno"> 5263</span>            }</div>
<div class="line"><a id="l05264" name="l05264"></a><span class="lineno"> 5264</span>            $attachment[<span class="stringliteral">&#39;sub_options&#39;</span>][] = $subOption;</div>
<div class="line"><a id="l05265" name="l05265"></a><span class="lineno"> 5265</span>          }</div>
<div class="line"><a id="l05266" name="l05266"></a><span class="lineno"> 5266</span>          usort($attachment[<span class="stringliteral">&#39;sub_options&#39;</span>], fn($a, $b) =&gt; strcmp($a[<span class="stringliteral">&#39;name&#39;</span>], $b[<span class="stringliteral">&#39;name&#39;</span>]));</div>
<div class="line"><a id="l05267" name="l05267"></a><span class="lineno"> 5267</span>        }</div>
<div class="line"><a id="l05268" name="l05268"></a><span class="lineno"> 5268</span>        $serviceFeeAttachments[] = $attachment;</div>
<div class="line"><a id="l05269" name="l05269"></a><span class="lineno"> 5269</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l05270" name="l05270"></a><span class="lineno"> 5270</span>        $attachment[<span class="stringliteral">&#39;sub_topic&#39;</span>] = <span class="stringliteral">&#39;general&#39;</span>;</div>
<div class="line"><a id="l05271" name="l05271"></a><span class="lineno"> 5271</span>        $generalAttachments[] = $attachment;</div>
<div class="line"><a id="l05272" name="l05272"></a><span class="lineno"> 5272</span>      }</div>
<div class="line"><a id="l05273" name="l05273"></a><span class="lineno"> 5273</span>    }</div>
<div class="line"><a id="l05274" name="l05274"></a><span class="lineno"> 5274</span> </div>
<div class="line"><a id="l05275" name="l05275"></a><span class="lineno"> 5275</span>    <span class="comment">// add also the global document templates</span></div>
<div class="line"><a id="l05276" name="l05276"></a><span class="lineno"> 5276</span>    <span class="keywordflow">foreach</span> (ConfigService::DOCUMENT_TEMPLATES as $templateId =&gt; $documentTemplate) {</div>
<div class="line"><a id="l05277" name="l05277"></a><span class="lineno"> 5277</span>      <span class="keywordflow">if</span> ($documentTemplate[<span class="stringliteral">&#39;type&#39;</span>] != ConfigService::DOCUMENT_TYPE_TEMPLATE) {</div>
<div class="line"><a id="l05278" name="l05278"></a><span class="lineno"> 5278</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l05279" name="l05279"></a><span class="lineno"> 5279</span>      }</div>
<div class="line"><a id="l05280" name="l05280"></a><span class="lineno"> 5280</span>      $attachment = [</div>
<div class="line"><a id="l05281" name="l05281"></a><span class="lineno"> 5281</span>        <span class="stringliteral">&#39;value&#39;</span> =&gt; <span class="stringliteral">&#39;template_id&#39;</span>,</div>
<div class="line"><a id="l05282" name="l05282"></a><span class="lineno"> 5282</span>        <span class="stringliteral">&#39;template_id&#39;</span> =&gt; $templateId,</div>
<div class="line"><a id="l05283" name="l05283"></a><span class="lineno"> 5283</span>        <span class="stringliteral">&#39;name&#39;</span> =&gt; $this-&gt;l-&gt;t($documentTemplate[<span class="stringliteral">&#39;name&#39;</span>]),</div>
<div class="line"><a id="l05284" name="l05284"></a><span class="lineno"> 5284</span>        <span class="stringliteral">&#39;origin&#39;</span> =&gt; $origin,</div>
<div class="line"><a id="l05285" name="l05285"></a><span class="lineno"> 5285</span>        <span class="stringliteral">&#39;sub_topic&#39;</span> =&gt; ConfigService::DOCUMENT_TYPE_TEMPLATE,</div>
<div class="line"><a id="l05286" name="l05286"></a><span class="lineno"> 5286</span>        <span class="stringliteral">&#39;sub_selection&#39;</span> =&gt; <span class="keyword">false</span>,</div>
<div class="line"><a id="l05287" name="l05287"></a><span class="lineno"> 5287</span>      ];</div>
<div class="line"><a id="l05288" name="l05288"></a><span class="lineno"> 5288</span>      $status = <span class="stringliteral">&#39;inactive&#39;</span>;</div>
<div class="line"><a id="l05289" name="l05289"></a><span class="lineno"> 5289</span>      <span class="keywordflow">if</span> (isset($selectedAttachments[$origin . <span class="charliteral">&#39;:&#39;</span> . $attachment[$attachment[<span class="stringliteral">&#39;value&#39;</span>]]])) {</div>
<div class="line"><a id="l05290" name="l05290"></a><span class="lineno"> 5290</span>        $status = <span class="stringliteral">&#39;selected&#39;</span>;</div>
<div class="line"><a id="l05291" name="l05291"></a><span class="lineno"> 5291</span>      } elseif (!empty($this-&gt;project) &amp;&amp; !empty($this-&gt;bulkTransaction) &amp;&amp; ($this-&gt;bulkTransaction instanceof Entities\SepaDebitNote)) {</div>
<div class="line"><a id="l05292" name="l05292"></a><span class="lineno"> 5292</span>        <span class="keywordflow">switch</span> ($templateId) {</div>
<div class="line"><a id="l05293" name="l05293"></a><span class="lineno"> 5293</span>          <span class="keywordflow">case</span> ConfigService::DOCUMENT_TEMPLATE_PROJECT_DEBIT_NOTE_MANDATE:</div>
<div class="line"><a id="l05294" name="l05294"></a><span class="lineno"> 5294</span>            <span class="keywordflow">if</span> ($this-&gt;project-&gt;getId() != $this-&gt;getClubMembersProjectId()) {</div>
<div class="line"><a id="l05295" name="l05295"></a><span class="lineno"> 5295</span>              $status = <span class="stringliteral">&#39;selected&#39;</span>;</div>
<div class="line"><a id="l05296" name="l05296"></a><span class="lineno"> 5296</span>            }</div>
<div class="line"><a id="l05297" name="l05297"></a><span class="lineno"> 5297</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l05298" name="l05298"></a><span class="lineno"> 5298</span>          <span class="keywordflow">case</span> ConfigService::DOCUMENT_TEMPLATE_MEMBER_DATA_UPDATE:</div>
<div class="line"><a id="l05299" name="l05299"></a><span class="lineno"> 5299</span>            <span class="keywordflow">if</span> ($this-&gt;project-&gt;getId() == $this-&gt;getClubMembersProjectId()) {</div>
<div class="line"><a id="l05300" name="l05300"></a><span class="lineno"> 5300</span>              $status = <span class="stringliteral">&#39;selected&#39;</span>;</div>
<div class="line"><a id="l05301" name="l05301"></a><span class="lineno"> 5301</span>            }</div>
<div class="line"><a id="l05302" name="l05302"></a><span class="lineno"> 5302</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l05303" name="l05303"></a><span class="lineno"> 5303</span>        }</div>
<div class="line"><a id="l05304" name="l05304"></a><span class="lineno"> 5304</span>      }</div>
<div class="line"><a id="l05305" name="l05305"></a><span class="lineno"> 5305</span>      $attachment[<span class="stringliteral">&#39;status&#39;</span>] = $status;</div>
<div class="line"><a id="l05306" name="l05306"></a><span class="lineno"> 5306</span>      $templateAttachments[] = $attachment;</div>
<div class="line"><a id="l05307" name="l05307"></a><span class="lineno"> 5307</span>    }</div>
<div class="line"><a id="l05308" name="l05308"></a><span class="lineno"> 5308</span> </div>
<div class="line"><a id="l05309" name="l05309"></a><span class="lineno"> 5309</span>    $comparator = <span class="keyword">function</span>($a, $b) {</div>
<div class="line"><a id="l05310" name="l05310"></a><span class="lineno"> 5310</span>      <span class="keywordflow">return</span> strcmp(</div>
<div class="line"><a id="l05311" name="l05311"></a><span class="lineno"> 5311</span>        $a[<span class="stringliteral">&#39;origin&#39;</span>].$a[<span class="stringliteral">&#39;sub_topic&#39;</span>].$a[<span class="stringliteral">&#39;name&#39;</span>],</div>
<div class="line"><a id="l05312" name="l05312"></a><span class="lineno"> 5312</span>        $b[<span class="stringliteral">&#39;origin&#39;</span>].$b[<span class="stringliteral">&#39;sub_topic&#39;</span>].$b[<span class="stringliteral">&#39;name&#39;</span>]</div>
<div class="line"><a id="l05313" name="l05313"></a><span class="lineno"> 5313</span>      );</div>
<div class="line"><a id="l05314" name="l05314"></a><span class="lineno"> 5314</span>    };</div>
<div class="line"><a id="l05315" name="l05315"></a><span class="lineno"> 5315</span>    usort($generalAttachments, $comparator);</div>
<div class="line"><a id="l05316" name="l05316"></a><span class="lineno"> 5316</span>    usort($serviceFeeAttachments, $comparator);</div>
<div class="line"><a id="l05317" name="l05317"></a><span class="lineno"> 5317</span>    usort($templateAttachments, $comparator);</div>
<div class="line"><a id="l05318" name="l05318"></a><span class="lineno"> 5318</span> </div>
<div class="line"><a id="l05319" name="l05319"></a><span class="lineno"> 5319</span>    $this-&gt;personalFileAttachments = array_merge($templateAttachments, $generalAttachments, $serviceFeeAttachments);</div>
<div class="line"><a id="l05320" name="l05320"></a><span class="lineno"> 5320</span> </div>
<div class="line"><a id="l05321" name="l05321"></a><span class="lineno"> 5321</span>    <span class="keywordflow">return</span> $this-&gt;personalFileAttachments;</div>
<div class="line"><a id="l05322" name="l05322"></a><span class="lineno"> 5322</span>  }</div>
<div class="line"><a id="l05323" name="l05323"></a><span class="lineno"> 5323</span> </div>
<div class="line"><a id="l05325" name="l05325"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a9e832998c1a0a41b681b857a6c47ce48"> 5325</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a9e832998c1a0a41b681b857a6c47ce48">activePersonalAttachments</a>():int</div>
<div class="line"><a id="l05326" name="l05326"></a><span class="lineno"> 5326</span>  {</div>
<div class="line"><a id="l05327" name="l05327"></a><span class="lineno"> 5327</span>    $numAttachments = 0;</div>
<div class="line"><a id="l05328" name="l05328"></a><span class="lineno"> 5328</span>    <span class="comment">// walk through the list of configured attachments and attach all requested.</span></div>
<div class="line"><a id="l05329" name="l05329"></a><span class="lineno"> 5329</span>    <span class="keywordflow">foreach</span> ($this-&gt;personalAttachments() as $attachment) {</div>
<div class="line"><a id="l05330" name="l05330"></a><span class="lineno"> 5330</span>      <span class="keywordflow">if</span> ($attachment[<span class="stringliteral">&#39;status&#39;</span>] != <span class="stringliteral">&#39;selected&#39;</span> &amp;&amp; !$attachment[<span class="stringliteral">&#39;sub_selection&#39;</span>]) {</div>
<div class="line"><a id="l05331" name="l05331"></a><span class="lineno"> 5331</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l05332" name="l05332"></a><span class="lineno"> 5332</span>      }</div>
<div class="line"><a id="l05333" name="l05333"></a><span class="lineno"> 5333</span>      ++$numAttachments;</div>
<div class="line"><a id="l05334" name="l05334"></a><span class="lineno"> 5334</span>    }</div>
<div class="line"><a id="l05335" name="l05335"></a><span class="lineno"> 5335</span>    <span class="keywordflow">return</span> $numAttachments;</div>
<div class="line"><a id="l05336" name="l05336"></a><span class="lineno"> 5336</span>  }</div>
<div class="line"><a id="l05337" name="l05337"></a><span class="lineno"> 5337</span> </div>
<div class="line"><a id="l05355" name="l05355"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a56fae4bd1b4337dfe78d90b051c93a01"> 5355</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a56fae4bd1b4337dfe78d90b051c93a01">fileAttachments</a>()</div>
<div class="line"><a id="l05356" name="l05356"></a><span class="lineno"> 5356</span>  {</div>
<div class="line"><a id="l05357" name="l05357"></a><span class="lineno"> 5357</span>    <span class="keywordflow">if</span> ($this-&gt;globalFileAttachments !== <span class="keyword">null</span>) {</div>
<div class="line"><a id="l05358" name="l05358"></a><span class="lineno"> 5358</span>      <span class="keywordflow">return</span> $this-&gt;globalFileAttachments;</div>
<div class="line"><a id="l05359" name="l05359"></a><span class="lineno"> 5359</span>    }</div>
<div class="line"><a id="l05360" name="l05360"></a><span class="lineno"> 5360</span> </div>
<div class="line"><a id="l05361" name="l05361"></a><span class="lineno"> 5361</span>    <span class="comment">// JSON encoded array</span></div>
<div class="line"><a id="l05362" name="l05362"></a><span class="lineno"> 5362</span>    $fileAttachJSON = $this-&gt;cgiValue(<span class="stringliteral">&#39;fileAttachments&#39;</span>, <span class="stringliteral">&#39;{}&#39;</span>);</div>
<div class="line"><a id="l05363" name="l05363"></a><span class="lineno"> 5363</span>    $fileAttach = json_decode($fileAttachJSON, <span class="keyword">true</span>);</div>
<div class="line"><a id="l05364" name="l05364"></a><span class="lineno"> 5364</span>    $selectedAttachments = array_flip($this-&gt;cgiValue(<span class="stringliteral">&#39;attachedFiles&#39;</span>, []));</div>
<div class="line"><a id="l05365" name="l05365"></a><span class="lineno"> 5365</span> </div>
<div class="line"><a id="l05366" name="l05366"></a><span class="lineno"> 5366</span>    $localFileAttach = [];</div>
<div class="line"><a id="l05367" name="l05367"></a><span class="lineno"> 5367</span>    $cloudFileAttach = [];</div>
<div class="line"><a id="l05368" name="l05368"></a><span class="lineno"> 5368</span>    <span class="keywordflow">foreach</span> (($fileAttach ?? []) as $origin =&gt; $attachment) {</div>
<div class="line"><a id="l05369" name="l05369"></a><span class="lineno"> 5369</span>      $attachment[<span class="stringliteral">&#39;value&#39;</span>] = <span class="stringliteral">&#39;tmp_name&#39;</span>;</div>
<div class="line"><a id="l05370" name="l05370"></a><span class="lineno"> 5370</span>      $origin = $attachment[<span class="stringliteral">&#39;origin&#39;</span>];</div>
<div class="line"><a id="l05371" name="l05371"></a><span class="lineno"> 5371</span>      <span class="keywordflow">if</span> ($attachment[<span class="stringliteral">&#39;status&#39;</span>] == <span class="stringliteral">&#39;new&#39;</span>) {</div>
<div class="line"><a id="l05372" name="l05372"></a><span class="lineno"> 5372</span>        $attachment[<span class="stringliteral">&#39;status&#39;</span>] = <span class="stringliteral">&#39;selected&#39;</span>;</div>
<div class="line"><a id="l05373" name="l05373"></a><span class="lineno"> 5373</span>      } elseif (isset($selectedAttachments[$origin . <span class="charliteral">&#39;:&#39;</span> . $attachment[<span class="stringliteral">&#39;tmp_name&#39;</span>]])) {</div>
<div class="line"><a id="l05374" name="l05374"></a><span class="lineno"> 5374</span>        $attachment[<span class="stringliteral">&#39;status&#39;</span>] = <span class="stringliteral">&#39;selected&#39;</span>;</div>
<div class="line"><a id="l05375" name="l05375"></a><span class="lineno"> 5375</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l05376" name="l05376"></a><span class="lineno"> 5376</span>        $attachment[<span class="stringliteral">&#39;status&#39;</span>] = <span class="stringliteral">&#39;inactive&#39;</span>;</div>
<div class="line"><a id="l05377" name="l05377"></a><span class="lineno"> 5377</span>      }</div>
<div class="line"><a id="l05378" name="l05378"></a><span class="lineno"> 5378</span>      <span class="comment">// Keep only the basename part as the folder is programmatically fixed.</span></div>
<div class="line"><a id="l05379" name="l05379"></a><span class="lineno"> 5379</span>      $attachment[<span class="stringliteral">&#39;name&#39;</span>] = basename($attachment[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l05380" name="l05380"></a><span class="lineno"> 5380</span>      <span class="keywordflow">if</span> ($attachment[<span class="stringliteral">&#39;origin&#39;</span>] == AttachmentOrigin::CLOUD) {</div>
<div class="line"><a id="l05381" name="l05381"></a><span class="lineno"> 5381</span>        $cloudFileAttach[] = $attachment;</div>
<div class="line"><a id="l05382" name="l05382"></a><span class="lineno"> 5382</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l05383" name="l05383"></a><span class="lineno"> 5383</span>        $localFileAttach[] = $attachment;</div>
<div class="line"><a id="l05384" name="l05384"></a><span class="lineno"> 5384</span>      }</div>
<div class="line"><a id="l05385" name="l05385"></a><span class="lineno"> 5385</span>    }</div>
<div class="line"><a id="l05386" name="l05386"></a><span class="lineno"> 5386</span> </div>
<div class="line"><a id="l05387" name="l05387"></a><span class="lineno"> 5387</span>    $comparator = fn($a, $b) =&gt; strcmp($a[<span class="stringliteral">&#39;name&#39;</span>], $b[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l05388" name="l05388"></a><span class="lineno"> 5388</span>    usort($cloudFileAttach, $comparator);</div>
<div class="line"><a id="l05389" name="l05389"></a><span class="lineno"> 5389</span>    usort($localFileAttach, $comparator);</div>
<div class="line"><a id="l05390" name="l05390"></a><span class="lineno"> 5390</span> </div>
<div class="line"><a id="l05391" name="l05391"></a><span class="lineno"> 5391</span>    $this-&gt;globalFileAttachments = array_merge($localFileAttach, $cloudFileAttach);</div>
<div class="line"><a id="l05392" name="l05392"></a><span class="lineno"> 5392</span> </div>
<div class="line"><a id="l05393" name="l05393"></a><span class="lineno"> 5393</span>    <span class="keywordflow">return</span> $this-&gt;globalFileAttachments;</div>
<div class="line"><a id="l05394" name="l05394"></a><span class="lineno"> 5394</span>  }</div>
<div class="line"><a id="l05395" name="l05395"></a><span class="lineno"> 5395</span> </div>
<div class="line"><a id="l05402" name="l05402"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a64924c3e38450824617993e28ac40b3e"> 5402</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a64924c3e38450824617993e28ac40b3e">fileAttachmentOptions</a>():array</div>
<div class="line"><a id="l05403" name="l05403"></a><span class="lineno"> 5403</span>  {</div>
<div class="line"><a id="l05404" name="l05404"></a><span class="lineno"> 5404</span>    $fileAttachments = array_merge($this-&gt;fileAttachments(), $this-&gt;blankTemplateAttachments(), $this-&gt;personalAttachments());</div>
<div class="line"><a id="l05405" name="l05405"></a><span class="lineno"> 5405</span> </div>
<div class="line"><a id="l05406" name="l05406"></a><span class="lineno"> 5406</span>    $selectOptions = [];</div>
<div class="line"><a id="l05407" name="l05407"></a><span class="lineno"> 5407</span>    <span class="keywordflow">foreach</span> ($fileAttachments as $attachment) {</div>
<div class="line"><a id="l05408" name="l05408"></a><span class="lineno"> 5408</span>      $value = $attachment[$attachment[<span class="stringliteral">&#39;value&#39;</span>]];</div>
<div class="line"><a id="l05409" name="l05409"></a><span class="lineno"> 5409</span>      $name = $attachment[<span class="stringliteral">&#39;name&#39;</span>];</div>
<div class="line"><a id="l05410" name="l05410"></a><span class="lineno"> 5410</span>      <span class="keywordflow">if</span> (isset($attachment[<span class="stringliteral">&#39;size&#39;</span>])) {</div>
<div class="line"><a id="l05411" name="l05411"></a><span class="lineno"> 5411</span>        $size = \OC_Helper::humanFileSize($attachment[<span class="stringliteral">&#39;size&#39;</span>]);</div>
<div class="line"><a id="l05412" name="l05412"></a><span class="lineno"> 5412</span>        $name .= <span class="stringliteral">&#39; (&#39;</span> . $size . <span class="charliteral">&#39;)&#39;</span>;</div>
<div class="line"><a id="l05413" name="l05413"></a><span class="lineno"> 5413</span>      }</div>
<div class="line"><a id="l05414" name="l05414"></a><span class="lineno"> 5414</span>      $origin = $attachment[<span class="stringliteral">&#39;origin&#39;</span>];</div>
<div class="line"><a id="l05415" name="l05415"></a><span class="lineno"> 5415</span>      <span class="keywordflow">switch</span> ($origin) {</div>
<div class="line"><a id="l05416" name="l05416"></a><span class="lineno"> 5416</span>        <span class="keywordflow">case</span> AttachmentOrigin::TEMPLATE:</div>
<div class="line"><a id="l05417" name="l05417"></a><span class="lineno"> 5417</span>          $group = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Blank Template&#39;</span>);</div>
<div class="line"><a id="l05418" name="l05418"></a><span class="lineno"> 5418</span>          $name .= <span class="stringliteral">&#39; (&#39;</span> . $this-&gt;l-&gt;t(<span class="stringliteral">&#39;blank&#39;</span>) . <span class="charliteral">&#39;)&#39;</span>;</div>
<div class="line"><a id="l05419" name="l05419"></a><span class="lineno"> 5419</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l05420" name="l05420"></a><span class="lineno"> 5420</span>        <span class="keywordflow">case</span> AttachmentOrigin::PARTICIPANT_FIELD:</div>
<div class="line"><a id="l05421" name="l05421"></a><span class="lineno"> 5421</span>          $group = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Personalized&#39;</span>);</div>
<div class="line"><a id="l05422" name="l05422"></a><span class="lineno"> 5422</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l05423" name="l05423"></a><span class="lineno"> 5423</span>        <span class="keywordflow">case</span> AttachmentOrigin::CLOUD:</div>
<div class="line"><a id="l05424" name="l05424"></a><span class="lineno"> 5424</span>          $group = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Cloud&#39;</span>);</div>
<div class="line"><a id="l05425" name="l05425"></a><span class="lineno"> 5425</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l05426" name="l05426"></a><span class="lineno"> 5426</span>        <span class="keywordflow">case</span> AttachmentOrigin::UPLOAD:</div>
<div class="line"><a id="l05427" name="l05427"></a><span class="lineno"> 5427</span>          $group = $this-&gt;l-&gt;t(<span class="stringliteral">&#39;Local Filesystem&#39;</span>);</div>
<div class="line"><a id="l05428" name="l05428"></a><span class="lineno"> 5428</span>          <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l05429" name="l05429"></a><span class="lineno"> 5429</span>      }</div>
<div class="line"><a id="l05430" name="l05430"></a><span class="lineno"> 5430</span>      $groupData = [ <span class="stringliteral">&#39;origin&#39;</span> =&gt; $origin, ];</div>
<div class="line"><a id="l05431" name="l05431"></a><span class="lineno"> 5431</span>      <span class="keywordflow">if</span> (isset($attachment[<span class="stringliteral">&#39;sub_topic&#39;</span>])) {</div>
<div class="line"><a id="l05432" name="l05432"></a><span class="lineno"> 5432</span>        $group .= <span class="stringliteral">&#39; - &#39;</span> . $this-&gt;l-&gt;t($attachment[<span class="stringliteral">&#39;sub_topic&#39;</span>]);</div>
<div class="line"><a id="l05433" name="l05433"></a><span class="lineno"> 5433</span>        $groupData[<span class="stringliteral">&#39;sub_topic&#39;</span>] = $attachment[<span class="stringliteral">&#39;sub_topic&#39;</span>];</div>
<div class="line"><a id="l05434" name="l05434"></a><span class="lineno"> 5434</span>      }</div>
<div class="line"><a id="l05435" name="l05435"></a><span class="lineno"> 5435</span>      $selected = $attachment[<span class="stringliteral">&#39;status&#39;</span>] == <span class="stringliteral">&#39;selected&#39;</span>;</div>
<div class="line"><a id="l05436" name="l05436"></a><span class="lineno"> 5436</span>      $selectOption = [</div>
<div class="line"><a id="l05437" name="l05437"></a><span class="lineno"> 5437</span>        <span class="stringliteral">&#39;value&#39;</span> =&gt; $origin . <span class="charliteral">&#39;:&#39;</span> . $value,</div>
<div class="line"><a id="l05438" name="l05438"></a><span class="lineno"> 5438</span>        <span class="stringliteral">&#39;name&#39;</span> =&gt; $name,</div>
<div class="line"><a id="l05439" name="l05439"></a><span class="lineno"> 5439</span>        <span class="stringliteral">&#39;group&#39;</span> =&gt; $group,</div>
<div class="line"><a id="l05440" name="l05440"></a><span class="lineno"> 5440</span>        <span class="stringliteral">&#39;groupData&#39;</span> =&gt; $groupData,</div>
<div class="line"><a id="l05441" name="l05441"></a><span class="lineno"> 5441</span>        <span class="stringliteral">&#39;flags&#39;</span> =&gt; $selected ? PageNavigation::SELECTED : 0,</div>
<div class="line"><a id="l05442" name="l05442"></a><span class="lineno"> 5442</span>      ];</div>
<div class="line"><a id="l05443" name="l05443"></a><span class="lineno"> 5443</span>      $selectOptions[] = $selectOption;</div>
<div class="line"><a id="l05444" name="l05444"></a><span class="lineno"> 5444</span>      <span class="keywordflow">foreach</span> ($attachment[<span class="stringliteral">&#39;sub_options&#39;</span>]??[] as $subOption) {</div>
<div class="line"><a id="l05445" name="l05445"></a><span class="lineno"> 5445</span>        $selected = $attachment[<span class="stringliteral">&#39;status&#39;</span>] == <span class="stringliteral">&#39;selected&#39;</span></div>
<div class="line"><a id="l05446" name="l05446"></a><span class="lineno"> 5446</span>          || $subOption[<span class="stringliteral">&#39;status&#39;</span>] == <span class="stringliteral">&#39;selected&#39;</span>;</div>
<div class="line"><a id="l05447" name="l05447"></a><span class="lineno"> 5447</span>        $selectOptions[] = [</div>
<div class="line"><a id="l05448" name="l05448"></a><span class="lineno"> 5448</span>          <span class="stringliteral">&#39;value&#39;</span> =&gt; $selectOption[<span class="stringliteral">&#39;value&#39;</span>] . <span class="charliteral">&#39;:&#39;</span> . $subOption[$subOption[<span class="stringliteral">&#39;value&#39;</span>]],</div>
<div class="line"><a id="l05449" name="l05449"></a><span class="lineno"> 5449</span>          <span class="stringliteral">&#39;name&#39;</span> =&gt; $subOption[<span class="stringliteral">&#39;name&#39;</span>],</div>
<div class="line"><a id="l05450" name="l05450"></a><span class="lineno"> 5450</span>          <span class="stringliteral">&#39;group&#39;</span> =&gt; $selectOption[<span class="stringliteral">&#39;group&#39;</span>],</div>
<div class="line"><a id="l05451" name="l05451"></a><span class="lineno"> 5451</span>          <span class="stringliteral">&#39;groupData&#39;</span> =&gt; $groupData,</div>
<div class="line"><a id="l05452" name="l05452"></a><span class="lineno"> 5452</span>          <span class="stringliteral">&#39;flags&#39;</span> =&gt; $selected ? PageNavigation::SELECTED : 0,</div>
<div class="line"><a id="l05453" name="l05453"></a><span class="lineno"> 5453</span>          <span class="stringliteral">&#39;data&#39;</span> =&gt; [ <span class="stringliteral">&#39;parent&#39;</span> =&gt; $selectOption[<span class="stringliteral">&#39;value&#39;</span>] ],</div>
<div class="line"><a id="l05454" name="l05454"></a><span class="lineno"> 5454</span>        ];</div>
<div class="line"><a id="l05455" name="l05455"></a><span class="lineno"> 5455</span>      }</div>
<div class="line"><a id="l05456" name="l05456"></a><span class="lineno"> 5456</span>    }</div>
<div class="line"><a id="l05457" name="l05457"></a><span class="lineno"> 5457</span>    <span class="keywordflow">return</span> $selectOptions;</div>
<div class="line"><a id="l05458" name="l05458"></a><span class="lineno"> 5458</span>  }</div>
<div class="line"><a id="l05459" name="l05459"></a><span class="lineno"> 5459</span> </div>
<div class="line"><a id="l05468" name="l05468"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa7c51513462cc05bd28c79540a6d374a"> 5468</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa7c51513462cc05bd28c79540a6d374a">eventAttachments</a>()</div>
<div class="line"><a id="l05469" name="l05469"></a><span class="lineno"> 5469</span>  {</div>
<div class="line"><a id="l05470" name="l05470"></a><span class="lineno"> 5470</span>    $attachedEvents = $this-&gt;parameterService-&gt;getParam(</div>
<div class="line"><a id="l05471" name="l05471"></a><span class="lineno"> 5471</span>      <span class="stringliteral">&#39;eventSelect&#39;</span>, $this-&gt;cgiValue(<span class="stringliteral">&#39;attachedEvents&#39;</span>, []));</div>
<div class="line"><a id="l05472" name="l05472"></a><span class="lineno"> 5472</span>    $events = [];</div>
<div class="line"><a id="l05473" name="l05473"></a><span class="lineno"> 5473</span>    <span class="keywordflow">foreach</span> ($attachedEvents as $event) {</div>
<div class="line"><a id="l05474" name="l05474"></a><span class="lineno"> 5474</span>      $event = json_decode($event, <span class="keyword">true</span>);</div>
<div class="line"><a id="l05475" name="l05475"></a><span class="lineno"> 5475</span>      $events[$event[<span class="stringliteral">&#39;uri&#39;</span>]] = $event[<span class="stringliteral">&#39;calendarId&#39;</span>];</div>
<div class="line"><a id="l05476" name="l05476"></a><span class="lineno"> 5476</span>    }</div>
<div class="line"><a id="l05477" name="l05477"></a><span class="lineno"> 5477</span> </div>
<div class="line"><a id="l05478" name="l05478"></a><span class="lineno"> 5478</span>    <span class="keywordflow">return</span> $events;</div>
<div class="line"><a id="l05479" name="l05479"></a><span class="lineno"> 5479</span>  }</div>
<div class="line"><a id="l05480" name="l05480"></a><span class="lineno"> 5480</span> </div>
<div class="line"><a id="l05492" name="l05492"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a2e450981f16737e95f54c94543ae66cf"> 5492</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a2e450981f16737e95f54c94543ae66cf">eventAttachmentOptions</a>(mixed $projectId, array $attachedEvents):array</div>
<div class="line"><a id="l05493" name="l05493"></a><span class="lineno"> 5493</span>  {</div>
<div class="line"><a id="l05494" name="l05494"></a><span class="lineno"> 5494</span>    <span class="keywordflow">if</span> ($projectId &lt;= 0) {</div>
<div class="line"><a id="l05495" name="l05495"></a><span class="lineno"> 5495</span>      <span class="keywordflow">return</span> [];</div>
<div class="line"><a id="l05496" name="l05496"></a><span class="lineno"> 5496</span>    }</div>
<div class="line"><a id="l05497" name="l05497"></a><span class="lineno"> 5497</span> </div>
<div class="line"><a id="l05498" name="l05498"></a><span class="lineno"> 5498</span>    <span class="comment">// fetch all events for this project</span></div>
<div class="line"><a id="l05499" name="l05499"></a><span class="lineno"> 5499</span>    $events      = $this-&gt;eventsService-&gt;events($projectId);</div>
<div class="line"><a id="l05500" name="l05500"></a><span class="lineno"> 5500</span>    $dfltIds     = $this-&gt;eventsService-&gt;defaultCalendars();</div>
<div class="line"><a id="l05501" name="l05501"></a><span class="lineno"> 5501</span>    $eventMatrix = $this-&gt;eventsService-&gt;eventMatrix($events, $dfltIds);</div>
<div class="line"><a id="l05502" name="l05502"></a><span class="lineno"> 5502</span> </div>
<div class="line"><a id="l05503" name="l05503"></a><span class="lineno"> 5503</span>    <span class="comment">// timezone, locale</span></div>
<div class="line"><a id="l05504" name="l05504"></a><span class="lineno"> 5504</span>    $locale = $this-&gt;getLocale();</div>
<div class="line"><a id="l05505" name="l05505"></a><span class="lineno"> 5505</span>    $timezone = $this-&gt;getTimezone();</div>
<div class="line"><a id="l05506" name="l05506"></a><span class="lineno"> 5506</span> </div>
<div class="line"><a id="l05507" name="l05507"></a><span class="lineno"> 5507</span>    <span class="comment">// build the select option control array</span></div>
<div class="line"><a id="l05508" name="l05508"></a><span class="lineno"> 5508</span>    $selectOptions = [];</div>
<div class="line"><a id="l05509" name="l05509"></a><span class="lineno"> 5509</span>    <span class="keywordflow">foreach</span> ($eventMatrix as $eventGroup) {</div>
<div class="line"><a id="l05510" name="l05510"></a><span class="lineno"> 5510</span>      $group = $this-&gt;l-&gt;t($eventGroup[<span class="stringliteral">&#39;name&#39;</span>]);</div>
<div class="line"><a id="l05511" name="l05511"></a><span class="lineno"> 5511</span>      <span class="keywordflow">foreach</span> ($eventGroup[<span class="stringliteral">&#39;events&#39;</span>] as $event) {</div>
<div class="line"><a id="l05512" name="l05512"></a><span class="lineno"> 5512</span>        $datestring = $this-&gt;eventsService-&gt;briefEventDate($event, $timezone, $locale);</div>
<div class="line"><a id="l05513" name="l05513"></a><span class="lineno"> 5513</span>        $name = stripslashes($event[<span class="stringliteral">&#39;summary&#39;</span>]).<span class="stringliteral">&#39;, &#39;</span>.$datestring;</div>
<div class="line"><a id="l05514" name="l05514"></a><span class="lineno"> 5514</span>        $value = json_encode([ <span class="stringliteral">&#39;uri&#39;</span> =&gt; $event[<span class="stringliteral">&#39;uri&#39;</span>], <span class="stringliteral">&#39;calendarId&#39;</span> =&gt; $event[<span class="stringliteral">&#39;calendarid&#39;</span>], ]);</div>
<div class="line"><a id="l05515" name="l05515"></a><span class="lineno"> 5515</span>        $selectOptions[] = [</div>
<div class="line"><a id="l05516" name="l05516"></a><span class="lineno"> 5516</span>          <span class="stringliteral">&#39;value&#39;</span> =&gt; $value,</div>
<div class="line"><a id="l05517" name="l05517"></a><span class="lineno"> 5517</span>          <span class="stringliteral">&#39;name&#39;</span> =&gt; $name,</div>
<div class="line"><a id="l05518" name="l05518"></a><span class="lineno"> 5518</span>          <span class="stringliteral">&#39;group&#39;</span> =&gt; $group,</div>
<div class="line"><a id="l05519" name="l05519"></a><span class="lineno"> 5519</span>          <span class="stringliteral">&#39;flags&#39;</span> =&gt; isset($attachedEvents[$event[<span class="stringliteral">&#39;uri&#39;</span>]]) ? PageNavigation::SELECTED : 0</div>
<div class="line"><a id="l05520" name="l05520"></a><span class="lineno"> 5520</span>        ];</div>
<div class="line"><a id="l05521" name="l05521"></a><span class="lineno"> 5521</span>      }</div>
<div class="line"><a id="l05522" name="l05522"></a><span class="lineno"> 5522</span>    }</div>
<div class="line"><a id="l05523" name="l05523"></a><span class="lineno"> 5523</span>    <span class="keywordflow">return</span> $selectOptions;</div>
<div class="line"><a id="l05524" name="l05524"></a><span class="lineno"> 5524</span>  }</div>
<div class="line"><a id="l05525" name="l05525"></a><span class="lineno"> 5525</span> </div>
<div class="line"><a id="l05527" name="l05527"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8d6568d7a87ba2a132aa630bb5fd5f4f"> 5527</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8d6568d7a87ba2a132aa630bb5fd5f4f">executionStatus</a>():bool</div>
<div class="line"><a id="l05528" name="l05528"></a><span class="lineno"> 5528</span>  {</div>
<div class="line"><a id="l05529" name="l05529"></a><span class="lineno"> 5529</span>    <span class="keywordflow">return</span> $this-&gt;executionStatus;</div>
<div class="line"><a id="l05530" name="l05530"></a><span class="lineno"> 5530</span>  }</div>
<div class="line"><a id="l05531" name="l05531"></a><span class="lineno"> 5531</span> </div>
<div class="line"><a id="l05533" name="l05533"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a09b451e02c3719a4a66cc56ac4c2edea"> 5533</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a09b451e02c3719a4a66cc56ac4c2edea">errorStatus</a>():bool</div>
<div class="line"><a id="l05534" name="l05534"></a><span class="lineno"> 5534</span>  {</div>
<div class="line"><a id="l05535" name="l05535"></a><span class="lineno"> 5535</span>    <span class="keywordflow">return</span> !$this-&gt;executionStatus();</div>
<div class="line"><a id="l05536" name="l05536"></a><span class="lineno"> 5536</span>  }</div>
<div class="line"><a id="l05537" name="l05537"></a><span class="lineno"> 5537</span> </div>
<div class="line"><a id="l05539" name="l05539"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa928a4f761c6be57478c9424ceaf4c22"> 5539</a></span>  <span class="keyword">public</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa928a4f761c6be57478c9424ceaf4c22">statusDiagnostics</a>():array</div>
<div class="line"><a id="l05540" name="l05540"></a><span class="lineno"> 5540</span>  {</div>
<div class="line"><a id="l05541" name="l05541"></a><span class="lineno"> 5541</span>    <span class="keywordflow">return</span> $this-&gt;diagnostics;</div>
<div class="line"><a id="l05542" name="l05542"></a><span class="lineno"> 5542</span>  }</div>
<div class="line"><a id="l05543" name="l05543"></a><span class="lineno"> 5543</span> </div>
<div class="line"><a id="l05551" name="l05551"></a><span class="lineno"><a class="line" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a5a1b75120c97a555674c76ad7c1da6fb"> 5551</a></span>  <span class="keyword">private</span> <span class="keyword">function</span> <a class="code hl_function" href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a5a1b75120c97a555674c76ad7c1da6fb">formatExceptionMessage</a>(\Throwable $throwable):string</div>
<div class="line"><a id="l05552" name="l05552"></a><span class="lineno"> 5552</span>  {</div>
<div class="line"><a id="l05553" name="l05553"></a><span class="lineno"> 5553</span>    <span class="keywordflow">return</span> $this-&gt;l-&gt;t(<span class="stringliteral">&#39;code %1$d, %2$s:%3$d -- %4$s&#39;</span>, [</div>
<div class="line"><a id="l05554" name="l05554"></a><span class="lineno"> 5554</span>      $throwable-&gt;getCode(), $throwable-&gt;getFile(), $throwable-&gt;getLine(), $throwable-&gt;getMessage()</div>
<div class="line"><a id="l05555" name="l05555"></a><span class="lineno"> 5555</span>    ]);</div>
<div class="line"><a id="l05556" name="l05556"></a><span class="lineno"> 5556</span>  }</div>
<div class="line"><a id="l05557" name="l05557"></a><span class="lineno"> 5557</span>}</div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_background_job_1_1_cleanup_expired_downloads_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_background_job_1_1_cleanup_expired_downloads.html">OCA\CAFEVDB\BackgroundJob\CleanupExpiredDownloads</a></div><div class="ttdoc">Cleanup temporary file downloads where the share-link has expired.</div><div class="ttdef"><b>Definition:</b> <a href="_cleanup_expired_downloads_8php_source.html#l00048">CleanupExpiredDownloads.php:49</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html">OCA\CAFEVDB\Common\PHPMailer</a></div><div class="ttdoc">Slightly enhanced version of PHPMailer.</div><div class="ttdef"><b>Definition:</b> <a href="_p_h_p_mailer_8php_source.html#l00034">PHPMailer.php:35</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer_html_a09d71aa2b61683913b0c85db146eaaa5"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#a09d71aa2b61683913b0c85db146eaaa5">OCA\CAFEVDB\Common\PHPMailer\setProgressCallback</a></div><div class="ttdeci">setProgressCallback(callable $progressCallback)</div><div class="ttdef"><b>Definition:</b> <a href="_p_h_p_mailer_8php_source.html#l00135">PHPMailer.php:135</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer_html_a47e64d2b15ebd283026c4dbbe135c6fa"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#a47e64d2b15ebd283026c4dbbe135c6fa">OCA\CAFEVDB\Common\PHPMailer\generateMessageId</a></div><div class="ttdeci">generateMessageId()</div><div class="ttdoc">Generate a messsage id just like it would be generated by PHPMailer.</div><div class="ttdef"><b>Definition:</b> <a href="_p_h_p_mailer_8php_source.html#l00176">PHPMailer.php:176</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer_html_a791cd59480e37c707d9d3a3c5bd376bc"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#a791cd59480e37c707d9d3a3c5bd376bc">OCA\CAFEVDB\Common\PHPMailer\setReferences</a></div><div class="ttdeci">setReferences(array $references)</div><div class="ttdoc">Set the referenced message ids.</div><div class="ttdef"><b>Definition:</b> <a href="_p_h_p_mailer_8php_source.html#l00200">PHPMailer.php:200</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer_html_ac4f5ea2807846c4cfb8123f501a43959"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#ac4f5ea2807846c4cfb8123f501a43959">OCA\CAFEVDB\Common\PHPMailer\addReference</a></div><div class="ttdeci">addReference(string $messageId)</div><div class="ttdoc">Add a referenced message id.</div><div class="ttdef"><b>Definition:</b> <a href="_p_h_p_mailer_8php_source.html#l00188">PHPMailer.php:188</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer_html_ad7a38b4a534c0c810df6f217af6ffcb3"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#ad7a38b4a534c0c810df6f217af6ffcb3">OCA\CAFEVDB\Common\PHPMailer\getMailHeaders</a></div><div class="ttdeci">getMailHeaders()</div><div class="ttdoc">Returns the complete headers, but not the body.</div><div class="ttdef"><b>Definition:</b> <a href="_p_h_p_mailer_8php_source.html#l00081">PHPMailer.php:81</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer_html_afdd329740ea48df3134056d10c21ea2e"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_p_h_p_mailer.html#afdd329740ea48df3134056d10c21ea2e">OCA\CAFEVDB\Common\PHPMailer\failedRecipients</a></div><div class="ttdeci">failedRecipients(string $errorMessage)</div><div class="ttdoc">Parse a failed-recipients error string and explode into a list of failed recipients.</div><div class="ttdef"><b>Definition:</b> <a href="_p_h_p_mailer_8php_source.html#l00259">PHPMailer.php:259</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_util_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_util.html">OCA\CAFEVDB\Common\Util</a></div><div class="ttdoc">General static utility routines.</div><div class="ttdef"><b>Definition:</b> <a href="_common_2_util_8php_source.html#l00037">Util.php:38</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_uuid_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_common_1_1_uuid.html">OCA\CAFEVDB\Common\Uuid</a></div><div class="ttdoc">Customize with some defaults, like a random node.</div><div class="ttdef"><b>Definition:</b> <a href="_uuid_8php_source.html#l00033">Uuid.php:34</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_d_b_a_l_1_1_types_1_1_enum_attachment_origin_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_d_b_a_l_1_1_types_1_1_enum_attachment_origin.html">OCA\CAFEVDB\Database\Doctrine\DBAL\Types\EnumAttachmentOrigin</a></div><div class="ttdef"><b>Definition:</b> <a href="_enum_attachment_origin_8php_source.html#l00037">EnumAttachmentOrigin.php:38</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_d_b_a_l_1_1_types_1_1_enum_member_status_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_d_b_a_l_1_1_types_1_1_enum_member_status.html">OCA\CAFEVDB\Database\Doctrine\DBAL\Types\EnumMemberStatus</a></div><div class="ttdef"><b>Definition:</b> <a href="_enum_member_status_8php_source.html#l00040">EnumMemberStatus.php:41</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_d_b_a_l_1_1_types_1_1_enum_participant_field_data_type_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_d_b_a_l_1_1_types_1_1_enum_participant_field_data_type.html">OCA\CAFEVDB\Database\Doctrine\DBAL\Types\EnumParticipantFieldDataType</a></div><div class="ttdef"><b>Definition:</b> <a href="_enum_participant_field_data_type_8php_source.html#l00078">EnumParticipantFieldDataType.php:79</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_d_b_a_l_1_1_types_1_1_enum_participant_field_multiplicity_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_d_b_a_l_1_1_types_1_1_enum_participant_field_multiplicity.html">OCA\CAFEVDB\Database\Doctrine\DBAL\Types\EnumParticipantFieldMultiplicity</a></div><div class="ttdef"><b>Definition:</b> <a href="_enum_participant_field_multiplicity_8php_source.html#l00040">EnumParticipantFieldMultiplicity.php:41</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_entities_1_1_email_template_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_entities_1_1_email_template.html">OCA\CAFEVDB\Database\Doctrine\ORM\Entities\EmailTemplate</a></div><div class="ttdoc">EmailTemplate.</div><div class="ttdef"><b>Definition:</b> <a href="_email_template_8php_source.html#l00039">EmailTemplate.php:40</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_entities_1_1_musician_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_entities_1_1_musician.html">OCA\CAFEVDB\Database\Doctrine\ORM\Entities\Musician</a></div><div class="ttdoc">Musician.</div><div class="ttdef"><b>Definition:</b> <a href="_musician_8php_source.html#l00058">Musician.php:59</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_util_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_util.html">OCA\CAFEVDB\Database\Doctrine\Util</a></div><div class="ttdoc">Some mostly static convenience stuff.</div><div class="ttdef"><b>Definition:</b> <a href="_database_2_doctrine_2_util_8php_source.html#l00032">Util.php:33</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_util_html_aafe8e2082bd107d572aa76086a06b24e"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_util.html#aafe8e2082bd107d572aa76086a06b24e">OCA\CAFEVDB\Database\Doctrine\Util\criteriaWhere</a></div><div class="ttdeci">static criteriaWhere(array $arrayCriteria)</div><div class="ttdoc">Convenience function.</div><div class="ttdef"><b>Definition:</b> <a href="_database_2_doctrine_2_util_8php_source.html#l00081">Util.php:81</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_entity_manager_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_entity_manager.html">OCA\CAFEVDB\Database\EntityManager</a></div><div class="ttdoc">Use this as the actual EntityManager in order to be able to construct it without a Factory and to def...</div><div class="ttdef"><b>Definition:</b> <a href="_entity_manager_8php_source.html#l00098">EntityManager.php:99</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_documents_1_1_open_document_filler_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_documents_1_1_open_document_filler.html">OCA\CAFEVDB\Documents\OpenDocumentFiller</a></div><div class="ttdoc">Autofill for Libre-/Openoffice documents.</div><div class="ttdef"><b>Definition:</b> <a href="_open_document_filler_8php_source.html#l00044">OpenDocumentFiller.php:45</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html">OCA\CAFEVDB\EmailForm\Composer</a></div><div class="ttdoc">This is the mass-email composer class.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00083">Composer.php:84</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a016db532796f0e82eb53352cd95baf70"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a016db532796f0e82eb53352cd95baf70">OCA\CAFEVDB\EmailForm\Composer\messageText</a></div><div class="ttdeci">messageText()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04986">Composer.php:4986</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a01fa63e084ed727e9a7e0eb0bc2bbba5"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a01fa63e084ed727e9a7e0eb0bc2bbba5">OCA\CAFEVDB\EmailForm\Composer\outBoxSubFolderFromMessageId</a></div><div class="ttdeci">static outBoxSubFolderFromMessageId(string $messageId)</div><div class="ttdoc">Generate a directory name for the stripped attachments in the cloud file space.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l02334">Composer.php:2334</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a093a2dca4bf36d33578bf0ab620eb6fa"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a093a2dca4bf36d33578bf0ab620eb6fa">OCA\CAFEVDB\EmailForm\Composer\__construct</a></div><div class="ttdeci">__construct(ConfigService $configService, RequestParameterService $parameterService, EventsService $eventsService, RecipientsFilter $recipientsFilter, EntityManager $entityManager, ProjectParticipantFieldsService $participantFieldsService, ProgressStatusService $progressStatusService, SimpleSharingService $simpleSharingService, OrganizationalRolesService $organizationRolesService, AppStorage $appStorage, UserStorage $userStorage,)</div><div class="ttdoc">{}</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00488">Composer.php:488</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a099a1eac786c0fc2c4d7b8c3108b7d13"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a099a1eac786c0fc2c4d7b8c3108b7d13">OCA\CAFEVDB\EmailForm\Composer\blindCarbonCopy</a></div><div class="ttdeci">blindCarbonCopy()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04992">Composer.php:4992</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a09b451e02c3719a4a66cc56ac4c2edea"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a09b451e02c3719a4a66cc56ac4c2edea">OCA\CAFEVDB\EmailForm\Composer\errorStatus</a></div><div class="ttdeci">errorStatus()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l05533">Composer.php:5533</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a0abfd59485d4c62afddeb31fcfbc7ec5"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a0abfd59485d4c62afddeb31fcfbc7ec5">OCA\CAFEVDB\EmailForm\Composer\catchAllEmail</a></div><div class="ttdeci">catchAllEmail()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04882">Composer.php:4882</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a0bd93e4267049cfd7b9bb36bdaae694b"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a0bd93e4267049cfd7b9bb36bdaae694b">OCA\CAFEVDB\EmailForm\Composer\sentEmails</a></div><div class="ttdeci">sentEmails()</div><div class="ttdoc">Return a list of previously sent emails related to the current project.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04942">Composer.php:4942</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a1277a745b6d92dd38773bb7d361f3b58"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a1277a745b6d92dd38773bb7d361f3b58">OCA\CAFEVDB\EmailForm\Composer\bankAccount</a></div><div class="ttdeci">bankAccount()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04095">Composer.php:4095</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a1dc30339bb1489c3f4a9586dff31066d"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a1dc30339bb1489c3f4a9586dff31066d">OCA\CAFEVDB\EmailForm\Composer\carbonCopy</a></div><div class="ttdeci">carbonCopy()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04998">Composer.php:4998</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a1e0d5995112f4233f626fbb08fc44753"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a1e0d5995112f4233f626fbb08fc44753">OCA\CAFEVDB\EmailForm\Composer\$recipients</a></div><div class="ttdeci">$recipients</div><div class="ttdoc">The list of recipients.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00376">Composer.php:376</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a24e7fbb14ed9dce86eee44d9f81c2e06"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a24e7fbb14ed9dce86eee44d9f81c2e06">OCA\CAFEVDB\EmailForm\Composer\setCatchAll</a></div><div class="ttdeci">setCatchAll()</div><div class="ttdoc">Set the catch-all email address.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l03856">Composer.php:3856</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a27966bf10334cb5a39f4df8dc8f2a151"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a27966bf10334cb5a39f4df8dc8f2a151">OCA\CAFEVDB\EmailForm\Composer\currentEmailTemplate</a></div><div class="ttdeci">currentEmailTemplate()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04948">Composer.php:4948</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a28c3e766ec95a8d1201a7dc1c857b0b3"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a28c3e766ec95a8d1201a7dc1c857b0b3">OCA\CAFEVDB\EmailForm\Composer\normalizeTemplateName</a></div><div class="ttdeci">normalizeTemplateName(string $templateName)</div><div class="ttdoc">Normalize the given template-name: CamelCase, not spaces, no dashes.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04287">Composer.php:4287</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a2d844a225351b80afb7da14fee0e6edc"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a2d844a225351b80afb7da14fee0e6edc">OCA\CAFEVDB\EmailForm\Composer\fetchSentEmailsList</a></div><div class="ttdeci">fetchSentEmailsList()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04399">Composer.php:4399</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a2e450981f16737e95f54c94543ae66cf"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a2e450981f16737e95f54c94543ae66cf">OCA\CAFEVDB\EmailForm\Composer\eventAttachmentOptions</a></div><div class="ttdeci">eventAttachmentOptions(mixed $projectId, array $attachedEvents)</div><div class="ttdoc">A helper function to generate suitable select options for PageNavigation::selectOptions().</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l05492">Composer.php:5492</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a3022527659976cc7e4ce7ea8eed647a2"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a3022527659976cc7e4ce7ea8eed647a2">OCA\CAFEVDB\EmailForm\Composer\preComposeValidation</a></div><div class="ttdeci">preComposeValidation(array $recipients)</div><div class="ttdoc">Pre-message construction validation.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l03530">Composer.php:3530</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a30ead6103e6fb25a10628774c18ed36a"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a30ead6103e6fb25a10628774c18ed36a">OCA\CAFEVDB\EmailForm\Composer\storedEmails</a></div><div class="ttdeci">storedEmails()</div><div class="ttdoc">Export an option array suitable to load stored email messages, currently templates and message drafts...</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04926">Composer.php:4926</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a346f94effc8c8dfea565e54bc6a27ba7"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a346f94effc8c8dfea565e54bc6a27ba7">OCA\CAFEVDB\EmailForm\Composer\setDefaultTemplate</a></div><div class="ttdeci">setDefaultTemplate()</div><div class="ttdoc">Install a default email text if no tempalte is given.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l03832">Composer.php:3832</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a35115d6c4451757ebad296254ead1c5a"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a35115d6c4451757ebad296254ead1c5a">OCA\CAFEVDB\EmailForm\Composer\cgiValue</a></div><div class="ttdeci">cgiValue(string $key, $default=null)</div><div class="ttdoc">Fetch a CGI-variable out of the form-select name-space.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00686">Composer.php:686</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a3985e2723a7cdac4576e7163d9bfc943"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a3985e2723a7cdac4576e7163d9bfc943">OCA\CAFEVDB\EmailForm\Composer\validateFreeFormAddresses</a></div><div class="ttdeci">validateFreeFormAddresses(string $header, string $freeForm)</div><div class="ttdoc">Validate a comma separated list of email address from the Cc: or Bcc: input.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l03705">Composer.php:3705</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a3d0e19c34ee0b39d6539a29a3ff33f43"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a3d0e19c34ee0b39d6539a29a3ff33f43">OCA\CAFEVDB\EmailForm\Composer\$templateFileAttachments</a></div><div class="ttdeci">$templateFileAttachments</div><div class="ttdoc">Template file-attachment without personalization, i.e.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00462">Composer.php:462</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a462c7fe31c4345bb890b366c50621cfa"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a462c7fe31c4345bb890b366c50621cfa">OCA\CAFEVDB\EmailForm\Composer\toStringArray</a></div><div class="ttdeci">toStringArray()</div><div class="ttdoc">Compose one &quot;readable&quot;, flat array of recipients, meant only for display.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04894">Composer.php:4894</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a4c011d39b66793b8969a1a66e8a74cb6"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a4c011d39b66793b8969a1a66e8a74cb6">OCA\CAFEVDB\EmailForm\Composer\messageIdFromOutBoxSubFolder</a></div><div class="ttdeci">static messageIdFromOutBoxSubFolder(string $outBoxSubFolderPath)</div><div class="ttdoc">Reconstruct the message id from the given outbox folder name.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l02346">Composer.php:2346</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a4dfa28837b25f75555b35e1fb69d6fc2"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a4dfa28837b25f75555b35e1fb69d6fc2">OCA\CAFEVDB\EmailForm\Composer\deleteDraft</a></div><div class="ttdeci">deleteDraft(?int $draftId=null)</div><div class="ttdoc">Delete the given or current message draft.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04544">Composer.php:4544</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a4eba5485d3006dee315412a6e8cce42e"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a4eba5485d3006dee315412a6e8cce42e">OCA\CAFEVDB\EmailForm\Composer\emitHtmlBodyStyle</a></div><div class="ttdeci">static emitHtmlBodyStyle(string $style, ?string $cssPrefix=null)</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l01698">Composer.php:1698</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a5558c5d549f41597377fa1ea8a1cefa3"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a5558c5d549f41597377fa1ea8a1cefa3">OCA\CAFEVDB\EmailForm\Composer\toString</a></div><div class="ttdeci">toString()</div><div class="ttdoc">Compose one &quot;readable&quot;, comma separated list of recipients, meant only for display.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04915">Composer.php:4915</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a56fae4bd1b4337dfe78d90b051c93a01"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a56fae4bd1b4337dfe78d90b051c93a01">OCA\CAFEVDB\EmailForm\Composer\fileAttachments</a></div><div class="ttdeci">fileAttachments()</div><div class="ttdoc">Return the file attachment data.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l05355">Composer.php:5355</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a5764bbb364eac41ce21eeeec75f64e1b"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a5764bbb364eac41ce21eeeec75f64e1b">OCA\CAFEVDB\EmailForm\Composer\rememberTemporaryFile</a></div><div class="ttdeci">rememberTemporaryFile(string $tmpFile, mixed $origin)</div><div class="ttdoc">Remember a temporary file.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04699">Composer.php:4699</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a583519d7e9354b0ee2cd0b656711dd91"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a583519d7e9354b0ee2cd0b656711dd91">OCA\CAFEVDB\EmailForm\Composer\$onLookers</a></div><div class="ttdeci">$onLookers</div><div class="ttdoc">Cc: and Bcc: recipients.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00377">Composer.php:377</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a5a1b75120c97a555674c76ad7c1da6fb"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a5a1b75120c97a555674c76ad7c1da6fb">OCA\CAFEVDB\EmailForm\Composer\formatExceptionMessage</a></div><div class="ttdeci">formatExceptionMessage(\Throwable $throwable)</div><div class="ttdoc">Compose a &quot;readable&quot; message from a thrown exception.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l05551">Composer.php:5551</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a64924c3e38450824617993e28ac40b3e"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a64924c3e38450824617993e28ac40b3e">OCA\CAFEVDB\EmailForm\Composer\fileAttachmentOptions</a></div><div class="ttdeci">fileAttachmentOptions()</div><div class="ttdoc">A helper function to generate suitable select options for PageNavigation::selectOptions().</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l05402">Composer.php:5402</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a64951c106ffa52c954480dfeaace1db6"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a64951c106ffa52c954480dfeaace1db6">OCA\CAFEVDB\EmailForm\Composer\validateTemplate</a></div><div class="ttdeci">validateTemplate(string $template=null)</div><div class="ttdoc">Validates the given template, i.e.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l03767">Composer.php:3767</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a64e84fa7a7176cd87fe8fa9818aae4d7"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a64e84fa7a7176cd87fe8fa9818aae4d7">OCA\CAFEVDB\EmailForm\Composer\getRecipientsFilter</a></div><div class="ttdeci">getRecipientsFilter()</div><div class="ttdoc">The email composer never goes without its recipients filter.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00672">Composer.php:672</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a699971615de166d76a02ec9aec1c4200"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a699971615de166d76a02ec9aec1c4200">OCA\CAFEVDB\EmailForm\Composer\dateSubstitution</a></div><div class="ttdeci">dateSubstitution(array $arg, string $nameSpace, mixed $data=null)</div><div class="ttdoc">Generic data substitution function which is used to substitute data-variables during mail-merge.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l03884">Composer.php:3884</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a6dfede44ffd8068052baa8a06ad05260"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a6dfede44ffd8068052baa8a06ad05260">OCA\CAFEVDB\EmailForm\Composer\forgetTemporaryFile</a></div><div class="ttdeci">forgetTemporaryFile(string $tmpFile)</div><div class="ttdoc">Forget a temporary file, i.e.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04735">Composer.php:4735</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a71a62ba0936f5853e5c3ac3c0157ff66"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a71a62ba0936f5853e5c3ac3c0157ff66">OCA\CAFEVDB\EmailForm\Composer\$referencing</a></div><div class="ttdeci">$referencing</div><div class="ttdoc">Further related message ids.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00413">Composer.php:413</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a771ab1f79b7a4747ccd2ff0a69164a43"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a771ab1f79b7a4747ccd2ff0a69164a43">OCA\CAFEVDB\EmailForm\Composer\fetchTemplatesList</a></div><div class="ttdeci">fetchTemplatesList()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04379">Composer.php:4379</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a79652808b8c32f885da0e02c13dff113"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a79652808b8c32f885da0e02c13dff113">OCA\CAFEVDB\EmailForm\Composer\deleteTemplate</a></div><div class="ttdeci">deleteTemplate(string $templateName)</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04245">Composer.php:4245</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a82ee6dc3fe4830272788180d197340fd"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a82ee6dc3fe4830272788180d197340fd">OCA\CAFEVDB\EmailForm\Composer\loadTemplate</a></div><div class="ttdeci">loadTemplate(string $templateIdentifier)</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04260">Composer.php:4260</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a858b467638cc7c967dd04b9fb1272c73"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a858b467638cc7c967dd04b9fb1272c73">OCA\CAFEVDB\EmailForm\Composer\replaceFormVariables</a></div><div class="ttdeci">replaceFormVariables(string $nameSpace, mixed $data=null, ?string $message=null, ?array &amp;$failures=null)</div><div class="ttdoc">Replace all variables of the given namespace in $this-&gt;messageContents.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l01576">Composer.php:1576</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a8b343a4564c310b65c59e5a08305dbf0"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8b343a4564c310b65c59e5a08305dbf0">OCA\CAFEVDB\EmailForm\Composer\$draftId</a></div><div class="ttdeci">$draftId</div><div class="ttdoc">The ID of the current message draft, or -1.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00415">Composer.php:415</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a8c51518ac57ca5c9bdf846051ac17f0a"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8c51518ac57ca5c9bdf846051ac17f0a">OCA\CAFEVDB\EmailForm\Composer\fetchDraftsList</a></div><div class="ttdeci">fetchDraftsList()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04390">Composer.php:4390</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a8d6568d7a87ba2a132aa630bb5fd5f4f"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8d6568d7a87ba2a132aa630bb5fd5f4f">OCA\CAFEVDB\EmailForm\Composer\executionStatus</a></div><div class="ttdeci">executionStatus()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l05527">Composer.php:5527</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a8e77623277f1542549bfd7ae557512eb"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a8e77623277f1542549bfd7ae557512eb">OCA\CAFEVDB\EmailForm\Composer\hasSubstitutionNamespace</a></div><div class="ttdeci">hasSubstitutionNamespace(string $nameSpace, ?string $message=null)</div><div class="ttdoc">Return true if this email needs per-namespace substitutions.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l01550">Composer.php:1550</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a91e639d9817255254574e35ba821deab"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a91e639d9817255254574e35ba821deab">OCA\CAFEVDB\EmailForm\Composer\recordMessageDiagnostics</a></div><div class="ttdeci">recordMessageDiagnostics(string $mimeMsg)</div><div class="ttdoc">Record diagnostic output from the actual message composition for the status page.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l02867">Composer.php:2867</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a93205910f367adeb7052a773907ab2c2"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a93205910f367adeb7052a773907ab2c2">OCA\CAFEVDB\EmailForm\Composer\$catchAllName</a></div><div class="ttdeci">$catchAllName</div><div class="ttdoc">The default From: name.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00407">Composer.php:407</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a983520de1e3cc2a8f002055bf82ad3a8"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a983520de1e3cc2a8f002055bf82ad3a8">OCA\CAFEVDB\EmailForm\Composer\storeTemplate</a></div><div class="ttdeci">storeTemplate(string $templateName, ?string $subject=null, ?string $contents=null)</div><div class="ttdoc">Take the text supplied by $contents and store it in the DB EmailTemplates table with tag $templateNam...</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04218">Composer.php:4218</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a9e1ded8474fe53124cbc5887bc2705cc"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a9e1ded8474fe53124cbc5887bc2705cc">OCA\CAFEVDB\EmailForm\Composer\saveAttachment</a></div><div class="ttdeci">saveAttachment(array &amp;$fileRecord)</div><div class="ttdoc">Handle file uploads.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04765">Composer.php:4765</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_a9e832998c1a0a41b681b857a6c47ce48"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#a9e832998c1a0a41b681b857a6c47ce48">OCA\CAFEVDB\EmailForm\Composer\activePersonalAttachments</a></div><div class="ttdeci">activePersonalAttachments()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l05325">Composer.php:5325</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_aa250740057568420a6211021cd23db97"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa250740057568420a6211021cd23db97">OCA\CAFEVDB\EmailForm\Composer\$implicitFileAttachments</a></div><div class="ttdeci">$implicitFileAttachments</div><div class="ttdoc">Potential personal file-attachments deduced from parsing the personal substitutions.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00485">Composer.php:485</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_aa3c2bbdf1d23258866694670e6549993"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa3c2bbdf1d23258866694670e6549993">OCA\CAFEVDB\EmailForm\Composer\$personalFileAttachments</a></div><div class="ttdeci">$personalFileAttachments</div><div class="ttdoc">Personal file-attachments stemming form ProjectParticipantField entities.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00470">Composer.php:470</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_aa6773d095ef2595974297b6e90fe2199"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa6773d095ef2595974297b6e90fe2199">OCA\CAFEVDB\EmailForm\Composer\streetAddress</a></div><div class="ttdeci">streetAddress()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04083">Composer.php:4083</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_aa7c51513462cc05bd28c79540a6d374a"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa7c51513462cc05bd28c79540a6d374a">OCA\CAFEVDB\EmailForm\Composer\eventAttachments</a></div><div class="ttdeci">eventAttachments()</div><div class="ttdoc">Return the calendar attachment data.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l05468">Composer.php:5468</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_aa928a4f761c6be57478c9424ceaf4c22"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aa928a4f761c6be57478c9424ceaf4c22">OCA\CAFEVDB\EmailForm\Composer\statusDiagnostics</a></div><div class="ttdeci">statusDiagnostics()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l05539">Composer.php:5539</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_ab1086dcea02fd293a5b40f89c685f1af"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ab1086dcea02fd293a5b40f89c685f1af">OCA\CAFEVDB\EmailForm\Composer\detachTemporaryFiles</a></div><div class="ttdeci">detachTemporaryFiles(int $draftId)</div><div class="ttdoc">Detach temporaries from a draft, i.e.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04667">Composer.php:4667</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_ac54fcac898abdad38c7a08936d225d0b"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac54fcac898abdad38c7a08936d225d0b">OCA\CAFEVDB\EmailForm\Composer\$catchAllEmail</a></div><div class="ttdeci">$catchAllEmail</div><div class="ttdoc">The fixed From: email address.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00406">Composer.php:406</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_ac5976a0a50b5addf24a0bd26280f2772"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac5976a0a50b5addf24a0bd26280f2772">OCA\CAFEVDB\EmailForm\Composer\discloseRecipients</a></div><div class="ttdeci">discloseRecipients()</div><div class="ttdoc">Whether recipients are disclosed (send via Cc:) or undisclosed (send via Bcc:).</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l01652">Composer.php:1652</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_ac81b054796aa09191608631425f4b3ee"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac81b054796aa09191608631425f4b3ee">OCA\CAFEVDB\EmailForm\Composer\addFileAttachment</a></div><div class="ttdeci">addFileAttachment(PHPMailer $phpMailer, string $messageId, string $data, string $fileName, string $transferEncoding, string $mimeType,)</div><div class="ttdoc">Add the given file attachment, replacing it by a download-link if too large.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l02371">Composer.php:2371</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_ac9b7ecf11f96b66f5b50b296815ace81"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac9b7ecf11f96b66f5b50b296815ace81">OCA\CAFEVDB\EmailForm\Composer\sendMessages</a></div><div class="ttdeci">sendMessages()</div><div class="ttdoc">Send out the messages with self::doSendMessages(), after checking them with self::preComposeValidatio...</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l01670">Composer.php:1670</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_ac9f13bb428d2f8fba2e6cdf565df683f"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ac9f13bb428d2f8fba2e6cdf565df683f">OCA\CAFEVDB\EmailForm\Composer\subjectTag</a></div><div class="ttdeci">subjectTag()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04966">Composer.php:4966</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_ad647aec9f224f570e5c79be0a9ddd3d1"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad647aec9f224f570e5c79be0a9ddd3d1">OCA\CAFEVDB\EmailForm\Composer\subject</a></div><div class="ttdeci">subject()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l05004">Composer.php:5004</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_ad74240dcb020960b41df6447a5b0e1ff"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad74240dcb020960b41df6447a5b0e1ff">OCA\CAFEVDB\EmailForm\Composer\setSubjectTag</a></div><div class="ttdeci">setSubjectTag(?int $recipientsSet=null)</div><div class="ttdoc">Compute the subject tag, depending on whether we are in project mode or not.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l03669">Composer.php:3669</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_ad898ece7f3ae7d21feaedaef97802604"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad898ece7f3ae7d21feaedaef97802604">OCA\CAFEVDB\EmailForm\Composer\messageDraftId</a></div><div class="ttdeci">messageDraftId()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04954">Composer.php:4954</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_ad9a0cdb1a4120677afc94f22b45b6f1f"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ad9a0cdb1a4120677afc94f22b45b6f1f">OCA\CAFEVDB\EmailForm\Composer\finalizeSubstitutions</a></div><div class="ttdeci">finalizeSubstitutions(?string $message=null)</div><div class="ttdoc">Cleanup edge-cases.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l01636">Composer.php:1636</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_ada8dcf30020d39897d4515e16c4d5ca7"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ada8dcf30020d39897d4515e16c4d5ca7">OCA\CAFEVDB\EmailForm\Composer\getOutboundService</a></div><div class="ttdeci">getOutboundService(bool $authenticate=false)</div><div class="ttdoc">Construct the PHPMailer instance.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l02292">Composer.php:2292</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_adb1dd030a0eed2cad2054a2678608536"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#adb1dd030a0eed2cad2054a2678608536">OCA\CAFEVDB\EmailForm\Composer\fromAddress</a></div><div class="ttdeci">fromAddress()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04980">Composer.php:4980</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_add8504b52466d3419381680a483a652f"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#add8504b52466d3419381680a483a652f">OCA\CAFEVDB\EmailForm\Composer\copyToSentFolder</a></div><div class="ttdeci">copyToSentFolder(string $mimeMessage)</div><div class="ttdoc">Take the supplied message and copy it to the &quot;Sent&quot; folder.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l02908">Composer.php:2908</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_adda03ec92a7028324dd0f3d882e975ba"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#adda03ec92a7028324dd0f3d882e975ba">OCA\CAFEVDB\EmailForm\Composer\blankTemplateAttachments</a></div><div class="ttdeci">blankTemplateAttachments()</div><div class="ttdoc">Return non-personalized document templates for use in mass-email.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l05133">Composer.php:5133</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_ae220f15c10e5298f7e1f74bc69a15743"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#ae220f15c10e5298f7e1f74bc69a15743">OCA\CAFEVDB\EmailForm\Composer\inReplyTo</a></div><div class="ttdeci">inReplyTo()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04960">Composer.php:4960</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_aeee4b6b94a0d071a13a6f75057140db5"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#aeee4b6b94a0d071a13a6f75057140db5">OCA\CAFEVDB\EmailForm\Composer\$inReplyToId</a></div><div class="ttdeci">$inReplyToId</div><div class="ttdoc">Message id of a to-be-replied message.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00412">Composer.php:412</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_af025be7c6d229803717a6b717854a0a3"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#af025be7c6d229803717a6b717854a0a3">OCA\CAFEVDB\EmailForm\Composer\formData</a></div><div class="ttdeci">formData()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04871">Composer.php:4871</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_af38d44317b9aa9b9f6a8886ec8b293d1"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#af38d44317b9aa9b9f6a8886ec8b293d1">OCA\CAFEVDB\EmailForm\Composer\head</a></div><div class="ttdeci">head(string $text, int $lines=64, string $separators=&quot;/\n/&quot;)</div><div class="ttdoc">Extract the first few line of a text-buffer.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l01887">Composer.php:1887</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_af4c5ee02b3adc07ecccf22dfcd9b1108"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#af4c5ee02b3adc07ecccf22dfcd9b1108">OCA\CAFEVDB\EmailForm\Composer\$globalFileAttachments</a></div><div class="ttdeci">$globalFileAttachments</div><div class="ttdoc">&quot;Global&quot; file attachments from upload or the cloud file-system.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00477">Composer.php:477</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_af6fe2b68e7e9ad882d4bca0d4409df3d"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#af6fe2b68e7e9ad882d4bca0d4409df3d">OCA\CAFEVDB\EmailForm\Composer\fetchExecutiveBoard</a></div><div class="ttdeci">fetchExecutiveBoard()</div><div class="ttdoc">Fetch the pre-names of the members of the organizing committee in order to construct an up-to-date gr...</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04113">Composer.php:4113</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer_html_afce9302bd8ab508408cc457cb24786e5"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_composer.html#afce9302bd8ab508408cc457cb24786e5">OCA\CAFEVDB\EmailForm\Composer\fromName</a></div><div class="ttdeci">fromName()</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l04974">Composer.php:4974</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_recipients_filter_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_recipients_filter.html">OCA\CAFEVDB\EmailForm\RecipientsFilter</a></div><div class="ttdoc">Wrap the email filter form into a class to make things a little less crowded.</div><div class="ttdef"><b>Definition:</b> <a href="_recipients_filter_8php_source.html#l00051">RecipientsFilter.php:52</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_sent_email_d_t_o_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_1_1_sent_email_d_t_o.html">OCA\CAFEVDB\EmailForm\SentEmailDTO</a></div><div class="ttdoc">Data-transfer object in order to later generate the log-entry in the data-base from it.</div><div class="ttdef"><b>Definition:</b> <a href="_sent_email_d_t_o_8php_source.html#l00031">SentEmailDTO.php:32</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_exceptions_1_1_substitution_exception_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_exceptions_1_1_substitution_exception.html">OCA\CAFEVDB\Exceptions\SubstitutionException</a></div><div class="ttdef"><b>Definition:</b> <a href="_substitution_exception_8php_source.html#l00028">SubstitutionException.php:29</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_page_renderer_1_1_util_1_1_navigation_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_page_renderer_1_1_util_1_1_navigation.html">OCA\CAFEVDB\PageRenderer\Util\Navigation</a></div><div class="ttdoc">Support class to generate navigation buttons and the like.</div><div class="ttdef"><b>Definition:</b> <a href="_navigation_8php_source.html#l00036">Navigation.php:37</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_config_check_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_config_check_service.html">OCA\CAFEVDB\Service\ConfigCheckService</a></div><div class="ttdoc">Check for a usable configuration.</div><div class="ttdef"><b>Definition:</b> <a href="_config_check_service_8php_source.html#l00050">ConfigCheckService.php:51</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_config_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_config_service.html">OCA\CAFEVDB\Service\ConfigService</a></div><div class="ttdoc">Configuration do-it-all class.</div><div class="ttdef"><b>Definition:</b> <a href="_config_service_8php_source.html#l00059">ConfigService.php:60</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_events_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_events_service.html">OCA\CAFEVDB\Service\EventsService</a></div><div class="ttdoc">Events and tasks handling.</div><div class="ttdef"><b>Definition:</b> <a href="_events_service_8php_source.html#l00052">EventsService.php:53</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_finance_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_finance_service.html">OCA\CAFEVDB\Service\Finance\FinanceService</a></div><div class="ttdoc">Finance and bank related stuff.</div><div class="ttdef"><b>Definition:</b> <a href="_finance_service_8php_source.html#l00053">FinanceService.php:54</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_instrument_insurance_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_instrument_insurance_service.html">OCA\CAFEVDB\Service\Finance\InstrumentInsuranceService</a></div><div class="ttdoc">Collective instrument insurance.</div><div class="ttdef"><b>Definition:</b> <a href="_instrument_insurance_service_8php_source.html#l00045">InstrumentInsuranceService.php:46</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_receivables_generator_factory_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_receivables_generator_factory.html">OCA\CAFEVDB\Service\Finance\ReceivablesGeneratorFactory</a></div><div class="ttdoc">Factory for receivables generators.</div><div class="ttdef"><b>Definition:</b> <a href="_receivables_generator_factory_8php_source.html#l00044">ReceivablesGeneratorFactory.php:45</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_sepa_bulk_transaction_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_sepa_bulk_transaction_service.html">OCA\CAFEVDB\Service\Finance\SepaBulkTransactionService</a></div><div class="ttdoc">Service class for generating bulk-transactions for submittance to the respective bank.</div><div class="ttdef"><b>Definition:</b> <a href="_sepa_bulk_transaction_service_8php_source.html#l00062">SepaBulkTransactionService.php:63</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_instrumentation_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_instrumentation_service.html">OCA\CAFEVDB\Service\InstrumentationService</a></div><div class="ttdoc">General support service, kind of inconsequent glue between Doctrine\ORM and CAFEVDB\PageRenderer.</div><div class="ttdef"><b>Definition:</b> <a href="_instrumentation_service_8php_source.html#l00038">InstrumentationService.php:39</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_organizational_roles_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_organizational_roles_service.html">OCA\CAFEVDB\Service\OrganizationalRolesService</a></div><div class="ttdoc">Check for authorization and supply contact information for several administrative roles.</div><div class="ttdef"><b>Definition:</b> <a href="_organizational_roles_service_8php_source.html#l00042">OrganizationalRolesService.php:43</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_progress_status_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_progress_status_service.html">OCA\CAFEVDB\Service\ProgressStatusService</a></div><div class="ttdoc">Factory for progress status implementation.</div><div class="ttdef"><b>Definition:</b> <a href="_progress_status_service_8php_source.html#l00038">ProgressStatusService.php:39</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_project_participant_fields_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_project_participant_fields_service.html">OCA\CAFEVDB\Service\ProjectParticipantFieldsService</a></div><div class="ttdoc">General support service, kind of inconsequent glue between Doctrine\ORM and CAFEVDB\PageRenderer.</div><div class="ttdef"><b>Definition:</b> <a href="_project_participant_fields_service_8php_source.html#l00060">ProjectParticipantFieldsService.php:61</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_project_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_project_service.html">OCA\CAFEVDB\Service\ProjectService</a></div><div class="ttdoc">General support service, kind of inconsequent glue between Doctrine\ORM and CAFEVDB\PageRenderer.</div><div class="ttdef"><b>Definition:</b> <a href="_project_service_8php_source.html#l00060">ProjectService.php:61</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_request_parameter_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_request_parameter_service.html">OCA\CAFEVDB\Service\RequestParameterService</a></div><div class="ttdef"><b>Definition:</b> <a href="_request_parameter_service_8php_source.html#l00032">RequestParameterService.php:33</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_simple_sharing_service_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_simple_sharing_service.html">OCA\CAFEVDB\Service\SimpleSharingService</a></div><div class="ttdoc">Support class for the creating cloud shared, currently only web-links can be generated.</div><div class="ttdef"><b>Definition:</b> <a href="_simple_sharing_service_8php_source.html#l00040">SimpleSharingService.php:41</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_storage_1_1_app_storage_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_storage_1_1_app_storage.html">OCA\CAFEVDB\Storage\AppStorage</a></div><div class="ttdoc">App-storage wrapper in order to have a common interface with the user-storage.</div><div class="ttdef"><b>Definition:</b> <a href="_app_storage_8php_source.html#l00046">AppStorage.php:47</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_storage_1_1_database_storage_util_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_storage_1_1_database_storage_util.html">OCA\CAFEVDB\Storage\DatabaseStorageUtil</a></div><div class="ttdoc">Support functions for the database storage backend.</div><div class="ttdef"><b>Definition:</b> <a href="_database_storage_util_8php_source.html#l00039">DatabaseStorageUtil.php:40</a></div></div>
<div class="ttc" id="aclass_o_c_a_1_1_c_a_f_e_v_d_b_1_1_storage_1_1_user_storage_html"><div class="ttname"><a href="class_o_c_a_1_1_c_a_f_e_v_d_b_1_1_storage_1_1_user_storage.html">OCA\CAFEVDB\Storage\UserStorage</a></div><div class="ttdoc">Some tweaks to for the user-folder stuff.</div><div class="ttdef"><b>Definition:</b> <a href="_user_storage_8php_source.html#l00059">UserStorage.php:60</a></div></div>
<div class="ttc" id="ainterface_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_i_recurring_receivables_generator_html"><div class="ttname"><a href="interface_o_c_a_1_1_c_a_f_e_v_d_b_1_1_service_1_1_finance_1_1_i_recurring_receivables_generator.html">OCA\CAFEVDB\Service\Finance\IRecurringReceivablesGenerator</a></div><div class="ttdoc">Generate recurring receivables and manifest them as recurring Entities\ProjectParticipantField entity...</div><div class="ttdef"><b>Definition:</b> <a href="_i_recurring_receivables_generator_8php_source.html#l00038">IRecurringReceivablesGenerator.php:39</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_entities_html"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_entities.html">OCA\CAFEVDB\Database\Doctrine\ORM\Entities</a></div><div class="ttdoc">Orchestra member, musician and project management application.</div><div class="ttdef"><b>Definition:</b> <a href="_change_log_8php_source.html#l00025">ChangeLog.php:25</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_traits_html_a658defb34762c8f40085aec87e16ba1a"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_database_1_1_doctrine_1_1_o_r_m_1_1_traits.html#a658defb34762c8f40085aec87e16ba1a">OCA\CAFEVDB\Database\Doctrine\ORM\Traits\toArray</a></div><div class="ttdeci">toArray()</div><div class="ttdef"><b>Definition:</b> <a href="_array_trait_8php_source.html#l00075">ArrayTrait.php:75</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form_html"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_email_form.html">OCA\CAFEVDB\EmailForm</a></div><div class="ttdoc">Orchestra member, musician and project management application.</div><div class="ttdef"><b>Definition:</b> <a href="_composer_8php_source.html#l00025">Composer.php:25</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_exceptions_html"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_exceptions.html">OCA\CAFEVDB\Exceptions</a></div><div class="ttdoc">Orchestra member, musician and project management application.</div><div class="ttdef"><b>Definition:</b> <a href="_cannot_decrypt_exception_8php_source.html#l00025">CannotDecryptException.php:25</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_page_renderer_1_1_field_traits_html_a6f53acf3fbee704d2b47e98751896711"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_page_renderer_1_1_field_traits.html#a6f53acf3fbee704d2b47e98751896711">OCA\CAFEVDB\PageRenderer\FieldTraits\$participantFields</a></div><div class="ttdeci">function renderParticipantFields iterable $participantFields</div><div class="ttdoc">For each extra field add one dedicated join table entry which is pinned to the respective field-id.</div><div class="ttdef"><b>Definition:</b> <a href="_participant_fields_trait_8php_source.html#l00135">ParticipantFieldsTrait.php:135</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits_html_a4d87f4e47d18fb535d235414c357f821"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a4d87f4e47d18fb535d235414c357f821">OCA\CAFEVDB\Toolkit\Traits\logDebug</a></div><div class="ttdeci">logDebug(string $message, array $context=[], int $shift=0, bool $showTrace=false)</div><div class="ttdoc">Log a debug message.</div><div class="ttdef"><b>Definition:</b> <a href="_logger_trait_8php_source.html#l00179">LoggerTrait.php:179</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits_html_a6d05693fe567b9d34daf71eb6c8aecb4"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a6d05693fe567b9d34daf71eb6c8aecb4">OCA\CAFEVDB\Toolkit\Traits\logException</a></div><div class="ttdeci">logException(Throwable $exception, string $message=null, int $shift=0, bool $showTrace=false, mixed $level=LogLevel::ERROR,)</div><div class="ttdef"><b>Definition:</b> <a href="_logger_trait_8php_source.html#l00132">LoggerTrait.php:132</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits_html_a90f07ed512379da471e822b7471b72fc"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#a90f07ed512379da471e822b7471b72fc">OCA\CAFEVDB\Toolkit\Traits\logError</a></div><div class="ttdeci">logError(string $message, array $context=[], int $shift=0, bool $showTrace=false)</div><div class="ttdoc">Log an error.</div><div class="ttdef"><b>Definition:</b> <a href="_logger_trait_8php_source.html#l00164">LoggerTrait.php:164</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits_html_ab8e67cfd6a09d264ed60634dd794bb30"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_toolkit_1_1_traits.html#ab8e67cfd6a09d264ed60634dd794bb30">OCA\CAFEVDB\Toolkit\Traits\logInfo</a></div><div class="ttdeci">logInfo(string $message, array $context=[], int $shift=0, bool $showTrace=false)</div><div class="ttdoc">Log an informational message.</div><div class="ttdef"><b>Definition:</b> <a href="_logger_trait_8php_source.html#l00194">LoggerTrait.php:194</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_a010c9c0626aa3587f7062ffbcc9ff64e"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a010c9c0626aa3587f7062ffbcc9ff64e">OCA\CAFEVDB\Traits\formatDate</a></div><div class="ttdeci">formatDate($timestamp, string $format='long', DateTimeZone $timeZone=null, IL10N $l=null)</div><div class="ttdoc">Work around NC annoyingly not accepting \DateTimeInterface.</div><div class="ttdef"><b>Definition:</b> <a href="_config_trait_8php_source.html#l00802">ConfigTrait.php:802</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_a0f8f77ebc7e2ed62151c9213aebed956"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a0f8f77ebc7e2ed62151c9213aebed956">OCA\CAFEVDB\Traits\di</a></div><div class="ttdeci">di(string $className)</div><div class="ttdoc">Dependency injection of $className.</div><div class="ttdef"><b>Definition:</b> <a href="_config_trait_8php_source.html#l00122">ConfigTrait.php:122</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_a38cf04b2bc83979fbc0084250dd7a772"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a38cf04b2bc83979fbc0084250dd7a772">OCA\CAFEVDB\Traits\translationVariants</a></div><div class="ttdeci">translationVariants(string $name)</div><div class="ttdoc">Search for translation variants by trying several camel-case transformations.</div><div class="ttdef"><b>Definition:</b> <a href="_config_trait_8php_source.html#l01054">ConfigTrait.php:1054</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_a3a2983317152273aaf635e4bd61f0c7a"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a3a2983317152273aaf635e4bd61f0c7a">OCA\CAFEVDB\Traits\appContainer</a></div><div class="ttdeci">appContainer()</div><div class="ttdef"><b>Definition:</b> <a href="_config_trait_8php_source.html#l00110">ConfigTrait.php:110</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_a41c11b7ac132f68b944624210a5135be"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a41c11b7ac132f68b944624210a5135be">OCA\CAFEVDB\Traits\shareOwnerId</a></div><div class="ttdeci">shareOwnerId()</div><div class="ttdef"><b>Definition:</b> <a href="_config_trait_8php_source.html#l00441">ConfigTrait.php:441</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_a4c1dc0e4e1b0686a92c0f6486e91b7c6"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a4c1dc0e4e1b0686a92c0f6486e91b7c6">OCA\CAFEVDB\Traits\localeLanguageNames</a></div><div class="ttdeci">localeLanguageNames($locale=null)</div><div class="ttdef"><b>Definition:</b> <a href="_config_trait_8php_source.html#l00888">ConfigTrait.php:888</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_a8e12ef5cafdab7b950132867526d1113"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a8e12ef5cafdab7b950132867526d1113">OCA\CAFEVDB\Traits\count</a></div><div class="ttdeci">count(array $criteria, string $entityClassName=null)</div><div class="ttdoc">Counts entities by a set of criteria.</div><div class="ttdef"><b>Definition:</b> <a href="_entity_manager_trait_8php_source.html#l00434">EntityManagerTrait.php:434</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_a8e9e0e801f3bc1dd0ba6575643dc4704"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a8e9e0e801f3bc1dd0ba6575643dc4704">OCA\CAFEVDB\Traits\persist</a></div><div class="ttdeci">persist(mixed $entity)</div><div class="ttdoc">Tells the EntityManager to make an instance managed and persistent.</div><div class="ttdef"><b>Definition:</b> <a href="_entity_manager_trait_8php_source.html#l00208">EntityManagerTrait.php:208</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_a99b7aab0b8e4fdf667a5729026a0828f"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#a99b7aab0b8e4fdf667a5729026a0828f">OCA\CAFEVDB\Traits\getReference</a></div><div class="ttdeci">getReference(string $entityClassName, mixed $key)</div><div class="ttdoc">Gets a reference to the entity identified by the given type and identifier without actually loading i...</div><div class="ttdef"><b>Definition:</b> <a href="_entity_manager_trait_8php_source.html#l00187">EntityManagerTrait.php:187</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_aa57ee6dad7c7f33cff6983ad79080946"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aa57ee6dad7c7f33cff6983ad79080946">OCA\CAFEVDB\Traits\getConfigValue</a></div><div class="ttdeci">getConfigValue(string $key, mixed $default=null)</div><div class="ttdoc">Get a possibly encrypted config value.</div><div class="ttdef"><b>Definition:</b> <a href="_config_trait_8php_source.html#l00338">ConfigTrait.php:338</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_aaeb05cf94149de0821a30628a8c7bcef"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#aaeb05cf94149de0821a30628a8c7bcef">OCA\CAFEVDB\Traits\moneyValue</a></div><div class="ttdeci">moneyValue(mixed $value, ?string $locale=null)</div><div class="ttdoc">Convert $value to a currency value in the given or default locale.</div><div class="ttdef"><b>Definition:</b> <a href="_config_trait_8php_source.html#l00962">ConfigTrait.php:962</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_ab6f5f4edde190f5e5f1cd1e2fdd402d4"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#ab6f5f4edde190f5e5f1cd1e2fdd402d4">OCA\CAFEVDB\Traits\getDatabaseRepository</a></div><div class="ttdeci">getDatabaseRepository($entityClassName=null)</div><div class="ttdoc">Set and get the given name as the current database target entity.</div><div class="ttdef"><b>Definition:</b> <a href="_entity_manager_trait_8php_source.html#l00081">EntityManagerTrait.php:81</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_ad0e227937c98eb3733d82ea455977862"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#ad0e227937c98eb3733d82ea455977862">OCA\CAFEVDB\Traits\formatDateTime</a></div><div class="ttdeci">formatDateTime($timestamp, string $formatDate='long', string $formatTime='medium', DateTimeZone $timeZone=null, IL10N $l=null)</div><div class="ttdoc">Work around NC annoyingly not accepting \DateTimeInterface.</div><div class="ttdef"><b>Definition:</b> <a href="_config_trait_8php_source.html#l00831">ConfigTrait.php:831</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_ad9f7964d2ea3ec421dd166a41e4ff17d"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#ad9f7964d2ea3ec421dd166a41e4ff17d">OCA\CAFEVDB\Traits\flush</a></div><div class="ttdeci">flush($entity=null)</div><div class="ttdoc">Flushes all changes to objects that have been queued up to now to the database.</div><div class="ttdef"><b>Definition:</b> <a href="_entity_manager_trait_8php_source.html#l00229">EntityManagerTrait.php:229</a></div></div>
<div class="ttc" id="anamespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits_html_af5292021a7603645a7372870c43e6115"><div class="ttname"><a href="namespace_o_c_a_1_1_c_a_f_e_v_d_b_1_1_traits.html#af5292021a7603645a7372870c43e6115">OCA\CAFEVDB\Traits\getClubMembersProjectId</a></div><div class="ttdeci">getClubMembersProjectId()</div><div class="ttdef"><b>Definition:</b> <a href="_config_trait_8php_source.html#l00574">ConfigTrait.php:574</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_97aefd0d527b934f1d99a682da8fe6a9.html">lib</a></li><li class="navelem"><a class="el" href="dir_c3772678a21d6b058da687e6d68001d4.html">EmailForm</a></li><li class="navelem"><b>Composer.php</b></li>
    <li class="footer">Generated on Sun Mar 19 2023 16:18:28 for CamerataDB by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
