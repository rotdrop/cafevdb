<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>app/project-participant-fields.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#actionHandler">actionHandler</a></li><li><a href="global.html#addEditor">addEditor</a></li><li><a href="global.html#addMusicians">addMusicians</a></li><li><a href="global.html#addReadyCallback">addReadyCallback</a></li><li><a href="global.html#afterLoad">afterLoad</a></li><li><a href="global.html#ajaxFailData">ajaxFailData</a></li><li><a href="global.html#ajaxFailMessage">ajaxFailMessage</a></li><li><a href="global.html#ajaxHandleError">ajaxHandleError</a></li><li><a href="global.html#ajaxValidateResponse">ajaxValidateResponse</a></li><li><a href="global.html#appInfo">appInfo</a></li><li><a href="global.html#applyToolTips">applyToolTips</a></li><li><a href="global.html#appPrefix">appPrefix</a></li><li><a href="global.html#appSettings">appSettings</a></li><li><a href="global.html#attachHandlers">attachHandlers</a></li><li><a href="global.html#checkInvalidInputs">checkInvalidInputs</a></li><li><a href="global.html#chosenActive">chosenActive</a></li><li><a href="global.html#clearObject">clearObject</a></li><li><a href="global.html#closeActionMenu">closeActionMenu</a></li><li><a href="global.html#contactValidation">contactValidation</a></li><li><a href="global.html#containerSelector">containerSelector</a></li><li><a href="global.html#createProgressStatus">createProgressStatus</a></li><li><a href="global.html#debugPopup">debugPopup</a></li><li><a href="global.html#dialogCustomCloseButton">dialogCustomCloseButton</a></li><li><a href="global.html#dialogFullScreenButton">dialogFullScreenButton</a></li><li><a href="global.html#dialogToBackButton">dialogToBackButton</a></li><li><a href="global.html#documentReady">documentReady</a></li><li><a href="global.html#download">download</a></li><li><a href="global.html#emailFormCompositionHandlers">emailFormCompositionHandlers</a></li><li><a href="global.html#emailFormPopup">emailFormPopup</a></li><li><a href="global.html#emailFormRecipientsHandlers">emailFormRecipientsHandlers</a></li><li><a href="global.html#emailFormRecipientsSelectControls">emailFormRecipientsSelectControls</a></li><li><a href="global.html#emailPopup">emailPopup</a></li><li><a href="global.html#eventsPopup">eventsPopup</a></li><li><a href="global.html#findOptionByValue">findOptionByValue</a></li><li><a href="global.html#FindRanges">FindRanges</a></li><li><a href="global.html#formSubmit">formSubmit</a></li><li><a href="global.html#generateSettingsUrl">generateSettingsUrl</a></li><li><a href="global.html#generateUrl">generateUrl</a></li><li><a href="global.html#getAppUrl">getAppUrl</a></li><li><a href="global.html#getChildren">getChildren</a></li><li><a href="global.html#getControlObject">getControlObject</a></li><li><a href="global.html#getOptions">getOptions</a></li><li><a href="global.html#getOptionValues">getOptionValues</a></li><li><a href="global.html#getPersonalUrl">getPersonalUrl</a></li><li><a href="global.html#getSelectize">getSelectize</a></li><li><a href="global.html#getToken">getToken</a></li><li><a href="global.html#getUrl">getUrl</a></li><li><a href="global.html#getWidget">getWidget</a></li><li><a href="global.html#handleProjectActions">handleProjectActions</a></li><li><a href="global.html#handleQueryLogMenu">handleQueryLogMenu</a></li><li><a href="global.html#handleTableExportMenu">handleTableExportMenu</a></li><li><a href="global.html#htmlDecode">htmlDecode</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#installInputSelectize">installInputSelectize</a></li><li><a href="global.html#instrumentationNumbersPopup">instrumentationNumbersPopup</a></li><li><a href="global.html#invalidInputDowncount">invalidInputDowncount</a></li><li><a href="global.html#isVanilla">isVanilla</a></li><li><a href="global.html#jQuery">jQuery</a></li><li><a href="global.html#lazyBatchDecryptValues">lazyBatchDecryptValues</a></li><li><a href="global.html#loadPage">loadPage</a></li><li><a href="global.html#loadPMETable">loadPMETable</a></li><li><a href="global.html#loadPMETableFiltered">loadPMETableFiltered</a></li><li><a href="global.html#mandatesInit">mandatesInit</a></li><li><a href="global.html#mandateValidate">mandateValidate</a></li><li><a href="global.html#mandateValidatePME">mandateValidatePME</a></li><li><a href="global.html#mandateValidatePMEPromise">mandateValidatePMEPromise</a></li><li><a href="global.html#mandateValidatePMEWorker">mandateValidatePMEWorker</a></li><li><a href="global.html#maybeTranspose">maybeTranspose</a></li><li><a href="global.html#messages">messages</a></li><li><a href="global.html#modalizer">modalizer</a></li><li><a href="global.html#modalWaitNotification">modalWaitNotification</a></li><li><a href="global.html#myLoadAddMusicians">myLoadAddMusicians</a></li><li><a href="global.html#myLoadMusicians">myLoadMusicians</a></li><li><a href="global.html#myLoadProjectParticipants">myLoadProjectParticipants</a></li><li><a href="global.html#myPersonalRecordDialog">myPersonalRecordDialog</a></li><li><a href="global.html#nonTextInputTypes">nonTextInputTypes</a></li><li><a href="global.html#participantFieldsPopup">participantFieldsPopup</a></li><li><a href="global.html#photoEditCurrent">photoEditCurrent</a></li><li><a href="global.html#photoLoad">photoLoad</a></li><li><a href="global.html#photoLoadHandlers">photoLoadHandlers</a></li><li><a href="global.html#photoReady">photoReady</a></li><li><a href="global.html#photoUploadDragDrop">photoUploadDragDrop</a></li><li><a href="global.html#pmeCellSelector">pmeCellSelector</a></li><li><a href="global.html#pmeClassSelector">pmeClassSelector</a></li><li><a href="global.html#pmeClassSelectors">pmeClassSelectors</a></li><li><a href="global.html#pmeContainer">pmeContainer</a></li><li><a href="global.html#pmeContextMenu">pmeContextMenu</a></li><li><a href="global.html#pmeData">pmeData</a></li><li><a href="global.html#pmeDeferReload">pmeDeferReload</a></li><li><a href="global.html#pmeFilterSelector">pmeFilterSelector</a></li><li><a href="global.html#pmeFormSelector">pmeFormSelector</a></li><li><a href="global.html#pmeIdSelector">pmeIdSelector</a></li><li><a href="global.html#pmeInit">pmeInit</a></li><li><a href="global.html#pmeInner">pmeInner</a></li><li><a href="global.html#pmeInputSelector">pmeInputSelector</a></li><li><a href="global.html#pmeKeySelector">pmeKeySelector</a></li><li><a href="global.html#pmeNavigationSelector">pmeNavigationSelector</a></li><li><a href="global.html#pmeOpenRowDialog">pmeOpenRowDialog</a></li><li><a href="global.html#pmeQueryInfoSelector">pmeQueryInfoSelector</a></li><li><a href="global.html#pmeRec">pmeRec</a></li><li><a href="global.html#pmeRecordValue">pmeRecordValue</a></li><li><a href="global.html#pmeSelector">pmeSelector</a></li><li><a href="global.html#pmeSubmitOuterForm">pmeSubmitOuterForm</a></li><li><a href="global.html#pmeSys">pmeSys</a></li><li><a href="global.html#pmeSysNameSelector">pmeSysNameSelector</a></li><li><a href="global.html#pmeSysNameSelectors">pmeSysNameSelectors</a></li><li><a href="global.html#pmeTableDialogOpen">pmeTableDialogOpen</a></li><li><a href="global.html#pmeTableSelector">pmeTableSelector</a></li><li><a href="global.html#pmeToken">pmeToken</a></li><li><a href="global.html#pmeTriggerSubmit">pmeTriggerSubmit</a></li><li><a href="global.html#pmeTweaks">pmeTweaks</a></li><li><a href="global.html#pmeUnTweak">pmeUnTweak</a></li><li><a href="global.html#pmeValueSelector">pmeValueSelector</a></li><li><a href="global.html#pollProgressStatus">pollProgressStatus</a></li><li><a href="global.html#print_r">print_r</a></li><li><a href="global.html#projectPaymentPopup">projectPaymentPopup</a></li><li><a href="global.html#projectViewPopup">projectViewPopup</a></li><li><a href="global.html#projectWebPageRequest">projectWebPageRequest</a></li><li><a href="global.html#projectWebPageTabHandler">projectWebPageTabHandler</a></li><li><a href="global.html#pseudoSubmit">pseudoSubmit</a></li><li><a href="global.html#pseudoSubmitPost">pseudoSubmitPost</a></li><li><a href="global.html#queryData">queryData</a></li><li><a href="global.html#refreshSelectWidget">refreshSelectWidget</a></li><li><a href="global.html#refreshWidgetProperties">refreshWidgetProperties</a></li><li><a href="global.html#removeEditor">removeEditor</a></li><li><a href="global.html#renderTag">renderTag</a></li><li><a href="global.html#replaceSelectOptions">replaceSelectOptions</a></li><li><a href="global.html#runReadyCallbacks">runReadyCallbacks</a></li><li><a href="global.html#selectedOptions">selectedOptions</a></li><li><a href="global.html#selectedValues">selectedValues</a></li><li><a href="global.html#selectizeActive">selectizeActive</a></li><li><a href="global.html#setAppUrl">setAppUrl</a></li><li><a href="global.html#setPersonalUrl">setPersonalUrl</a></li><li><a href="global.html#setToken">setToken</a></li><li><a href="global.html#simpleSetHandler">simpleSetHandler</a></li><li><a href="global.html#simpleSetValueHandler">simpleSetValueHandler</a></li><li><a href="global.html#snapshotEditor">snapshotEditor</a></li><li><a href="global.html#stopEnterSubmit">stopEnterSubmit</a></li><li><a href="global.html#tableDialog">tableDialog</a></li><li><a href="global.html#tableDialogHandlers">tableDialogHandlers</a></li><li><a href="global.html#tableDialogReload">tableDialogReload</a></li><li><a href="global.html#tableDialogReplace">tableDialogReplace</a></li><li><a href="global.html#Template">Template</a></li><li><a href="global.html#textareaResize">textareaResize</a></li><li><a href="global.html#toolTipsEnabled">toolTipsEnabled</a></li><li><a href="global.html#toolTipsInit">toolTipsInit</a></li><li><a href="global.html#transposeMainTable">transposeMainTable</a></li><li><a href="global.html#transposeReady">transposeReady</a></li><li><a href="global.html#unfocus">unfocus</a></li><li><a href="global.html#updateEditor">updateEditor</a></li><li><a href="global.html#urlDecode">urlDecode</a></li><li><a href="global.html#urlEncode">urlEncode</a></li><li><a href="global.html#validateInstrumentChoices">validateInstrumentChoices</a></li><li><a href="global.html#wikiPopup">wikiPopup</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">app/project-participant-fields.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Orchestra member, musicion and project management application.
 *
 * CAFEVDB -- Camerata Academica Freiburg e.V. DataBase.
 *
 * @author Claus-Justus Heine
 * @copyright 2011-2016, 2020, 2021, 2022, 2023 Claus-Justus Heine &lt;himself@claus-justus-heine.de>
 * @license AGPL-3.0-or-later
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see &lt;http://www.gnu.org/licenses/>.
 */

import { globalState, appName, $ } from './globals.js';
import * as CAFEVDB from './cafevdb.js';
import * as Ajax from './ajax.js';
import * as PHPMyEdit from './pme.js';
import * as Notification from './notification.js';
import * as SelectUtils from './select-utils.js';
import * as Dialogs from './dialogs.js';
import * as DialogUtils from './dialog-utils.js';
import * as ProgressStatus from './progress-status.js';
import * as WysiwygEditor from './wysiwyg-editor.js';
import generateUrl from './generate-url.js';
import textareaResize from './textarea-resize.js';
import { rec as pmeRec } from './pme-record-id.js';
import './lock-input.js';
import { textInputSelector, nonTextInputSelector, textElementSelector } from '../util/css-selectors.js';
require('../legacy/nextcloud/jquery/octemplate.js');
require('jquery-ui/ui/widgets/autocomplete');
require('jquery-ui/themes/base/autocomplete.css');

require('./jquery-ui-progressbar.js');
require('./jquery-datetimepicker.js');

// NB: much of the visibility stuff is handled by CSS, e.g. which
// input is shown for which multiplicity.
require('project-participant-fields.scss');

const confirmedReceivablesUpdate = function(updateStrategy, requestHandler, single) {
  const handlerWithProgress = function() {
    ProgressStatus.create(-1, 0, { field: null, musician: '', receivable: '' })
      .fail(Ajax.handleError)
      .done(function(data) {
        if (!Ajax.validateResponse(data, ['id'])) {
          return;
        }
        const progressToken = data.id;
        const progressWrapperTemplate = $('#progressWrapperTemplate');
        const progressWrapperId = 'project-participant-fields-progress';
        const progressWrapper = progressWrapperTemplate.octemplate({
          wrapperId: progressWrapperId,
          caption: '',
          label: '',
        });
        const oldProgressWrapper = $('#' + progressWrapperId);
        if (oldProgressWrapper.length === 0) {
          $('body').append(progressWrapper);
        } else {
          oldProgressWrapper.replaceWith(progressWrapper);
        }
        progressWrapper.find('span.progressbar').progressbar({ value: 0, max: 100 });
        let progressOpen = false;
        progressWrapper.cafevDialog({
          title: t(appName, 'Updating recurring receivables'),
          width: 'auto',
          height: 'auto',
          modal: true,
          closeOnEscape: false,
          resizable: false,
          dialogClass: 'progress-status progress',
          buttons: [
            {
              text: t(appName, 'cancel'),
              title: t(appName, 'Cancel the operation in progress.'),
              class: 'cancel',
              click() {
                // if (ajaxRequest) {
                //   ajaxRequest.abort('cancelled');
                //   ajaxRequest = null;
                // }
                $(this).dialog('close');
              },
            },
          ],
          open() {
            const dialogHolder = $(this);
            DialogUtils.toBackButton(dialogHolder);
            DialogUtils.customCloseButton(dialogHolder, function(event, container) {
              dialogHolder.dialog('widget').find('.cancel.ui-button').trigger('click');
              return false;
            });
            progressOpen = true;
            ProgressStatus.poll(progressToken, {
              update(id, current, target, data) {
                if (data.field) {
                  try {
                    dialogHolder.dialog(
                      'option', 'title',
                      t(appName, 'Updating receivables for {field}, {receivable}, {musician}',
                        { field: data.field || '', receivable: data.receivable || '', musician: data.musician || '' })
                    );
                  } catch (e) {
                    // don't care
                  }
                }
                if (current >= 0 &amp;&amp; target > 0) {
                  progressWrapper.find('.progressbar .label').text(
                    t(appName, '{current} of {target}', { current, target }));
                }
                progressWrapper.find('.progressbar').progressbar('option', 'value', current / target * 100.0);
                return current &lt; 0 || current !== target;
              },
              fail(xhr, status, errorThrown) { Ajax.handleError(xhr, status, errorThrown); },
              interval: 500,
            });
          },
          close() {
            progressOpen = false;
            ProgressStatus.poll.stop();
            ProgressStatus.delete(progressToken);
            progressWrapper.dialog('destroy');
            progressWrapper.hide();
          },
        });
        requestHandler(progressToken, function() {
          if (progressOpen) {
            try {
              progressWrapper.dialog('close');
            } catch (e) {
              // don't care
            }
          }
        });
      });
  };
  const handler = single
    ? function() { requestHandler(null, function() {}); }
    : handlerWithProgress;
  if (updateStrategy === 'replace') {
    Dialogs.confirm(
      t(appName, 'Update strategy "{updateStrategy}" replaces the value of existing receivables, please confirm that you want to continue.', { updateStrategy }),
      t(appName, 'Overwrite Existing Records?'),
      (answer) => (answer &amp;&amp; handler()));
  } else {
    handler();
  }
};

const ready = function(selector, resizeCB) {
  const $container = $(selector);

  const $tableTab = $container.find('select.tab');
  const $newTab = $container.find('input.new-tab');
  $newTab.prop('readonly', !!SelectUtils.selected($tableTab));
  $container.on('change', 'select.tab', function(event) {
    $newTab.prop('readonly', !!SelectUtils.selected($tableTab));
    return false;
  });

  const setFieldTypeCssClass = function(data) {
    if (!data) {
      return;
    }
    const dataType = data.dataType;
    const multiplicity = data.multiplicity;
    const dueDate = data.depositDueDate;
    const multiplicityClass = 'multiplicity-' + multiplicity;
    const dataTypeClass = 'data-type-' + dataType;
    const depositDueDateClass = 'deposit-due-date-' + dueDate;
    $container.find('tr.multiplicity')
      .removeClass(function(index, className) {
        return (className.match(/\b(multiplicity|data-type|deposit-due-date)-\S+/g) || []).join(' ');
      })
      .addClass([multiplicityClass, dataTypeClass, depositDueDateClass]);
    $container.find('tr.data-options table.data-options')
      .removeClass(function(index, className) {
        return (className.match(/\b(multiplicity|data-type|deposit-due-date)-\S+/g) || []).join(' ');
      })
      .addClass([multiplicityClass, dataTypeClass]);

    $container.find('[class*="-multiplicity-required"], [class*="-data-type-required"], [class*="-deposit-due-date-required"]').each(function(index) {
      const $this = $(this);
      let required = false;
      for (const className of $this.attr('class').split(/\s+/)) {
        switch (className) {
        case multiplicity + '-multiplicity-required':
        case dataType + '-data-type-required':
        case dueDate + '-deposit-due-date-required':
        case 'multiplicity-' + multiplicity + '-' + dueDate + '-deposit-due-date-required':
          required = true;
          break;
        default:
          break;
        }
        if (className === 'not-multiplicity-' + multiplicity + '-' + dueDate + '-deposit-due-date-required') {
          required = false;
          break; // kill-switch, bail out.
        }
        const onlyMultiplicityRequired = className.match(/only-multiplicity-(.*)-multiplicity-required/);
        if (onlyMultiplicityRequired &amp;&amp; onlyMultiplicityRequired[1] !== multiplicity) {
          required = false;
          break; // kill-switch, bail out.
        }
      }
      $this.prop('required', required);
    });
    $container.find('.data-type-html-disabled, .data-type-html-disabled *').prop('disabled', dataType === 'html');
    $container.find('.not-data-type-html-disabled, .not-data-type-html-disabled *').prop('disabled', dataType !== 'html');

    $container.find('.data-type-html-wysiwyg-editor').each(function() {
      const $this = $(this);
      WysiwygEditor.removeEditor($this);
      if (dataType === 'html') {
        WysiwygEditor.addEditor($this, resizeCB);
      }
    });

    const inputData = $container.find('table.data-options').data('size');
    const $dataInputs = $container
      .find(
        'tr.pme-row.' + 'data-options-' + multiplicity + ' td.pme-value'
          + ', '
          + 'tr.pme-row.data-options td.pme-value table.' + multiplicityClass + ' tr:not(.generator, .placeholder)')
      .find('input.field-data')
      .not(nonTextInputSelector);

    const dateTimePickerSelector = 'body > .xdsoft_datetimepicker';
    $dataInputs.each(function() {
      const $this = $(this);
      if ($this.hasClass('hasDatepicker')) {
        $this.datepicker('destroy');
      }
      $this.datetimepicker('destroy');
      if (inputData) {
        const inputSize = inputData[dataType] || inputData.default;
        if (inputSize) {
          $this.attr('size', inputSize);
        } else {
          console.warn('No input size defined, even not the default', $this, inputData, dataType);
        }
      }
    });
    $(dateTimePickerSelector).remove();
    switch (dataType) {
    case 'receivables':
    case 'liabilities':
      $dataInputs
        .attr('type', 'number')
        .attr('step', '0.01');
      break;
    case 'date':
      $dataInputs
        .attr('type', 'text')
        .removeAttr('step')
        .datepicker({
          minDate: '01.01.1940', // birthday
        });
      // $dataInputs
      //   .off('change')
      //   .on('change', function(event) {
      //     const $this = $(this);
      //     console.info('DATE', $this.datepicker('getDate'));
      //   });
      break;
    case 'datetime':
      $dataInputs
        .attr('type', 'text')
        .removeAttr('step')
        .datetimepicker({
          step: 5,
        });
      break;
    default:
      $dataInputs
        .attr('type', 'text')
        .removeAttr('step');
      break;
    }
  };

  const isMonetaryType = dataType => dataType === 'receivables' || dataType === 'liabilities';

  const fieldTypeData = function() {
    const multiplicity = $container.find('select.multiplicity');
    const dataType = $container.find('select.data-type');
    const depositDueDate = $container.find('input.deposit-due-date');
    if (multiplicity.length > 0 &amp;&amp; dataType.length > 0) {
      const data = {
        multiplicity: multiplicity.val(),
        dataType: dataType.val(),
        depositDueDate: (isMonetaryType(dataType) &amp;&amp; depositDueDate.val() !== '') ? 'set' : 'unset',
      };
      return data;
    }
    const elem = $container.find('td.pme-value.field-type .data');
    if (elem.length &lt;= 0) {
      return null;
    }
    return elem.data('data');
  };

  /**
   * Hide the header for single choice options because in View and
   * Delete mode the mult-value table is used as well.
   */
  const allowedHeaderVisibility = function() {
    const allowedValuesTable = $container.find('table.data-options');
    if (allowedValuesTable.hasClass('multiplicity-multiple')
        || allowedValuesTable.hasClass('multiplicity-parallel')
        || allowedValuesTable.hasClass('multiplicity-recurring')
        || allowedValuesTable.hasClass('multiplicity-groups-of-people')
        || allowedValuesTable.find('tbody tr:visible').length >= 1) {
      allowedValuesTable.find('thead').show();
    } else {
      allowedValuesTable.find('thead').hide();
    }
  };

  // Field-Type Selectors
  $container.on(
    'change', [
      'select.multiplicity',
      'select.data-type',
      'input.deposit-due-date',
    ].join(), function(event) {
      const depositDueDateInput = $container.find('input.deposit-due-date');
      const multiplicitySelect = $container.find('select.multiplicity');
      const dataTypeSelect = $container.find('select.data-type');
      const multiplicity = multiplicitySelect.val();
      const dataTypeMask = SelectUtils.optionByValue(multiplicitySelect, multiplicity).data('data');
      let dataType = dataTypeSelect.val();
      const enabledTypes = [];
      dataTypeSelect.find('option').each(function(index) {
        const $option = $(this);
        const value = $option.val();
        if (value === '') {
          return;
        }
        const enabled = dataTypeMask.indexOf(value) === -1;
        if (enabled) {
          enabledTypes.push(value);
        }
        $option.prop('disabled', !enabled);
      });
      if (enabledTypes.indexOf(dataType) === -1) {
        if (enabledTypes.length > 0) {
          dataType = enabledTypes[0];
          dataTypeSelect.val(dataType);
        } else {
          dataType = '';
          console.error('no data types left to enable');
        }
      }
      dataTypeSelect.trigger('chosen:updated');
      const depositDueDate = (isMonetaryType(dataType) &amp;&amp; depositDueDateInput.val() !== '') ? 'set' : 'unset';
      setFieldTypeCssClass({ multiplicity, dataType, depositDueDate });
      allowedHeaderVisibility();
      console.debug('RESIZECB');
      resizeCB();

      $.fn.cafevTooltip.remove(); // remove left-overs

      return false;
    });
  $container.find('select.multiplicity:not(.pme-filter)').trigger('change');

  $container.on('keypress', 'tr.data-options input' + textInputSelector, function(event) {
    let pressedKey;
    if (event.which) {
      pressedKey = event.which;
    } else {
      pressedKey = event.keyCode;
    }
    if (pressedKey === 13) { // enter pressed
      event.stopImmediatePropagation();
      $(this).blur();
      return false;
    }
    return true; // other key pressed
  });

  const $dataOptionsTable = $container.find('table.data-options');
  $container.on('change', '#data-options-show-deleted', function(event) {
    if ($(this).prop('checked')) {
      $dataOptionsTable.addClass('show-deleted');
    } else {
      $dataOptionsTable.removeClass('show-deleted');
    }
    $.fn.cafevTooltip.remove();
    allowedHeaderVisibility();
    resizeCB();
    return false;
  });

  $container.on('change', '#data-options-show-data', function(event) {
    if ($(this).prop('checked')) {
      $dataOptionsTable.addClass('show-data');
    } else {
      $dataOptionsTable.removeClass('show-data');
    }
    $.fn.cafevTooltip.remove();
    allowedHeaderVisibility();
    resizeCB();
    return false;
  });

  $container.on('change', 'select.default-multi-value', function(event) {
    const $self = $(this);
    $container.find('input.pme-input.default-single-value').val(SelectUtils.selected($self));
    return false;
  });

  $container.on('blur', 'input.pme-input.default-single-value', function(event) {
    const self = $(this);
    const dfltSelect = $container.find('select.default-multi-value');
    dfltSelect.children('option[value="' + self.val() + '"]').prop('selected', true);
    dfltSelect.trigger('chosen:updated');
    return false;
  });

  $container.on('click', 'tr.data-options input.regenerate', function(event) {
    const $self = $(this);
    const $row = $self.closest('tr.data-options');
    const fieldId = pmeRec($container);
    const key = $row.find('input.field-key').val();
    const updateStrategy = $self.closest('table').find('select.recurring-receivables-update-strategy').val();
    const requestHandler = function(progressToken, progressCleanup) {
      const cleanup = function() {
        progressCleanup();
        $self.removeClass('busy');
      };
      const request = 'option/regenerate';
      $self.addClass('busy');
      return $.post(
        generateUrl('projects/participant-fields/' + request), {
          data: {
            fieldId,
            key,
            updateStrategy,
            progressToken,
          },
        })
        .fail(function(xhr, status, errorThrown) {
          Ajax.handleError(xhr, status, errorThrown, cleanup);
        })
        .done(function(data) {
          if (!Ajax.validateResponse(data, [], cleanup)) {
            return;
          }
          cleanup();
          Notification.messages(data.message);
        });
    };
    confirmedReceivablesUpdate(updateStrategy, requestHandler);
    return false;
  });

  $container.on('click', 'tr.data-options input.regenerate-all', function(event) {
    const $self = $(this);
    const $row = $self.closest('tr.data-options');
    const fieldId = $row.data('fieldId');
    const updateStrategy = $row.find('select.recurring-receivables-update-strategy').val();
    const requestHandler = function(progressToken, progressCleanup) {
      const cleanup = function() {
        progressCleanup();
        $self.removeClass('busy');
      };
      const request = 'generator/regenerate';
      $self.addClass('busy');
      return $.post(
        generateUrl('projects/participant-fields/' + request), {
          data: {
            fieldId,
            updateStrategy,
            progressToken,
          },
        })
        .fail(function(xhr, status, errorThrown) {
          Ajax.handleError(xhr, status, errorThrown, cleanup);
        })
        .done(function(data) {
          if (!Ajax.validateResponse(data, ['fieldsAffected'], cleanup)) {
            return;
          }
          Notification.messages(data.message);
          cleanup();
        });
    };
    confirmedReceivablesUpdate(updateStrategy, requestHandler);
    return false;
  });

  $container.on('click', 'tr.data-options input.generator-run', function(event) {
    const $self = $(this);
    const $row = $self.closest('tr.data-options');
    const fieldId = $row.data('fieldId');
    // defer submit until after validation.
    const submitDefer = PHPMyEdit.deferReload($container);
    const cleanup = function() {
      $self.removeClass('busy');
      setFieldTypeCssClass(fieldTypeData());
      submitDefer.resolve();
    };
    const request = 'generator/run';
    const startDate = $self.closest('tr').find('.field-limit');
    $self.addClass('busy');
    $.post(
      generateUrl('projects/participant-fields/' + request), {
        data: {
          fieldId,
          startDate: startDate.val(),
        },
      })
      .fail(function(xhr, status, errorThrown) {
        Ajax.handleError(xhr, status, errorThrown, cleanup);
      })
      .done(function(data) {
        if (!Ajax.validateResponse(data, ['startDate', 'dataOptionFormInputs'], cleanup)) {
          return;
        }
        const body = $self.closest('tbody');
        body.find('tr').not('.generator, .placeholder').remove();
        body.parents('table').find('thead').show();
        const tail = body.children().first();
        for (const input of data.dataOptionFormInputs) {
          tail.before(input);
        }
        lockGeneratedValues($container);
        startDate.val(data.startDate);
        resizeCB();
        cleanup();
        Notification.messages(data.message);
      });
    return false;
  });

  $container.on('click', 'tr.data-options input.delete-undelete', function(event) {
    const $self = $(this);
    const $row = $self.closest('tr.data-options');
    const dfltSelect = $container.find('select.default-multi-value');
    let used = $row.data('used');
    used = !(!used || used === 'unused');
    if ($row.data('deleted') !== '') {
      // undelete
      $row.data('deleted', '');
      $row.switchClass('deleted', 'active');
      $row.find('input.field-deleted').val('');
      $row.find('input' + textInputSelector + ':not(.field-key), textarea').prop('readonly', false);
      $row.find('input.operation').prop('disabled', false);
      const key = $row.find('input.field-key');
      const label = $row.find('input.field-label');
      const option = '&lt;option value="' + key.val() + '">' + label.val() + '&lt;/option>';
      dfltSelect.children('option').first().after(option);
    } else {
      const key = $row.find('input.field-key').val();
      if (!used) {
        // just remove the row
        $row.remove();
      } else {
        // must not delete, mark as inactive
        $row.data('deleted', Date.now() / 1000.0);
        $row.switchClass('active', 'deleted');
        $row.find('input.field-deleted').val($row.data('deleted'));
        $row.find('input' + textInputSelector + ', textarea').prop('readonly', true);
        $row.find('input.operation.regenerate').prop('disabled', true);
      }
      dfltSelect.find('option[value="' + key + '"]').remove();
    }
    setTimeout(function() {
      dfltSelect.trigger('chosen:updated');
      $.fn.cafevTooltip.remove();
      allowedHeaderVisibility();
      resizeCB();
    }, 400);
    return false;
  });

  // validate monetary inputs
  $container.on(
    'blur',
    [
      'tr.multiplicity.data-type-receivables ~ tr.data-options-single input' + textInputSelector,
      'tr.multiplicity.data-type-receivables:not(.multiplicity-recurring) ~ tr.data-options tr.data-options:not(.generator) input.field-data' + textInputSelector,
      'tr.multiplicity.data-type-liabilities ~ tr.data-options-single input' + textInputSelector,
      'tr.multiplicity.data-type-liabilities:not(.multiplicity-recurring) ~ tr.data-options tr.data-options:not(.generator) input.field-data' + textInputSelector,
    ].join(),
    function(event) {
      const self = $(this);
      if (self.prop('readonly')) {
        return false;
      }
      const amount = self.val().trim();
      if (amount === '') {
        self.val('');
        return false;
      }

      // defer submit until after validation.
      const submitDefer = PHPMyEdit.deferReload($container);
      self.prop('readonly', true);

      const cleanup = function() {
        self.prop('readonly', false);
        submitDefer.resolve();
      };

      $.post(
        generateUrl('validate/general/monetary-value'), { value: amount })
        .fail(function(xhr, status, errorThrown) {
          Ajax.handleError(xhr, status, errorThrown, cleanup);
        })
        .done(function(data) {
          if (!Ajax.validateResponse(data, ['amount'], cleanup)) {
            return;
          }
          self.val(data.amount);
          cleanup();
        });
      return false;
    });

  const lockGeneratedValuesRow = function($row) {
    const generated = $row.find('input' + textInputSelector + ', textarea');
    generated.each(function(index) {
      const $this = $(this);
      if (!$this.hasClass('expert-mode-only') &amp;&amp; !$this.hasClass('not-expert-mode-hidden')) {
        $this.lockUnlock({
          locked: $this.val().trim() !== '',
        });
      }
      if (!$this.hasClass('finance-mode-only') &amp;&amp; !$this.hasClass('not-finance-mode-hidden')) {
        $this.lockUnlock({
          locked: $this.val().trim() !== '',
        });
      }
    });
  };

  const lockGeneratedValues = function($container) {
    // generated options
    const generatedSelector = 'tr.data-options table.multiplicity-recurring tr.data-line.data-options:not(.generator)';
    lockGeneratedValuesRow($container.find(generatedSelector));
  };

  lockGeneratedValues($container);

  // generator input
  const generatorSelector = 'tr.data-options table.multiplicity-recurring tr.data-line.generator input' + textInputSelector;
  const generator = $container.find(generatorSelector);
  generator.each(function(index) {
    const $this = $(this);
    $this.lockUnlock({
      locked: $this.val().trim() !== '',
    });
    if ($this.is('.field-limit')) {
      $this.datepicker({
        minDate: '01.01.2000', // no receivables before this time
      });
    }
  });

  // generated due date
  const dueDate = $container.find('tr.multiplicity-recurring ~ tr.due-date td.pme-value input').not(nonTextInputSelector);
  if (dueDate.length > 0) {
    dueDate.lockUnlock({
      locked: dueDate.val().trim() !== '',
    });
  }

  $container.on(
    'blur',
    generatorSelector + '.field-data',
    function(event) {
      const $self = $(this);
      if ($self.prop('readonly')) {
        return false;
      }
      const $row = $self.closest('tr.data-options');

      const request = 'generator/define';
      const data = $.extend({}, fieldTypeData(), $row.data());
      const allowed = $row.find(textElementSelector);
      const postData = $.param({ request, data })
            + '&amp;' + allowed.serialize();

      // defer submit until after validation.
      const submitDefer = PHPMyEdit.deferReload($container);
      allowed.each(function(index) {
        const $this = $(this);
        $this.data('readonly-saved', $this.prop('readonly'));
        $this.prop('readonly', true);
      });
      const cleanup = function() {
        allowed.each(function(index) {
          const $this = $(this);
          $this.prop('readonly', $this.data('readonly-saved') || $this.hasClass('readonly'));
          $this.removeData('readonly-saved');
        });
        submitDefer.resolve();
      };

      $.post(
        generateUrl('projects/participant-fields/' + request),
        postData)
        .fail(function(xhr, status, errorThrown) {
          Ajax.handleError(xhr, status, errorThrown, cleanup);
        })
        .done(function(data) {
          if (!Ajax.validateResponse(
            data,
            ['value', 'slug', 'operationLabels', 'availableUpdateStrategies'],
            cleanup)) {
            return;
          }

          if (data.value !== $self.val()) {
            $self.val(data.value);
          }

          const fieldId = parseInt($row.data('fieldId'));
          const empty = $self.val().trim() === '';
          if (empty) {
            $self.removeClass('readonly');
          } else {
            $self.addClass('readonly');
          }
          $self.lockUnlock('lock', !empty);
          $row.find('.operation.generator-run').prop('disabled', empty || !(fieldId > 0));

          const $table = $row.closest('table');
          const oldGeneratorSlug = $row.data('generatorSlug');
          $table.removeClass('recurring-generator-' + oldGeneratorSlug);
          $table.addClass('recurring-generator-' + data.slug);
          $row.data('generatorSlug', data.slug);
          $row.removeClass('update-strategy-count-' + $row.data('availableUpdateStrategies').length);
          $row.data('availableUpdateStrategies', data.availableUpdateStrategies);
          $row.addClass('update-strategy-count-' + $row.data('availableUpdateStrategies').length);

          const operationClass = (operation, value) => [
            'recurring',
            operation,
            (value ? 'enabled' : 'disabled'),
          ].join('-');
          for (const [operation, value] of Object.entries(data.operationLabels)) {
            $table.removeClass([
              operationClass(operation, true),
              operationClass(operation, false),
            ]);
            $table.addClass(operationClass(operation, value));
          }

          // adjust update strategy options
          const $updateStrategies = $row.find('select.recurring-receivables-update-strategy');
          const defaultStrategy = $updateStrategies.data('defaultValue');
          $updateStrategies.find('option').each(function() {
            const $option = $(this);
            const optionValue = $option.val();
            if (optionValue !== '') {
              $option.prop('disabled', data.availableUpdateStrategies.indexOf($option.val()) === -1);
              if ($option.prop('disabled')) {
                $option.prop('selected', false);
              } else if (optionValue === defaultStrategy) {
                $updateStrategies.val(defaultStrategy);
              }
            }
          });
          if (data.availableUpdateStrategies.length === 1) {
            $updateStrategies.val(data.availableUpdateStrategies[0]);
          }

          Notification.messages(data.message);

          cleanup();
        });
      return false;
    });

  // multi-field input matrix
  $container.on(
    'blur', [
      'tr.data-options tr.data-line:not(.generator) input' + textInputSelector,
      'tr.data-options tr.data-line textarea',
    ].join(),
    function(event) {
      const self = $(this);
      if (self.prop('readonly')) {
        return false;
      }
      const $row = self.closest('tr.data-options');
      const $table = $row.closest('table.data-options');
      const placeHolder = $row.hasClass('placeholder');
      if (placeHolder &amp;&amp; self.val().trim() === '') {
        // don't add empty fields (but of course allow to remove field data)
        self.val('');
        return false;
      }

      // default data selector, if applicable
      const dflt = $container.find('select.default-multi-value');

      const request = 'option/define';
      const data = $.extend({ default: dflt.val() }, fieldTypeData(), $row.data());
      const allowed = $row.find(textElementSelector);
      const postData = $.param({ request, data })
            + '&amp;' + allowed.serialize();

      // defer submit until after validation.
      const submitDefer = PHPMyEdit.deferReload($container);
      allowed.prop('readonly', true);
      const cleanup = function() {
        if (!allowed.hasClass('readonly')) {
          allowed.prop('readonly', false);
        }
        setFieldTypeCssClass(fieldTypeData());
        submitDefer.resolve();
      };

      $.post(
        generateUrl('projects/participant-fields/' + request),
        postData)
        .fail(function(xhr, status, errorThrown) {
          Ajax.handleError(xhr, status, errorThrown, cleanup);
        })
        .done(function(data) {
          if (!Ajax.validateResponse(
            data,
            ['dataOptionSelectOption', 'dataOptionFormInputs'],
            cleanup)) {
            return;
          }
          const option = data.dataOptionSelectOption;
          const input = data.dataOptionFormInputs;
          $.fn.cafevTooltip.remove();
          if (placeHolder) {
            $row.parents('table').find('thead').show();
            $row.before(input).prev().find('input, textarea').cafevTooltip({ placement: 'auto right' });
            self.val('');
            $row.data('index', +$row.data('index') + 1); // next index
            resizeCB();
          } else {
            const $nextRow = $row.next();
            $row.replaceWith(input);
            const $newRow = $nextRow.prev();
            $newRow.find('input, textarea').cafevTooltip({ placement: 'auto right' });
            if ($table.hasClass('multiplicity-recurring')) {
              lockGeneratedValuesRow($newRow);
            }
          }
          // get the key &lt;-> value connection right for the default selector
          const newValue = $(option).val();
          const oldOption = dflt.find('option[value="' + newValue + '"]');
          if (oldOption.length > 0) {
            oldOption.replaceWith(option);
          } else {
            dflt.children('option').first().after(option);
          }
          dflt.trigger('chosen:updated');

          if (globalState.toolTipsEnabled) {
            $.fn.cafevTooltip.enable();
          } else {
            $.fn.cafevTooltip.disable();
          }

          cleanup();
        });
      return false;
    });

  // When a reader-group is removed, we also deselect it from the
  // writers. This -- of course -- only works if initially
  // the readers and writers list is in a sane state ;)
  $container.on('change', 'select.readers', function(event) {
    console.log('readers change');
    const $self = $(this);

    let changed = false;
    const $writers = $container.find('select.writers');
    SelectUtils.options($self).not(':selected').each(function() {
      const $writer = SelectUtils.optionByValue($writers, this.value);
      if ($writer.prop('selected')) {
        $writer.prop('selected', false);
        changed = true;
      }
    });
    if (changed) {
      SelectUtils.refreshWidget($writers);
    }
    return false;
  });

  // When a writer-group is added, then add it to the
  // readers as well ;)
  $container.on('change', 'select.writers', function(event) {
    const $self = $(this);

    let changed = false;
    const $readers = $container.find('select.readers');
    SelectUtils.selectedOptions($self).each(function() {
      const $reader = SelectUtils.optionByValue($readers, this.value);
      if (!$reader.prop('selected')) {
        $reader.prop('selected', true);
        changed = true;
      }
    });
    if (changed) {
      SelectUtils.refreshWidget($readers);
    }
    return false;
  });

  const tableContainerId = PHPMyEdit.idSelector('table-container');

  // TODO: check whether these are still necessary
  $container.on('chosen:showing_dropdown', tableContainerId + ' select', function(event) {
    console.log('chosen:showing_dropdown');
    // const widget = $container.cafevDialog('widget');
    // const tableContainer = $container.find(tableContainerId);
    // widget.css('overflow', 'visible');
    // $container.css('overflow', 'visible');
    // tableContainer.css('overflow', 'visible');
    return true;
  });

  // TODO: check whether these are still necessary
  $container.on('chosen:hiding_dropdown', tableContainerId + ' select', function(event) {
    console.log('chosen:hiding_dropdown');
    // const widget = $container.cafevDialog('widget');
    // const tableContainer = $container.find(tableContainerId);
    // tableContainer.css('overflow', '');
    // $container.css('overflow', '');
    // widget.css('overflow', '');
    return true;
  });

  $container.on('chosen:update', 'select.writers, select.readers', function(event) {
    resizeCB();
    return false;
  });

  setFieldTypeCssClass(fieldTypeData());

  allowedHeaderVisibility();

  // set autocomplete for generator selection
  const generatorRow = $container.find('tr.data-options.generator');
  const generators = generatorRow.data('generators');
  generatorRow.find('input.field-data')
    .autocomplete({
      source: generators,
      position: { my: 'left bottom', at: 'left top', collision: 'none' },
      minLength: 0,
      select(event, ui) {
        // trigger blur event for validation
        const $input = $(event.target);
        $input.val(ui.item.value);
        $input.blur();
      },
    })
    .on('focus', function() {
      const $this = $(this);
      if (!$this.autocomplete('widget').is(':visible')
          &amp;&amp; !$this.prop('disabled') &amp;&amp; !$this.prop('readonly')) {
        $(this).autocomplete('search', '');
      }
    });

  // synthesize resize events for textareas.
  textareaResize($container, 'textarea.field-tooltip, textarea.participant-field-tooltip, textarea.pme-input');
  resizeCB();
};

const documentReady = function() {

  CAFEVDB.addReadyCallback(function() {
    // const $container = PHPMyEdit.container();
    // if (!$container.hasClass('project-participant-fields')) {
    //   return; // not for us
    // }
    // ready(); // ????
  });

};

export {
  ready,
  documentReady,
  confirmedReceivablesUpdate,
};

// Local Variables: ***
// js-indent-level: 2 ***
// indent-tabs-mode: nil ***
// End: ***
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Mon Mar 20 2023 16:35:54 GMT+0100 (Central European Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
