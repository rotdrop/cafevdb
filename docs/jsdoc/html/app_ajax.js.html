<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>app/ajax.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#actionHandler">actionHandler</a></li><li><a href="global.html#addEditor">addEditor</a></li><li><a href="global.html#addMusicians">addMusicians</a></li><li><a href="global.html#addReadyCallback">addReadyCallback</a></li><li><a href="global.html#afterLoad">afterLoad</a></li><li><a href="global.html#ajaxFailData">ajaxFailData</a></li><li><a href="global.html#ajaxFailMessage">ajaxFailMessage</a></li><li><a href="global.html#ajaxHandleError">ajaxHandleError</a></li><li><a href="global.html#ajaxValidateResponse">ajaxValidateResponse</a></li><li><a href="global.html#appInfo">appInfo</a></li><li><a href="global.html#applyToolTips">applyToolTips</a></li><li><a href="global.html#appPrefix">appPrefix</a></li><li><a href="global.html#appSettings">appSettings</a></li><li><a href="global.html#attachHandlers">attachHandlers</a></li><li><a href="global.html#checkInvalidInputs">checkInvalidInputs</a></li><li><a href="global.html#chosenActive">chosenActive</a></li><li><a href="global.html#clearObject">clearObject</a></li><li><a href="global.html#closeActionMenu">closeActionMenu</a></li><li><a href="global.html#contactValidation">contactValidation</a></li><li><a href="global.html#containerSelector">containerSelector</a></li><li><a href="global.html#createProgressStatus">createProgressStatus</a></li><li><a href="global.html#debugPopup">debugPopup</a></li><li><a href="global.html#dialogCustomCloseButton">dialogCustomCloseButton</a></li><li><a href="global.html#dialogFullScreenButton">dialogFullScreenButton</a></li><li><a href="global.html#dialogToBackButton">dialogToBackButton</a></li><li><a href="global.html#documentReady">documentReady</a></li><li><a href="global.html#download">download</a></li><li><a href="global.html#emailFormCompositionHandlers">emailFormCompositionHandlers</a></li><li><a href="global.html#emailFormPopup">emailFormPopup</a></li><li><a href="global.html#emailFormRecipientsHandlers">emailFormRecipientsHandlers</a></li><li><a href="global.html#emailFormRecipientsSelectControls">emailFormRecipientsSelectControls</a></li><li><a href="global.html#emailPopup">emailPopup</a></li><li><a href="global.html#eventsPopup">eventsPopup</a></li><li><a href="global.html#findOptionByValue">findOptionByValue</a></li><li><a href="global.html#FindRanges">FindRanges</a></li><li><a href="global.html#formSubmit">formSubmit</a></li><li><a href="global.html#generateSettingsUrl">generateSettingsUrl</a></li><li><a href="global.html#generateUrl">generateUrl</a></li><li><a href="global.html#getAppUrl">getAppUrl</a></li><li><a href="global.html#getChildren">getChildren</a></li><li><a href="global.html#getControlObject">getControlObject</a></li><li><a href="global.html#getOptions">getOptions</a></li><li><a href="global.html#getOptionValues">getOptionValues</a></li><li><a href="global.html#getPersonalUrl">getPersonalUrl</a></li><li><a href="global.html#getSelectize">getSelectize</a></li><li><a href="global.html#getToken">getToken</a></li><li><a href="global.html#getUrl">getUrl</a></li><li><a href="global.html#getWidget">getWidget</a></li><li><a href="global.html#handleProjectActions">handleProjectActions</a></li><li><a href="global.html#handleQueryLogMenu">handleQueryLogMenu</a></li><li><a href="global.html#handleTableExportMenu">handleTableExportMenu</a></li><li><a href="global.html#htmlDecode">htmlDecode</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#installInputSelectize">installInputSelectize</a></li><li><a href="global.html#instrumentationNumbersPopup">instrumentationNumbersPopup</a></li><li><a href="global.html#invalidInputDowncount">invalidInputDowncount</a></li><li><a href="global.html#isVanilla">isVanilla</a></li><li><a href="global.html#jQuery">jQuery</a></li><li><a href="global.html#lazyBatchDecryptValues">lazyBatchDecryptValues</a></li><li><a href="global.html#loadPage">loadPage</a></li><li><a href="global.html#loadPMETable">loadPMETable</a></li><li><a href="global.html#loadPMETableFiltered">loadPMETableFiltered</a></li><li><a href="global.html#mandatesInit">mandatesInit</a></li><li><a href="global.html#mandateValidate">mandateValidate</a></li><li><a href="global.html#mandateValidatePME">mandateValidatePME</a></li><li><a href="global.html#mandateValidatePMEPromise">mandateValidatePMEPromise</a></li><li><a href="global.html#mandateValidatePMEWorker">mandateValidatePMEWorker</a></li><li><a href="global.html#maybeTranspose">maybeTranspose</a></li><li><a href="global.html#messages">messages</a></li><li><a href="global.html#modalizer">modalizer</a></li><li><a href="global.html#modalWaitNotification">modalWaitNotification</a></li><li><a href="global.html#myLoadAddMusicians">myLoadAddMusicians</a></li><li><a href="global.html#myLoadMusicians">myLoadMusicians</a></li><li><a href="global.html#myLoadProjectParticipants">myLoadProjectParticipants</a></li><li><a href="global.html#myPersonalRecordDialog">myPersonalRecordDialog</a></li><li><a href="global.html#nonTextInputTypes">nonTextInputTypes</a></li><li><a href="global.html#participantFieldsPopup">participantFieldsPopup</a></li><li><a href="global.html#photoEditCurrent">photoEditCurrent</a></li><li><a href="global.html#photoLoad">photoLoad</a></li><li><a href="global.html#photoLoadHandlers">photoLoadHandlers</a></li><li><a href="global.html#photoReady">photoReady</a></li><li><a href="global.html#photoUploadDragDrop">photoUploadDragDrop</a></li><li><a href="global.html#pmeCellSelector">pmeCellSelector</a></li><li><a href="global.html#pmeClassSelector">pmeClassSelector</a></li><li><a href="global.html#pmeClassSelectors">pmeClassSelectors</a></li><li><a href="global.html#pmeContainer">pmeContainer</a></li><li><a href="global.html#pmeContextMenu">pmeContextMenu</a></li><li><a href="global.html#pmeData">pmeData</a></li><li><a href="global.html#pmeDeferReload">pmeDeferReload</a></li><li><a href="global.html#pmeFilterSelector">pmeFilterSelector</a></li><li><a href="global.html#pmeFormSelector">pmeFormSelector</a></li><li><a href="global.html#pmeIdSelector">pmeIdSelector</a></li><li><a href="global.html#pmeInit">pmeInit</a></li><li><a href="global.html#pmeInner">pmeInner</a></li><li><a href="global.html#pmeInputSelector">pmeInputSelector</a></li><li><a href="global.html#pmeKeySelector">pmeKeySelector</a></li><li><a href="global.html#pmeNavigationSelector">pmeNavigationSelector</a></li><li><a href="global.html#pmeOpenRowDialog">pmeOpenRowDialog</a></li><li><a href="global.html#pmeQueryInfoSelector">pmeQueryInfoSelector</a></li><li><a href="global.html#pmeRec">pmeRec</a></li><li><a href="global.html#pmeRecordValue">pmeRecordValue</a></li><li><a href="global.html#pmeSelector">pmeSelector</a></li><li><a href="global.html#pmeSubmitOuterForm">pmeSubmitOuterForm</a></li><li><a href="global.html#pmeSys">pmeSys</a></li><li><a href="global.html#pmeSysNameSelector">pmeSysNameSelector</a></li><li><a href="global.html#pmeSysNameSelectors">pmeSysNameSelectors</a></li><li><a href="global.html#pmeTableDialogOpen">pmeTableDialogOpen</a></li><li><a href="global.html#pmeTableSelector">pmeTableSelector</a></li><li><a href="global.html#pmeToken">pmeToken</a></li><li><a href="global.html#pmeTriggerSubmit">pmeTriggerSubmit</a></li><li><a href="global.html#pmeTweaks">pmeTweaks</a></li><li><a href="global.html#pmeUnTweak">pmeUnTweak</a></li><li><a href="global.html#pmeValueSelector">pmeValueSelector</a></li><li><a href="global.html#pollProgressStatus">pollProgressStatus</a></li><li><a href="global.html#print_r">print_r</a></li><li><a href="global.html#projectPaymentPopup">projectPaymentPopup</a></li><li><a href="global.html#projectViewPopup">projectViewPopup</a></li><li><a href="global.html#projectWebPageRequest">projectWebPageRequest</a></li><li><a href="global.html#projectWebPageTabHandler">projectWebPageTabHandler</a></li><li><a href="global.html#pseudoSubmit">pseudoSubmit</a></li><li><a href="global.html#pseudoSubmitPost">pseudoSubmitPost</a></li><li><a href="global.html#queryData">queryData</a></li><li><a href="global.html#refreshSelectWidget">refreshSelectWidget</a></li><li><a href="global.html#refreshWidgetProperties">refreshWidgetProperties</a></li><li><a href="global.html#removeEditor">removeEditor</a></li><li><a href="global.html#renderTag">renderTag</a></li><li><a href="global.html#replaceSelectOptions">replaceSelectOptions</a></li><li><a href="global.html#runReadyCallbacks">runReadyCallbacks</a></li><li><a href="global.html#selectedOptions">selectedOptions</a></li><li><a href="global.html#selectedValues">selectedValues</a></li><li><a href="global.html#selectizeActive">selectizeActive</a></li><li><a href="global.html#setAppUrl">setAppUrl</a></li><li><a href="global.html#setPersonalUrl">setPersonalUrl</a></li><li><a href="global.html#setToken">setToken</a></li><li><a href="global.html#simpleSetHandler">simpleSetHandler</a></li><li><a href="global.html#simpleSetValueHandler">simpleSetValueHandler</a></li><li><a href="global.html#snapshotEditor">snapshotEditor</a></li><li><a href="global.html#stopEnterSubmit">stopEnterSubmit</a></li><li><a href="global.html#tableDialog">tableDialog</a></li><li><a href="global.html#tableDialogHandlers">tableDialogHandlers</a></li><li><a href="global.html#tableDialogReload">tableDialogReload</a></li><li><a href="global.html#tableDialogReplace">tableDialogReplace</a></li><li><a href="global.html#Template">Template</a></li><li><a href="global.html#textareaResize">textareaResize</a></li><li><a href="global.html#toolTipsEnabled">toolTipsEnabled</a></li><li><a href="global.html#toolTipsInit">toolTipsInit</a></li><li><a href="global.html#transposeMainTable">transposeMainTable</a></li><li><a href="global.html#transposeReady">transposeReady</a></li><li><a href="global.html#unfocus">unfocus</a></li><li><a href="global.html#updateEditor">updateEditor</a></li><li><a href="global.html#urlDecode">urlDecode</a></li><li><a href="global.html#urlEncode">urlEncode</a></li><li><a href="global.html#validateInstrumentChoices">validateInstrumentChoices</a></li><li><a href="global.html#wikiPopup">wikiPopup</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">app/ajax.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Orchestra member, musicion and project management application.
 *
 * CAFEVDB -- Camerata Academica Freiburg e.V. DataBase.
 *
 * @author Claus-Justus Heine
 * @copyright 2011-2016, 2020, 2021, 2022 Claus-Justus Heine &lt;himself@claus-justus-heine.de>
 * @license AGPL-3.0-or-later
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see &lt;http://www.gnu.org/licenses/>.
 */

import $ from './jquery.js';
import { appName } from './app-info.js';
import globalState from './globalstate.js';
import print_r from './print-r.js';
import * as Dialogs from './dialogs.js';
import { isPlainObject } from 'is-plain-object';
import { getRootUrl as getCloudRootUrl } from '@nextcloud/router';
import { loadState } from '@nextcloud/initial-state';

const cloudWebRoot = getCloudRootUrl() || '/';

const ajaxHttpStatus = {
  200: t(appName, 'OK'),
  201: t(appName, 'Created'),
  202: t(appName, 'Accepted'),
  203: t(appName, 'Non-Authoritative Information'),
  204: t(appName, 'No Content'),
  205: t(appName, 'Reset Content'),
  206: t(appName, 'Partial Content'),
  207: t(appName, 'Multi-Status (WebDAV)'),
  208: t(appName, 'Already Reported (WebDAV)'),
  226: t(appName, 'IM Used'),
  300: t(appName, 'Multiple Choices'),
  301: t(appName, 'Moved Permanently'),
  302: t(appName, 'Found'),
  303: t(appName, 'See Other'),
  304: t(appName, 'Not Modified'),
  305: t(appName, 'Use Proxy'),
  306: t(appName, '(Unused)'),
  307: t(appName, 'Temporary Redirect'),
  308: t(appName, 'Permanent Redirect (experimental)'),
  400: t(appName, 'Bad Request'),
  401: t(appName, 'Unauthorized'),
  402: t(appName, 'Payment Required'),
  403: t(appName, 'Forbidden'),
  404: t(appName, 'Not Found'),
  405: t(appName, 'Method Not Allowed'),
  406: t(appName, 'Not Acceptable'),
  407: t(appName, 'Proxy Authentication Required'),
  408: t(appName, 'Request Timeout'),
  409: t(appName, 'Conflict'),
  410: t(appName, 'Gone'),
  411: t(appName, 'Length Required'),
  412: t(appName, 'Precondition Failed'),
  413: t(appName, 'Request Entity Too Large'),
  414: t(appName, 'Request-URI Too Long'),
  415: t(appName, 'Unsupported Media Type'),
  416: t(appName, 'Requested Range Not Satisfiable'),
  417: t(appName, 'Expectation Failed'),
  418: t(appName, 'I\'m a teapot (RFC 2324)'),
  420: t(appName, 'Enhance Your Calm (Twitter)'),
  422: t(appName, 'Unprocessable Entity (WebDAV)'),
  423: t(appName, 'Locked (WebDAV)'),
  424: t(appName, 'Failed Dependency (WebDAV)'),
  425: t(appName, 'Reserved for WebDAV'),
  426: t(appName, 'Upgrade Required'),
  428: t(appName, 'Precondition Required'),
  429: t(appName, 'Too Many Requests'),
  431: t(appName, 'Request Header Fields Too Large'),
  444: t(appName, 'No Response (Nginx)'),
  449: t(appName, 'Retry With (Microsoft)'),
  450: t(appName, 'Blocked by Windows Parental Controls (Microsoft)'),
  451: t(appName, 'Unavailable For Legal Reasons'),
  499: t(appName, 'Client Closed Request (Nginx)'),
  500: t(appName, 'Internal Server Error'),
  501: t(appName, 'Not Implemented'),
  502: t(appName, 'Bad Gateway'),
  503: t(appName, 'Service Unavailable'),
  504: t(appName, 'Gateway Timeout'),
  505: t(appName, 'HTTP Version Not Supported'),
  506: t(appName, 'Variant Also Negotiates (Experimental)'),
  507: t(appName, 'Insufficient Storage (WebDAV)'),
  508: t(appName, 'Loop Detected (WebDAV)'),
  509: t(appName, 'Bandwidth Limit Exceeded (Apache)'),
  510: t(appName, 'Not Extended'),
  511: t(appName, 'Network Authentication Required'),
  598: t(appName, 'Network read timeout error'),
  599: t(appName, 'Network connect timeout error'),

  // Seemingly Nextcloud always ever only returns one of these:
  OK: 200,
  BAD_REQUEST: 400,
  UNAUTHORIZED: 401,
  NOT_FOUND: 404,
  CONFLICT: 409,
  PRECONDITION_FAILED: 412,
  INTERNAL_SERVER_ERROR: 500,
};

/**
 * Generate some diagnostic output, mostly needed during application
 * development. This is intended to be called from the fail()
 * callback.
 *
 * @param {object} xhr TBD.
 *
 * @param {string} textStatus TBD.
 *
 * @param {number} errorThrown TBD.
 *
 * @param {object} callbacks An object with hook-functions:
 *
 * ```
 * {
 *   cleanup: function(data) { ... },
 *   preProcess: function(data) { ... }
 * ```
 *
 * The callbacks as well as the callback object itself is optional and
 * defaults to "do nothing". The argument is the data possibly
 * submitted by the server, as computed by ajaFailData().
 *
 * @returns {object} TBD.
 */
const ajaxHandleError = function(xhr, textStatus, errorThrown, callbacks) {

  if (!globalState.initialized) {
    $.extend(globalState, loadState(appName, 'CAFEVDB'));
  }

  const defaultCallbacks = {
    cleanup(data) {},
    preProcess(data) {},
  };
  callbacks = callbacks || {};
  if (callbacks instanceof Function) {
    callbacks = {
      cleanup: callbacks,
    };
  }
  callbacks = $.extend({}, defaultCallbacks, callbacks);

  const failData = ajaxFailData(xhr, textStatus, errorThrown);
  callbacks.preProcess(failData);

  let decodedStatus;
  switch (textStatus) {
  case 'cancelled':
    decodedStatus = t(appName, 'Operation cancelled by user.');
    break;
  case 'abort':
    decodedStatus = t(appName, 'Aborted');
    break;
  case 'notmodified':
  case 'nocontent':
  case 'error':
  case 'timeout':
  case 'parsererror':
  case 'success': // this should not happen here
  default:
    decodedStatus = ajaxHttpStatus[xhr.status];
    break;
  }

  const caption = t(appName, 'Error');
  let info = '&lt;span class="bold toastify http-status error">' + decodedStatus + '&lt;/span>';
  // console.info(xhr.status, info, errorThrown, textStatus);

  const reportBody = `JavaScript User Agent:
${navigator.userAgent}

PHP User Agent:
${globalState.phpUserAgent || 'unknown'}

Error Code:  ${decodedStatus}

Error Data: ${print_r(failData, true)}
`;
  let autoReport = '&lt;a href="mailto:'
      + encodeURIComponent(globalState.adminContact)
      + '?subject=' + '[CAFEVDB Error] Error Feedback'
      + '&amp;body='
      + encodeURIComponent(reportBody)
      + '">'
      + t('cafevdb', 'System Administrator')
      + '&lt;/a>';

  switch (xhr.status) {
  case ajaxHttpStatus.OK:
  case ajaxHttpStatus.BAD_REQUEST:
  case ajaxHttpStatus.NOT_FOUND:
  case ajaxHttpStatus.CONFLICT:
  case ajaxHttpStatus.INTERNAL_SERVER_ERROR: {
    if (failData.error &amp;&amp; ajaxHttpStatus[xhr.status] !== t(appName, failData.error)) {
      info += ': '
        + '&lt;span class="bold error toastify name">'
        + t(appName, failData.error)
        + '&lt;/span>';
    }
    if (failData.message) {
      if (!Array.isArray(failData.message)) {
        failData.message = [failData.message];
      }
      for (const msg of failData.message) {
        info += '&lt;div class="' + appName + ' error toastify">' + msg + '&lt;/div>';
      }
    }
    info += '&lt;div class="error toastify feedback-link">'
      + t(appName, 'Feedback email: {AutoReport}', { AutoReport: autoReport }, -1, { escape: false })
      + '&lt;/div>';
    autoReport = '';
    let exceptionData = failData;
    if (exceptionData.exception !== undefined) {
      info += '&lt;div class="exception error name">&lt;pre>' + exceptionData.exception + '&lt;/pre>&lt;/div>'
        + '&lt;div class="exception error trace">&lt;pre>' + exceptionData.trace + '&lt;/pre>&lt;/div>';
      while ((exceptionData = exceptionData.previous) != null) {
        info += '&lt;div class="bold error toastify">' + exceptionData.message + '&lt;/div>';
        info += '&lt;div class="exception error name">&lt;pre>' + exceptionData.exception + '&lt;/pre>&lt;/div>'
          + '&lt;div class="exception error trace">&lt;pre>' + exceptionData.trace + '&lt;/pre>&lt;/div>';
      }
    }
    if (failData.info) {
      info += '&lt;div class="' + appName + ' error-page">' + failData.info + '&lt;/div>';
    }
    break;
  }
  case ajaxHttpStatus.PRECONDITION_FAILED:
    // a simple page reload may help
    callbacks.cleanup = function() {
      window.location.reload();
    };
    if (failData.error &amp;&amp; ajaxHttpStatus[xhr.status] !== t(appName, failData.error)) {
      info += ': '
        + '&lt;span class="bold error toastify name">'
        + t(appName, failData.error)
        + '&lt;/span>';
    }
    if (failData.message) {
      if (!Array.isArray(failData.message)) {
        failData.message = [failData.message];
      }
      for (const msg of failData.message) {
        info += '&lt;div class="' + appName + ' error toastify">' + msg + '&lt;/div>';
      }
    }
    info += `&lt;div class="error general">
This can happen when your device has been put to sleep (close the lid,
switch off your phone or tablet) for a longer time. In this case a
certain security token could not be refreshed regularly which may
produce the error your see. A simple page reload may help. This is
done automatically when cloud click "ok" or close this dialog window.
&lt;/div>`;
    break;
  case ajaxHttpStatus.UNAUTHORIZED: {
    // no point in continuing, direct the user to the login page
    callbacks.cleanup = function() {
      window.location.replace(cloudWebRoot);
    };

    let generalHint = t(appName, 'Something went wrong.');
    generalHint += '&lt;br/>'
      + t(appName, 'If it should be the case that you are already '
          + 'logged in for a long time without interacting '
          + 'with the web-app, then the reason for this '
          + 'error is probably a simple timeout.');
    generalHint += '&lt;br/>'
      + t(appName, 'I any case it may help to logoff and logon again, as a '
          + 'temporary work-around. You will be redirected to the '
          + 'log-in page when you close this window.');
    info += '&lt;div class="error general">' + generalHint + '&lt;/div>';
    // info += '&lt;div class="error toastify feedback-link">'
    //       + t(appName, 'Feedback email: {AutoReport}', { AutoReport: autoReport }, -1, { escape: false })
    //       + '&lt;/div>';
    break;
  }
  }

  // console.info(info);
  Dialogs.alert(info, caption, function() { callbacks.cleanup(failData); }, true, true);
  return failData;
};

/**
 * Generate some diagnostic output, mostly needed during
 * application development. This is intended to be called from the
 * done() callback after a successful AJAX call.
 *
 * @param {object} data The data passed to the callback to $.post()
 *
 * @param {Array} required List of required fields in data.data.
 *
 * @param {Function} errorCB TBD.
 *
 * @returns {boolean} TBD.
 */
const ajaxValidateResponse = function(data, required, errorCB) {
  if (data.data &amp;&amp; data.data.status !== undefined) {
    console.error('********** Success handler called as error handler ************');
    if (data.data.status !== 'success') {
      ajaxHandleError(null, data, null);
      return false;
    } else {
      data = data.data;
    }
  }
  if (typeof errorCB === 'undefined') {
    errorCB = function(data) {};
  }
  const dialogCallback = function() {
    errorCB(data);
  };
  // error handling
  if (typeof data === 'undefined' || !data) {
    Dialogs.alert(
      t(appName, 'Unrecoverable unknown internal error, '
        + 'no further information available, sorry.'),
      t(appName, 'Internal Error'), dialogCallback, true);
    return false;
  }
  let missing = '';
  for (let idx = 0; idx &lt; required.length; ++idx) {
    if (typeof data[required[idx]] === 'undefined') {
      missing += t(
        appName, 'Field {RequiredField} not present in AJAX response.',
        { RequiredField: required[idx] }) + '&lt;br>';
    }
  }
  if (missing.length > 0) {
    let info = '';
    if (typeof data.message !== 'undefined') {
      info += data.message + ' ';
    }
    info += t(appName, 'Missing data');
    // Add missing fields only if no exception or setup-error was
    // caught as in this case no regular data-fields have been
    // constructed
    info += '&lt;div class="missing error">' + missing + '&lt;/div>';

    if (!isPlainObject(data)) {
      let caption = 'Error';
      switch (typeof data) {
      case 'string':
        info += t(
          appName,
          'The submitted data "{stringValue}" seems to be a plain string, '
            + 'but we need an object where the data is provided through above listed properties.',
          { stringValue: data.substring(0, 32) + '...' });
        caption = t(appName, 'Error: plain string received');
        break;
      default:
        info += t(
          appName,
          'The submitted data is not a plain object, '
            + 'and does not provide the properties listed above.',
          { stringValue: data.substring(0, 32) + '...' });
        caption = t(appName, 'Error: not a plain object');
        break;
      }
      data = { caption, data };
    }

    // Display additional debug info if any
    Dialogs.debugPopup(data);

    let caption = data.caption;
    if (typeof caption === 'undefined' || caption === '') {
      caption = t(appName, 'Error');
      data.caption = caption;
    }
    Dialogs.alert(info, caption, dialogCallback, true, true);
    return false;
  }
  return true;
};

/**
 * Fetch data from an error response.
 *
 * @param {object} xhr jqXHR, see fail() method of jQuery ajax.
 *
 * @param {string} textStatus from jQuery, see fail() method of jQuery ajax.
 *
 * @param {string} errorThrown see fail() method of jQuery ajax.
 *
 * @returns {object} TBD.
 */
const ajaxFailData = function(xhr, textStatus, errorThrown) {
  if (xhr.parsed !== undefined &amp;&amp; xhr.error !== undefined &amp;&amp; xhr.status !== undefined &amp;&amp; xhr.message !== undefined) {
    return xhr;
  }
  const ct = xhr.getResponseHeader('content-type') || '';
  let data = {
    error: errorThrown,
    status: textStatus,
    message: t(appName, 'Unknown JSON error response to AJAX call: {status} / {error}', { status: textStatus, error: errorThrown }),
    parsed: false,
  };
  if (ct.indexOf('html') > -1) {
    console.debug('html response', xhr, textStatus, errorThrown);
    console.debug(xhr.status);
    data.message = t(
      appName, 'HTTP error response to AJAX call: {code} / {error}',
      { code: xhr.status, error: errorThrown });
    data.info = $(xhr.responseText).find('main').html();
    data.parsed = true;
  } else if (ct.indexOf('json') > -1) {
    const response = JSON.parse(xhr.responseText);
    // console.info('XHR response text', xhr.responseText);
    // console.log('JSON response', response);
    data = { ...data, ...response };
    data.parsed = true;
  } else {
    console.log('unknown response');
  }
  // console.info(data);
  return data;
};

/**
 * Generate some diagnostic output, mostly needed during application
 * development.
 *
 * @param {object} xhr jqXHR, see fail() method of jQuery ajax.
 *
 * @param {string} textStatus from jQuery, see fail() method of jQuery ajax.
 *
 * @param {string} errorThrown see fail() method of jQuery ajax.
 *
 * @returns {object} TBD.
 */
const ajaxFailMessage = function(xhr, textStatus, errorThrown) {
  return ajaxFailData(xhr, textStatus, errorThrown).message;
};

$(function() {
  Dialogs.attachDialogHandlers();
});

export {
  ajaxHttpStatus as httpStatus,
  ajaxHandleError as handleError,
  ajaxValidateResponse as validateResponse,
  ajaxFailData as failData,
  ajaxFailMessage as failMessage,
};

// Local Variables: ***
// js-indent-level: 2 ***
// End: ***
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Mon Mar 20 2023 16:35:54 GMT+0100 (Central European Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
